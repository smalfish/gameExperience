System.register("chunks:///_virtual/effect.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(e){"use strict";var t,n,i,r,o,a,l,c,p,s,u;return{setters:[function(e){t=e.applyDecoratedDescriptor,n=e.inheritsLoose,i=e.initializerDefineProperty,r=e.assertThisInitialized,o=e.defineProperty},function(e){a=e.cclegacy,l=e._decorator,c=e.Enum,p=e.AnimationComponent,s=e.ParticleSystemComponent,u=e.Component}],execute:function(){var f,y,h,d,m,b,g,C,v,L,N,T,I;a._RF.push({},"07f78DYBgNKjKZNL1uL0JyA","effect",void 0);var _=l.ccclass,A=l.property,E=c({ANIMATION:0,PARTICLE:1,SPINE:2});e("Effect",(f=_("Effect"),y=A({type:E}),h=A({type:p}),d=A({displayName:"持续时间",tooltip:"到达指定时间后会自动移除该特效"}),m=A({displayName:"自动销毁",tooltip:"是否自动销毁"}),b=A({displayName:"是否自动播放",tooltip:"是否在允许游戏后自动播放"}),f((v=t((C=function(e){function t(){for(var t,n=arguments.length,a=new Array(n),l=0;l<n;l++)a[l]=arguments[l];return t=e.call.apply(e,[this].concat(a))||this,i(r(t),"effectType",v,r(t)),i(r(t),"ani",L,r(t)),i(r(t),"keepTime",N,r(t)),i(r(t),"autoDestroy",T,r(t)),i(r(t),"playOnStart",I,r(t)),o(r(t),"_endListenerCb",null),t}n(t,e);var a=t.prototype;return a.start=function(){this.playOnStart&&this.play()},a.play=function(){var e=this;this.node.getComponentsInChildren(s).forEach((function(e){e.clear(),e.stop(),e.play()})),this.node.getComponentsInChildren(p).forEach((function(e){e.play()})),this.keepTime>0&&this.scheduleOnce((function(){e.effectOver()}),this.keepTime)},a.effectOver=function(){this.autoDestroy&&this.node.destroy(),this._endListenerCb&&this._endListenerCb()},a.setEndListener=function(e){this._endListenerCb=e},t}(u)).prototype,"effectType",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return E.ANIMATION}}),L=t(C.prototype,"ani",[h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=t(C.prototype,"keepTime",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),T=t(C.prototype,"autoDestroy",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I=t(C.prototype,"playOnStart",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),g=C))||g));a._RF.pop()}}}));

System.register("chunks:///_virtual/csvManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(e){"use strict";var t,r,n,i;return{setters:[function(e){t=e.defineProperty,r=e.createClass},function(e){n=e.cclegacy,i=e._decorator}],execute:function(){var s,u,a;n._RF.push({},"09755lSX5pCjIM4FngL22aB","csvManager",void 0);var o=i.ccclass,l=(i.property,[",",";","\t","|","^"]),c=["\r\n","\r","\n"],h=function(e,t,r,n){return r instanceof Array?"number"===r[t]?Number(n[t]):"boolean"===r[t]?"true"===n[t]||"t"===n[t]||"1"===n[t]:n[t]:isNaN(Number(e))?"false"==e||"true"==e||"t"==e||"f"==e?"true"===n[t]||"t"===n[t]||"1"===n[t]:n[t]:Number(n[t])},f={STANDARD_DECODE_OPTS:{skip:0,limit:!1,header:!1,cast:!1,comment:""},STANDARD_ENCODE_OPTS:{delimiter:l[0],newline:c[0],skip:0,limit:!1,header:!1},quoteMark:'"',doubleQuoteMark:'""',quoteRegex:/"/g,assign:function(){for(var e=Array.prototype.slice.call(arguments),t=e[0],r=e.slice(1),n=0,i=r.length;n<i;n++)for(var s in r[n])t[s]=r[n][s];return t},map:function(e,t){for(var r=[],n=0,i=e.length;n<i;n++)r[n]=t(e[n],n);return r},getType:function(e){return Object.prototype.toString.call(e).slice(8,-1)},getLimit:function(e,t){return!1===e?t:e},buildObjectConstructor:function(e,t,r){return function(n){var i=new Object,s=function(e,t){return i[e]=t};return r?e.forEach((function(e,i){s(e,h(t[i],i,r,n))})):e.forEach((function(e,r){s(e,h(t[r],r,null,n))})),i}},buildArrayConstructor:function(e,t,r){return function(n){var i=new Array(t.length),s=function(e,t){return i[e]=t};return r?e.forEach((function(e,i){s(e,h(t[i],i,r,n))})):e.forEach((function(e,r){s(e,h(t[r],r,null,n))})),i}},frequency:function(e,t,r){void 0===r&&(r=!1);for(var n=0,i=0,s=this.getLimit(r,e.length);i<s&&-1!==(i=e.indexOf(t,i));)i+=1,n++;return n},mostFrequent:function(e,t,r){for(var n,i=t.length-1;i>=0;i--)this.frequency(e,t[i],r)>0&&(n=t[i]);return n||t[0]},unsafeParse:function(e,t,r){var n,i,s=e.split(t.newline);function u(e){var r=e.shift();if(r.indexOf('"')>=0){for(var n=0,i=0,s=0;e.length>0&&(-1!==(n=r.indexOf('"',i))||s%2!=0);)-1!==n?(i=n+1,s++):r=r+t.newline+e.shift();var u,a=[],o=0,l=0,c=0,h=r.length;for(var f in r)if(r.hasOwnProperty(f)){var d=parseInt(f),g=r[f];0===d&&'"'===g&&(o++,l=1),'"'===g&&(o++,r[d-1]===t.delimiter&&l===d&&l++),'"'===g&&o%2==0&&(r[d+1]!==t.delimiter&&d+1!==h||(c=d,u=r.substring(l,c),a.push(u),c=l=c+2)),g===t.delimiter&&o%2==0&&((c=d)>l?(u=r.substring(l,c),a.push(u),c=l=c+1):c===l&&(a.push(""),c=l=c+1))}return(c=h)>=l&&(u=r.substring(l,c),a.push(u)),a}return r.split(t.delimiter)}for(t.skip>0&&s.splice(t.skip),t.header?(!0===t.header?(t.comment=u(s),t.cast=u(s),n=u(s)):"Array"===this.getType(t.header)&&(n=t.header),i=this.buildObjectConstructor(n,s[0].split(t.delimiter),t.cast)):i=this.buildArrayConstructor(n,s[0].split(t.delimiter),t.cast);s.length>0;){var a=u(s);a.length>1&&r(i(a),n[0])}return!0},safeParse:function(e,t,r){t.delimiter;var n=t.newline,i=e.split(n);return t.skip>0&&i.splice(t.skip),!0},encodeCells:function(e,t,r){for(var n=e.slice(0),i=0,s=n.length;i<s;i++)-1!==n[i].indexOf(this.quoteMark)&&(n[i]=n[i].replace(this.quoteRegex,this.doubleQuoteMark)),-1===n[i].indexOf(t)&&-1===n[i].indexOf(r)||(n[i]=this.quoteMark+n[i]+this.quoteMark);return n.join(t)},encodeArrays:function(e,t,r){var n=t.delimiter,i=t.newline;t.header&&"Array"===this.getType(t.header)&&r(this.encodeCells(t.header,n,i));for(var s=0,u=this.getLimit(t.limit,e.length);s<u;s++)r(this.encodeCells(e[s],n,i));return!0},encodeObjects:function(e,t,r){var n,i,s=t.delimiter,u=t.newline;for(var a in n=[],i=[],e[0])n.push(a),i.push(e[0][a]);!0===t.header?r(this.encodeCells(n,s,u)):"Array"===this.getType(t.header)&&r(this.encodeCells(t.header,s,u)),r(this.encodeCells(i,s));for(var o=1,l=this.getLimit(t.limit,e.length);o<l;o++){i=[];for(var c=0,h=n.length;c<h;c++)i.push(e[o][n[c]]);r(this.encodeCells(i,s,u))}return!0},parse:function(e,t,r){var n;if("Function"===this.getType(t)?(r=t,t={}):"Function"!==this.getType(r)?r=(n=[]).push.bind(n):n=[],t=this.assign({},this.STANDARD_DECODE_OPTS,t),this.opts=t,!t.delimiter||!t.newline){var i=Math.min(48,Math.floor(e.length/20),e.length);t.delimiter=t.delimiter||this.mostFrequent(e,l,i),t.newline=t.newline||this.mostFrequent(e,c,i)}return this.unsafeParse(e,t,r)&&(!(n.length>0)||n)},encode:function(e,t,r){var n;return"Function"===this.getType(t)?(r=t,t={}):"Function"!==this.getType(r)&&(r=(n=[]).push.bind(n)),(t=this.assign({},this.STANDARD_ENCODE_OPTS,t)).skip>0&&(e=e.slice(t.skip)),("Array"===this.getType(e[0])?this.encodeArrays:this.encodeObjects)(e,t,r)&&(!(n.length>0)||n.join(t.newline))}};e("CSVManager",o("CSVManager")((a=u=function(){function e(){t(this,"_csvTables",{}),t(this,"_csvTableForArr",{}),t(this,"_tableCast",{}),t(this,"_tableComment",{})}var n=e.prototype;return n.addTable=function(e,t,r){if(!this._csvTables[e]||r){var n={},i=[];f.parse(t,{header:!0},(function(e,t){n[e[t]]=e,i.push(e)})),this._tableCast[e]=f.opts.cast,this._tableComment[e]=f.opts.comment,this._csvTables[e]=n,this._csvTableForArr[e]=i}},n.getTableArr=function(e){return this._csvTableForArr[e]},n.getTable=function(e){return this._csvTables[e]},n.queryOne=function(e,t,r){var n=this.getTable(e);if(!n)return null;if(!t)return n[r];for(var i in n)if(n.hasOwnProperty(i)&&n[i][t]===r)return n[i]},n.queryByID=function(e,t){return this.queryOne(e,null,t)},n.queryAll=function(e,t,r){var n=this.getTable(e);if(!n||!t)return null;var i={};for(var s in n)n.hasOwnProperty(s)&&n[s][t]===r&&(i[s]=n[s]);return i},n.queryIn=function(e,t,r){var n=this.getTable(e);if(!n||!t)return null;for(var i={},s=Object.keys(n),u=s.length,a=0;a<u;a++){var o=n[s[a]];r.indexOf(o[t])>-1&&(i[s[a]]=o)}return i},n.queryByCondition=function(e,t){if(t.constructor!==Object)return null;var r=this.getTable(e);if(!r)return null;for(var n={},i=Object.keys(r),s=i.length,u=Object.keys(t),a=u.length,o=0;o<s;o++){for(var l=r[i[o]],c=!0,h=0;h<a;h++){var f=u[h];c=c&&t[f]===l[f]&&!n[i[o]]}c&&(n[i[o]]=l)}return n},n.queryOneByCondition=function(e,t){if(t.constructor!==Object)return null;var r=this.getTable(e);if(!r)return null;var n=Object.keys(t),i=n.length;for(var s in r){for(var u=r[s],a=!0,o=0;o<i;o++){var l=n[o];a=a&&t[l]===u[l]}if(a)return u}return null},r(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}(),t(u,"_instance",void 0),s=a))||s);n._RF.pop()}}}));

System.register("chunks:///_virtual/box2d.js",["./cjs-loader.mjs"],(function(t,e){"use strict";var i;return{setters:[function(t){i=t.default}],execute:function(){t("default",void 0),i.define(e.meta.url,(function(e,o,s,r,n){i.createRequireWithReqMap({},o);!function(){var t={};function e(t,e){return void 0!==t?t:e}window.box2d=t;var i=1e37,o=1e-5,s=o*o,r=3.14159265359,n=.1,a=.008,m=2/180*r,_=.016,h=.2,l=8/180*r,u=.5*r,c=2.4674011002726646,p=-1,f=.75,d=.25,y=256,v=.01,x=2/180*r,B=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),S=new B(2,3,2);function A(t,e){for(var i=[],o=0;o<t;++o)i.push(e(o));return i}function b(t,e){void 0===e&&(e=0);for(var i=[],o=0;o<t;++o)i.push(e);return i}var C=r/180,V=180/r,g=2*r,w=Math.abs,M=Math.min,P=Math.max;function I(t,e,i){return t<e?e:t>i?i:t}var G=isFinite;function D(t){return t*t}function F(t){return 1/Math.sqrt(t)}var T,L=Math.sqrt,R=Math.pow,k=Math.cos,q=Math.sin,z=Math.acos,E=Math.asin,J=Math.atan2,N=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.Clone=function(){return new t(this.x,this.y)},t.prototype.SetZero=function(){return this.x=0,this.y=0,this},t.prototype.Set=function(t,e){return this.x=t,this.y=e,this},t.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},t.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},t.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this},t.prototype.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},t.prototype.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},t.prototype.Dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.Cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},t.prototype.Normalize=function(){var t=this.Length();if(t>=o){var e=1/t;this.x*=e,this.y*=e}return t},t.prototype.SelfNormalize=function(){var t=this.Length();if(t>=o){var e=1/t;this.x*=e,this.y*=e}return this},t.prototype.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),o=this.x;return this.x=e*o-i*this.y,this.y=i*o+e*this.y,this},t.prototype.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},t.prototype.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},t.prototype.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},t.prototype.SelfMinV=function(t){return this.x=M(this.x,t.x),this.y=M(this.y,t.y),this},t.prototype.SelfMaxV=function(t){return this.x=P(this.x,t.x),this.y=P(this.y,t.y),this},t.prototype.SelfAbs=function(){return this.x=w(this.x),this.y=w(this.y),this},t.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return A(e,(function(e){return new t}))},t.AbsV=function(t,e){return e.x=w(t.x),e.y=w(t.y),e},t.MinV=function(t,e,i){return i.x=M(t.x,e.x),i.y=M(t.y,e.y),i},t.MaxV=function(t,e,i){return i.x=P(t.x,e.x),i.y=P(t.y,e.y),i},t.ClampV=function(t,e,i,o){return o.x=I(t.x,e.x,i.x),o.y=I(t.y,e.y,i.y),o},t.RotateV=function(t,e,i){var o=t.x,s=t.y,r=Math.cos(e),n=Math.sin(e);return i.x=r*o-n*s,i.y=n*o+r*s,i},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,i){var o=t.x;return i.x=e*t.y,i.y=-e*o,i},t.CrossVOne=function(t,e){var i=t.x;return e.x=t.y,e.y=-i,e},t.CrossSV=function(t,e,i){var o=e.x;return i.x=-t*e.y,i.y=t*o,i},t.CrossOneV=function(t,e){var i=t.x;return e.x=-t.y,e.y=i,e},t.AddVV=function(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i},t.SubVV=function(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i},t.MulSV=function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i},t.MulVS=function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i},t.AddVMulSV=function(t,e,i,o){return o.x=t.x+e*i.x,o.y=t.y+e*i.y,o},t.SubVMulSV=function(t,e,i,o){return o.x=t.x-e*i.x,o.y=t.y-e*i.y,o},t.AddVCrossSV=function(t,e,i,o){var s=i.x;return o.x=t.x-e*i.y,o.y=t.y+e*s,o},t.MidVV=function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i},t.ExtVV=function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var i=t.x-e.x,o=t.y-e.y;return Math.sqrt(i*i+o*o)},t.DistanceSquaredVV=function(t,e){var i=t.x-e.x,o=t.y-e.y;return i*i+o*o},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},t.ZERO=new t(0,0),t.UNITX=new t(1,0),t.UNITY=new t(0,1),t.s_t0=new t,t.s_t1=new t,t.s_t2=new t,t.s_t3=new t,t}(),j=new N(0,0),O=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.Clone=function(){return new t(this.x,this.y,this.z)},t.prototype.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},t.prototype.SetXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},t.prototype.SelfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},t.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},t.prototype.SelfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},t.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,i){var o=t.x,s=t.y,r=t.z,n=e.x,a=e.y,m=e.z;return i.x=s*m-r*a,i.y=r*n-o*m,i.z=o*a-s*n,i},t.ZERO=new t(0,0,0),t.s_t0=new t,t}(),X=function(){function t(){this.ex=new N(1,0),this.ey=new N(0,1)}return t.prototype.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,i){return(new t).SetVV(e,i)},t.FromSSSS=function(e,i,o,s){return(new t).SetSSSS(e,i,o,s)},t.FromAngle=function(e){return(new t).SetAngle(e)},t.prototype.SetSSSS=function(t,e,i,o){return this.ex.Set(t,i),this.ey.Set(e,o),this},t.prototype.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},t.prototype.SetAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this},t.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},t.prototype.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},t.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},t.prototype.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},t.prototype.GetInverse=function(t){var e=this.ex.x,i=this.ey.x,o=this.ex.y,s=this.ey.y,r=e*s-i*o;return 0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.y=-r*o,t.ey.y=r*e,t},t.prototype.Solve=function(t,e,i){var o=this.ex.x,s=this.ey.x,r=this.ex.y,n=this.ey.y,a=o*n-s*r;return 0!==a&&(a=1/a),i.x=a*(n*t-s*e),i.y=a*(o*e-r*t),i},t.prototype.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},t.prototype.SelfInv=function(){return this.GetInverse(this),this},t.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},t.prototype.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var i=t.ex,o=t.ey;return e.ex.x=w(i.x),e.ex.y=w(i.y),e.ey.x=w(o.x),e.ey.y=w(o.y),e},t.MulMV=function(t,e,i){var o=t.ex,s=t.ey,r=e.x,n=e.y;return i.x=o.x*r+s.x*n,i.y=o.y*r+s.y*n,i},t.MulTMV=function(t,e,i){var o=t.ex,s=t.ey,r=e.x,n=e.y;return i.x=o.x*r+o.y*n,i.y=s.x*r+s.y*n,i},t.AddMM=function(t,e,i){var o=t.ex,s=t.ey,r=e.ex,n=e.ey;return i.ex.x=o.x+r.x,i.ex.y=o.y+r.y,i.ey.x=s.x+n.x,i.ey.y=s.y+n.y,i},t.MulMM=function(t,e,i){var o=t.ex.x,s=t.ex.y,r=t.ey.x,n=t.ey.y,a=e.ex.x,m=e.ex.y,_=e.ey.x,h=e.ey.y;return i.ex.x=o*a+r*m,i.ex.y=s*a+n*m,i.ey.x=o*_+r*h,i.ey.y=s*_+n*h,i},t.MulTMM=function(t,e,i){var o=t.ex.x,s=t.ex.y,r=t.ey.x,n=t.ey.y,a=e.ex.x,m=e.ex.y,_=e.ey.x,h=e.ey.y;return i.ex.x=o*a+s*m,i.ex.y=r*a+n*m,i.ey.x=o*_+s*h,i.ey.y=r*_+n*h,i},t.IDENTITY=new t,t}(),U=function(){function t(){this.ex=new O(1,0,0),this.ey=new O(0,1,0),this.ez=new O(0,0,1)}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.SetVVV=function(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this},t.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},t.prototype.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},t.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},t.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},t.prototype.Solve33=function(t,e,i,o){var s=this.ex.x,r=this.ex.y,n=this.ex.z,a=this.ey.x,m=this.ey.y,_=this.ey.z,h=this.ez.x,l=this.ez.y,u=this.ez.z,c=s*(m*u-_*l)+r*(_*h-a*u)+n*(a*l-m*h);return 0!==c&&(c=1/c),o.x=c*(t*(m*u-_*l)+e*(_*h-a*u)+i*(a*l-m*h)),o.y=c*(s*(e*u-i*l)+r*(i*h-t*u)+n*(t*l-e*h)),o.z=c*(s*(m*i-_*e)+r*(_*t-a*i)+n*(a*e-m*t)),o},t.prototype.Solve22=function(t,e,i){var o=this.ex.x,s=this.ey.x,r=this.ex.y,n=this.ey.y,a=o*n-s*r;return 0!==a&&(a=1/a),i.x=a*(n*t-s*e),i.y=a*(o*e-r*t),i},t.prototype.GetInverse22=function(t){var e=this.ex.x,i=this.ey.x,o=this.ex.y,s=this.ey.y,r=e*s-i*o;0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*o,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},t.prototype.GetSymInverse33=function(t){var e=O.DotV3V3(this.ex,O.CrossV3V3(this.ey,this.ez,O.s_t0));0!==e&&(e=1/e);var i=this.ex.x,o=this.ey.x,s=this.ez.x,r=this.ey.y,n=this.ez.y,a=this.ez.z;t.ex.x=e*(r*a-n*n),t.ex.y=e*(s*n-o*a),t.ex.z=e*(o*n-s*r),t.ey.x=t.ex.y,t.ey.y=e*(i*a-s*s),t.ey.z=e*(s*o-i*n),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-o*o)},t.MulM33V3=function(t,e,i){var o=e.x,s=e.y,r=e.z;return i.x=t.ex.x*o+t.ey.x*s+t.ez.x*r,i.y=t.ex.y*o+t.ey.y*s+t.ez.y*r,i.z=t.ex.z*o+t.ey.z*s+t.ez.z*r,i},t.MulM33XYZ=function(t,e,i,o,s){return s.x=t.ex.x*e+t.ey.x*i+t.ez.x*o,s.y=t.ex.y*e+t.ey.y*i+t.ez.y*o,s.z=t.ex.z*e+t.ey.z*i+t.ez.z*o,s},t.MulM33V2=function(t,e,i){var o=e.x,s=e.y;return i.x=t.ex.x*o+t.ey.x*s,i.y=t.ex.y*o+t.ey.y*s,i},t.MulM33XY=function(t,e,i,o){return o.x=t.ex.x*e+t.ey.x*i,o.y=t.ex.y*e+t.ey.y*i,o},t.IDENTITY=new t,t}(),Z=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.s=t.s,this.c=t.c,this},t.prototype.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},t.prototype.SetIdentity=function(){return this.s=0,this.c=1,this},t.prototype.GetAngle=function(){return Math.atan2(this.s,this.c)},t.prototype.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},t.prototype.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,i){var o=t.c,s=t.s,r=e.c,n=e.s;return i.s=s*r+o*n,i.c=o*r-s*n,i},t.MulTRR=function(t,e,i){var o=t.c,s=t.s,r=e.c,n=e.s;return i.s=o*n-s*r,i.c=o*r+s*n,i},t.MulRV=function(t,e,i){var o=t.c,s=t.s,r=e.x,n=e.y;return i.x=o*r-s*n,i.y=s*r+o*n,i},t.MulTRV=function(t,e,i){var o=t.c,s=t.s,r=e.x,n=e.y;return i.x=o*r+s*n,i.y=-s*r+o*n,i},t.IDENTITY=new t,t}(),W=function(){function t(){this.p=new N,this.q=new Z}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},t.prototype.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},t.prototype.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},t.prototype.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},t.prototype.SetPosition=function(t){return this.p.Copy(t),this},t.prototype.SetPositionXY=function(t,e){return this.p.Set(t,e),this},t.prototype.SetRotation=function(t){return this.q.Copy(t),this},t.prototype.SetRotationAngle=function(t){return this.q.SetAngle(t),this},t.prototype.GetPosition=function(){return this.p},t.prototype.GetRotation=function(){return this.q},t.prototype.GetRotationAngle=function(){return this.q.GetAngle()},t.prototype.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,i){var o=t.q.c,s=t.q.s,r=e.x,n=e.y;return i.x=o*r-s*n+t.p.x,i.y=s*r+o*n+t.p.y,i},t.MulTXV=function(t,e,i){var o=t.q.c,s=t.q.s,r=e.x-t.p.x,n=e.y-t.p.y;return i.x=o*r+s*n,i.y=-s*r+o*n,i},t.MulXX=function(t,e,i){return Z.MulRR(t.q,e.q,i.q),N.AddVV(Z.MulRV(t.q,e.p,i.p),t.p,i.p),i},t.MulTXX=function(t,e,i){return Z.MulTRR(t.q,e.q,i.q),Z.MulTRV(t.q,N.SubVV(e.p,t.p,i.p),i.p),i},t.IDENTITY=new t,t}(),H=function(){function t(){this.localCenter=new N,this.c0=new N,this.c=new N,this.a0=0,this.a=0,this.alpha0=0}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},t.prototype.GetTransform=function(t,e){var i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;var o=i*this.a0+e*this.a;return t.q.SetAngle(o),t.p.SelfSub(Z.MulRV(t.q,this.localCenter,N.s_t0)),t},t.prototype.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},t.prototype.Normalize=function(){var t=g*Math.floor(this.a0/g);this.a0-=t,this.a-=t},t}(),Q=function(){function t(t,e,i,o){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=.5),void 0===o&&(o=1),this.r=t,this.g=e,this.b=i,this.a=o}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},t.prototype.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},t.prototype.Set=function(t,e,i,o){void 0===o&&(o=this.a),this.SetRGBA(t,e,i,o)},t.prototype.SetByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},t.prototype.SetByteRGBA=function(t,e,i,o){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=o/255,this},t.prototype.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},t.prototype.SetRGBA=function(t,e,i,o){return this.r=t,this.g=e,this.b=i,this.a=o,this},t.prototype.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},t.prototype.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},t.prototype.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},t.prototype.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},t.prototype.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},t.prototype.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},t.prototype.Mix=function(e,i){t.MixColors(this,e,i)},t.MixColors=function(t,e,i){var o=i*(e.r-t.r),s=i*(e.g-t.g),r=i*(e.b-t.b),n=i*(e.a-t.a);t.r+=o,t.g+=s,t.b+=r,t.a+=n,e.r-=o,e.g-=s,e.b-=r,e.a-=n},t.prototype.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,i,o){return void 0===o&&(o=1),t*=255,e*=255,i*=255,o<1?"rgba("+t+","+e+","+i+","+o+")":"rgb("+t+","+e+","+i+")"},t.ZERO=new t(0,0,0,0),t.RED=new t(1,0,0),t.GREEN=new t(0,1,0),t.BLUE=new t(0,0,1),t}();(T=t.b2DrawFlags||(t.b2DrawFlags={}))[T.e_none=0]="e_none",T[T.e_shapeBit=1]="e_shapeBit",T[T.e_jointBit=2]="e_jointBit",T[T.e_aabbBit=4]="e_aabbBit",T[T.e_pairBit=8]="e_pairBit",T[T.e_centerOfMassBit=16]="e_centerOfMassBit",T[T.e_particleBit=32]="e_particleBit",T[T.e_controllerBit=64]="e_controllerBit",T[T.e_all=63]="e_all";var Y=function(){function t(){this.m_drawFlags=0}return t.prototype.SetFlags=function(t){this.m_drawFlags=t},t.prototype.GetFlags=function(){return this.m_drawFlags},t.prototype.AppendFlags=function(t){this.m_drawFlags|=t},t.prototype.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),K=function(){function t(){this.m_start=Date.now()}return t.prototype.Reset=function(){return this.m_start=Date.now(),this},t.prototype.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),$=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}return t.prototype.GetCount=function(){return this.m_count},t.prototype.GetMinCount=function(){return this.m_min_count},t.prototype.GetMaxCount=function(){return this.m_max_count},t.prototype.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},t.prototype.ResetMinCount=function(){this.m_min_count=0},t.prototype.ResetMaxCount=function(){this.m_max_count=0},t.prototype.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},t.prototype.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),tt=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=A(t,(function(t){return null})),this.m_count=0}return t.prototype.Reset=function(){return this.m_count=0,this},t.prototype.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},t.prototype.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},t.prototype.GetCount=function(){return this.m_count},t}(),et=function(){},it=function(){},ot=function(){function t(){this.m_buffer=N.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}return t.prototype.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},t.prototype.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},t.prototype.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},t.prototype.SetVerticesRadius=function(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i},t.prototype.GetSupport=function(t){for(var e=0,i=N.DotVV(this.m_vertices[0],t),o=1;o<this.m_count;++o){var s=N.DotVV(this.m_vertices[o],t);s>i&&(e=o,i=s)}return e},t.prototype.GetSupportVertex=function(t){for(var e=0,i=N.DotVV(this.m_vertices[0],t),o=1;o<this.m_count;++o){var s=N.DotVV(this.m_vertices[o],t);s>i&&(e=o,i=s)}return this.m_vertices[e]},t.prototype.GetVertexCount=function(){return this.m_count},t.prototype.GetVertex=function(t){return this.m_vertices[t]},t}(),st=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),rt=function(){function t(){this.proxyA=new ot,this.proxyB=new ot,this.transformA=new W,this.transformB=new W,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),nt=function(){function t(){this.pointA=new N,this.pointB=new N,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),at=function(){this.proxyA=new ot,this.proxyB=new ot,this.transformA=new W,this.transformB=new W,this.translationB=new N},mt=function(){this.point=new N,this.normal=new N,this.lambda=0,this.iterations=0};t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var _t=function(){function t(){this.wA=new N,this.wB=new N,this.w=new N,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),ht=function(){function t(){this.m_v1=new _t,this.m_v2=new _t,this.m_v3=new _t,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}return t.prototype.ReadCache=function(t,e,i,s,r){this.m_count=t.count;for(var n=this.m_vertices,a=0;a<this.m_count;++a){(u=n[a]).indexA=t.indexA[a],u.indexB=t.indexB[a];var m=e.GetVertex(u.indexA),_=s.GetVertex(u.indexB);W.MulXV(i,m,u.wA),W.MulXV(r,_,u.wB),N.SubVV(u.wB,u.wA,u.w),u.a=0}if(this.m_count>1){var h=t.metric,l=this.GetMetric();(l<.5*h||2*h<l||l<o)&&(this.m_count=0)}var u;0===this.m_count&&((u=n[0]).indexA=0,u.indexB=0,m=e.GetVertex(0),_=s.GetVertex(0),W.MulXV(i,m,u.wA),W.MulXV(r,_,u.wB),N.SubVV(u.wB,u.wA,u.w),u.a=1,this.m_count=1)},t.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},t.prototype.GetSearchDirection=function(t){switch(this.m_count){case 1:return N.NegV(this.m_v1.w,t);case 2:var e=N.SubVV(this.m_v2.w,this.m_v1.w,t);return N.CrossVV(e,N.NegV(this.m_v1.w,N.s_t0))>0?N.CrossOneV(e,t):N.CrossVOne(e,t);default:return t.SetZero()}},t.prototype.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},t.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},t.prototype.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return N.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return N.CrossVV(N.SubVV(this.m_v2.w,this.m_v1.w,N.s_t0),N.SubVV(this.m_v3.w,this.m_v1.w,N.s_t1));default:return 0}},t.prototype.Solve2=function(){var e=this.m_v1.w,i=this.m_v2.w,o=N.SubVV(i,e,t.s_e12),s=-N.DotVV(e,o);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);var r=N.DotVV(i,o);if(r<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var n=1/(r+s);this.m_v1.a=r*n,this.m_v2.a=s*n,this.m_count=2},t.prototype.Solve3=function(){var e=this.m_v1.w,i=this.m_v2.w,o=this.m_v3.w,s=N.SubVV(i,e,t.s_e12),r=N.DotVV(e,s),n=N.DotVV(i,s),a=-r,m=N.SubVV(o,e,t.s_e13),_=N.DotVV(e,m),h=N.DotVV(o,m),l=-_,u=N.SubVV(o,i,t.s_e23),c=N.DotVV(i,u),p=N.DotVV(o,u),f=-c,d=N.CrossVV(s,m),y=d*N.CrossVV(i,o),v=d*N.CrossVV(o,e),x=d*N.CrossVV(e,i);if(a<=0&&l<=0)return this.m_v1.a=1,void(this.m_count=1);if(n>0&&a>0&&x<=0){var B=1/(n+a);return this.m_v1.a=n*B,this.m_v2.a=a*B,void(this.m_count=2)}if(h>0&&l>0&&v<=0){var S=1/(h+l);return this.m_v1.a=h*S,this.m_v3.a=l*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(n<=0&&f<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(h<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(p>0&&f>0&&y<=0){var A=1/(p+f);return this.m_v2.a=p*A,this.m_v3.a=f*A,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var b=1/(y+v+x);this.m_v1.a=y*b,this.m_v2.a=v*b,this.m_v3.a=x*b,this.m_count=3},t.s_e12=new N,t.s_e13=new N,t.s_e23=new N,t}(),lt=new ht,ut=[0,0,0],ct=[0,0,0],pt=new N,ft=new N,dt=new N,yt=new N,vt=new N;function xt(e,i,r){++t.b2_gjkCalls;var n=r.proxyA,a=r.proxyB,m=r.transformA,_=r.transformB,h=lt;h.ReadCache(i,n,m,a,_);for(var l=h.m_vertices,u=ut,c=ct,p=0,f=0;f<20;){p=h.m_count;for(var d=0;d<p;++d)u[d]=l[d].indexA,c[d]=l[d].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;var y=h.GetSearchDirection(ft);if(y.LengthSquared()<s)break;var v=l[h.m_count];v.indexA=n.GetSupport(Z.MulTRV(m.q,N.NegV(y,N.s_t0),yt)),W.MulXV(m,n.GetVertex(v.indexA),v.wA),v.indexB=a.GetSupport(Z.MulTRV(_.q,y,vt)),W.MulXV(_,a.GetVertex(v.indexB),v.wB),N.SubVV(v.wB,v.wA,v.w),++f,++t.b2_gjkIters;var x=!1;for(d=0;d<p;++d)if(v.indexA===u[d]&&v.indexB===c[d]){x=!0;break}if(x)break;++h.m_count}if(t.b2_gjkMaxIters=P(t.b2_gjkMaxIters,f),h.GetWitnessPoints(e.pointA,e.pointB),e.distance=N.DistanceVV(e.pointA,e.pointB),e.iterations=f,h.WriteCache(i),r.useRadii){var B=n.m_radius,S=a.m_radius;if(e.distance>B+S&&e.distance>o){e.distance-=B+S;var A=N.SubVV(e.pointB,e.pointA,dt);A.Normalize(),e.pointA.SelfMulAdd(B,A),e.pointB.SelfMulSub(S,A)}else{var b=N.MidVV(e.pointA,e.pointB,pt);e.pointA.Copy(b),e.pointB.Copy(b),e.distance=0}}}var Bt,St=new N,At=new ht,bt=new N,Ct=new N,Vt=new N,gt=new N,wt=new N,Mt=new N;(Bt=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[Bt.e_vertex=0]="e_vertex",Bt[Bt.e_face=1]="e_face";var Pt,It=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return Object.defineProperty(t.prototype,"key",{get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexA",{get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexB",{get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"typeA",{get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"typeB",{get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),t}(),Gt=function(){function t(){this.cf=new It}return t.prototype.Copy=function(t){return this.key=t.key,this},t.prototype.Clone=function(){return(new t).Copy(this)},Object.defineProperty(t.prototype,"key",{get:function(){return this.cf.key},set:function(t){this.cf.key=t},enumerable:!0,configurable:!0}),t}(),Dt=function(){function t(){this.localPoint=new N,this.normalImpulse=0,this.tangentImpulse=0,this.id=new Gt}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t.prototype.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},t.prototype.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(Pt=t.b2ManifoldType||(t.b2ManifoldType={}))[Pt.e_unknown=-1]="e_unknown",Pt[Pt.e_circles=0]="e_circles",Pt[Pt.e_faceA=1]="e_faceA",Pt[Pt.e_faceB=2]="e_faceB";var Ft,Tt=function(){function e(){this.points=Dt.MakeArray(2),this.localNormal=new N,this.localPoint=new N,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}return e.prototype.Reset=function(){for(var e=0;e<2;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},e.prototype.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<2;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},e.prototype.Clone=function(){return(new e).Copy(this)},e}(),Lt=function(){function e(){this.normal=new N,this.points=N.MakeArray(2),this.separations=b(2)}return e.prototype.Initialize=function(i,o,r,n,a){if(0!==i.pointCount)switch(i.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var m=W.MulXV(o,i.localPoint,e.Initialize_s_pointA),_=W.MulXV(n,i.points[0].localPoint,e.Initialize_s_pointB);N.DistanceSquaredVV(m,_)>s&&N.SubVV(_,m,this.normal).SelfNormalize();var h=N.AddVMulSV(m,r,this.normal,e.Initialize_s_cA),l=N.SubVMulSV(_,a,this.normal,e.Initialize_s_cB);N.MidVV(h,l,this.points[0]),this.separations[0]=N.DotVV(N.SubVV(l,h,N.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:Z.MulRV(o.q,i.localNormal,this.normal);for(var u=W.MulXV(o,i.localPoint,e.Initialize_s_planePoint),c=0;c<i.pointCount;++c){var p=W.MulXV(n,i.points[c].localPoint,e.Initialize_s_clipPoint),f=r-N.DotVV(N.SubVV(p,u,N.s_t0),this.normal);h=N.AddVMulSV(p,f,this.normal,e.Initialize_s_cA),l=N.SubVMulSV(p,a,this.normal,e.Initialize_s_cB),N.MidVV(h,l,this.points[c]),this.separations[c]=N.DotVV(N.SubVV(l,h,N.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:for(Z.MulRV(n.q,i.localNormal,this.normal),u=W.MulXV(n,i.localPoint,e.Initialize_s_planePoint),c=0;c<i.pointCount;++c)p=W.MulXV(o,i.points[c].localPoint,e.Initialize_s_clipPoint),f=a-N.DotVV(N.SubVV(p,u,N.s_t0),this.normal),l=N.AddVMulSV(p,f,this.normal,e.Initialize_s_cB),h=N.SubVMulSV(p,r,this.normal,e.Initialize_s_cA),N.MidVV(h,l,this.points[c]),this.separations[c]=N.DotVV(N.SubVV(h,l,N.s_t0),this.normal);this.normal.SelfNeg()}},e.Initialize_s_pointA=new N,e.Initialize_s_pointB=new N,e.Initialize_s_cA=new N,e.Initialize_s_cB=new N,e.Initialize_s_planePoint=new N,e.Initialize_s_clipPoint=new N,e}();(Ft=t.b2PointState||(t.b2PointState={}))[Ft.b2_nullState=0]="b2_nullState",Ft[Ft.b2_addState=1]="b2_addState",Ft[Ft.b2_persistState=2]="b2_persistState",Ft[Ft.b2_removeState=3]="b2_removeState";var Rt=function(){function t(){this.v=new N,this.id=new Gt}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),kt=function(){function t(){this.p1=new N,this.p2=new N,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),qt=function(){function t(){this.normal=new N,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),zt=function(){function t(){this.lowerBound=new N,this.upperBound=new N,this.m_cache_center=new N,this.m_cache_extent=new N}return t.prototype.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},t.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=t>=0&&e>=0;return i=i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},t.prototype.GetCenter=function(){return N.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},t.prototype.GetExtents=function(){return N.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},t.prototype.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},t.prototype.Combine1=function(t){return this.lowerBound.x=M(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=M(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=P(this.upperBound.x,t.upperBound.x),this.upperBound.y=P(this.upperBound.y,t.upperBound.y),this},t.prototype.Combine2=function(t,e){return this.lowerBound.x=M(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=M(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=P(t.upperBound.x,e.upperBound.x),this.upperBound.y=P(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,i){return i.Combine2(t,e),i},t.prototype.Contains=function(t){var e=!0;return e=(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},t.prototype.RayCast=function(t,e){var s,r,n=-i,a=i,m=e.p1.x,_=e.p1.y,h=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,u=w(h),c=w(l),p=t.normal;if(u<o){if(m<this.lowerBound.x||this.upperBound.x<m)return!1}else{var f=1/h,d=-1;if((s=(this.lowerBound.x-m)*f)>(r=(this.upperBound.x-m)*f)){var y=s;s=r,r=y,d=1}if(s>n&&(p.x=d,p.y=0,n=s),n>(a=M(a,r)))return!1}if(c<o){if(_<this.lowerBound.y||this.upperBound.y<_)return!1}else if(f=1/l,d=-1,(s=(this.lowerBound.y-_)*f)>(r=(this.upperBound.y-_)*f)&&(y=s,s=r,r=y,d=1),s>n&&(p.x=0,p.y=d,n=s),n>(a=M(a,r)))return!1;return!(n<0||e.maxFraction<n||(t.fraction=n,0))},t.prototype.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},t.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,o=this.lowerBound.x-t.upperBound.x,s=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0||o>0||s>0)},t}();function Et(t,e){var i=e.lowerBound.x-t.upperBound.x,o=e.lowerBound.y-t.upperBound.y,s=t.lowerBound.x-e.upperBound.x,r=t.lowerBound.y-e.upperBound.y;return!(i>0||o>0||s>0||r>0)}function Jt(e,i,o,s,r){var n=0,a=i[0],m=i[1],_=N.DotVV(o,a.v)-s,h=N.DotVV(o,m.v)-s;if(_<=0&&e[n++].Copy(a),h<=0&&e[n++].Copy(m),_*h<0){var l=_/(_-h),u=e[n].v;u.x=a.v.x+l*(m.v.x-a.v.x),u.y=a.v.y+l*(m.v.y-a.v.y);var c=e[n].id;c.cf.indexA=r,c.cf.indexB=a.id.cf.indexB,c.cf.typeA=t.b2ContactFeatureType.e_vertex,c.cf.typeB=t.b2ContactFeatureType.e_face,++n}return n}var Nt=new rt,jt=new st,Ot=new nt;function Xt(t,e,i,o,s,r){var n=Nt.Reset();n.proxyA.SetShape(t,e),n.proxyB.SetShape(i,o),n.transformA.Copy(s),n.transformB.Copy(r),n.useRadii=!0;var a=jt.Reset();a.count=0;var m=Ot.Reset();return xt(m,a,n),m.distance<1e-4}function Ut(t){if(null===t)throw new Error;return t}var Zt=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new zt,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}return t.prototype.IsLeaf=function(){return null===this.child1},t}(),Wt=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new tt(256)}return t.prototype.Query=function(t,e){if(null!==this.m_root){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var o=i.Pop();if(o.aabb.TestOverlap(t))if(o.IsLeaf()){if(!e(o))return}else i.Push(Ut(o.child1)),i.Push(Ut(o.child2))}}},t.prototype.QueryPoint=function(t,e){if(null!==this.m_root){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var o=i.Pop();if(o.aabb.TestContain(t))if(o.IsLeaf()){if(!e(o))return}else i.Push(Ut(o.child1)),i.Push(Ut(o.child2))}}},t.prototype.RayCast=function(e,i){if(null!==this.m_root){var o=e.p1,s=e.p2,r=N.SubVV(s,o,t.s_r);r.Normalize();var n=N.CrossOneV(r,t.s_v),a=N.AbsV(n,t.s_abs_v),m=e.maxFraction,_=t.s_segmentAABB,h=o.x+m*(s.x-o.x),l=o.y+m*(s.y-o.y);_.lowerBound.x=M(o.x,h),_.lowerBound.y=M(o.y,l),_.upperBound.x=P(o.x,h),_.upperBound.y=P(o.y,l);var u=this.m_stack.Reset();for(u.Push(this.m_root);u.GetCount()>0;){var c=u.Pop();if(Et(c.aabb,_)){var p=c.aabb.GetCenter(),f=c.aabb.GetExtents();if(!(w(N.DotVV(n,N.SubVV(o,p,N.s_t0)))-N.DotVV(a,f)>0))if(c.IsLeaf()){var d=t.s_subInput;d.p1.Copy(e.p1),d.p2.Copy(e.p2),d.maxFraction=m;var y=i(d,c);if(0===y)return;y>0&&(m=y,h=o.x+m*(s.x-o.x),l=o.y+m*(s.y-o.y),_.lowerBound.x=M(o.x,h),_.lowerBound.y=M(o.y,l),_.upperBound.x=P(o.x,h),_.upperBound.y=P(o.y,l))}else u.Push(Ut(c.child1)),u.Push(Ut(c.child2))}}}},t.prototype.AllocateNode=function(){if(this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,delete e.userData,e}return new Zt(t.s_node_id++)},t.prototype.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,delete t.userData,this.m_freeList=t},t.prototype.CreateProxy=function(t,e){var i=this.AllocateNode();return i.aabb.lowerBound.x=t.lowerBound.x-.1,i.aabb.lowerBound.y=t.lowerBound.y-.1,i.aabb.upperBound.x=t.upperBound.x+.1,i.aabb.upperBound.y=t.upperBound.y+.1,i.userData=e,i.height=0,this.InsertLeaf(i),i},t.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},t.prototype.MoveProxy=function(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var o=n+2*(i.x>0?i.x:-i.x),s=n+2*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-o,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+o,t.aabb.upperBound.y=e.upperBound.y+s,this.InsertLeaf(t),!0},t.prototype.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var i=e.aabb,o=this.m_root;!o.IsLeaf();){var s=Ut(o.child1),r=Ut(o.child2),n=o.aabb.GetPerimeter(),a=t.s_combinedAABB;a.Combine2(o.aabb,i);var m=a.GetPerimeter(),_=2*m,h=2*(m-n),l=void 0,u=t.s_aabb,c=void 0;s.IsLeaf()?(u.Combine2(i,s.aabb),l=u.GetPerimeter()+h):(u.Combine2(i,s.aabb),c=s.aabb.GetPerimeter(),l=u.GetPerimeter()-c+h);var p=void 0;if(r.IsLeaf()?(u.Combine2(i,r.aabb),p=u.GetPerimeter()+h):(u.Combine2(i,r.aabb),c=r.aabb.GetPerimeter(),p=u.GetPerimeter()-c+h),_<l&&_<p)break;o=l<p?s:r}var f=o,d=f.parent,y=this.AllocateNode();y.parent=d,delete y.userData,y.aabb.Combine2(i,f.aabb),y.height=f.height+1,d?(d.child1===f?d.child1=y:d.child2=y,y.child1=f,y.child2=e,f.parent=y,e.parent=y):(y.child1=f,y.child2=e,f.parent=y,e.parent=y,this.m_root=y);for(var v=e.parent;null!==v;)s=Ut((v=this.Balance(v)).child1),r=Ut(v.child2),v.height=1+P(s.height,r.height),v.aabb.Combine2(s.aabb,r.aabb),v=v.parent},t.prototype.RemoveLeaf=function(t){if(t!==this.m_root){var e,i=Ut(t.parent),o=i&&i.parent;if(e=i.child1===t?Ut(i.child2):Ut(i.child1),o){o.child1===i?o.child1=e:o.child2=e,e.parent=o,this.FreeNode(i);for(var s=o;s;){var r=Ut((s=this.Balance(s)).child1),n=Ut(s.child2);s.aabb.Combine2(r.aabb,n.aabb),s.height=1+P(r.height,n.height),s=s.parent}}else this.m_root=e,e.parent=null,this.FreeNode(i)}else this.m_root=null},t.prototype.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Ut(t.child1),i=Ut(t.child2),o=i.height-e.height;if(o>1){var s=Ut(i.child1),r=Ut(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>r.height?(i.child2=s,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+P(e.height,r.height),i.height=1+P(t.height,s.height)):(i.child2=r,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,r.aabb),t.height=1+P(e.height,s.height),i.height=1+P(t.height,r.height)),i}if(o<-1){var n=Ut(e.child1),a=Ut(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,n.height>a.height?(e.child2=n,t.child1=a,a.parent=t,t.aabb.Combine2(i.aabb,a.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+P(i.height,a.height),e.height=1+P(t.height,n.height)):(e.child2=a,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+P(i.height,n.height),e.height=1+P(t.height,a.height)),e}return t},t.prototype.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var i=e.aabb.GetPerimeter();return i+=t.GetAreaNode(e.child1),i+=t.GetAreaNode(e.child2)},t.prototype.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.prototype.ComputeHeightNode=function(t){if(!t||t.IsLeaf())return 0;var e=this.ComputeHeightNode(t.child1),i=this.ComputeHeightNode(t.child2);return 1+P(e,i)},t.prototype.ComputeHeight=function(){return this.ComputeHeightNode(this.m_root)},t.prototype.ValidateStructure=function(t){if(null!==t){this.m_root;var e=t;if(!e.IsLeaf()){var i=Ut(e.child1),o=Ut(e.child2);this.ValidateStructure(i),this.ValidateStructure(o)}}},t.prototype.ValidateMetrics=function(e){if(null!==e){var i=e;if(!i.IsLeaf()){var o=Ut(i.child1),s=Ut(i.child2);t.s_aabb.Combine2(o.aabb,s.aabb),this.ValidateMetrics(o),this.ValidateMetrics(s)}}},t.prototype.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=Ut(t.child1),o=Ut(t.child2),s=w(o.height-i.height);return P(e,s)},t.prototype.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},t.prototype.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,i){if(null!==e&&!(e.height<=1)){var o=e.child1,s=e.child2;t.ShiftOriginNode(o,i),t.ShiftOriginNode(s,i),e.aabb.lowerBound.SelfSub(i),e.aabb.upperBound.SelfSub(i)}},t.prototype.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t.s_r=new N,t.s_v=new N,t.s_abs_v=new N,t.s_segmentAABB=new zt,t.s_subInput=new kt,t.s_combinedAABB=new zt,t.s_aabb=new zt,t.s_node_id=0,t}(),Ht=function(t,e){this.proxyA=t,this.proxyB=e},Qt=function(){function t(){this.m_tree=new Wt,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}return t.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},t.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},t.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},t.prototype.TouchProxy=function(t){this.BufferMove(t)},t.prototype.GetProxyCount=function(){return this.m_proxyCount},t.prototype.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var i=function(t){var i=o.m_moveBuffer[t];if(null===i)return"continue";var s=i.aabb;o.m_tree.Query(s,(function(t){if(t.m_id===i.m_id)return!0;var o,s;if(t.m_id<i.m_id?(o=t,s=i):(o=i,s=t),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new Ht(o,s);else{var r=e.m_pairBuffer[e.m_pairCount];r.proxyA=o,r.proxyB=s}return++e.m_pairCount,!0}))},o=this,s=0;s<this.m_moveCount;++s)i(s);this.m_moveCount=0,this.m_pairBuffer.length=this.m_pairCount,this.m_pairBuffer.sort(Yt);for(var r=0;r<this.m_pairCount;){var n=this.m_pairBuffer[r],a=n.proxyA.userData,m=n.proxyB.userData;for(a&&m&&t(a,m),++r;r<this.m_pairCount;){var _=this.m_pairBuffer[r];if(_.proxyA.m_id!==n.proxyA.m_id||_.proxyB.m_id!==n.proxyB.m_id)break;++r}}},t.prototype.Query=function(t,e){this.m_tree.Query(t,e)},t.prototype.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},t.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},t.prototype.GetTreeHeight=function(){return this.m_tree.GetHeight()},t.prototype.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},t.prototype.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},t.prototype.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},t.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},t.prototype.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function Yt(t,e){return t.proxyA.m_id===e.proxyA.m_id?t.proxyB.m_id-e.proxyB.m_id:t.proxyA.m_id-e.proxyA.m_id}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var Kt,$t=new W,te=new W,ee=new N,ie=new N,oe=new N,se=new N,re=new N,ne=function(){this.proxyA=new ot,this.proxyB=new ot,this.sweepA=new H,this.sweepB=new H,this.tMax=0};(Kt=t.b2TOIOutputState||(t.b2TOIOutputState={}))[Kt.e_unknown=0]="e_unknown",Kt[Kt.e_failed=1]="e_failed",Kt[Kt.e_overlapped=2]="e_overlapped",Kt[Kt.e_touching=3]="e_touching",Kt[Kt.e_separated=4]="e_separated";var ae,me=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(ae=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[ae.e_unknown=-1]="e_unknown",ae[ae.e_points=0]="e_points",ae[ae.e_faceA=1]="e_faceA",ae[ae.e_faceB=2]="e_faceB";var _e=function(){function e(){this.m_sweepA=new H,this.m_sweepB=new H,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new N,this.m_axis=new N}return e.prototype.Initialize=function(e,i,o,s,r,n){this.m_proxyA=i,this.m_proxyB=s;var a=e.count;this.m_sweepA.Copy(o),this.m_sweepB.Copy(r);var m=$t,_=te;if(this.m_sweepA.GetTransform(m,n),this.m_sweepB.GetTransform(_,n),1===a){this.m_type=t.b2SeparationFunctionType.e_points;var h=this.m_proxyA.GetVertex(e.indexA[0]),l=this.m_proxyB.GetVertex(e.indexB[0]),u=W.MulXV(m,h,ee),c=W.MulXV(_,l,ie);N.SubVV(c,u,this.m_axis);var p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var f=this.m_proxyB.GetVertex(e.indexB[0]),d=this.m_proxyB.GetVertex(e.indexB[1]);N.CrossVOne(N.SubVV(d,f,N.s_t0),this.m_axis).SelfNormalize();var y=Z.MulRV(_.q,this.m_axis,oe);return N.MidVV(f,d,this.m_localPoint),c=W.MulXV(_,this.m_localPoint,ie),h=this.m_proxyA.GetVertex(e.indexA[0]),u=W.MulXV(m,h,ee),(p=N.DotVV(N.SubVV(u,c,N.s_t0),y))<0&&(this.m_axis.SelfNeg(),p=-p),p}this.m_type=t.b2SeparationFunctionType.e_faceA;var v=this.m_proxyA.GetVertex(e.indexA[0]),x=this.m_proxyA.GetVertex(e.indexA[1]);return N.CrossVOne(N.SubVV(x,v,N.s_t0),this.m_axis).SelfNormalize(),y=Z.MulRV(m.q,this.m_axis,oe),N.MidVV(v,x,this.m_localPoint),u=W.MulXV(m,this.m_localPoint,ee),l=this.m_proxyB.GetVertex(e.indexB[0]),c=W.MulXV(_,l,ie),(p=N.DotVV(N.SubVV(c,u,N.s_t0),y))<0&&(this.m_axis.SelfNeg(),p=-p),p},e.prototype.FindMinSeparation=function(e,i,o){var s=$t,r=te;switch(this.m_sweepA.GetTransform(s,o),this.m_sweepB.GetTransform(r,o),this.m_type){case t.b2SeparationFunctionType.e_points:var n=Z.MulTRV(s.q,this.m_axis,se),a=Z.MulTRV(r.q,N.NegV(this.m_axis,N.s_t0),re);e[0]=this.m_proxyA.GetSupport(n),i[0]=this.m_proxyB.GetSupport(a);var m=this.m_proxyA.GetVertex(e[0]),_=this.m_proxyB.GetVertex(i[0]),h=W.MulXV(s,m,ee),l=W.MulXV(r,_,ie);return N.DotVV(N.SubVV(l,h,N.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=Z.MulRV(s.q,this.m_axis,oe);return h=W.MulXV(s,this.m_localPoint,ee),a=Z.MulTRV(r.q,N.NegV(u,N.s_t0),re),e[0]=-1,i[0]=this.m_proxyB.GetSupport(a),_=this.m_proxyB.GetVertex(i[0]),l=W.MulXV(r,_,ie),N.DotVV(N.SubVV(l,h,N.s_t0),u);case t.b2SeparationFunctionType.e_faceB:return u=Z.MulRV(r.q,this.m_axis,oe),l=W.MulXV(r,this.m_localPoint,ie),n=Z.MulTRV(s.q,N.NegV(u,N.s_t0),se),i[0]=-1,e[0]=this.m_proxyA.GetSupport(n),m=this.m_proxyA.GetVertex(e[0]),h=W.MulXV(s,m,ee),N.DotVV(N.SubVV(h,l,N.s_t0),u);default:return e[0]=-1,i[0]=-1,0}},e.prototype.Evaluate=function(e,i,o){var s=$t,r=te;switch(this.m_sweepA.GetTransform(s,o),this.m_sweepB.GetTransform(r,o),this.m_type){case t.b2SeparationFunctionType.e_points:var n=this.m_proxyA.GetVertex(e),a=this.m_proxyB.GetVertex(i),m=W.MulXV(s,n,ee),_=W.MulXV(r,a,ie);return N.DotVV(N.SubVV(_,m,N.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var h=Z.MulRV(s.q,this.m_axis,oe);return m=W.MulXV(s,this.m_localPoint,ee),a=this.m_proxyB.GetVertex(i),_=W.MulXV(r,a,ie),N.DotVV(N.SubVV(_,m,N.s_t0),h);case t.b2SeparationFunctionType.e_faceB:return h=Z.MulRV(r.q,this.m_axis,oe),_=W.MulXV(r,this.m_localPoint,ie),n=this.m_proxyA.GetVertex(e),m=W.MulXV(s,n,ee),N.DotVV(N.SubVV(m,_,N.s_t0),h);default:return 0}},e}(),he=new K,le=new st,ue=new rt,ce=new nt,pe=new _e,fe=[0],de=[0],ye=new H,ve=new H;function xe(e,i){var o=he.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;var s=i.proxyA,r=i.proxyB,n=ye.Copy(i.sweepA),m=ve.Copy(i.sweepB);n.Normalize(),m.Normalize();var _=i.tMax,h=s.m_radius+r.m_radius,l=P(a,h-.024),u=.002,c=0,p=0,f=le;f.count=0;var d=ue;for(d.proxyA.Copy(i.proxyA),d.proxyB.Copy(i.proxyB),d.useRadii=!1;;){var y=$t,v=te;n.GetTransform(y,c),m.GetTransform(v,c),d.transformA.Copy(y),d.transformB.Copy(v);var x=ce;if(xt(x,f,d),x.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(x.distance<l+u){e.state=t.b2TOIOutputState.e_touching,e.t=c;break}var B=pe;B.Initialize(f,s,n,r,m,c);for(var S=!1,A=_,b=0;;){var C=fe,V=de,g=B.FindMinSeparation(C,V,A);if(g>l+u){e.state=t.b2TOIOutputState.e_separated,e.t=_,S=!0;break}if(g>l-u){c=A;break}var M=B.Evaluate(C[0],V[0],c);if(M<l-u){e.state=t.b2TOIOutputState.e_failed,e.t=c,S=!0;break}if(M<=l+u){e.state=t.b2TOIOutputState.e_touching,e.t=c,S=!0;break}for(var I=0,G=c,D=A;;){var F=0;F=1&I?G+(l-M)*(D-G)/(g-M):.5*(G+D),++I,++t.b2_toiRootIters;var T=B.Evaluate(C[0],V[0],F);if(w(T-l)<u){A=F;break}if(T>l?(G=F,M=T):(D=F,g=T),50===I)break}if(t.b2_toiMaxRootIters=P(t.b2_toiMaxRootIters,I),8==++b)break}if(++p,++t.b2_toiIters,S)break;if(20===p){e.state=t.b2TOIOutputState.e_failed,e.t=c;break}}t.b2_toiMaxIters=P(t.b2_toiMaxIters,p);var L=o.GetMilliseconds();t.b2_toiMaxTime=P(t.b2_toiMaxTime,L),t.b2_toiTime+=L}var Be=new N,Se=new N;function Ae(e,i,o,s,r){e.pointCount=0;var n=W.MulXV(o,i.m_p,Be),a=W.MulXV(r,s.m_p,Se),m=N.DistanceSquaredVV(n,a),_=i.m_radius+s.m_radius;m>_*_||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(s.m_p),e.points[0].id.key=0)}var be=new N,Ce=new N,Ve=new N;function ge(e,s,r,n,a){e.pointCount=0;for(var m=W.MulXV(a,n.m_p,be),_=W.MulTXV(r,m,Ce),h=0,l=-i,u=s.m_radius+n.m_radius,c=s.m_count,p=s.m_vertices,f=s.m_normals,d=0;d<c;++d){var y=N.DotVV(f[d],N.SubVV(_,p[d],N.s_t0));if(y>u)return;y>l&&(l=y,h=d)}var v=h,x=(v+1)%c,B=p[v],S=p[x];if(l<o)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(f[h]),N.MidVV(B,S,e.localPoint),e.points[0].localPoint.Copy(n.m_p),void(e.points[0].id.key=0);var A=N.DotVV(N.SubVV(_,B,N.s_t0),N.SubVV(S,B,N.s_t1)),b=N.DotVV(N.SubVV(_,S,N.s_t0),N.SubVV(B,S,N.s_t1));if(A<=0){if(N.DistanceSquaredVV(_,B)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,N.SubVV(_,B,e.localNormal).SelfNormalize(),e.localPoint.Copy(B),e.points[0].localPoint.Copy(n.m_p),e.points[0].id.key=0}else if(b<=0){if(N.DistanceSquaredVV(_,S)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,N.SubVV(_,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(n.m_p),e.points[0].id.key=0}else{var C=N.MidVV(B,S,Ve);if(N.DotVV(N.SubVV(_,C,N.s_t1),f[v])>u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(f[v]).SelfNormalize(),e.localPoint.Copy(C),e.points[0].localPoint.Copy(n.m_p),e.points[0].id.key=0}}var we=new N,Me=new N,Pe=new N,Ie=new N;function Ge(t,e,o,s,r){for(var n=t.m_vertices,a=t.m_normals,m=s.m_count,_=s.m_vertices,h=Z.MulRV(e.q,a[o],we),l=Z.MulTRV(r.q,h,Me),u=0,c=i,p=0;p<m;++p){var f=N.DotVV(_[p],l);f<c&&(c=f,u=p)}var d=W.MulXV(e,n[o],Pe),y=W.MulXV(r,_[u],Ie);return N.DotVV(N.SubVV(y,d,N.s_t0),h)}var De=new N,Fe=new N;function Te(t,e,o,s,r){for(var n=e.m_count,a=e.m_normals,m=N.SubVV(W.MulXV(r,s.m_centroid,N.s_t0),W.MulXV(o,e.m_centroid,N.s_t1),De),_=Z.MulTRV(o.q,m,Fe),h=0,l=-i,u=0;u<n;++u){var c=N.DotVV(a[u],_);c>l&&(l=c,h=u)}var p=Ge(e,o,h,s,r),f=(h+n-1)%n,d=Ge(e,o,f,s,r),y=(h+1)%n,v=Ge(e,o,y,s,r),x=0,B=0,S=0;if(d>p&&d>v)S=-1,x=f,B=d;else{if(!(v>p))return t[0]=h,p;S=1,x=y,B=v}for(;(p=Ge(e,o,h=-1===S?(x+n-1)%n:(x+1)%n,s,r))>B;)x=h,B=p;return t[0]=x,B}var Le=new N,Re=Rt.MakeArray(2),ke=Rt.MakeArray(2),qe=Rt.MakeArray(2),ze=[0],Ee=[0],Je=new N,Ne=new N,je=new N,Oe=new N,Xe=new N,Ue=new N,Ze=new N,We=new N;function He(e,o,s,r,n){e.pointCount=0;var a=o.m_radius+r.m_radius,m=ze;m[0]=0;var _=Te(m,o,s,r,n);if(!(_>a)){var h=Ee;h[0]=0;var l=Te(h,r,n,o,s);if(!(l>a)){var u,c,p,f,d=0,y=0;l>.98*_+.001?(u=r,c=o,p=n,f=s,d=h[0],e.type=t.b2ManifoldType.e_faceB,y=1):(u=o,c=r,p=s,f=n,d=m[0],e.type=t.b2ManifoldType.e_faceA,y=0);var v=Re;!function(e,o,s,r,n,a){for(var m=o.m_normals,_=n.m_count,h=n.m_vertices,l=n.m_normals,u=Z.MulTRV(a.q,Z.MulRV(s.q,m[r],N.s_t0),Le),c=0,p=i,f=0;f<_;++f){var d=N.DotVV(u,l[f]);d<p&&(p=d,c=f)}var y=c,v=(y+1)%_,x=e[0];W.MulXV(a,h[y],x.v);var B=x.id.cf;B.indexA=r,B.indexB=y,B.typeA=t.b2ContactFeatureType.e_face,B.typeB=t.b2ContactFeatureType.e_vertex;var S=e[1];W.MulXV(a,h[v],S.v);var A=S.id.cf;A.indexA=r,A.indexB=v,A.typeA=t.b2ContactFeatureType.e_face,A.typeB=t.b2ContactFeatureType.e_vertex}(v,u,p,d,c,f);var x=u.m_count,B=u.m_vertices,S=d,A=(d+1)%x,b=B[S],C=B[A],V=N.SubVV(C,b,Je);V.Normalize();var g=N.CrossVOne(V,Ne),w=N.MidVV(b,C,je),M=Z.MulRV(p.q,V,Xe),P=N.CrossVOne(M,Oe),I=W.MulXV(p,b,Ze),G=W.MulXV(p,C,We),D=N.DotVV(P,I),F=-N.DotVV(M,I)+a,T=N.DotVV(M,G)+a,L=ke,R=qe;if(!(Jt(L,v,N.NegV(M,Ue),F,S)<2||Jt(R,L,M,T,A)<2)){e.localNormal.Copy(g),e.localPoint.Copy(w);for(var k=0,q=0;q<2;++q){var z=R[q];if(N.DotVV(P,z.v)-D<=a){var E=e.points[k];if(W.MulTXV(f,z.v,E.localPoint),E.id.Copy(z.id),y){var J=E.id.cf;E.id.cf.indexA=J.indexB,E.id.cf.indexB=J.indexA,E.id.cf.typeA=J.typeB,E.id.cf.typeB=J.typeA}++k}}e.pointCount=k}}}}var Qe=new N,Ye=new N,Ke=new N,$e=new N,ti=new N,ei=new N,ii=new N,oi=new Gt;function si(e,i,o,s,r){e.pointCount=0;var n=W.MulTXV(o,W.MulXV(r,s.m_p,N.s_t0),Qe),a=i.m_vertex1,m=i.m_vertex2,_=N.SubVV(m,a,Ye),h=N.DotVV(_,N.SubVV(m,n,N.s_t0)),l=N.DotVV(_,N.SubVV(n,a,N.s_t0)),u=i.m_radius+s.m_radius,c=oi;if(c.cf.indexB=0,c.cf.typeB=t.b2ContactFeatureType.e_vertex,l<=0){var p=a,f=N.SubVV(n,p,Ke);if(N.DotVV(f,f)>u*u)return;if(i.m_hasVertex0){var d=i.m_vertex0,y=a,v=N.SubVV(y,d,$e);if(N.DotVV(v,N.SubVV(y,n,N.s_t0))>0)return}return c.cf.indexA=0,c.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(p),e.points[0].id.Copy(c),void e.points[0].localPoint.Copy(s.m_p)}if(h<=0){var x=m,B=N.SubVV(n,x,Ke);if(N.DotVV(B,B)>u*u)return;if(i.m_hasVertex3){var S=i.m_vertex3,A=m,b=N.SubVV(S,A,ti);if(N.DotVV(b,N.SubVV(n,A,N.s_t0))>0)return}return c.cf.indexA=1,c.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(x),e.points[0].id.Copy(c),void e.points[0].localPoint.Copy(s.m_p)}var C=N.DotVV(_,_),V=ei;V.x=1/C*(h*a.x+l*m.x),V.y=1/C*(h*a.y+l*m.y);var g=N.SubVV(n,V,Ke);if(!(N.DotVV(g,g)>u*u)){var w=ii.Set(-_.y,_.x);N.DotVV(w,N.SubVV(n,a,N.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),c.cf.indexA=0,c.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(w),e.localPoint.Copy(a),e.points[0].id.Copy(c),e.points[0].localPoint.Copy(s.m_p)}}var ri=function(){this.type=0,this.index=0,this.separation=0},ni=function(){this.vertices=N.MakeArray(8),this.normals=N.MakeArray(8),this.count=0},ai=function(){this.i1=0,this.i2=0,this.v1=new N,this.v2=new N,this.normal=new N,this.sideNormal1=new N,this.sideOffset1=0,this.sideNormal2=new N,this.sideOffset2=0},mi=new(function(){function e(){this.m_polygonB=new ni,this.m_xf=new W,this.m_centroidB=new N,this.m_v0=new N,this.m_v1=new N,this.m_v2=new N,this.m_v3=new N,this.m_normal0=new N,this.m_normal1=new N,this.m_normal2=new N,this.m_normal=new N,this.m_type1=0,this.m_type2=0,this.m_lowerLimit=new N,this.m_upperLimit=new N,this.m_radius=0,this.m_front=!1}return e.prototype.Collide=function(i,o,s,r,n){W.MulTXX(s,n,this.m_xf),W.MulXV(this.m_xf,r.m_centroid,this.m_centroidB),this.m_v0.Copy(o.m_vertex0),this.m_v1.Copy(o.m_vertex1),this.m_v2.Copy(o.m_vertex2),this.m_v3.Copy(o.m_vertex3);var a=o.m_hasVertex0,m=o.m_hasVertex3,_=N.SubVV(this.m_v2,this.m_v1,e.s_edge1);_.Normalize(),this.m_normal1.Set(_.y,-_.x);var h=N.DotVV(this.m_normal1,N.SubVV(this.m_centroidB,this.m_v1,N.s_t0)),l=0,u=0,c=!1,p=!1;if(a){var f=N.SubVV(this.m_v1,this.m_v0,e.s_edge0);f.Normalize(),this.m_normal0.Set(f.y,-f.x),c=N.CrossVV(f,_)>=0,l=N.DotVV(this.m_normal0,N.SubVV(this.m_centroidB,this.m_v0,N.s_t0))}if(m){var d=N.SubVV(this.m_v3,this.m_v2,e.s_edge2);d.Normalize(),this.m_normal2.Set(d.y,-d.x),p=N.CrossVV(_,d)>0,u=N.DotVV(this.m_normal2,N.SubVV(this.m_centroidB,this.m_v2,N.s_t0))}a&&m?c&&p?(this.m_front=l>=0||h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):c?(this.m_front=l>=0||h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=u>=0||l>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=l>=0&&h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):a?c?(this.m_front=l>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=l>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):m?p?(this.m_front=h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=r.m_count;for(var y=0;y<r.m_count;++y)W.MulXV(this.m_xf,r.m_vertices[y],this.m_polygonB.vertices[y]),Z.MulRV(this.m_xf.q,r.m_normals[y],this.m_polygonB.normals[y]);this.m_radius=r.m_radius+o.m_radius,i.pointCount=0;var v=this.ComputeEdgeSeparation(e.s_edgeAxis);if(0!==v.type&&!(v.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(0!==x.type&&x.separation>this.m_radius)){var B;B=0===x.type?v:x.separation>.98*v.separation+.001?x:v;var S=e.s_ie,A=e.s_rf;if(1===B.type){i.type=t.b2ManifoldType.e_faceA;var b=0,C=N.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(y=1;y<this.m_polygonB.count;++y){var V=N.DotVV(this.m_normal,this.m_polygonB.normals[y]);V<C&&(C=V,b=y)}var g=b,w=(g+1)%this.m_polygonB.count;(M=S[0]).v.Copy(this.m_polygonB.vertices[g]),M.id.cf.indexA=0,M.id.cf.indexB=g,M.id.cf.typeA=t.b2ContactFeatureType.e_face,M.id.cf.typeB=t.b2ContactFeatureType.e_vertex,(P=S[1]).v.Copy(this.m_polygonB.vertices[w]),P.id.cf.indexA=0,P.id.cf.indexB=w,P.id.cf.typeA=t.b2ContactFeatureType.e_face,P.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(A.i1=0,A.i2=1,A.v1.Copy(this.m_v1),A.v2.Copy(this.m_v2),A.normal.Copy(this.m_normal1)):(A.i1=1,A.i2=0,A.v1.Copy(this.m_v2),A.v2.Copy(this.m_v1),A.normal.Copy(this.m_normal1).SelfNeg())}else{var M,P;i.type=t.b2ManifoldType.e_faceB,(M=S[0]).v.Copy(this.m_v1),M.id.cf.indexA=0,M.id.cf.indexB=B.index,M.id.cf.typeA=t.b2ContactFeatureType.e_vertex,M.id.cf.typeB=t.b2ContactFeatureType.e_face,(P=S[1]).v.Copy(this.m_v2),P.id.cf.indexA=0,P.id.cf.indexB=B.index,P.id.cf.typeA=t.b2ContactFeatureType.e_vertex,P.id.cf.typeB=t.b2ContactFeatureType.e_face,A.i1=B.index,A.i2=(A.i1+1)%this.m_polygonB.count,A.v1.Copy(this.m_polygonB.vertices[A.i1]),A.v2.Copy(this.m_polygonB.vertices[A.i2]),A.normal.Copy(this.m_polygonB.normals[A.i1])}A.sideNormal1.Set(A.normal.y,-A.normal.x),A.sideNormal2.Copy(A.sideNormal1).SelfNeg(),A.sideOffset1=N.DotVV(A.sideNormal1,A.v1),A.sideOffset2=N.DotVV(A.sideNormal2,A.v2);var I=e.s_clipPoints1,G=e.s_clipPoints2;if(!(Jt(I,S,A.sideNormal1,A.sideOffset1,A.i1)<2||Jt(G,I,A.sideNormal2,A.sideOffset2,A.i2)<2)){1===B.type?(i.localNormal.Copy(A.normal),i.localPoint.Copy(A.v1)):(i.localNormal.Copy(r.m_normals[A.i1]),i.localPoint.Copy(r.m_vertices[A.i1]));var D=0;for(y=0;y<2;++y)if(N.DotVV(A.normal,N.SubVV(G[y].v,A.v1,N.s_t0))<=this.m_radius){var F=i.points[D];1===B.type?(W.MulTXV(this.m_xf,G[y].v,F.localPoint),F.id=G[y].id):(F.localPoint.Copy(G[y].v),F.id.cf.typeA=G[y].id.cf.typeB,F.id.cf.typeB=G[y].id.cf.typeA,F.id.cf.indexA=G[y].id.cf.indexB,F.id.cf.indexB=G[y].id.cf.indexA),++D}i.pointCount=D}}}},e.prototype.ComputeEdgeSeparation=function(t){var e=t;e.type=1,e.index=this.m_front?0:1,e.separation=i;for(var o=0;o<this.m_polygonB.count;++o){var s=N.DotVV(this.m_normal,N.SubVV(this.m_polygonB.vertices[o],this.m_v1,N.s_t0));s<e.separation&&(e.separation=s)}return e},e.prototype.ComputePolygonSeparation=function(t){var o=t;o.type=0,o.index=-1,o.separation=-i;for(var s=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),r=0;r<this.m_polygonB.count;++r){var n=N.NegV(this.m_polygonB.normals[r],e.s_n),a=N.DotVV(n,N.SubVV(this.m_polygonB.vertices[r],this.m_v1,N.s_t0)),_=N.DotVV(n,N.SubVV(this.m_polygonB.vertices[r],this.m_v2,N.s_t0)),h=M(a,_);if(h>this.m_radius)return o.type=2,o.index=r,o.separation=h,o;if(N.DotVV(n,s)>=0){if(N.DotVV(N.SubVV(n,this.m_upperLimit,N.s_t0),this.m_normal)<-m)continue}else if(N.DotVV(N.SubVV(n,this.m_lowerLimit,N.s_t0),this.m_normal)<-m)continue;h>o.separation&&(o.type=2,o.index=r,o.separation=h)}return o},e.s_edge1=new N,e.s_edge0=new N,e.s_edge2=new N,e.s_ie=Rt.MakeArray(2),e.s_rf=new ai,e.s_clipPoints1=Rt.MakeArray(2),e.s_clipPoints2=Rt.MakeArray(2),e.s_edgeAxis=new ri,e.s_polygonAxis=new ri,e.s_n=new N,e.s_perp=new N,e}());function _i(t,e,i,o,s){mi.Collide(t,e,i,o,s)}var hi,li=function(){this.mass=0,this.center=new N(0,0),this.I=0};(hi=t.b2ShapeType||(t.b2ShapeType={}))[hi.e_unknown=-1]="e_unknown",hi[hi.e_circleShape=0]="e_circleShape",hi[hi.e_edgeShape=1]="e_edgeShape",hi[hi.e_polygonShape=2]="e_polygonShape",hi[hi.e_chainShape=3]="e_chainShape",hi[hi.e_shapeTypeCount=4]="e_shapeTypeCount";var ui=function(){function e(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}return e.prototype.Copy=function(t){return this.m_radius=t.m_radius,this},e.prototype.GetType=function(){return this.m_type},e}(),ci=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};
/*! *****************************************************************************
            Copyright (c) Microsoft Corporation. All rights reserved.
            Licensed under the Apache License, Version 2.0 (the "License"); you may not use
            this file except in compliance with the License. You may obtain a copy of the
            License at http://www.apache.org/licenses/LICENSE-2.0
             THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
            KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
            WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
            MERCHANTABLITY OR NON-INFRINGEMENT.
             See the Apache Version 2.0 License for specific language governing permissions
            and limitations under the License.
            ***************************************************************************** */function pi(t,e){function i(){this.constructor=t}ci(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var fi,di=function(e){function i(i){void 0===i&&(i=0);var o=e.call(this,t.b2ShapeType.e_circleShape,i)||this;return o.m_p=new N,o}return pi(i,e),i.prototype.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},i.prototype.Clone=function(){return(new i).Copy(this)},i.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},i.prototype.GetChildCount=function(){return 1},i.prototype.TestPoint=function(t,e){var o=W.MulXV(t,this.m_p,i.TestPoint_s_center),s=N.SubVV(e,o,i.TestPoint_s_d);return N.DotVV(s,s)<=D(this.m_radius)},i.prototype.ComputeDistance=function(t,e,o,s){var r=W.MulXV(t,this.m_p,i.ComputeDistance_s_center);return N.SubVV(e,r,o),o.Normalize()-this.m_radius},i.prototype.RayCast=function(t,e,s,r){var n=W.MulXV(s,this.m_p,i.RayCast_s_position),a=N.SubVV(e.p1,n,i.RayCast_s_s),m=N.DotVV(a,a)-D(this.m_radius),_=N.SubVV(e.p2,e.p1,i.RayCast_s_r),h=N.DotVV(a,_),l=N.DotVV(_,_),u=h*h-l*m;if(u<0||l<o)return!1;var c=-(h+L(u));return 0<=c&&c<=e.maxFraction*l&&(c/=l,t.fraction=c,N.AddVMulSV(a,c,_,t.normal).SelfNormalize(),!0)},i.prototype.ComputeAABB=function(t,e,o){var s=W.MulXV(e,this.m_p,i.ComputeAABB_s_p);t.lowerBound.Set(s.x-this.m_radius,s.y-this.m_radius),t.upperBound.Set(s.x+this.m_radius,s.y+this.m_radius)},i.prototype.ComputeMass=function(t,e){var i=D(this.m_radius);t.mass=e*r*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+N.DotVV(this.m_p,this.m_p))},i.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},i.prototype.ComputeSubmergedArea=function(t,e,i,s){var n=W.MulXV(i,this.m_p,new N),a=-(N.DotVV(t,n)-e);if(a<-this.m_radius+o)return 0;if(a>this.m_radius)return s.Copy(n),r*this.m_radius*this.m_radius;var m=this.m_radius*this.m_radius,_=a*a,h=m*(E(a/this.m_radius)+r/2)+a*L(m-_),l=-2/3*R(m-_,1.5)/h;return s.x=n.x+t.x*l,s.y=n.y+t.y*l,h},i.prototype.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},i.TestPoint_s_center=new N,i.TestPoint_s_d=new N,i.ComputeDistance_s_center=new N,i.RayCast_s_position=new N,i.RayCast_s_s=new N,i.RayCast_s_r=new N,i.ComputeAABB_s_p=new N,i}(ui),yi=function(e){function o(){var i=e.call(this,t.b2ShapeType.e_polygonShape,_)||this;return i.m_centroid=new N(0,0),i.m_vertices=[],i.m_normals=[],i.m_count=0,i}return pi(o,e),o.prototype.Clone=function(){return(new o).Copy(this)},o.prototype.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=N.MakeArray(this.m_count),this.m_normals=N.MakeArray(this.m_count);for(var i=0;i<this.m_count;++i)this.m_vertices[i].Copy(t.m_vertices[i]),this.m_normals[i].Copy(t.m_normals[i]);return this},o.prototype.GetChildCount=function(){return 1},o.prototype.Set=function(t,e,i){if(void 0===e&&(e=t.length),void 0===i&&(i=0),e<3)return this.SetAsBox(1,1);for(var s=M(e,8),r=o.Set_s_ps,n=0,a=0;a<s;++a){for(var m=t[i+a],_=!0,h=0;h<n;++h)if(N.DistanceSquaredVV(m,r[h])<16e-6){_=!1;break}_&&r[n++].Copy(m)}if((s=n)<3)return this.SetAsBox(1,1);var l=0,u=r[0].x;for(a=1;a<s;++a){var c=r[a].x;(c>u||c===u&&r[a].y<r[l].y)&&(l=a,u=c)}for(var p=o.Set_s_hull,f=0,d=l;;){p[f]=d;var y=0;for(h=1;h<s;++h)if(y!==d){var v=N.SubVV(r[y],r[p[f]],o.Set_s_r),x=(m=N.SubVV(r[h],r[p[f]],o.Set_s_v),N.CrossVV(v,m));x<0&&(y=h),0===x&&m.LengthSquared()>v.LengthSquared()&&(y=h)}else y=h;if(++f,d=y,y===l)break}for(this.m_count=f,this.m_vertices=N.MakeArray(this.m_count),this.m_normals=N.MakeArray(this.m_count),a=0;a<f;++a)this.m_vertices[a].Copy(r[p[a]]);for(a=0;a<f;++a){var B=this.m_vertices[a],S=this.m_vertices[(a+1)%f],A=N.SubVV(S,B,N.s_t0);N.CrossVOne(A,this.m_normals[a]).SelfNormalize()}return o.ComputeCentroid(this.m_vertices,f,this.m_centroid),this},o.prototype.SetAsArray=function(t,e){return void 0===e&&(e=t.length),this.Set(t,e)},o.prototype.SetAsBox=function(t,e,i,o){if(void 0===o&&(o=0),this.m_count=4,this.m_vertices=N.MakeArray(this.m_count),this.m_normals=N.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);var s=new W;s.SetPosition(i),s.SetRotationAngle(o);for(var r=0;r<this.m_count;++r)W.MulXV(s,this.m_vertices[r],this.m_vertices[r]),Z.MulRV(s.q,this.m_normals[r],this.m_normals[r])}return this},o.prototype.TestPoint=function(t,e){for(var i=W.MulTXV(t,e,o.TestPoint_s_pLocal),s=0;s<this.m_count;++s)if(N.DotVV(this.m_normals[s],N.SubVV(i,this.m_vertices[s],N.s_t0))>0)return!1;return!0},o.prototype.ComputeDistance=function(t,e,s,r){for(var n=W.MulTXV(t,e,o.ComputeDistance_s_pLocal),a=-i,m=o.ComputeDistance_s_normalForMaxDistance.Copy(n),_=0;_<this.m_count;++_){var h=N.DotVV(this.m_normals[_],N.SubVV(n,this.m_vertices[_],N.s_t0));h>a&&(a=h,m.Copy(this.m_normals[_]))}if(a>0){var l=o.ComputeDistance_s_minDistance.Copy(m),u=a*a;for(_=0;_<this.m_count;++_){var c=N.SubVV(n,this.m_vertices[_],o.ComputeDistance_s_distance),p=c.LengthSquared();u>p&&(l.Copy(c),u=p)}return Z.MulRV(t.q,l,s),s.Normalize(),Math.sqrt(u)}return Z.MulRV(t.q,m,s),a},o.prototype.RayCast=function(t,e,i,s){for(var r=W.MulTXV(i,e.p1,o.RayCast_s_p1),n=W.MulTXV(i,e.p2,o.RayCast_s_p2),a=N.SubVV(n,r,o.RayCast_s_d),m=0,_=e.maxFraction,h=-1,l=0;l<this.m_count;++l){var u=N.DotVV(this.m_normals[l],N.SubVV(this.m_vertices[l],r,N.s_t0)),c=N.DotVV(this.m_normals[l],a);if(0===c){if(u<0)return!1}else c<0&&u<m*c?(m=u/c,h=l):c>0&&u<_*c&&(_=u/c);if(_<m)return!1}return h>=0&&(t.fraction=m,Z.MulRV(i.q,this.m_normals[h],t.normal),!0)},o.prototype.ComputeAABB=function(t,e,i){for(var s=W.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(s),n=0;n<this.m_count;++n){var a=W.MulXV(e,this.m_vertices[n],o.ComputeAABB_s_v);N.MinV(a,s,s),N.MaxV(a,r,r)}var m=this.m_radius;s.SelfSubXY(m,m),r.SelfAddXY(m,m)},o.prototype.ComputeMass=function(t,e){for(var i=o.ComputeMass_s_center.SetZero(),s=0,r=0,n=o.ComputeMass_s_s.SetZero(),a=0;a<this.m_count;++a)n.SelfAdd(this.m_vertices[a]);n.SelfMul(1/this.m_count);var m=1/3;for(a=0;a<this.m_count;++a){var _=N.SubVV(this.m_vertices[a],n,o.ComputeMass_s_e1),h=N.SubVV(this.m_vertices[(a+1)%this.m_count],n,o.ComputeMass_s_e2),l=N.CrossVV(_,h),u=.5*l;s+=u,i.SelfAdd(N.MulSV(u*m,N.AddVV(_,h,N.s_t0),N.s_t1));var c=_.x,p=_.y,f=h.x,d=h.y;r+=.25*m*l*(c*c+f*c+f*f+(p*p+d*p+d*d))}t.mass=e*s,i.SelfMul(1/s),N.AddVV(i,n,t.center),t.I=e*r,t.I+=t.mass*(N.DotVV(t.center,t.center)-N.DotVV(i,i))},o.prototype.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,i=(t+1)%this.m_count,s=this.m_vertices[e],r=N.SubVV(this.m_vertices[i],s,o.Validate_s_e),n=0;n<this.m_count;++n)if(n!==e&&n!==i){var a=N.SubVV(this.m_vertices[n],s,o.Validate_s_v);if(N.CrossVV(r,a)<0)return!1}return!0},o.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},o.prototype.ComputeSubmergedArea=function(t,e,i,s){for(var r=Z.MulTRV(i.q,t,o.ComputeSubmergedArea_s_normalL),n=e-N.DotVV(t,i.p),a=o.ComputeSubmergedArea_s_depths,m=0,_=-1,h=-1,l=!1,u=0;u<this.m_count;++u){a[u]=N.DotVV(r,this.m_vertices[u])-n;var c=a[u]<-1e-5;u>0&&(c?l||(_=u-1,m++):l&&(h=u-1,m++)),l=c}switch(m){case 0:if(l){var p=o.ComputeSubmergedArea_s_md;return this.ComputeMass(p,1),W.MulXV(i,p.center,s),p.mass}return 0;case 1:-1===_?_=this.m_count-1:h=this.m_count-1}for(var f,d=(_+1)%this.m_count,y=(h+1)%this.m_count,v=(0-a[_])/(a[d]-a[_]),x=(0-a[h])/(a[y]-a[h]),B=o.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[_].x*(1-v)+this.m_vertices[d].x*v,this.m_vertices[_].y*(1-v)+this.m_vertices[d].y*v),S=o.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[y].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[y].y*x),A=0,b=o.ComputeSubmergedArea_s_center.SetZero(),C=this.m_vertices[d],V=d;V!==y;){f=(V=(V+1)%this.m_count)===y?S:this.m_vertices[V];var g=.5*((C.x-B.x)*(f.y-B.y)-(C.y-B.y)*(f.x-B.x));A+=g,b.x+=g*(B.x+C.x+f.x)/3,b.y+=g*(B.y+C.y+f.y)/3,C=f}return b.SelfMul(1/A),W.MulXV(i,b,s),A},o.prototype.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",8);for(var e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},o.ComputeCentroid=function(t,e,i){var s=i;s.SetZero();for(var r=0,n=o.ComputeCentroid_s_pRef.SetZero(),a=1/3,m=0;m<e;++m){var _=n,h=t[m],l=t[(m+1)%e],u=N.SubVV(h,_,o.ComputeCentroid_s_e1),c=N.SubVV(l,_,o.ComputeCentroid_s_e2),p=.5*N.CrossVV(u,c);r+=p,s.x+=p*a*(_.x+h.x+l.x),s.y+=p*a*(_.y+h.y+l.y)}return s.SelfMul(1/r),s},o.Set_s_ps=N.MakeArray(8),o.Set_s_hull=b(8),o.Set_s_r=new N,o.Set_s_v=new N,o.TestPoint_s_pLocal=new N,o.ComputeDistance_s_pLocal=new N,o.ComputeDistance_s_normalForMaxDistance=new N,o.ComputeDistance_s_minDistance=new N,o.ComputeDistance_s_distance=new N,o.RayCast_s_p1=new N,o.RayCast_s_p2=new N,o.RayCast_s_d=new N,o.ComputeAABB_s_v=new N,o.ComputeMass_s_center=new N,o.ComputeMass_s_s=new N,o.ComputeMass_s_e1=new N,o.ComputeMass_s_e2=new N,o.Validate_s_e=new N,o.Validate_s_v=new N,o.ComputeSubmergedArea_s_normalL=new N,o.ComputeSubmergedArea_s_depths=b(8),o.ComputeSubmergedArea_s_md=new li,o.ComputeSubmergedArea_s_intoVec=new N,o.ComputeSubmergedArea_s_outoVec=new N,o.ComputeSubmergedArea_s_center=new N,o.ComputeCentroid_s_pRef=new N,o.ComputeCentroid_s_e1=new N,o.ComputeCentroid_s_e2=new N,o}(ui),vi=function(e){function i(){var i=e.call(this,t.b2ShapeType.e_edgeShape,_)||this;return i.m_vertex1=new N,i.m_vertex2=new N,i.m_vertex0=new N,i.m_vertex3=new N,i.m_hasVertex0=!1,i.m_hasVertex3=!1,i}return pi(i,e),i.prototype.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},i.prototype.Clone=function(){return(new i).Copy(this)},i.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},i.prototype.GetChildCount=function(){return 1},i.prototype.TestPoint=function(t,e){return!1},i.prototype.ComputeDistance=function(t,e,o,s){var r=W.MulXV(t,this.m_vertex1,i.ComputeDistance_s_v1),n=W.MulXV(t,this.m_vertex2,i.ComputeDistance_s_v2),a=N.SubVV(e,r,i.ComputeDistance_s_d),m=N.SubVV(n,r,i.ComputeDistance_s_s),_=N.DotVV(a,m);if(_>0){var h=N.DotVV(m,m);_>h?N.SubVV(e,n,a):a.SelfMulSub(_/h,m)}return o.Copy(a),o.Normalize()},i.prototype.RayCast=function(t,e,o,s){var r=W.MulTXV(o,e.p1,i.RayCast_s_p1),n=W.MulTXV(o,e.p2,i.RayCast_s_p2),a=N.SubVV(n,r,i.RayCast_s_d),m=this.m_vertex1,_=this.m_vertex2,h=N.SubVV(_,m,i.RayCast_s_e),l=t.normal.Set(h.y,-h.x).SelfNormalize(),u=N.DotVV(l,N.SubVV(m,r,N.s_t0)),c=N.DotVV(l,a);if(0===c)return!1;var p=u/c;if(p<0||e.maxFraction<p)return!1;var f=N.AddVMulSV(r,p,a,i.RayCast_s_q),d=N.SubVV(_,m,i.RayCast_s_r),y=N.DotVV(d,d);if(0===y)return!1;var v=N.DotVV(N.SubVV(f,m,N.s_t0),d)/y;return!(v<0||1<v||(t.fraction=p,Z.MulRV(o.q,t.normal,t.normal),u>0&&t.normal.SelfNeg(),0))},i.prototype.ComputeAABB=function(t,e,o){var s=W.MulXV(e,this.m_vertex1,i.ComputeAABB_s_v1),r=W.MulXV(e,this.m_vertex2,i.ComputeAABB_s_v2);N.MinV(s,r,t.lowerBound),N.MaxV(s,r,t.upperBound);var n=this.m_radius;t.lowerBound.SelfSubXY(n,n),t.upperBound.SelfAddXY(n,n)},i.prototype.ComputeMass=function(t,e){t.mass=0,N.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},i.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},i.prototype.ComputeSubmergedArea=function(t,e,i,o){return o.SetZero(),0},i.prototype.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},i.ComputeDistance_s_v1=new N,i.ComputeDistance_s_v2=new N,i.ComputeDistance_s_d=new N,i.ComputeDistance_s_s=new N,i.RayCast_s_p1=new N,i.RayCast_s_p2=new N,i.RayCast_s_d=new N,i.RayCast_s_e=new N,i.RayCast_s_q=new N,i.RayCast_s_r=new N,i.ComputeAABB_s_v1=new N,i.ComputeAABB_s_v2=new N,i}(ui),xi=function(e){function i(){var i=e.call(this,t.b2ShapeType.e_chainShape,_)||this;return i.m_vertices=[],i.m_count=0,i.m_prevVertex=new N,i.m_nextVertex=new N,i.m_hasPrevVertex=!1,i.m_hasNextVertex=!1,i}return pi(i,e),i.prototype.CreateLoop=function(t,e,i){if(void 0===e&&(e=t.length),void 0===i&&(i=0),e<3)return this;this.m_count=e+1,this.m_vertices=N.MakeArray(this.m_count);for(var o=0;o<e;++o)this.m_vertices[o].Copy(t[i+o]);return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},i.prototype.CreateChain=function(t,e,i){void 0===e&&(e=t.length),void 0===i&&(i=0),this.m_count=e,this.m_vertices=N.MakeArray(e);for(var o=0;o<e;++o)this.m_vertices[o].Copy(t[i+o]);return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},i.prototype.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},i.prototype.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},i.prototype.Clone=function(){return(new i).Copy(this)},i.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.CreateChain(t.m_vertices,t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},i.prototype.GetChildCount=function(){return this.m_count-1},i.prototype.GetChildEdge=function(e,i){e.m_type=t.b2ShapeType.e_edgeShape,e.m_radius=this.m_radius,e.m_vertex1.Copy(this.m_vertices[i]),e.m_vertex2.Copy(this.m_vertices[i+1]),i>0?(e.m_vertex0.Copy(this.m_vertices[i-1]),e.m_hasVertex0=!0):(e.m_vertex0.Copy(this.m_prevVertex),e.m_hasVertex0=this.m_hasPrevVertex),i<this.m_count-2?(e.m_vertex3.Copy(this.m_vertices[i+2]),e.m_hasVertex3=!0):(e.m_vertex3.Copy(this.m_nextVertex),e.m_hasVertex3=this.m_hasNextVertex)},i.prototype.TestPoint=function(t,e){return!1},i.prototype.ComputeDistance=function(t,e,o,s){var r=i.ComputeDistance_s_edgeShape;return this.GetChildEdge(r,s),r.ComputeDistance(t,e,o,0)},i.prototype.RayCast=function(t,e,o,s){var r=i.RayCast_s_edgeShape;return r.m_vertex1.Copy(this.m_vertices[s]),r.m_vertex2.Copy(this.m_vertices[(s+1)%this.m_count]),r.RayCast(t,e,o,0)},i.prototype.ComputeAABB=function(t,e,o){var s=this.m_vertices[o],r=this.m_vertices[(o+1)%this.m_count],n=W.MulXV(e,s,i.ComputeAABB_s_v1),a=W.MulXV(e,r,i.ComputeAABB_s_v2);N.MinV(n,a,t.lowerBound),N.MaxV(n,a,t.upperBound)},i.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetZero(),t.I=0},i.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},i.prototype.ComputeSubmergedArea=function(t,e,i,o){return o.SetZero(),0},i.prototype.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",8);for(var e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},i.ComputeDistance_s_edgeShape=new vi,i.RayCast_s_edgeShape=new vi,i.ComputeAABB_s_v1=new N,i.ComputeAABB_s_v2=new N,i}(ui),Bi=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t.DEFAULT=new t,t}(),Si=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new Bi},Ai=function(t){this.aabb=new zt,this.childIndex=0,this.fixture=t},bi=function(){function t(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_proxyCount=0,this.m_filter=new Bi,this.m_isSensor=!1,this.m_userData=null,this.m_body=e,this.m_shape=t.shape.Clone()}return t.prototype.GetType=function(){return this.m_shape.GetType()},t.prototype.GetShape=function(){return this.m_shape},t.prototype.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},t.prototype.IsSensor=function(){return this.m_isSensor},t.prototype.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},t.prototype.GetFilterData=function(){return this.m_filter},t.prototype.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,i=e.GetFixtureA(),o=e.GetFixtureB();i!==this&&o!==this||e.FlagForFiltering(),t=t.next}var s=this.m_body.GetWorld();if(null!==s)for(var r=s.m_contactManager.m_broadPhase,n=0;n<this.m_proxyCount;++n)r.TouchProxy(this.m_proxies[n].treeNode)},t.prototype.GetBody=function(){return this.m_body},t.prototype.GetNext=function(){return this.m_next},t.prototype.GetUserData=function(){return this.m_userData},t.prototype.SetUserData=function(t){this.m_userData=t},t.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},t.prototype.ComputeDistance=function(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)},t.prototype.RayCast=function(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)},t.prototype.GetMassData=function(t){return void 0===t&&(t=new li),this.m_shape.ComputeMass(t,this.m_density),t},t.prototype.SetDensity=function(t){this.m_density=t},t.prototype.GetDensity=function(){return this.m_density},t.prototype.GetFriction=function(){return this.m_friction},t.prototype.SetFriction=function(t){this.m_friction=t},t.prototype.GetRestitution=function(){return this.m_restitution},t.prototype.SetRestitution=function(t){this.m_restitution=t},t.prototype.GetAABB=function(t){return this.m_proxies[t].aabb},t.prototype.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},t.prototype.Create=function(t){var i=this;this.m_userData=t.userData,this.m_friction=e(t.friction,.2),this.m_restitution=e(t.restitution,0),this.m_next=null,this.m_filter.Copy(e(t.filter,Bi.DEFAULT)),this.m_isSensor=e(t.isSensor,!1),this.m_proxies=A(this.m_shape.GetChildCount(),(function(t){return new Ai(i)})),this.m_proxyCount=0,this.m_density=e(t.density,0)},t.prototype.Destroy=function(){},t.prototype.CreateProxies=function(t){var e=this.m_body.m_world.m_contactManager.m_broadPhase;this.m_proxyCount=this.m_shape.GetChildCount();for(var i=0;i<this.m_proxyCount;++i){var o=this.m_proxies[i]=new Ai(this);this.m_shape.ComputeAABB(o.aabb,t,i),o.treeNode=e.CreateProxy(o.aabb,o),o.childIndex=i}},t.prototype.DestroyProxies=function(){for(var t=this.m_body.m_world.m_contactManager.m_broadPhase,e=0;e<this.m_proxyCount;++e){var i=this.m_proxies[e];delete i.treeNode.userData,t.DestroyProxy(i.treeNode),delete i.treeNode}this.m_proxyCount=0},t.prototype.TouchProxies=function(){for(var t=this.m_body.m_world.m_contactManager.m_broadPhase,e=this.m_proxyCount,i=0;i<e;++i)t.TouchProxy(this.m_proxies[i].treeNode)},t.prototype.Synchronize=function(e,i){if(0!==this.m_proxyCount)for(var o=this.m_body.m_world.m_contactManager.m_broadPhase,s=0;s<this.m_proxyCount;++s){var r=this.m_proxies[s],n=t.Synchronize_s_aabb1,a=t.Synchronize_s_aabb2;this.m_shape.ComputeAABB(n,e,s),this.m_shape.ComputeAABB(a,i,s),r.aabb.Combine2(n,a);var m=N.SubVV(i.p,e.p,t.Synchronize_s_displacement);o.MoveProxy(r.treeNode,r.aabb,m)}},t.Synchronize_s_aabb1=new zt,t.Synchronize_s_aabb2=new zt,t.Synchronize_s_displacement=new N,t}();(fi=t.b2BodyType||(t.b2BodyType={}))[fi.b2_unknown=-1]="b2_unknown",fi[fi.b2_staticBody=0]="b2_staticBody",fi[fi.b2_kinematicBody=1]="b2_kinematicBody",fi[fi.b2_dynamicBody=2]="b2_dynamicBody";var Ci,Vi,gi=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new N(0,0),this.angle=0,this.linearVelocity=new N(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},wi=function(){function i(i,o){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new W,this.m_xf0=new W,this.m_sweep=new H,this.m_linearVelocity=new N,this.m_angularVelocity=0,this.m_force=new N,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=e(i.bullet,!1),this.m_fixedRotationFlag=e(i.fixedRotation,!1),this.m_autoSleepFlag=e(i.allowSleep,!0),this.m_awakeFlag=e(i.awake,!0),this.m_activeFlag=e(i.active,!0),this.m_world=o,this.m_xf.p.Copy(e(i.position,N.ZERO)),this.m_xf.q.SetAngle(e(i.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(e(i.linearVelocity,N.ZERO)),this.m_angularVelocity=e(i.angularVelocity,0),this.m_linearDamping=e(i.linearDamping,0),this.m_angularDamping=e(i.angularDamping,0),this.m_gravityScale=e(i.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=e(i.type,t.b2BodyType.b2_staticBody),i.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=i.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}return i.prototype.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof ui?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},i.prototype.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new bi(t,this);return e.Create(t),this.m_activeFlag&&e.CreateProxies(this.m_xf),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},i.prototype.CreateFixtureShapeDensity=function(t,e){void 0===e&&(e=0);var o=i.CreateFixtureShapeDensity_s_def;return o.shape=t,o.density=e,this.CreateFixtureDef(o)},i.prototype.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,i=null;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var o=this.m_contactList;o;){var s=o.contact;o=o.next;var r=s.GetFixtureA(),n=s.GetFixtureB();t!==r&&t!==n||this.m_world.m_contactManager.Destroy(s)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Destroy(),--this.m_fixtureCount,this.ResetMassData()},i.prototype.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},i.prototype.SetTransformXY=function(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),W.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(var o=this.m_fixtureList;o;o=o.m_next)o.Synchronize(this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()},i.prototype.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},i.prototype.GetTransform=function(){return this.m_xf},i.prototype.GetPosition=function(){return this.m_xf.p},i.prototype.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},i.prototype.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},i.prototype.GetAngle=function(){return this.m_sweep.a},i.prototype.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},i.prototype.GetWorldCenter=function(){return this.m_sweep.c},i.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},i.prototype.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(N.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},i.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},i.prototype.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},i.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},i.prototype.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},i.prototype.ApplyForce=function(e,i,o){void 0===o&&(o=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(o&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))},i.prototype.ApplyForceToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},i.prototype.ApplyTorque=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},i.prototype.ApplyLinearImpulse=function(e,i,o){void 0===o&&(o=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(o&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))},i.prototype.ApplyLinearImpulseToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},i.prototype.ApplyAngularImpulse=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},i.prototype.GetMass=function(){return this.m_mass},i.prototype.GetInertia=function(){return this.m_I+this.m_mass*N.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.prototype.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*N.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},i.prototype.SetMassData=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*N.DotVV(e.center,e.center),this.m_invI=1/this.m_I);var o=i.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),W.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),N.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,N.SubVV(this.m_sweep.c,o,N.s_t0),this.m_linearVelocity)}},i.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var e=i.ResetMassData_s_localCenter.SetZero(),o=this.m_fixtureList;o;o=o.m_next)if(0!==o.m_density){var s=o.GetMassData(i.ResetMassData_s_massData);this.m_mass+=s.mass,e.x+=s.center.x*s.mass,e.y+=s.center.y*s.mass,this.m_I+=s.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*N.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var r=i.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),W.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),N.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,N.SubVV(this.m_sweep.c,r,N.s_t0),this.m_linearVelocity)},i.prototype.GetWorldPoint=function(t,e){return W.MulXV(this.m_xf,t,e)},i.prototype.GetWorldVector=function(t,e){return Z.MulRV(this.m_xf.q,t,e)},i.prototype.GetLocalPoint=function(t,e){return W.MulTXV(this.m_xf,t,e)},i.prototype.GetLocalVector=function(t,e){return Z.MulTRV(this.m_xf.q,t,e)},i.prototype.GetLinearVelocityFromWorldPoint=function(t,e){return N.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,N.SubVV(t,this.m_sweep.c,N.s_t0),e)},i.prototype.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},i.prototype.GetLinearDamping=function(){return this.m_linearDamping},i.prototype.SetLinearDamping=function(t){this.m_linearDamping=t},i.prototype.GetAngularDamping=function(){return this.m_angularDamping},i.prototype.SetAngularDamping=function(t){this.m_angularDamping=t},i.prototype.GetGravityScale=function(){return this.m_gravityScale},i.prototype.SetGravityScale=function(t){this.m_gravityScale=t},i.prototype.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var i=this.m_contactList;i;){var o=i;i=i.next,this.m_world.m_contactManager.Destroy(o.contact)}this.m_contactList=null;for(var s=this.m_fixtureList;s;s=s.m_next)s.TouchProxies()}},i.prototype.GetType=function(){return this.m_type},i.prototype.SetBullet=function(t){this.m_bulletFlag=t},i.prototype.IsBullet=function(){return this.m_bulletFlag},i.prototype.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},i.prototype.IsSleepingAllowed=function(){return this.m_autoSleepFlag},i.prototype.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},i.prototype.IsAwake=function(){return this.m_awakeFlag},i.prototype.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies(this.m_xf);else{for(e=this.m_fixtureList;e;e=e.m_next)e.DestroyProxies();for(var i=this.m_contactList;i;){var o=i;i=i.next,this.m_world.m_contactManager.Destroy(o.contact)}this.m_contactList=null}},i.prototype.IsActive=function(){return this.m_activeFlag},i.prototype.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},i.prototype.IsFixedRotation=function(){return this.m_fixedRotationFlag},i.prototype.GetFixtureList=function(){return this.m_fixtureList},i.prototype.GetJointList=function(){return this.m_jointList},i.prototype.GetContactList=function(){return this.m_contactList},i.prototype.GetNext=function(){return this.m_next},i.prototype.GetUserData=function(){return this.m_userData},i.prototype.SetUserData=function(t){this.m_userData=t},i.prototype.GetWorld=function(){return this.m_world},i.prototype.Dump=function(e){var i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var o="";switch(this.m_type){case t.b2BodyType.b2_staticBody:o="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:o="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:o="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",o),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var s=this.m_fixtureList;s;s=s.m_next)e("  {\n"),s.Dump(e,i),e("  }\n");e("}\n")},i.prototype.SynchronizeFixtures=function(){var t=i.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Z.MulRV(t.q,this.m_sweep.localCenter,t.p),N.SubVV(this.m_sweep.c0,t.p,t.p);for(var e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(t,this.m_xf)},i.prototype.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),Z.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),N.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.prototype.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},i.prototype.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},i.prototype.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Z.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),N.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.prototype.GetControllerList=function(){return this.m_controllerList},i.prototype.GetControllerCount=function(){return this.m_controllerCount},i.CreateFixtureShapeDensity_s_def=new Si,i.SetMassData_s_oldCenter=new N,i.ResetMassData_s_localCenter=new N,i.ResetMassData_s_oldCenter=new N,i.ResetMassData_s_massData=new li,i.SynchronizeFixtures_s_xf1=new W,i}();(Ci=t.b2JointType||(t.b2JointType={}))[Ci.e_unknownJoint=0]="e_unknownJoint",Ci[Ci.e_revoluteJoint=1]="e_revoluteJoint",Ci[Ci.e_prismaticJoint=2]="e_prismaticJoint",Ci[Ci.e_distanceJoint=3]="e_distanceJoint",Ci[Ci.e_pulleyJoint=4]="e_pulleyJoint",Ci[Ci.e_mouseJoint=5]="e_mouseJoint",Ci[Ci.e_gearJoint=6]="e_gearJoint",Ci[Ci.e_wheelJoint=7]="e_wheelJoint",Ci[Ci.e_weldJoint=8]="e_weldJoint",Ci[Ci.e_frictionJoint=9]="e_frictionJoint",Ci[Ci.e_ropeJoint=10]="e_ropeJoint",Ci[Ci.e_motorJoint=11]="e_motorJoint",Ci[Ci.e_areaJoint=12]="e_areaJoint",(Vi=t.b2LimitState||(t.b2LimitState={}))[Vi.e_inactiveLimit=0]="e_inactiveLimit",Vi[Vi.e_atLowerLimit=1]="e_atLowerLimit",Vi[Vi.e_atUpperLimit=2]="e_atUpperLimit",Vi[Vi.e_equalLimits=3]="e_equalLimits";var Mi=function(){function t(){this.linear=new N,this.angularA=0,this.angularB=0}return t.prototype.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},t.prototype.Set=function(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this},t}(),Pi=function(t,e){this.prev=null,this.next=null,this.joint=t,this.other=e},Ii=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},Gi=function(){function i(i){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=i.type,this.m_edgeA=new Pi(this,i.bodyB),this.m_edgeB=new Pi(this,i.bodyA),this.m_bodyA=i.bodyA,this.m_bodyB=i.bodyB,this.m_collideConnected=e(i.collideConnected,!1),this.m_userData=i.userData}return i.prototype.GetType=function(){return this.m_type},i.prototype.GetBodyA=function(){return this.m_bodyA},i.prototype.GetBodyB=function(){return this.m_bodyB},i.prototype.GetNext=function(){return this.m_next},i.prototype.GetUserData=function(){return this.m_userData},i.prototype.SetUserData=function(t){this.m_userData=t},i.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},i.prototype.GetCollideConnected=function(){return this.m_collideConnected},i.prototype.Dump=function(t){t("// Dump is not supported for this joint type.\n")},i.prototype.ShiftOrigin=function(t){},i}(),Di=function(e){function i(){var i=e.call(this,t.b2JointType.e_distanceJoint)||this;return i.localAnchorA=new N,i.localAnchorB=new N,i.length=1,i.frequencyHz=0,i.dampingRatio=0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.length=N.DistanceVV(i,o),this.frequencyHz=0,this.dampingRatio=0},i}(Ii),Fi=function(t){function i(i){var o=t.call(this,i)||this;return o.m_frequencyHz=0,o.m_dampingRatio=0,o.m_bias=0,o.m_localAnchorA=new N,o.m_localAnchorB=new N,o.m_gamma=0,o.m_impulse=0,o.m_length=0,o.m_indexA=0,o.m_indexB=0,o.m_u=new N,o.m_rA=new N,o.m_rB=new N,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_mass=0,o.m_qA=new Z,o.m_qB=new Z,o.m_lalcA=new N,o.m_lalcB=new N,o.m_frequencyHz=e(i.frequencyHz,0),o.m_dampingRatio=e(i.dampingRatio,0),o.m_localAnchorA.Copy(i.localAnchorA),o.m_localAnchorB.Copy(i.localAnchorB),o.m_length=i.length,o}return pi(i,t),i.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},i.prototype.GetReactionTorque=function(t){return 0},i.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},i.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},i.prototype.SetLength=function(t){this.m_length=t},i.prototype.Length=function(){return this.m_length},i.prototype.SetFrequency=function(t){this.m_frequencyHz=t},i.prototype.GetFrequency=function(){return this.m_frequencyHz},i.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},i.prototype.GetDampingRatio=function(){return this.m_dampingRatio},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,m=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(o),c=this.m_qB.SetAngle(_);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Z.MulRV(u,this.m_lalcA,this.m_rA),N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(c,this.m_lalcB,this.m_rB),this.m_u.x=m.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=m.y+this.m_rB.y-e.y-this.m_rA.y;var p=this.m_u.Length();p>a?this.m_u.SelfMul(1/p):this.m_u.SetZero();var f=N.CrossVV(this.m_rA,this.m_u),d=N.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=0!==y?1/y:0,this.m_frequencyHz>0){var v=p-this.m_length,x=2*r*this.m_frequencyHz,B=2*this.m_mass*this.m_dampingRatio*x,S=this.m_mass*x*x,A=t.step.dt;this.m_gamma=A*(B+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=v*A*S*this.m_gamma,y+=this.m_gamma,this.m_mass=0!==y?1/y:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var b=N.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,b),n-=this.m_invIA*N.CrossVV(this.m_rA,b),h.SelfMulAdd(this.m_invMassB,b),l+=this.m_invIB*N.CrossVV(this.m_rB,b)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=l},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=N.AddVCrossSV(e,o,this.m_rA,i.SolveVelocityConstraints_s_vpA),a=N.AddVCrossSV(s,r,this.m_rB,i.SolveVelocityConstraints_s_vpB),m=N.DotVV(this.m_u,N.SubVV(a,n,N.s_t0)),_=-this.m_mass*(m+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=_;var h=N.MulSV(_,this.m_u,i.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,h),o-=this.m_invIA*N.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,h),r+=this.m_invIB*N.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},i.prototype.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(o),m=this.m_qB.SetAngle(r),_=Z.MulRV(n,this.m_lalcA,this.m_rA),l=Z.MulRV(m,this.m_lalcB,this.m_rB),u=this.m_u;u.x=s.x+l.x-e.x-_.x,u.y=s.y+l.y-e.y-_.y;var c=this.m_u.Normalize()-this.m_length;c=I(c,-.2,h);var p=-this.m_mass*c,f=N.MulSV(p,u,i.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,f),o-=this.m_invIA*N.CrossVV(_,f),s.SelfMulAdd(this.m_invMassB,f),r+=this.m_invIB*N.CrossVV(l,f),t.positions[this.m_indexA].a=o,t.positions[this.m_indexB].a=r,w(c)<a},i.InitVelocityConstraints_s_P=new N,i.SolveVelocityConstraints_s_vpA=new N,i.SolveVelocityConstraints_s_vpB=new N,i.SolveVelocityConstraints_s_P=new N,i.SolvePositionConstraints_s_P=new N,i}(Gi),Ti=function(e){function i(){var i=e.call(this,t.b2JointType.e_areaJoint)||this;return i.bodies=[],i.frequencyHz=0,i.dampingRatio=0,i}return pi(i,e),i.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},i}(Ii),Li=function(t){function i(i){var o=t.call(this,i)||this;o.m_frequencyHz=0,o.m_dampingRatio=0,o.m_impulse=0,o.m_targetArea=0,o.m_bodies=i.bodies,o.m_frequencyHz=e(i.frequencyHz,0),o.m_dampingRatio=e(i.dampingRatio,0),o.m_targetLengths=b(i.bodies.length),o.m_normals=N.MakeArray(i.bodies.length),o.m_joints=[],o.m_deltas=N.MakeArray(i.bodies.length),o.m_delta=new N;var s=new Di;s.frequencyHz=o.m_frequencyHz,s.dampingRatio=o.m_dampingRatio,o.m_targetArea=0;for(var r=0;r<o.m_bodies.length;++r){var n=o.m_bodies[r],a=o.m_bodies[(r+1)%o.m_bodies.length],m=n.GetWorldCenter(),_=a.GetWorldCenter();o.m_targetLengths[r]=N.DistanceVV(m,_),o.m_targetArea+=N.CrossVV(m,_),s.Initialize(n,a,m,_),o.m_joints[r]=n.GetWorld().CreateJoint(s)}return o.m_targetArea*=.5,o}return pi(i,t),i.prototype.GetAnchorA=function(t){return t},i.prototype.GetAnchorB=function(t){return t},i.prototype.GetReactionForce=function(t,e){return e},i.prototype.GetReactionTorque=function(t){return 0},i.prototype.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},i.prototype.GetFrequency=function(){return this.m_frequencyHz},i.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},i.prototype.GetDampingRatio=function(){return this.m_dampingRatio},i.prototype.Dump=function(t){t("Area joint dumping is not supported.\n")},i.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],o=this.m_bodies[(e+1)%this.m_bodies.length],s=t.positions[i.m_islandIndex].c,r=t.positions[o.m_islandIndex].c,n=this.m_deltas[e];N.SubVV(r,s,n)}if(t.step.warmStarting)for(this.m_impulse*=t.step.dtRatio,e=0;e<this.m_bodies.length;++e){var a=this.m_bodies[e],m=t.velocities[a.m_islandIndex].v;n=this.m_deltas[e],m.x+=a.m_invMass*n.y*.5*this.m_impulse,m.y+=a.m_invMass*-n.x*.5*this.m_impulse}else this.m_impulse=0},i.prototype.SolveVelocityConstraints=function(t){for(var e=0,i=0,o=0;o<this.m_bodies.length;++o){var s=this.m_bodies[o],r=t.velocities[s.m_islandIndex].v;e+=(a=this.m_deltas[o]).LengthSquared()/s.GetMass(),i+=N.CrossVV(r,a)}var n=-2*i/e;for(this.m_impulse+=n,o=0;o<this.m_bodies.length;++o){s=this.m_bodies[o],r=t.velocities[s.m_islandIndex].v;var a=this.m_deltas[o];r.x+=s.m_invMass*a.y*.5*n,r.y+=s.m_invMass*-a.x*.5*n}},i.prototype.SolvePositionConstraints=function(t){for(var e=0,i=0,s=0;s<this.m_bodies.length;++s){var r=this.m_bodies[s],n=this.m_bodies[(s+1)%this.m_bodies.length],m=t.positions[r.m_islandIndex].c,_=t.positions[n.m_islandIndex].c,l=(p=N.SubVV(_,m,this.m_delta)).Length();l<o&&(l=1),this.m_normals[s].x=p.y/l,this.m_normals[s].y=-p.x/l,e+=l,i+=N.CrossVV(m,_)}i*=.5;var u=.5*(this.m_targetArea-i)/e,c=!0;for(s=0;s<this.m_bodies.length;++s){r=this.m_bodies[s],m=t.positions[r.m_islandIndex].c;var p,f=(s+1)%this.m_bodies.length;(p=N.AddVV(this.m_normals[s],this.m_normals[f],this.m_delta)).SelfMul(u);var d=p.LengthSquared();d>D(h)&&p.SelfMul(h/L(d)),d>D(a)&&(c=!1),m.x+=p.x,m.y+=p.y}return c},i}(Gi),Ri=function(e){function i(){var i=e.call(this,t.b2JointType.e_frictionJoint)||this;return i.localAnchorA=new N,i.localAnchorB=new N,i.maxForce=0,i.maxTorque=0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)},i}(Ii),ki=function(t){function i(i){var o=t.call(this,i)||this;return o.m_localAnchorA=new N,o.m_localAnchorB=new N,o.m_linearImpulse=new N,o.m_angularImpulse=0,o.m_maxForce=0,o.m_maxTorque=0,o.m_indexA=0,o.m_indexB=0,o.m_rA=new N,o.m_rB=new N,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_linearMass=new X,o.m_angularMass=0,o.m_qA=new Z,o.m_qB=new Z,o.m_lalcA=new N,o.m_lalcB=new N,o.m_K=new X,o.m_localAnchorA.Copy(i.localAnchorA),o.m_localAnchorB.Copy(i.localAnchorB),o.m_linearImpulse.SetZero(),o.m_maxForce=e(i.maxForce,0),o.m_maxTorque=e(i.maxTorque,0),o.m_linearMass.SetZero(),o}return pi(i,t),i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,a=this.m_qA.SetAngle(e),m=this.m_qB.SetAngle(s);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var _=Z.MulRV(a,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Z.MulRV(m,this.m_lalcB,this.m_rB),l=this.m_invMassA,u=this.m_invMassB,c=this.m_invIA,p=this.m_invIB,f=this.m_K;if(f.ex.x=l+u+c*_.y*_.y+p*h.y*h.y,f.ex.y=-c*_.x*_.y-p*h.x*h.y,f.ey.x=f.ex.y,f.ey.y=l+u+c*_.x*_.x+p*h.x*h.x,f.GetInverse(this.m_linearMass),this.m_angularMass=c+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var d=this.m_linearImpulse;i.SelfMulSub(l,d),o-=c*(N.CrossVV(this.m_rA,d)+this.m_angularImpulse),r.SelfMulAdd(u,d),n+=p*(N.CrossVV(this.m_rB,d)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=n},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=this.m_invMassA,a=this.m_invMassB,m=this.m_invIA,_=this.m_invIB,h=t.step.dt,l=r-o,u=-this.m_angularMass*l,c=this.m_angularImpulse,p=h*this.m_maxTorque;this.m_angularImpulse=I(this.m_angularImpulse+u,-p,p),o-=m*(u=this.m_angularImpulse-c),r+=_*u;var f=N.SubVV(N.AddVCrossSV(s,r,this.m_rB,N.s_t0),N.AddVCrossSV(e,o,this.m_rA,N.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),d=X.MulMV(this.m_linearMass,f,i.SolveVelocityConstraints_s_impulseV).SelfNeg(),y=i.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(d),p=h*this.m_maxForce,this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),N.SubVV(this.m_linearImpulse,y,d),e.SelfMulSub(n,d),o-=m*N.CrossVV(this.m_rA,d),s.SelfMulAdd(a,d),r+=_*N.CrossVV(this.m_rB,d),t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},i.prototype.SolvePositionConstraints=function(t){return!0},i.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},i.prototype.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},i.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},i.prototype.SetMaxForce=function(t){this.m_maxForce=t},i.prototype.GetMaxForce=function(){return this.m_maxForce},i.prototype.SetMaxTorque=function(t){this.m_maxTorque=t},i.prototype.GetMaxTorque=function(){return this.m_maxTorque},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.SolveVelocityConstraints_s_Cdot_v2=new N,i.SolveVelocityConstraints_s_impulseV=new N,i.SolveVelocityConstraints_s_oldImpulseV=new N,i}(Gi),qi=function(e){function i(){var i=e.call(this,t.b2JointType.e_gearJoint)||this;return i.ratio=1,i}return pi(i,e),i}(Ii),zi=function(i){function o(o){var s,r,n=i.call(this,o)||this;n.m_typeA=t.b2JointType.e_unknownJoint,n.m_typeB=t.b2JointType.e_unknownJoint,n.m_localAnchorA=new N,n.m_localAnchorB=new N,n.m_localAnchorC=new N,n.m_localAnchorD=new N,n.m_localAxisC=new N,n.m_localAxisD=new N,n.m_referenceAngleA=0,n.m_referenceAngleB=0,n.m_constant=0,n.m_ratio=0,n.m_impulse=0,n.m_indexA=0,n.m_indexB=0,n.m_indexC=0,n.m_indexD=0,n.m_lcA=new N,n.m_lcB=new N,n.m_lcC=new N,n.m_lcD=new N,n.m_mA=0,n.m_mB=0,n.m_mC=0,n.m_mD=0,n.m_iA=0,n.m_iB=0,n.m_iC=0,n.m_iD=0,n.m_JvAC=new N,n.m_JvBD=new N,n.m_JwA=0,n.m_JwB=0,n.m_JwC=0,n.m_JwD=0,n.m_mass=0,n.m_qA=new Z,n.m_qB=new Z,n.m_qC=new Z,n.m_qD=new Z,n.m_lalcA=new N,n.m_lalcB=new N,n.m_lalcC=new N,n.m_lalcD=new N,n.m_joint1=o.joint1,n.m_joint2=o.joint2,n.m_typeA=n.m_joint1.GetType(),n.m_typeB=n.m_joint2.GetType(),n.m_bodyC=n.m_joint1.GetBodyA(),n.m_bodyA=n.m_joint1.GetBodyB();var a=n.m_bodyA.m_xf,m=n.m_bodyA.m_sweep.a,_=n.m_bodyC.m_xf,h=n.m_bodyC.m_sweep.a;if(n.m_typeA===t.b2JointType.e_revoluteJoint){var l=o.joint1;n.m_localAnchorC.Copy(l.m_localAnchorA),n.m_localAnchorA.Copy(l.m_localAnchorB),n.m_referenceAngleA=l.m_referenceAngle,n.m_localAxisC.SetZero(),s=m-h-n.m_referenceAngleA}else{var u=o.joint1;n.m_localAnchorC.Copy(u.m_localAnchorA),n.m_localAnchorA.Copy(u.m_localAnchorB),n.m_referenceAngleA=u.m_referenceAngle,n.m_localAxisC.Copy(u.m_localXAxisA);var c=n.m_localAnchorC,p=Z.MulTRV(_.q,N.AddVV(Z.MulRV(a.q,n.m_localAnchorA,N.s_t0),N.SubVV(a.p,_.p,N.s_t1),N.s_t0),N.s_t0);s=N.DotVV(N.SubVV(p,c,N.s_t0),n.m_localAxisC)}n.m_bodyD=n.m_joint2.GetBodyA(),n.m_bodyB=n.m_joint2.GetBodyB();var f=n.m_bodyB.m_xf,d=n.m_bodyB.m_sweep.a,y=n.m_bodyD.m_xf,v=n.m_bodyD.m_sweep.a;if(n.m_typeB===t.b2JointType.e_revoluteJoint)l=o.joint2,n.m_localAnchorD.Copy(l.m_localAnchorA),n.m_localAnchorB.Copy(l.m_localAnchorB),n.m_referenceAngleB=l.m_referenceAngle,n.m_localAxisD.SetZero(),r=d-v-n.m_referenceAngleB;else{u=o.joint2,n.m_localAnchorD.Copy(u.m_localAnchorA),n.m_localAnchorB.Copy(u.m_localAnchorB),n.m_referenceAngleB=u.m_referenceAngle,n.m_localAxisD.Copy(u.m_localXAxisA);var x=n.m_localAnchorD,B=Z.MulTRV(y.q,N.AddVV(Z.MulRV(f.q,n.m_localAnchorB,N.s_t0),N.SubVV(f.p,y.p,N.s_t1),N.s_t0),N.s_t0);r=N.DotVV(N.SubVV(B,x,N.s_t0),n.m_localAxisD)}return n.m_ratio=e(o.ratio,1),n.m_constant=s+n.m_ratio*r,n.m_impulse=0,n}return pi(o,i),o.prototype.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var i=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,n=e.positions[this.m_indexB].a,a=e.velocities[this.m_indexB].v,m=e.velocities[this.m_indexB].w,_=e.positions[this.m_indexC].a,h=e.velocities[this.m_indexC].v,l=e.velocities[this.m_indexC].w,u=e.positions[this.m_indexD].a,c=e.velocities[this.m_indexD].v,p=e.velocities[this.m_indexD].w,f=this.m_qA.SetAngle(i),d=this.m_qB.SetAngle(n),y=this.m_qC.SetAngle(_),v=this.m_qD.SetAngle(u);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var x=Z.MulRV(y,this.m_localAxisC,o.InitVelocityConstraints_s_u);N.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var B=Z.MulRV(y,this.m_lalcC,o.InitVelocityConstraints_s_rC);N.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=Z.MulRV(f,this.m_lalcA,o.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(x),this.m_JwC=N.CrossVV(B,x),this.m_JwA=N.CrossVV(S,x),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{x=Z.MulRV(v,this.m_localAxisD,o.InitVelocityConstraints_s_u),N.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var A=Z.MulRV(v,this.m_lalcD,o.InitVelocityConstraints_s_rD);N.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=Z.MulRV(d,this.m_lalcB,o.InitVelocityConstraints_s_rB);N.MulSV(this.m_ratio,x,this.m_JvBD),this.m_JwD=this.m_ratio*N.CrossVV(A,x),this.m_JwB=this.m_ratio*N.CrossVV(b,x),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(s.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),r+=this.m_iA*this.m_impulse*this.m_JwA,a.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),m+=this.m_iB*this.m_impulse*this.m_JwB,h.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),l-=this.m_iC*this.m_impulse*this.m_JwC,c.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),p-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=m,e.velocities[this.m_indexC].w=l,e.velocities[this.m_indexD].w=p},o.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,r=t.velocities[this.m_indexC].v,n=t.velocities[this.m_indexC].w,a=t.velocities[this.m_indexD].v,m=t.velocities[this.m_indexD].w,_=N.DotVV(this.m_JvAC,N.SubVV(e,r,N.s_t0))+N.DotVV(this.m_JvBD,N.SubVV(o,a,N.s_t0));_+=this.m_JwA*i-this.m_JwC*n+(this.m_JwB*s-this.m_JwD*m);var h=-this.m_mass*_;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,o.SelfMulAdd(this.m_mB*h,this.m_JvBD),s+=this.m_iB*h*this.m_JwB,r.SelfMulSub(this.m_mC*h,this.m_JvAC),n-=this.m_iC*h*this.m_JwC,a.SelfMulSub(this.m_mD*h,this.m_JvBD),m-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s,t.velocities[this.m_indexC].w=n,t.velocities[this.m_indexD].w=m},o.prototype.SolvePositionConstraints=function(e){var i,s,r,n,a,m,_=e.positions[this.m_indexA].c,h=e.positions[this.m_indexA].a,l=e.positions[this.m_indexB].c,u=e.positions[this.m_indexB].a,c=e.positions[this.m_indexC].c,p=e.positions[this.m_indexC].a,f=e.positions[this.m_indexD].c,d=e.positions[this.m_indexD].a,y=this.m_qA.SetAngle(h),v=this.m_qB.SetAngle(u),x=this.m_qC.SetAngle(p),B=this.m_qD.SetAngle(d),S=this.m_JvAC,A=this.m_JvBD,b=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)S.SetZero(),r=1,a=1,b+=this.m_iA+this.m_iC,i=h-p-this.m_referenceAngleA;else{var C=Z.MulRV(x,this.m_localAxisC,o.SolvePositionConstraints_s_u),V=Z.MulRV(x,this.m_lalcC,o.SolvePositionConstraints_s_rC),g=Z.MulRV(y,this.m_lalcA,o.SolvePositionConstraints_s_rA);S.Copy(C),a=N.CrossVV(V,C),r=N.CrossVV(g,C),b+=this.m_mC+this.m_mA+this.m_iC*a*a+this.m_iA*r*r;var w=this.m_lalcC,M=Z.MulTRV(x,N.AddVV(g,N.SubVV(_,c,N.s_t0),N.s_t0),N.s_t0);i=N.DotVV(N.SubVV(M,w,N.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)A.SetZero(),n=this.m_ratio,m=this.m_ratio,b+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),s=u-d-this.m_referenceAngleB;else{C=Z.MulRV(B,this.m_localAxisD,o.SolvePositionConstraints_s_u);var P=Z.MulRV(B,this.m_lalcD,o.SolvePositionConstraints_s_rD),I=Z.MulRV(v,this.m_lalcB,o.SolvePositionConstraints_s_rB);N.MulSV(this.m_ratio,C,A),m=this.m_ratio*N.CrossVV(P,C),n=this.m_ratio*N.CrossVV(I,C),b+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*m*m+this.m_iB*n*n;var G=this.m_lalcD,D=Z.MulTRV(B,N.AddVV(I,N.SubVV(l,f,N.s_t0),N.s_t0),N.s_t0);s=N.DotVV(N.SubVV(D,G,N.s_t0),this.m_localAxisD)}var F=i+this.m_ratio*s-this.m_constant,T=0;return b>0&&(T=-F/b),_.SelfMulAdd(this.m_mA*T,S),h+=this.m_iA*T*r,l.SelfMulAdd(this.m_mB*T,A),u+=this.m_iB*T*n,c.SelfMulSub(this.m_mC*T,S),p-=this.m_iC*T*a,f.SelfMulSub(this.m_mD*T,A),d-=this.m_iD*T*m,e.positions[this.m_indexA].a=h,e.positions[this.m_indexB].a=u,e.positions[this.m_indexC].a=p,e.positions[this.m_indexD].a=d,!0},o.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},o.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},o.prototype.GetReactionForce=function(t,e){return N.MulSV(t*this.m_impulse,this.m_JvAC,e)},o.prototype.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},o.prototype.GetJoint1=function(){return this.m_joint1},o.prototype.GetJoint2=function(){return this.m_joint2},o.prototype.GetRatio=function(){return this.m_ratio},o.prototype.SetRatio=function(t){this.m_ratio=t},o.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,o=this.m_joint1.m_index,s=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",o),t("  jd.joint2 = joints[%d];\n",s),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},o.InitVelocityConstraints_s_u=new N,o.InitVelocityConstraints_s_rA=new N,o.InitVelocityConstraints_s_rB=new N,o.InitVelocityConstraints_s_rC=new N,o.InitVelocityConstraints_s_rD=new N,o.SolvePositionConstraints_s_u=new N,o.SolvePositionConstraints_s_rA=new N,o.SolvePositionConstraints_s_rB=new N,o.SolvePositionConstraints_s_rC=new N,o.SolvePositionConstraints_s_rD=new N,o}(Gi),Ei=function(e){function i(){var i=e.call(this,t.b2JointType.e_motorJoint)||this;return i.linearOffset=new N(0,0),i.angularOffset=0,i.maxForce=1,i.maxTorque=1,i.correctionFactor=.3,i}return pi(i,e),i.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),o=this.bodyB.GetAngle();this.angularOffset=o-i},i}(Ii),Ji=function(t){function i(i){var o=t.call(this,i)||this;return o.m_linearOffset=new N,o.m_angularOffset=0,o.m_linearImpulse=new N,o.m_angularImpulse=0,o.m_maxForce=0,o.m_maxTorque=0,o.m_correctionFactor=.3,o.m_indexA=0,o.m_indexB=0,o.m_rA=new N,o.m_rB=new N,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_linearError=new N,o.m_angularError=0,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_linearMass=new X,o.m_angularMass=0,o.m_qA=new Z,o.m_qB=new Z,o.m_K=new X,o.m_linearOffset.Copy(e(i.linearOffset,N.ZERO)),o.m_linearImpulse.SetZero(),o.m_maxForce=e(i.maxForce,0),o.m_maxTorque=e(i.maxTorque,0),o.m_correctionFactor=e(i.correctionFactor,.3),o}return pi(i,t),i.prototype.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},i.prototype.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},i.prototype.GetReactionForce=function(t,e){return N.MulSV(t,this.m_linearImpulse,e)},i.prototype.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.prototype.SetLinearOffset=function(t){N.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},i.prototype.GetLinearOffset=function(){return this.m_linearOffset},i.prototype.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},i.prototype.GetAngularOffset=function(){return this.m_angularOffset},i.prototype.SetMaxForce=function(t){this.m_maxForce=t},i.prototype.GetMaxForce=function(){return this.m_maxForce},i.prototype.SetMaxTorque=function(t){this.m_maxTorque=t},i.prototype.GetMaxTorque=function(){return this.m_maxTorque},i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(n),l=Z.MulRV(_,N.SubVV(this.m_linearOffset,this.m_localCenterA,N.s_t0),this.m_rA),u=Z.MulRV(h,N.NegV(this.m_localCenterB,N.s_t0),this.m_rB),c=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,y=this.m_K;if(y.ex.x=c+p+f*l.y*l.y+d*u.y*u.y,y.ex.y=-f*l.x*l.y-d*u.x*u.y,y.ey.x=y.ex.y,y.ey.y=c+p+f*l.x*l.x+d*u.x*u.x,y.GetInverse(this.m_linearMass),this.m_angularMass=f+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),N.SubVV(N.AddVV(r,u,N.s_t0),N.AddVV(e,l,N.s_t1),this.m_linearError),this.m_angularError=n-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var v=this.m_linearImpulse;o.SelfMulSub(c,v),s-=f*(N.CrossVV(l,v)+this.m_angularImpulse),a.SelfMulAdd(p,v),m+=d*(N.CrossVV(u,v)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=m},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=this.m_invMassA,a=this.m_invMassB,m=this.m_invIA,_=this.m_invIB,h=t.step.dt,l=t.step.inv_dt,u=r-o+l*this.m_correctionFactor*this.m_angularError,c=-this.m_angularMass*u,p=this.m_angularImpulse,f=h*this.m_maxTorque;this.m_angularImpulse=I(this.m_angularImpulse+c,-f,f),o-=m*(c=this.m_angularImpulse-p),r+=_*c;var d=this.m_rA,y=this.m_rB,v=N.AddVV(N.SubVV(N.AddVV(s,N.CrossSV(r,y,N.s_t0),N.s_t0),N.AddVV(e,N.CrossSV(o,d,N.s_t1),N.s_t1),N.s_t2),N.MulSV(l*this.m_correctionFactor,this.m_linearError,N.s_t3),i.SolveVelocityConstraints_s_Cdot_v2),x=X.MulMV(this.m_linearMass,v,i.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),B=i.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(x),f=h*this.m_maxForce,this.m_linearImpulse.LengthSquared()>f*f&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(f)),N.SubVV(this.m_linearImpulse,B,x),e.SelfMulSub(n,x),o-=m*N.CrossVV(d,x),s.SelfMulAdd(a,x),r+=_*N.CrossVV(y,x),t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},i.prototype.SolvePositionConstraints=function(t){return!0},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.SolveVelocityConstraints_s_Cdot_v2=new N,i.SolveVelocityConstraints_s_impulse_v2=new N,i.SolveVelocityConstraints_s_oldImpulse_v2=new N,i}(Gi),Ni=function(e){function i(){var i=e.call(this,t.b2JointType.e_mouseJoint)||this;return i.target=new N,i.maxForce=0,i.frequencyHz=5,i.dampingRatio=.7,i}return pi(i,e),i}(Ii),ji=function(t){function i(i){var o=t.call(this,i)||this;return o.m_localAnchorB=new N,o.m_targetA=new N,o.m_frequencyHz=0,o.m_dampingRatio=0,o.m_beta=0,o.m_impulse=new N,o.m_maxForce=0,o.m_gamma=0,o.m_indexA=0,o.m_indexB=0,o.m_rB=new N,o.m_localCenterB=new N,o.m_invMassB=0,o.m_invIB=0,o.m_mass=new X,o.m_C=new N,o.m_qB=new Z,o.m_lalcB=new N,o.m_K=new X,o.m_targetA.Copy(e(i.target,N.ZERO)),W.MulTXV(o.m_bodyB.GetTransform(),o.m_targetA,o.m_localAnchorB),o.m_maxForce=e(i.maxForce,0),o.m_impulse.SetZero(),o.m_frequencyHz=e(i.frequencyHz,0),o.m_dampingRatio=e(i.dampingRatio,0),o.m_beta=0,o.m_gamma=0,o}return pi(i,t),i.prototype.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},i.prototype.GetTarget=function(){return this.m_targetA},i.prototype.SetMaxForce=function(t){this.m_maxForce=t},i.prototype.GetMaxForce=function(){return this.m_maxForce},i.prototype.SetFrequency=function(t){this.m_frequencyHz=t},i.prototype.GetFrequency=function(){return this.m_frequencyHz},i.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},i.prototype.GetDampingRatio=function(){return this.m_dampingRatio},i.prototype.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,n=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),m=2*r*this.m_frequencyHz,_=2*a*this.m_dampingRatio*m,h=a*(m*m),l=t.step.dt;this.m_gamma=l*(_+l*h),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=l*h*this.m_gamma,N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(n,this.m_lalcB,this.m_rB);var u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),s*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),o.x+=this.m_invMassB*this.m_impulse.x,o.y+=this.m_invMassB*this.m_impulse.y,s+=this.m_invIB*N.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=s},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,s=N.AddVCrossSV(e,o,this.m_rB,i.SolveVelocityConstraints_s_Cdot),r=X.MulMV(this.m_mass,N.AddVV(s,N.AddVV(this.m_C,N.MulSV(this.m_gamma,this.m_impulse,N.s_t0),N.s_t0),N.s_t0).SelfNeg(),i.SolveVelocityConstraints_s_impulse),n=i.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(r);var a=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>a*a&&this.m_impulse.SelfMul(a/this.m_impulse.Length()),N.SubVV(this.m_impulse,n,r),e.SelfMulAdd(this.m_invMassB,r),o+=this.m_invIB*N.CrossVV(this.m_rB,r),t.velocities[this.m_indexB].w=o},i.prototype.SolvePositionConstraints=function(t){return!0},i.prototype.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return N.MulSV(t,this.m_impulse,e)},i.prototype.GetReactionTorque=function(t){return 0},i.prototype.Dump=function(t){t("Mouse joint dumping is not supported.\n")},i.prototype.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},i.SolveVelocityConstraints_s_Cdot=new N,i.SolveVelocityConstraints_s_impulse=new N,i.SolveVelocityConstraints_s_oldImpulse=new N,i}(Gi),Oi=function(e){function i(){var i=e.call(this,t.b2JointType.e_prismaticJoint)||this;return i.localAnchorA=new N,i.localAnchorB=new N,i.localAxisA=new N(1,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerTranslation=0,i.upperTranslation=0,i.enableMotor=!1,i.maxMotorForce=0,i.motorSpeed=0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(o,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Ii),Xi=function(i){function o(o){var s=i.call(this,o)||this;return s.m_localAnchorA=new N,s.m_localAnchorB=new N,s.m_localXAxisA=new N,s.m_localYAxisA=new N,s.m_referenceAngle=0,s.m_impulse=new O(0,0,0),s.m_motorImpulse=0,s.m_lowerTranslation=0,s.m_upperTranslation=0,s.m_maxMotorForce=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_enableMotor=!1,s.m_limitState=t.b2LimitState.e_inactiveLimit,s.m_indexA=0,s.m_indexB=0,s.m_localCenterA=new N,s.m_localCenterB=new N,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_axis=new N(0,0),s.m_perp=new N(0,0),s.m_s1=0,s.m_s2=0,s.m_a1=0,s.m_a2=0,s.m_K=new U,s.m_K3=new U,s.m_K2=new X,s.m_motorMass=0,s.m_qA=new Z,s.m_qB=new Z,s.m_lalcA=new N,s.m_lalcB=new N,s.m_rA=new N,s.m_rB=new N,s.m_localAnchorA.Copy(e(o.localAnchorA,N.ZERO)),s.m_localAnchorB.Copy(e(o.localAnchorB,N.ZERO)),s.m_localXAxisA.Copy(e(o.localAxisA,new N(1,0))).SelfNormalize(),N.CrossOneV(s.m_localXAxisA,s.m_localYAxisA),s.m_referenceAngle=e(o.referenceAngle,0),s.m_lowerTranslation=e(o.lowerTranslation,0),s.m_upperTranslation=e(o.upperTranslation,0),s.m_maxMotorForce=e(o.maxMotorForce,0),s.m_motorSpeed=e(o.motorSpeed,0),s.m_enableLimit=e(o.enableLimit,!1),s.m_enableMotor=e(o.enableMotor,!1),s}return pi(o,i),o.prototype.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,s=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].c,m=e.positions[this.m_indexB].a,_=e.velocities[this.m_indexB].v,h=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(s),u=this.m_qB.SetAngle(m);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=Z.MulRV(l,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p=Z.MulRV(u,this.m_lalcB,this.m_rB),f=N.AddVV(N.SubVV(a,i,N.s_t0),N.SubVV(p,c,N.s_t1),o.InitVelocityConstraints_s_d),d=this.m_invMassA,y=this.m_invMassB,v=this.m_invIA,x=this.m_invIB;if(Z.MulRV(l,this.m_localXAxisA,this.m_axis),this.m_a1=N.CrossVV(N.AddVV(f,c,N.s_t0),this.m_axis),this.m_a2=N.CrossVV(p,this.m_axis),this.m_motorMass=d+y+v*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Z.MulRV(l,this.m_localYAxisA,this.m_perp),this.m_s1=N.CrossVV(N.AddVV(f,c,N.s_t0),this.m_perp),this.m_s2=N.CrossVV(p,this.m_perp),this.m_K.ex.x=d+y+v*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=v*this.m_s1+x*this.m_s2,this.m_K.ex.z=v*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=v+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=v*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=d+y+v*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var B=N.DotVV(this.m_axis,f);w(this.m_upperTranslation-this.m_lowerTranslation)<.016?this.m_limitState=t.b2LimitState.e_equalLimits:B<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):B>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var S=N.AddVV(N.MulSV(this.m_impulse.x,this.m_perp,N.s_t0),N.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,N.s_t1),o.InitVelocityConstraints_s_P),A=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;r.SelfMulSub(d,S),n-=v*A,_.SelfMulAdd(y,S),h+=x*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=h},o.prototype.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,n=e.velocities[this.m_indexB].w,a=this.m_invMassA,m=this.m_invMassB,_=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var l=N.DotVV(this.m_axis,N.SubVV(r,i,N.s_t0))+this.m_a2*n-this.m_a1*s,u=this.m_motorMass*(this.m_motorSpeed-l),c=this.m_motorImpulse,p=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=I(this.m_motorImpulse+u,-p,p),u=this.m_motorImpulse-c;var f=N.MulSV(u,this.m_axis,o.SolveVelocityConstraints_s_P),d=u*this.m_a1,y=u*this.m_a2;i.SelfMulSub(a,f),s-=_*d,r.SelfMulAdd(m,f),n+=h*y}var v=N.DotVV(this.m_perp,N.SubVV(r,i,N.s_t0))+this.m_s2*n-this.m_s1*s,x=n-s;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var B=N.DotVV(this.m_axis,N.SubVV(r,i,N.s_t0))+this.m_a2*n-this.m_a1*s,S=o.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),A=this.m_K.Solve33(-v,-x,-B,o.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(A),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=P(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=M(this.m_impulse.z,0));var b=-v-(this.m_impulse.z-S.z)*this.m_K.ez.x,C=-x-(this.m_impulse.z-S.z)*this.m_K.ez.y,V=this.m_K.Solve22(b,C,o.SolveVelocityConstraints_s_f2r);V.x+=S.x,V.y+=S.y,this.m_impulse.x=V.x,this.m_impulse.y=V.y,A.x=this.m_impulse.x-S.x,A.y=this.m_impulse.y-S.y,A.z=this.m_impulse.z-S.z,f=N.AddVV(N.MulSV(A.x,this.m_perp,N.s_t0),N.MulSV(A.z,this.m_axis,N.s_t1),o.SolveVelocityConstraints_s_P),d=A.x*this.m_s1+A.y+A.z*this.m_a1,y=A.x*this.m_s2+A.y+A.z*this.m_a2,i.SelfMulSub(a,f),s-=_*d,r.SelfMulAdd(m,f),n+=h*y}else{var g=this.m_K.Solve22(-v,-x,o.SolveVelocityConstraints_s_df2);this.m_impulse.x+=g.x,this.m_impulse.y+=g.y,f=N.MulSV(g.x,this.m_perp,o.SolveVelocityConstraints_s_P),d=g.x*this.m_s1+g.y,y=g.x*this.m_s2+g.y,i.SelfMulSub(a,f),s-=_*d,r.SelfMulAdd(m,f),n+=h*y}e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=n},o.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r),l=this.m_invMassA,u=this.m_invMassB,c=this.m_invIA,p=this.m_invIB,f=Z.MulRV(n,this.m_lalcA,this.m_rA),d=Z.MulRV(_,this.m_lalcB,this.m_rB),y=N.SubVV(N.AddVV(s,d,N.s_t0),N.AddVV(e,f,N.s_t1),o.SolvePositionConstraints_s_d),v=Z.MulRV(n,this.m_localXAxisA,this.m_axis),x=N.CrossVV(N.AddVV(y,f,N.s_t0),v),B=N.CrossVV(d,v),S=Z.MulRV(n,this.m_localYAxisA,this.m_perp),A=N.CrossVV(N.AddVV(y,f,N.s_t0),S),b=N.CrossVV(d,S),C=o.SolvePositionConstraints_s_impulse,V=N.DotVV(S,y),g=r-i-this.m_referenceAngle,M=w(V),G=w(g),D=!1,F=0;if(this.m_enableLimit){var T=N.DotVV(v,y);w(this.m_upperTranslation-this.m_lowerTranslation)<.016?(F=I(T,-.2,h),M=P(M,w(T)),D=!0):T<=this.m_lowerTranslation?(F=I(T-this.m_lowerTranslation+a,-.2,0),M=P(M,this.m_lowerTranslation-T),D=!0):T>=this.m_upperTranslation&&(F=I(T-this.m_upperTranslation-a,0,h),M=P(M,T-this.m_upperTranslation),D=!0)}if(D){var L=l+u+c*A*A+p*b*b,R=c*A+p*b,k=c*A*x+p*b*B;0===(J=c+p)&&(J=1);var q=c*x+p*B,z=l+u+c*x*x+p*B*B,E=this.m_K3;E.ex.SetXYZ(L,R,k),E.ey.SetXYZ(R,J,q),E.ez.SetXYZ(k,q,z),C=E.Solve33(-V,-g,-F,C)}else{var J;L=l+u+c*A*A+p*b*b,R=c*A+p*b,0===(J=c+p)&&(J=1);var j=this.m_K2;j.ex.Set(L,R),j.ey.Set(R,J);var O=j.Solve(-V,-g,o.SolvePositionConstraints_s_impulse1);C.x=O.x,C.y=O.y,C.z=0}var X=N.AddVV(N.MulSV(C.x,S,N.s_t0),N.MulSV(C.z,v,N.s_t1),o.SolvePositionConstraints_s_P),U=C.x*A+C.y+C.z*x,W=C.x*b+C.y+C.z*B;return e.SelfMulSub(l,X),i-=c*U,s.SelfMulAdd(u,X),r+=p*W,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,M<=a&&G<=m},o.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},o.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},o.prototype.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},o.prototype.GetReactionTorque=function(t){return t*this.m_impulse.y},o.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},o.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},o.prototype.GetLocalAxisA=function(){return this.m_localXAxisA},o.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},o.prototype.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,o.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,o.GetJointTranslation_s_pB),i=N.SubVV(e,t,o.GetJointTranslation_s_d),s=this.m_bodyA.GetWorldVector(this.m_localXAxisA,o.GetJointTranslation_s_axis);return N.DotVV(i,s)},o.prototype.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;N.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=Z.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var o=Z.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=N.AddVV(t.m_sweep.c,i,N.s_t0),r=N.AddVV(e.m_sweep.c,o,N.s_t1),n=N.SubVV(r,s,N.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),m=t.m_linearVelocity,_=e.m_linearVelocity,h=t.m_angularVelocity,l=e.m_angularVelocity;return N.DotVV(n,N.CrossSV(h,a,N.s_t0))+N.DotVV(a,N.SubVV(N.AddVCrossSV(_,l,o,N.s_t0),N.AddVCrossSV(m,h,i,N.s_t1),N.s_t0))},o.prototype.IsLimitEnabled=function(){return this.m_enableLimit},o.prototype.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},o.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},o.prototype.GetUpperLimit=function(){return this.m_upperTranslation},o.prototype.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},o.prototype.IsMotorEnabled=function(){return this.m_enableMotor},o.prototype.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},o.prototype.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},o.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},o.prototype.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},o.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},o.prototype.GetMotorForce=function(t){return t*this.m_motorImpulse},o.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},o.InitVelocityConstraints_s_d=new N,o.InitVelocityConstraints_s_P=new N,o.SolveVelocityConstraints_s_P=new N,o.SolveVelocityConstraints_s_f2r=new N,o.SolveVelocityConstraints_s_f1=new O,o.SolveVelocityConstraints_s_df3=new O,o.SolveVelocityConstraints_s_df2=new N,o.SolvePositionConstraints_s_d=new N,o.SolvePositionConstraints_s_impulse=new O,o.SolvePositionConstraints_s_impulse1=new N,o.SolvePositionConstraints_s_P=new N,o.GetJointTranslation_s_pA=new N,o.GetJointTranslation_s_pB=new N,o.GetJointTranslation_s_d=new N,o.GetJointTranslation_s_axis=new N,o}(Gi),Ui=function(e){function i(){var i=e.call(this,t.b2JointType.e_pulleyJoint)||this;return i.groundAnchorA=new N(-1,1),i.groundAnchorB=new N(1,1),i.localAnchorA=new N(-1,0),i.localAnchorB=new N(1,0),i.lengthA=0,i.lengthB=0,i.ratio=1,i.collideConnected=!0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i,o,s,r,n){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(o),this.bodyA.GetLocalPoint(s,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=N.DistanceVV(s,i),this.lengthB=N.DistanceVV(r,o),this.ratio=n},i}(Ii),Zi=function(t){function i(i){var o=t.call(this,i)||this;return o.m_groundAnchorA=new N,o.m_groundAnchorB=new N,o.m_lengthA=0,o.m_lengthB=0,o.m_localAnchorA=new N,o.m_localAnchorB=new N,o.m_constant=0,o.m_ratio=0,o.m_impulse=0,o.m_indexA=0,o.m_indexB=0,o.m_uA=new N,o.m_uB=new N,o.m_rA=new N,o.m_rB=new N,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_mass=0,o.m_qA=new Z,o.m_qB=new Z,o.m_lalcA=new N,o.m_lalcB=new N,o.m_groundAnchorA.Copy(e(i.groundAnchorA,new N(-1,1))),o.m_groundAnchorB.Copy(e(i.groundAnchorB,new N(1,0))),o.m_localAnchorA.Copy(e(i.localAnchorA,new N(-1,0))),o.m_localAnchorB.Copy(e(i.localAnchorB,new N(1,0))),o.m_lengthA=e(i.lengthA,0),o.m_lengthB=e(i.lengthB,0),o.m_ratio=e(i.ratio,1),o.m_constant=e(i.lengthA,0)+o.m_ratio*e(i.lengthB,0),o.m_impulse=0,o}return pi(i,t),i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,m=t.velocities[this.m_indexB].v,_=t.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(o),l=this.m_qB.SetAngle(a);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Z.MulRV(h,this.m_lalcA,this.m_rA),N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(l,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(n).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var u=this.m_uA.Length(),c=this.m_uB.Length();u>.08?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),c>.08?this.m_uB.SelfMul(1/c):this.m_uB.SetZero();var p=N.CrossVV(this.m_rA,this.m_uA),f=N.CrossVV(this.m_rB,this.m_uB),d=this.m_invMassA+this.m_invIA*p*p,y=this.m_invMassB+this.m_invIB*f*f;if(this.m_mass=d+this.m_ratio*this.m_ratio*y,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var v=N.MulSV(-this.m_impulse,this.m_uA,i.InitVelocityConstraints_s_PA),x=N.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,i.InitVelocityConstraints_s_PB);s.SelfMulAdd(this.m_invMassA,v),r+=this.m_invIA*N.CrossVV(this.m_rA,v),m.SelfMulAdd(this.m_invMassB,x),_+=this.m_invIB*N.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=_},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=N.AddVCrossSV(e,o,this.m_rA,i.SolveVelocityConstraints_s_vpA),a=N.AddVCrossSV(s,r,this.m_rB,i.SolveVelocityConstraints_s_vpB),m=-N.DotVV(this.m_uA,n)-this.m_ratio*N.DotVV(this.m_uB,a),_=-this.m_mass*m;this.m_impulse+=_;var h=N.MulSV(-_,this.m_uA,i.SolveVelocityConstraints_s_PA),l=N.MulSV(-this.m_ratio*_,this.m_uB,i.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,h),o+=this.m_invIA*N.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,l),r+=this.m_invIB*N.CrossVV(this.m_rB,l),t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},i.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(o),m=this.m_qB.SetAngle(r);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var _=Z.MulRV(n,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Z.MulRV(m,this.m_lalcB,this.m_rB),l=this.m_uA.Copy(e).SelfAdd(_).SelfSub(this.m_groundAnchorA),u=this.m_uB.Copy(s).SelfAdd(h).SelfSub(this.m_groundAnchorB),c=l.Length(),p=u.Length();c>.08?l.SelfMul(1/c):l.SetZero(),p>.08?u.SelfMul(1/p):u.SetZero();var f=N.CrossVV(_,l),d=N.CrossVV(h,u),y=this.m_invMassA+this.m_invIA*f*f,v=this.m_invMassB+this.m_invIB*d*d,x=y+this.m_ratio*this.m_ratio*v;x>0&&(x=1/x);var B=this.m_constant-c-this.m_ratio*p,S=w(B),A=-x*B,b=N.MulSV(-A,l,i.SolvePositionConstraints_s_PA),C=N.MulSV(-this.m_ratio*A,u,i.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,b),o+=this.m_invIA*N.CrossVV(_,b),s.SelfMulAdd(this.m_invMassB,C),r+=this.m_invIB*N.CrossVV(h,C),t.positions[this.m_indexA].a=o,t.positions[this.m_indexB].a=r,S<a},i.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},i.prototype.GetReactionTorque=function(t){return 0},i.prototype.GetGroundAnchorA=function(){return this.m_groundAnchorA},i.prototype.GetGroundAnchorB=function(){return this.m_groundAnchorB},i.prototype.GetLengthA=function(){return this.m_lengthA},i.prototype.GetLengthB=function(){return this.m_lengthB},i.prototype.GetRatio=function(){return this.m_ratio},i.prototype.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return N.DistanceVV(t,e)},i.prototype.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return N.DistanceVV(t,e)},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.prototype.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},i.InitVelocityConstraints_s_PA=new N,i.InitVelocityConstraints_s_PB=new N,i.SolveVelocityConstraints_s_vpA=new N,i.SolveVelocityConstraints_s_vpB=new N,i.SolveVelocityConstraints_s_PA=new N,i.SolveVelocityConstraints_s_PB=new N,i.SolvePositionConstraints_s_PA=new N,i.SolvePositionConstraints_s_PB=new N,i.GetCurrentLengthA_s_p=new N,i.GetCurrentLengthB_s_p=new N,i}(Gi),Wi=function(e){function i(){var i=e.call(this,t.b2JointType.e_revoluteJoint)||this;return i.localAnchorA=new N(0,0),i.localAnchorB=new N(0,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerAngle=0,i.upperAngle=0,i.enableMotor=!1,i.motorSpeed=0,i.maxMotorTorque=0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Ii),Hi=function(i){function o(o){var s=i.call(this,o)||this;return s.m_localAnchorA=new N,s.m_localAnchorB=new N,s.m_impulse=new O,s.m_motorImpulse=0,s.m_enableMotor=!1,s.m_maxMotorTorque=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_referenceAngle=0,s.m_lowerAngle=0,s.m_upperAngle=0,s.m_indexA=0,s.m_indexB=0,s.m_rA=new N,s.m_rB=new N,s.m_localCenterA=new N,s.m_localCenterB=new N,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=new U,s.m_motorMass=0,s.m_limitState=t.b2LimitState.e_inactiveLimit,s.m_qA=new Z,s.m_qB=new Z,s.m_lalcA=new N,s.m_lalcB=new N,s.m_K=new X,s.m_localAnchorA.Copy(e(o.localAnchorA,N.ZERO)),s.m_localAnchorB.Copy(e(o.localAnchorB,N.ZERO)),s.m_referenceAngle=e(o.referenceAngle,0),s.m_impulse.SetZero(),s.m_motorImpulse=0,s.m_lowerAngle=e(o.lowerAngle,0),s.m_upperAngle=e(o.upperAngle,0),s.m_maxMotorTorque=e(o.maxMotorTorque,0),s.m_motorSpeed=e(o.motorSpeed,0),s.m_enableLimit=e(o.enableLimit,!1),s.m_enableMotor=e(o.enableMotor,!1),s.m_limitState=t.b2LimitState.e_inactiveLimit,s}return pi(o,i),o.prototype.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,n=e.positions[this.m_indexB].a,a=e.velocities[this.m_indexB].v,_=e.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(n);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Z.MulRV(h,this.m_lalcA,this.m_rA),N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(l,this.m_lalcB,this.m_rB);var u=this.m_invMassA,c=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,d=p+f===0;if(this.m_mass.ex.x=u+c+this.m_rA.y*this.m_rA.y*p+this.m_rB.y*this.m_rB.y*f,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*p-this.m_rB.y*this.m_rB.x*f,this.m_mass.ez.x=-this.m_rA.y*p-this.m_rB.y*f,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=u+c+this.m_rA.x*this.m_rA.x*p+this.m_rB.x*this.m_rB.x*f,this.m_mass.ez.y=this.m_rA.x*p+this.m_rB.x*f,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=p+f,this.m_motorMass=p+f,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!d||(this.m_motorImpulse=0),this.m_enableLimit&&!d){var y=n-i-this.m_referenceAngle;w(this.m_upperAngle-this.m_lowerAngle)<2*m?this.m_limitState=t.b2LimitState.e_equalLimits:y<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):y>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var v=o.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);s.SelfMulSub(u,v),r-=p*(N.CrossVV(this.m_rA,v)+this.m_motorImpulse+this.m_impulse.z),a.SelfMulAdd(c,v),_+=f*(N.CrossVV(this.m_rB,v)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=_},o.prototype.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,n=e.velocities[this.m_indexB].w,a=this.m_invMassA,m=this.m_invMassB,_=this.m_invIA,h=this.m_invIB,l=_+h===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!l){var u=n-s-this.m_motorSpeed,c=-this.m_motorMass*u,p=this.m_motorImpulse,f=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=I(this.m_motorImpulse+c,-f,f),s-=_*(c=this.m_motorImpulse-p),n+=h*c}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!l){var d=N.SubVV(N.AddVCrossSV(r,n,this.m_rB,N.s_t0),N.AddVCrossSV(i,s,this.m_rA,N.s_t1),o.SolveVelocityConstraints_s_Cdot1),y=n-s,v=this.m_mass.Solve33(d.x,d.y,y,o.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(v);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+v.z<0){var x=-d.x+this.m_impulse.z*this.m_mass.ez.x,B=-d.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(x,B,o.SolveVelocityConstraints_s_reduced_v2);v.x=S.x,v.y=S.y,v.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(v);else this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z+v.z>0?(x=-d.x+this.m_impulse.z*this.m_mass.ez.x,B=-d.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(x,B,o.SolveVelocityConstraints_s_reduced_v2),v.x=S.x,v.y=S.y,v.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0):this.m_impulse.SelfAdd(v));var A=o.SolveVelocityConstraints_s_P.Set(v.x,v.y);i.SelfMulSub(a,A),s-=_*(N.CrossVV(this.m_rA,A)+v.z),r.SelfMulAdd(m,A),n+=h*(N.CrossVV(this.m_rB,A)+v.z)}else{var b=N.SubVV(N.AddVCrossSV(r,n,this.m_rB,N.s_t0),N.AddVCrossSV(i,s,this.m_rA,N.s_t1),o.SolveVelocityConstraints_s_Cdot_v2),C=this.m_mass.Solve22(-b.x,-b.y,o.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=C.x,this.m_impulse.y+=C.y,i.SelfMulSub(a,C),s-=_*N.CrossVV(this.m_rA,C),r.SelfMulAdd(m,C),n+=h*N.CrossVV(this.m_rB,C)}e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=n},o.prototype.SolvePositionConstraints=function(e){var i,s=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,n=e.positions[this.m_indexB].c,_=e.positions[this.m_indexB].a,h=this.m_qA.SetAngle(r),u=this.m_qB.SetAngle(_),c=0,p=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!p){var f=_-r-this.m_referenceAngle,d=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var y=I(f-this.m_lowerAngle,-.13962634015955555,l);d=-this.m_motorMass*y,c=w(y)}else this.m_limitState===t.b2LimitState.e_atLowerLimit?(c=-(y=f-this.m_lowerAngle),y=I(y+m,-.13962634015955555,0),d=-this.m_motorMass*y):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(c=y=f-this.m_upperAngle,y=I(y-m,0,l),d=-this.m_motorMass*y);r-=this.m_invIA*d,_+=this.m_invIB*d}h.SetAngle(r),u.SetAngle(_),N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=Z.MulRV(h,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var x=Z.MulRV(u,this.m_lalcB,this.m_rB),B=N.SubVV(N.AddVV(n,x,N.s_t0),N.AddVV(s,v,N.s_t1),o.SolvePositionConstraints_s_C_v2);i=B.Length();var S=this.m_invMassA,A=this.m_invMassB,b=this.m_invIA,C=this.m_invIB,V=this.m_K;V.ex.x=S+A+b*v.y*v.y+C*x.y*x.y,V.ex.y=-b*v.x*v.y-C*x.x*x.y,V.ey.x=V.ex.y,V.ey.y=S+A+b*v.x*v.x+C*x.x*x.x;var g=V.Solve(B.x,B.y,o.SolvePositionConstraints_s_impulse).SelfNeg();return s.SelfMulSub(S,g),r-=b*N.CrossVV(v,g),n.SelfMulAdd(A,g),_+=C*N.CrossVV(x,g),e.positions[this.m_indexA].a=r,e.positions[this.m_indexB].a=_,i<=a&&c<=m},o.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},o.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},o.prototype.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},o.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},o.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},o.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},o.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},o.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},o.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},o.prototype.IsMotorEnabled=function(){return this.m_enableMotor},o.prototype.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},o.prototype.GetMotorTorque=function(t){return t*this.m_motorImpulse},o.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},o.prototype.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},o.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},o.prototype.IsLimitEnabled=function(){return this.m_enableLimit},o.prototype.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},o.prototype.GetLowerLimit=function(){return this.m_lowerAngle},o.prototype.GetUpperLimit=function(){return this.m_upperAngle},o.prototype.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},o.prototype.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},o.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},o.InitVelocityConstraints_s_P=new N,o.SolveVelocityConstraints_s_P=new N,o.SolveVelocityConstraints_s_Cdot_v2=new N,o.SolveVelocityConstraints_s_Cdot1=new N,o.SolveVelocityConstraints_s_impulse_v3=new O,o.SolveVelocityConstraints_s_reduced_v2=new N,o.SolveVelocityConstraints_s_impulse_v2=new N,o.SolvePositionConstraints_s_C_v2=new N,o.SolvePositionConstraints_s_impulse=new N,o}(Gi),Qi=function(e){function i(){var i=e.call(this,t.b2JointType.e_ropeJoint)||this;return i.localAnchorA=new N(-1,0),i.localAnchorB=new N(1,0),i.maxLength=0,i}return pi(i,e),i}(Ii),Yi=function(i){function o(o){var s=i.call(this,o)||this;return s.m_localAnchorA=new N,s.m_localAnchorB=new N,s.m_maxLength=0,s.m_length=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_u=new N,s.m_rA=new N,s.m_rB=new N,s.m_localCenterA=new N,s.m_localCenterB=new N,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=0,s.m_state=t.b2LimitState.e_inactiveLimit,s.m_qA=new Z,s.m_qB=new Z,s.m_lalcA=new N,s.m_lalcB=new N,s.m_localAnchorA.Copy(e(o.localAnchorA,new N(-1,0))),s.m_localAnchorB.Copy(e(o.localAnchorB,new N(1,0))),s.m_maxLength=e(o.maxLength,0),s}return pi(o,i),o.prototype.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,s=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,m=e.positions[this.m_indexB].c,_=e.positions[this.m_indexB].a,h=e.velocities[this.m_indexB].v,l=e.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(s),c=this.m_qB.SetAngle(_);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Z.MulRV(u,this.m_lalcA,this.m_rA),N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(c,this.m_lalcB,this.m_rB),this.m_u.Copy(m).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var p=this.m_length-this.m_maxLength;if(this.m_state=p>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>a))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var f=N.CrossVV(this.m_rA,this.m_u),d=N.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=0!==y?1/y:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var v=N.MulSV(this.m_impulse,this.m_u,o.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,v),n-=this.m_invIA*N.CrossVV(this.m_rA,v),h.SelfMulAdd(this.m_invMassB,v),l+=this.m_invIB*N.CrossVV(this.m_rB,v)}else this.m_impulse=0;e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=l},o.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=N.AddVCrossSV(e,i,this.m_rA,o.SolveVelocityConstraints_s_vpA),a=N.AddVCrossSV(s,r,this.m_rB,o.SolveVelocityConstraints_s_vpB),m=this.m_length-this.m_maxLength,_=N.DotVV(this.m_u,N.SubVV(a,n,N.s_t0));m<0&&(_+=t.step.inv_dt*m);var h=-this.m_mass*_,l=this.m_impulse;this.m_impulse=M(0,this.m_impulse+h),h=this.m_impulse-l;var u=N.MulSV(h,this.m_u,o.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*N.CrossVV(this.m_rA,u),s.SelfMulAdd(this.m_invMassB,u),r+=this.m_invIB*N.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r},o.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(r);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var _=Z.MulRV(n,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=Z.MulRV(m,this.m_lalcB,this.m_rB),u=this.m_u.Copy(s).SelfAdd(l).SelfSub(e).SelfSub(_),c=u.Normalize(),p=c-this.m_maxLength;p=I(p,0,h);var f=-this.m_mass*p,d=N.MulSV(f,u,o.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*N.CrossVV(_,d),s.SelfMulAdd(this.m_invMassB,d),r+=this.m_invIB*N.CrossVV(l,d),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,c-this.m_maxLength<a},o.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},o.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},o.prototype.GetReactionForce=function(t,e){return N.MulSV(t*this.m_impulse,this.m_u,e)},o.prototype.GetReactionTorque=function(t){return 0},o.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},o.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},o.prototype.SetMaxLength=function(t){this.m_maxLength=t},o.prototype.GetMaxLength=function(){return this.m_maxLength},o.prototype.GetLimitState=function(){return this.m_state},o.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},o.InitVelocityConstraints_s_P=new N,o.SolveVelocityConstraints_s_vpA=new N,o.SolveVelocityConstraints_s_vpB=new N,o.SolveVelocityConstraints_s_P=new N,o.SolvePositionConstraints_s_P=new N,o}(Gi),Ki=function(e){function i(){var i=e.call(this,t.b2JointType.e_weldJoint)||this;return i.localAnchorA=new N,i.localAnchorB=new N,i.referenceAngle=0,i.frequencyHz=0,i.dampingRatio=0,i}return pi(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Ii),$i=function(t){function i(i){var o=t.call(this,i)||this;return o.m_frequencyHz=0,o.m_dampingRatio=0,o.m_bias=0,o.m_localAnchorA=new N,o.m_localAnchorB=new N,o.m_referenceAngle=0,o.m_gamma=0,o.m_impulse=new O(0,0,0),o.m_indexA=0,o.m_indexB=0,o.m_rA=new N,o.m_rB=new N,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_mass=new U,o.m_qA=new Z,o.m_qB=new Z,o.m_lalcA=new N,o.m_lalcB=new N,o.m_K=new U,o.m_frequencyHz=e(i.frequencyHz,0),o.m_dampingRatio=e(i.dampingRatio,0),o.m_localAnchorA.Copy(e(i.localAnchorA,N.ZERO)),o.m_localAnchorB.Copy(e(i.localAnchorB,N.ZERO)),o.m_referenceAngle=e(i.referenceAngle,0),o.m_impulse.SetZero(),o}return pi(i,t),i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(n);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Z.MulRV(_,this.m_lalcA,this.m_rA),N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Z.MulRV(h,this.m_lalcB,this.m_rB);var l=this.m_invMassA,u=this.m_invMassB,c=this.m_invIA,p=this.m_invIB,f=this.m_K;if(f.ex.x=l+u+this.m_rA.y*this.m_rA.y*c+this.m_rB.y*this.m_rB.y*p,f.ey.x=-this.m_rA.y*this.m_rA.x*c-this.m_rB.y*this.m_rB.x*p,f.ez.x=-this.m_rA.y*c-this.m_rB.y*p,f.ex.y=f.ey.x,f.ey.y=l+u+this.m_rA.x*this.m_rA.x*c+this.m_rB.x*this.m_rB.x*p,f.ez.y=this.m_rA.x*c+this.m_rB.x*p,f.ex.z=f.ez.x,f.ey.z=f.ez.y,f.ez.z=c+p,this.m_frequencyHz>0){f.GetInverse22(this.m_mass);var d=c+p,y=d>0?1/d:0,v=n-e-this.m_referenceAngle,x=2*r*this.m_frequencyHz,B=2*y*this.m_dampingRatio*x,S=y*x*x,A=t.step.dt;this.m_gamma=A*(B+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=v*A*S*this.m_gamma,d+=this.m_gamma,this.m_mass.ez.z=0!==d?1/d:0}else f.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var b=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);o.SelfMulSub(l,b),s-=c*(N.CrossVV(this.m_rA,b)+this.m_impulse.z),a.SelfMulAdd(u,b),m+=p*(N.CrossVV(this.m_rB,b)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=m},i.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,n=this.m_invMassA,a=this.m_invMassB,m=this.m_invIA,_=this.m_invIB;if(this.m_frequencyHz>0){var h=r-o,l=-this.m_mass.ez.z*(h+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,o-=m*l,r+=_*l;var u=N.SubVV(N.AddVCrossSV(s,r,this.m_rB,N.s_t0),N.AddVCrossSV(e,o,this.m_rA,N.s_t1),i.SolveVelocityConstraints_s_Cdot1),c=U.MulM33XY(this.m_mass,u.x,u.y,i.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=c.x,this.m_impulse.y+=c.y;var p=c;e.SelfMulSub(n,p),o-=m*N.CrossVV(this.m_rA,p),s.SelfMulAdd(a,p),r+=_*N.CrossVV(this.m_rB,p)}else{u=N.SubVV(N.AddVCrossSV(s,r,this.m_rB,N.s_t0),N.AddVCrossSV(e,o,this.m_rA,N.s_t1),i.SolveVelocityConstraints_s_Cdot1),h=r-o;var f=U.MulM33XYZ(this.m_mass,u.x,u.y,h,i.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(f),p=i.SolveVelocityConstraints_s_P.Set(f.x,f.y),e.SelfMulSub(n,p),o-=m*(N.CrossVV(this.m_rA,p)+f.z),s.SelfMulAdd(a,p),r+=_*(N.CrossVV(this.m_rB,p)+f.z)}t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},i.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(o),_=this.m_qB.SetAngle(r),h=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,c=this.m_invIB;N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=Z.MulRV(n,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var f,d,y=Z.MulRV(_,this.m_lalcB,this.m_rB),v=this.m_K;if(v.ex.x=h+l+p.y*p.y*u+y.y*y.y*c,v.ey.x=-p.y*p.x*u-y.y*y.x*c,v.ez.x=-p.y*u-y.y*c,v.ex.y=v.ey.x,v.ey.y=h+l+p.x*p.x*u+y.x*y.x*c,v.ez.y=p.x*u+y.x*c,v.ex.z=v.ez.x,v.ey.z=v.ez.y,v.ez.z=u+c,this.m_frequencyHz>0){f=(B=N.SubVV(N.AddVV(s,y,N.s_t0),N.AddVV(e,p,N.s_t1),i.SolvePositionConstraints_s_C1)).Length(),d=0;var x=v.Solve22(B.x,B.y,i.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(h,x),o-=u*N.CrossVV(p,x),s.SelfMulAdd(l,x),r+=c*N.CrossVV(y,x)}else{var B=N.SubVV(N.AddVV(s,y,N.s_t0),N.AddVV(e,p,N.s_t1),i.SolvePositionConstraints_s_C1),S=r-o-this.m_referenceAngle;f=B.Length(),d=w(S);var A=v.Solve33(B.x,B.y,S,i.SolvePositionConstraints_s_impulse).SelfNeg();x=i.SolvePositionConstraints_s_P.Set(A.x,A.y),e.SelfMulSub(h,x),o-=u*(N.CrossVV(this.m_rA,x)+A.z),s.SelfMulAdd(l,x),r+=c*(N.CrossVV(this.m_rB,x)+A.z)}return t.positions[this.m_indexA].a=o,t.positions[this.m_indexB].a=r,f<=a&&d<=m},i.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},i.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},i.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},i.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},i.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},i.prototype.SetFrequency=function(t){this.m_frequencyHz=t},i.prototype.GetFrequency=function(){return this.m_frequencyHz},i.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},i.prototype.GetDampingRatio=function(){return this.m_dampingRatio},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints_s_P=new N,i.SolveVelocityConstraints_s_Cdot1=new N,i.SolveVelocityConstraints_s_impulse1=new N,i.SolveVelocityConstraints_s_impulse=new O,i.SolveVelocityConstraints_s_P=new N,i.SolvePositionConstraints_s_C1=new N,i.SolvePositionConstraints_s_P=new N,i.SolvePositionConstraints_s_impulse=new O,i}(Gi),to=function(e){function i(){var i=e.call(this,t.b2JointType.e_wheelJoint)||this;return i.localAnchorA=new N(0,0),i.localAnchorB=new N(0,0),i.localAxisA=new N(1,0),i.enableMotor=!1,i.maxMotorTorque=0,i.motorSpeed=0,i.frequencyHz=2,i.dampingRatio=.7,i}return pi(i,e),i.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(o,this.localAxisA)},i}(Ii),eo=function(t){function i(i){var o=t.call(this,i)||this;return o.m_frequencyHz=0,o.m_dampingRatio=0,o.m_localAnchorA=new N,o.m_localAnchorB=new N,o.m_localXAxisA=new N,o.m_localYAxisA=new N,o.m_impulse=0,o.m_motorImpulse=0,o.m_springImpulse=0,o.m_maxMotorTorque=0,o.m_motorSpeed=0,o.m_enableMotor=!1,o.m_indexA=0,o.m_indexB=0,o.m_localCenterA=new N,o.m_localCenterB=new N,o.m_invMassA=0,o.m_invMassB=0,o.m_invIA=0,o.m_invIB=0,o.m_ax=new N,o.m_ay=new N,o.m_sAx=0,o.m_sBx=0,o.m_sAy=0,o.m_sBy=0,o.m_mass=0,o.m_motorMass=0,o.m_springMass=0,o.m_bias=0,o.m_gamma=0,o.m_qA=new Z,o.m_qB=new Z,o.m_lalcA=new N,o.m_lalcB=new N,o.m_rA=new N,o.m_rB=new N,o.m_frequencyHz=e(i.frequencyHz,2),o.m_dampingRatio=e(i.dampingRatio,.7),o.m_localAnchorA.Copy(e(i.localAnchorA,N.ZERO)),o.m_localAnchorB.Copy(e(i.localAnchorB,N.ZERO)),o.m_localXAxisA.Copy(e(i.localAxisA,N.UNITX)),N.CrossOneV(o.m_localXAxisA,o.m_localYAxisA),o.m_maxMotorTorque=e(i.maxMotorTorque,0),o.m_motorSpeed=e(i.motorSpeed,0),o.m_enableMotor=e(i.enableMotor,!1),o.m_ax.SetZero(),o.m_ay.SetZero(),o}return pi(i,t),i.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},i.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},i.prototype.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},i.prototype.GetSpringFrequencyHz=function(){return this.m_frequencyHz},i.prototype.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},i.prototype.GetSpringDampingRatio=function(){return this.m_dampingRatio},i.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_invMassA,o=this.m_invMassB,s=this.m_invIA,n=this.m_invIB,a=t.positions[this.m_indexA].c,m=t.positions[this.m_indexA].a,_=t.velocities[this.m_indexA].v,h=t.velocities[this.m_indexA].w,l=t.positions[this.m_indexB].c,u=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,p=t.velocities[this.m_indexB].w,f=this.m_qA.SetAngle(m),d=this.m_qB.SetAngle(u);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var y=Z.MulRV(f,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var v=Z.MulRV(d,this.m_lalcB,this.m_rB),x=N.SubVV(N.AddVV(l,v,N.s_t0),N.AddVV(a,y,N.s_t1),i.InitVelocityConstraints_s_d);if(Z.MulRV(f,this.m_localYAxisA,this.m_ay),this.m_sAy=N.CrossVV(N.AddVV(x,y,N.s_t0),this.m_ay),this.m_sBy=N.CrossVV(v,this.m_ay),this.m_mass=e+o+s*this.m_sAy*this.m_sAy+n*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Z.MulRV(f,this.m_localXAxisA,this.m_ax),this.m_sAx=N.CrossVV(N.AddVV(x,y,N.s_t0),this.m_ax),this.m_sBx=N.CrossVV(v,this.m_ax);var B=e+o+s*this.m_sAx*this.m_sAx+n*this.m_sBx*this.m_sBx;if(B>0){this.m_springMass=1/B;var S=N.DotVV(x,this.m_ax),A=2*r*this.m_frequencyHz,b=2*this.m_springMass*this.m_dampingRatio*A,C=this.m_springMass*A*A,V=t.step.dt;this.m_gamma=V*(b+V*C),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*V*C*this.m_gamma,this.m_springMass=B+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=s+n,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var g=N.AddVV(N.MulSV(this.m_impulse,this.m_ay,N.s_t0),N.MulSV(this.m_springImpulse,this.m_ax,N.s_t1),i.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,M=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;_.SelfMulSub(this.m_invMassA,g),h-=this.m_invIA*w,c.SelfMulAdd(this.m_invMassB,g),p+=this.m_invIB*M}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=h,t.velocities[this.m_indexB].w=p},i.prototype.SolveVelocityConstraints=function(t){var e=this.m_invMassA,o=this.m_invMassB,s=this.m_invIA,r=this.m_invIB,n=t.velocities[this.m_indexA].v,a=t.velocities[this.m_indexA].w,m=t.velocities[this.m_indexB].v,_=t.velocities[this.m_indexB].w,h=N.DotVV(this.m_ax,N.SubVV(m,n,N.s_t0))+this.m_sBx*_-this.m_sAx*a,l=-this.m_springMass*(h+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;var u=N.MulSV(l,this.m_ax,i.SolveVelocityConstraints_s_P),c=l*this.m_sAx,p=l*this.m_sBx;n.SelfMulSub(e,u),a-=s*c,m.SelfMulAdd(o,u),h=(_+=r*p)-a-this.m_motorSpeed,l=-this.m_motorMass*h;var f=this.m_motorImpulse,d=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=I(this.m_motorImpulse+l,-d,d),a-=s*(l=this.m_motorImpulse-f),_+=r*l,h=N.DotVV(this.m_ay,N.SubVV(m,n,N.s_t0))+this.m_sBy*_-this.m_sAy*a,l=-this.m_mass*h,this.m_impulse+=l,u=N.MulSV(l,this.m_ay,i.SolveVelocityConstraints_s_P),c=l*this.m_sAy,p=l*this.m_sBy,n.SelfMulSub(e,u),a-=s*c,m.SelfMulAdd(o,u),_+=r*p,t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=_},i.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,n=this.m_qA.SetAngle(o),m=this.m_qB.SetAngle(r);N.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var _=Z.MulRV(n,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h,l=Z.MulRV(m,this.m_lalcB,this.m_rB),u=N.AddVV(N.SubVV(s,e,N.s_t0),N.SubVV(l,_,N.s_t1),i.SolvePositionConstraints_s_d),c=Z.MulRV(n,this.m_localYAxisA,this.m_ay),p=N.CrossVV(N.AddVV(u,_,N.s_t0),c),f=N.CrossVV(l,c),d=N.DotVV(u,this.m_ay),y=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;h=0!==y?-d/y:0;var v=N.MulSV(h,c,i.SolvePositionConstraints_s_P),x=h*p,B=h*f;return e.SelfMulSub(this.m_invMassA,v),o-=this.m_invIA*x,s.SelfMulAdd(this.m_invMassB,v),r+=this.m_invIB*B,t.positions[this.m_indexA].a=o,t.positions[this.m_indexB].a=r,w(d)<=a},i.prototype.GetDefinition=function(t){return t},i.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.prototype.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},i.prototype.GetReactionTorque=function(t){return t*this.m_motorImpulse},i.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},i.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},i.prototype.GetLocalAxisA=function(){return this.m_localXAxisA},i.prototype.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},i.prototype.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},i.prototype.GetJointAngle=function(){return this.GetRevoluteJointAngle()},i.prototype.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},i.prototype.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new N),o=e.GetWorldPoint(this.m_localAnchorB,new N),s=N.SubVV(o,i,new N),r=t.GetWorldVector(this.m_localXAxisA,new N);return N.DotVV(s,r)},i.prototype.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;N.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=Z.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);N.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var o=Z.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=N.AddVV(t.m_sweep.c,i,N.s_t0),r=N.AddVV(e.m_sweep.c,o,N.s_t1),n=N.SubVV(r,s,N.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new N),m=t.m_linearVelocity,_=e.m_linearVelocity,h=t.m_angularVelocity,l=e.m_angularVelocity;return N.DotVV(n,N.CrossSV(h,a,N.s_t0))+N.DotVV(a,N.SubVV(N.AddVCrossSV(_,l,o,N.s_t0),N.AddVCrossSV(m,h,i,N.s_t1),N.s_t0))},i.prototype.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},i.prototype.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},i.prototype.IsMotorEnabled=function(){return this.m_enableMotor},i.prototype.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},i.prototype.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},i.prototype.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},i.prototype.GetMotorTorque=function(t){return t*this.m_motorImpulse},i.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints_s_d=new N,i.InitVelocityConstraints_s_P=new N,i.SolveVelocityConstraints_s_P=new N,i.SolvePositionConstraints_s_d=new N,i.SolvePositionConstraints_s_P=new N,i}(Gi);function io(t,e){return L(t*e)}function oo(t,e){return t>e?t:e}var so,ro=function(t){this.prev=null,this.next=null,this.contact=t},no=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_indexA=0,this.m_indexB=0,this.m_manifold=new Tt,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new Tt,this.m_nodeA=new ro(this),this.m_nodeB=new ro(this)}return t.prototype.GetManifold=function(){return this.m_manifold},t.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),o=this.m_fixtureA.GetShape(),s=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),o.m_radius,i.GetTransform(),s.m_radius)},t.prototype.IsTouching=function(){return this.m_touchingFlag},t.prototype.SetEnabled=function(t){this.m_enabledFlag=t},t.prototype.IsEnabled=function(){return this.m_enabledFlag},t.prototype.GetNext=function(){return this.m_next},t.prototype.GetFixtureA=function(){return this.m_fixtureA},t.prototype.GetChildIndexA=function(){return this.m_indexA},t.prototype.GetFixtureB=function(){return this.m_fixtureB},t.prototype.GetChildIndexB=function(){return this.m_indexB},t.prototype.FlagForFiltering=function(){this.m_filterFlag=!0},t.prototype.SetFriction=function(t){this.m_friction=t},t.prototype.GetFriction=function(){return this.m_friction},t.prototype.ResetFriction=function(){this.m_friction=io(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},t.prototype.SetRestitution=function(t){this.m_restitution=t},t.prototype.GetRestitution=function(){return this.m_restitution},t.prototype.ResetRestitution=function(){this.m_restitution=oo(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},t.prototype.SetTangentSpeed=function(t){this.m_tangentSpeed=t},t.prototype.GetTangentSpeed=function(){return this.m_tangentSpeed},t.prototype.Reset=function(t,e,i,o){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=o,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,delete this.m_nodeA.contact,this.m_nodeA.prev=null,this.m_nodeA.next=null,delete this.m_nodeA.other,delete this.m_nodeB.contact,this.m_nodeB.prev=null,this.m_nodeB.next=null,delete this.m_nodeB.other,this.m_toiCount=0,this.m_friction=io(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=oo(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},t.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var i=!1,o=this.m_touchingFlag,s=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),n=s||r,a=this.m_fixtureA.GetBody(),m=this.m_fixtureB.GetBody(),_=a.GetTransform(),h=m.GetTransform();if(n){var l=this.m_fixtureA.GetShape(),u=this.m_fixtureB.GetShape();i=Xt(l,this.m_indexA,u,this.m_indexB,_,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,_,h),i=this.m_manifold.pointCount>0;for(var c=0;c<this.m_manifold.pointCount;++c){var p=this.m_manifold.points[c];p.normalImpulse=0,p.tangentImpulse=0;for(var f=p.id,d=0;d<this.m_oldManifold.pointCount;++d){var y=this.m_oldManifold.points[d];if(y.id.key===f.key){p.normalImpulse=y.normalImpulse,p.tangentImpulse=y.tangentImpulse;break}}}i!==o&&(a.SetAwake(!0),m.SetAwake(!0))}this.m_touchingFlag=i,!o&&i&&t&&t.BeginContact(this),o&&!i&&t&&t.EndContact(this),!n&&i&&t&&t.PreSolve(this,this.m_oldManifold)},t.prototype.ComputeTOI=function(e,i){var o=t.ComputeTOI_s_input;o.proxyA.SetShape(this.m_fixtureA.GetShape(),this.m_indexA),o.proxyB.SetShape(this.m_fixtureB.GetShape(),this.m_indexB),o.sweepA.Copy(e),o.sweepB.Copy(i),o.tMax=a;var s=t.ComputeTOI_s_output;return xe(s,o),s.t},t.ComputeTOI_s_input=new ne,t.ComputeTOI_s_output=new me,t}(),ao=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,e,i){Ae(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)},e}(no),mo=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,e,i){He(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)},e}(no),_o=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,e,i){ge(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)},e}(no),ho=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,e,i){si(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)},e}(no),lo=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,e,i){_i(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)},e}(no),uo=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,i,o){var s=this.m_fixtureA.GetShape(),r=this.m_fixtureB.GetShape(),n=s,a=e.Evaluate_s_edge;n.GetChildEdge(a,this.m_indexA),si(t,a,i,r,o)},e.Evaluate_s_edge=new vi,e}(no),co=function(t){function e(){return t.call(this)||this}return pi(e,t),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(e,i,o,s){t.prototype.Reset.call(this,e,i,o,s)},e.prototype.Evaluate=function(t,i,o){var s=this.m_fixtureA.GetShape(),r=this.m_fixtureB.GetShape(),n=s,a=e.Evaluate_s_edge;n.GetChildEdge(a,this.m_indexA),_i(t,a,i,r,o)},e.Evaluate_s_edge=new vi,e}(no),po=function(){this.createFcn=null,this.destroyFcn=null,this.primary=!1},fo=function(){function e(t){this.m_allocator=null,this.m_allocator=t,this.InitializeRegisters()}return e.prototype.AddType=function(t,e,i,o){var s=this,r=A(256,(function(e){return t(s.m_allocator)}));function n(e){return r.pop()||t(e)}function a(t,e){r.push(t)}this.m_registers[i][o].createFcn=n,this.m_registers[i][o].destroyFcn=a,this.m_registers[i][o].primary=!0,i!==o&&(this.m_registers[o][i].createFcn=n,this.m_registers[o][i].destroyFcn=a,this.m_registers[o][i].primary=!1)},e.prototype.InitializeRegisters=function(){this.m_registers=[];for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new po}this.AddType(ao.Create,ao.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(_o.Create,_o.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(mo.Create,mo.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(ho.Create,ho.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(lo.Create,lo.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(uo.Create,uo.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(co.Create,co.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},e.prototype.Create=function(t,e,i,o){var s=t.GetType(),r=i.GetType(),n=this.m_registers[s][r];if(n.createFcn){var a=n.createFcn(this.m_allocator);return n.primary?a.Reset(t,e,i,o):a.Reset(i,o,t,e),a}return null},e.prototype.Destroy=function(t){var e=t.m_fixtureA,i=t.m_fixtureB;t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0));var o=e.GetType(),s=i.GetType(),r=this.m_registers[o][s];r.destroyFcn&&r.destroyFcn(t,this.m_allocator)},e}(),yo=function(){function t(){}return t.prototype.SayGoodbyeJoint=function(t){},t.prototype.SayGoodbyeFixture=function(t){},t.prototype.SayGoodbyeParticleGroup=function(t){},t.prototype.SayGoodbyeParticle=function(t,e){},t}(),vo=function(){function e(){}return e.prototype.ShouldCollide=function(e,i){var o=e.GetBody(),s=i.GetBody();if(s.GetType()===t.b2BodyType.b2_staticBody&&o.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!s.ShouldCollideConnected(o))return!1;var r=e.GetFilterData(),n=i.GetFilterData();return r.groupIndex===n.groupIndex&&0!==r.groupIndex?r.groupIndex>0:0!=(r.maskBits&n.categoryBits)&&0!=(r.categoryBits&n.maskBits)},e.prototype.ShouldCollideFixtureParticle=function(t,e,i){return!0},e.prototype.ShouldCollideParticleParticle=function(t,e,i){return!0},e.b2_defaultFilter=new e,e}(),xo=function(){this.normalImpulses=b(2),this.tangentImpulses=b(2),this.count=0},Bo=function(){function t(){}return t.prototype.BeginContact=function(t){},t.prototype.EndContact=function(t){},t.prototype.BeginContactFixtureParticle=function(t,e){},t.prototype.EndContactFixtureParticle=function(t,e){},t.prototype.BeginContactParticleParticle=function(t,e){},t.prototype.EndContactParticleParticle=function(t,e){},t.prototype.PreSolve=function(t,e){},t.prototype.PostSolve=function(t,e){},t.b2_defaultListener=new t,t}(),So=function(){function t(){}return t.prototype.ReportFixture=function(t){return!0},t.prototype.ReportParticle=function(t,e){return!1},t.prototype.ShouldQueryParticleSystem=function(t){return!0},t}(),Ao=function(){function t(){}return t.prototype.ReportFixture=function(t,e,i,o){return o},t.prototype.ReportParticle=function(t,e,i,o,s){return 0},t.prototype.ShouldQueryParticleSystem=function(t){return!0},t}(),bo=function(){function e(){this.m_broadPhase=new Qt,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=vo.b2_defaultFilter,this.m_contactListener=Bo.b2_defaultListener,this.m_allocator=null,this.m_contactFactory=new fo(this.m_allocator)}return e.prototype.AddPair=function(t,e){var i=t.fixture,o=e.fixture,s=t.childIndex,r=e.childIndex,n=i.GetBody(),a=o.GetBody();if(n!==a){for(var m=a.GetContactList();m;){if(m.other===n){var _=m.contact.GetFixtureA(),h=m.contact.GetFixtureB(),l=m.contact.GetChildIndexA(),u=m.contact.GetChildIndexB();if(_===i&&h===o&&l===s&&u===r)return;if(_===o&&h===i&&l===r&&u===s)return}m=m.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(i,o)){var c=this.m_contactFactory.Create(i,s,o,r);null!==c&&(i=c.GetFixtureA(),o=c.GetFixtureB(),s=c.GetChildIndexA(),r=c.GetChildIndexB(),n=i.m_body,a=o.m_body,c.m_prev=null,c.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=c),this.m_contactList=c,c.m_nodeA.contact=c,c.m_nodeA.other=a,c.m_nodeA.prev=null,c.m_nodeA.next=n.m_contactList,null!==n.m_contactList&&(n.m_contactList.prev=c.m_nodeA),n.m_contactList=c.m_nodeA,c.m_nodeB.contact=c,c.m_nodeB.other=n,c.m_nodeB.prev=null,c.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=c.m_nodeB),a.m_contactList=c.m_nodeB,i.IsSensor()||o.IsSensor()||(n.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}}},e.prototype.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,i){t.AddPair(e,i)}))},e.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),s=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===s.m_contactList&&(s.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},e.prototype.Collide=function(){for(var e=this.m_contactList;e;){var i=e.GetFixtureA(),o=e.GetFixtureB(),s=e.GetChildIndexA(),r=e.GetChildIndexB(),n=i.GetBody(),a=o.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,o)){e=(h=e).m_next,this.Destroy(h);continue}e.m_filterFlag=!1}var m=n.IsAwake()&&n.m_type!==t.b2BodyType.b2_staticBody,_=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(m||_){var h,l=i.m_proxies[s].treeNode,u=o.m_proxies[r].treeNode;Et(l.aabb,u.aabb)?(e.Update(this.m_contactListener),e=e.m_next):(e=(h=e).m_next,this.Destroy(h))}else e=e.m_next}},e}(),Co=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),Vo=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),go=function(){function t(){this.c=new N,this.a=0}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t}(),wo=function(){function t(){this.v=new N,this.w=0}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t}(),Mo=function(){this.step=new Vo},Po=!1,Io=function(){function t(){this.rA=new N,this.rB=new N,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t}(),Go=function(){function t(){this.points=Io.MakeArray(2),this.normal=new N,this.tangent=new N,this.normalMass=new X,this.K=new X,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return A(e,(function(e){return new t}))},t}(),Do=function(){function e(){this.localPoints=N.MakeArray(2),this.localNormal=new N,this.localPoint=new N,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new N,this.localCenterB=new N,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return A(t,(function(t){return new e}))},e}(),Fo=function(){this.step=new Vo,this.count=0,this.allocator=null},To=function(){function e(){this.normal=new N,this.point=new N,this.separation=0}return e.prototype.Initialize=function(i,o,s,r){var n=e.Initialize_s_pointA,a=e.Initialize_s_pointB,m=e.Initialize_s_planePoint,_=e.Initialize_s_clipPoint;switch(i.type){case t.b2ManifoldType.e_circles:W.MulXV(o,i.localPoint,n),W.MulXV(s,i.localPoints[0],a),N.SubVV(a,n,this.normal).SelfNormalize(),N.MidVV(n,a,this.point),this.separation=N.DotVV(N.SubVV(a,n,N.s_t0),this.normal)-i.radiusA-i.radiusB;break;case t.b2ManifoldType.e_faceA:Z.MulRV(o.q,i.localNormal,this.normal),W.MulXV(o,i.localPoint,m),W.MulXV(s,i.localPoints[r],_),this.separation=N.DotVV(N.SubVV(_,m,N.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(_);break;case t.b2ManifoldType.e_faceB:Z.MulRV(s.q,i.localNormal,this.normal),W.MulXV(s,i.localPoint,m),W.MulXV(o,i.localPoints[r],_),this.separation=N.DotVV(N.SubVV(_,m,N.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(_),this.normal.SelfNeg()}},e.Initialize_s_pointA=new N,e.Initialize_s_pointB=new N,e.Initialize_s_planePoint=new N,e.Initialize_s_clipPoint=new N,e}(),Lo=function(){function t(){this.m_step=new Vo,this.m_allocator=null,this.m_positionConstraints=Do.MakeArray(1024),this.m_velocityConstraints=Go.MakeArray(1024),this.m_count=0}return t.prototype.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_allocator=t.allocator,this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=P(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new Do;if(this.m_velocityConstraints.length<this.m_count)for(e=P(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<e;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Go;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var i=0;i<this.m_count;++i){var o=this.m_contacts[i],s=o.m_fixtureA,r=o.m_fixtureB,n=s.GetShape(),a=r.GetShape(),m=n.m_radius,_=a.m_radius,h=s.GetBody(),l=r.GetBody(),u=o.GetManifold(),c=u.pointCount,p=this.m_velocityConstraints[i];p.friction=o.m_friction,p.restitution=o.m_restitution,p.tangentSpeed=o.m_tangentSpeed,p.indexA=h.m_islandIndex,p.indexB=l.m_islandIndex,p.invMassA=h.m_invMass,p.invMassB=l.m_invMass,p.invIA=h.m_invI,p.invIB=l.m_invI,p.contactIndex=i,p.pointCount=c,p.K.SetZero(),p.normalMass.SetZero();var f=this.m_positionConstraints[i];f.indexA=h.m_islandIndex,f.indexB=l.m_islandIndex,f.invMassA=h.m_invMass,f.invMassB=l.m_invMass,f.localCenterA.Copy(h.m_sweep.localCenter),f.localCenterB.Copy(l.m_sweep.localCenter),f.invIA=h.m_invI,f.invIB=l.m_invI,f.localNormal.Copy(u.localNormal),f.localPoint.Copy(u.localPoint),f.pointCount=c,f.radiusA=m,f.radiusB=_,f.type=u.type;for(var d=0;d<c;++d){var y=u.points[d],v=p.points[d];this.m_step.warmStarting?(v.normalImpulse=this.m_step.dtRatio*y.normalImpulse,v.tangentImpulse=this.m_step.dtRatio*y.tangentImpulse):(v.normalImpulse=0,v.tangentImpulse=0),v.rA.SetZero(),v.rB.SetZero(),v.normalMass=0,v.tangentMass=0,v.velocityBias=0,f.localPoints[d].Copy(y.localPoint)}}return this},t.prototype.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,i=t.InitializeVelocityConstraints_s_xfB,o=t.InitializeVelocityConstraints_s_worldManifold,s=0;s<this.m_count;++s){var r=this.m_velocityConstraints[s],n=this.m_positionConstraints[s],a=n.radiusA,m=n.radiusB,_=this.m_contacts[r.contactIndex].GetManifold(),h=r.indexA,l=r.indexB,u=r.invMassA,c=r.invMassB,p=r.invIA,f=r.invIB,d=n.localCenterA,y=n.localCenterB,v=this.m_positions[h].c,x=this.m_positions[h].a,B=this.m_velocities[h].v,S=this.m_velocities[h].w,A=this.m_positions[l].c,b=this.m_positions[l].a,C=this.m_velocities[l].v,V=this.m_velocities[l].w;e.q.SetAngle(x),i.q.SetAngle(b),N.SubVV(v,Z.MulRV(e.q,d,N.s_t0),e.p),N.SubVV(A,Z.MulRV(i.q,y,N.s_t0),i.p),o.Initialize(_,e,a,i,m),r.normal.Copy(o.normal),N.CrossVOne(r.normal,r.tangent);for(var g=r.pointCount,w=0;w<g;++w){var M=r.points[w];N.SubVV(o.points[w],v,M.rA),N.SubVV(o.points[w],A,M.rB);var P=N.CrossVV(M.rA,r.normal),I=N.CrossVV(M.rB,r.normal),G=u+c+p*P*P+f*I*I;M.normalMass=G>0?1/G:0;var D=r.tangent,F=N.CrossVV(M.rA,D),T=N.CrossVV(M.rB,D),L=u+c+p*F*F+f*T*T;M.tangentMass=L>0?1/L:0,M.velocityBias=0;var R=N.DotVV(r.normal,N.SubVV(N.AddVCrossSV(C,V,M.rB,N.s_t0),N.AddVCrossSV(B,S,M.rA,N.s_t1),N.s_t0));R<-1&&(M.velocityBias+=-r.restitution*R)}r.pointCount}},t.prototype.WarmStart=function(){for(var e=t.WarmStart_s_P,i=0;i<this.m_count;++i){for(var o=this.m_velocityConstraints[i],s=o.indexA,r=o.indexB,n=o.invMassA,a=o.invIA,m=o.invMassB,_=o.invIB,h=o.pointCount,l=this.m_velocities[s].v,u=this.m_velocities[s].w,c=this.m_velocities[r].v,p=this.m_velocities[r].w,f=o.normal,d=o.tangent,y=0;y<h;++y){var v=o.points[y];N.AddVV(N.MulSV(v.normalImpulse,f,N.s_t0),N.MulSV(v.tangentImpulse,d,N.s_t1),e),u-=a*N.CrossVV(v.rA,e),l.SelfMulSub(n,e),p+=_*N.CrossVV(v.rB,e),c.SelfMulAdd(m,e)}this.m_velocities[s].w=u,this.m_velocities[r].w=p}},t.prototype.SolveVelocityConstraints=function(){for(var e=t.SolveVelocityConstraints_s_dv,i=(t.SolveVelocityConstraints_s_dv1,t.SolveVelocityConstraints_s_dv2,t.SolveVelocityConstraints_s_P),o=(t.SolveVelocityConstraints_s_a,t.SolveVelocityConstraints_s_b,t.SolveVelocityConstraints_s_x,t.SolveVelocityConstraints_s_d,t.SolveVelocityConstraints_s_P1,t.SolveVelocityConstraints_s_P2,t.SolveVelocityConstraints_s_P1P2,0);o<this.m_count;++o){for(var s=this.m_velocityConstraints[o],r=s.indexA,n=s.indexB,a=s.invMassA,m=s.invIA,_=s.invMassB,h=s.invIB,l=s.pointCount,u=this.m_velocities[r].v,c=this.m_velocities[r].w,p=this.m_velocities[n].v,f=this.m_velocities[n].w,d=s.normal,y=s.tangent,v=s.friction,x=0;x<l;++x){var B=s.points[x];N.SubVV(N.AddVCrossSV(p,f,B.rB,N.s_t0),N.AddVCrossSV(u,c,B.rA,N.s_t1),e);var S=N.DotVV(e,y)-s.tangentSpeed,A=B.tangentMass*-S,b=v*B.normalImpulse;A=(C=I(B.tangentImpulse+A,-b,b))-B.tangentImpulse,B.tangentImpulse=C,N.MulSV(A,y,i),u.SelfMulSub(a,i),c-=m*N.CrossVV(B.rA,i),p.SelfMulAdd(_,i),f+=h*N.CrossVV(B.rB,i)}for(s.pointCount,x=0;x<l;++x){B=s.points[x],N.SubVV(N.AddVCrossSV(p,f,B.rB,N.s_t0),N.AddVCrossSV(u,c,B.rA,N.s_t1),e);var C,V=N.DotVV(e,d);A=-B.normalMass*(V-B.velocityBias),A=(C=P(B.normalImpulse+A,0))-B.normalImpulse,B.normalImpulse=C,N.MulSV(A,d,i),u.SelfMulSub(a,i),c-=m*N.CrossVV(B.rA,i),p.SelfMulAdd(_,i),f+=h*N.CrossVV(B.rB,i)}this.m_velocities[r].w=c,this.m_velocities[n].w=f}},t.prototype.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold(),o=0;o<e.pointCount;++o)i.points[o].normalImpulse=e.points[o].normalImpulse,i.points[o].tangentImpulse=e.points[o].tangentImpulse},t.prototype.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,i=t.SolvePositionConstraints_s_xfB,o=t.SolvePositionConstraints_s_psm,s=t.SolvePositionConstraints_s_rA,r=t.SolvePositionConstraints_s_rB,n=t.SolvePositionConstraints_s_P,m=0,_=0;_<this.m_count;++_){for(var h=this.m_positionConstraints[_],l=h.indexA,u=h.indexB,c=h.localCenterA,p=h.invMassA,f=h.invIA,d=h.localCenterB,y=h.invMassB,v=h.invIB,x=h.pointCount,B=this.m_positions[l].c,S=this.m_positions[l].a,A=this.m_positions[u].c,b=this.m_positions[u].a,C=0;C<x;++C){e.q.SetAngle(S),i.q.SetAngle(b),N.SubVV(B,Z.MulRV(e.q,c,N.s_t0),e.p),N.SubVV(A,Z.MulRV(i.q,d,N.s_t0),i.p),o.Initialize(h,e,i,C);var V=o.normal,g=o.point,w=o.separation;N.SubVV(g,B,s),N.SubVV(g,A,r),m=M(m,w);var P=I(.2*(w+a),-.2,0),G=N.CrossVV(s,V),D=N.CrossVV(r,V),F=p+y+f*G*G+v*D*D,T=F>0?-P/F:0;N.MulSV(T,V,n),B.SelfMulSub(p,n),S-=f*N.CrossVV(s,n),A.SelfMulAdd(y,n),b+=v*N.CrossVV(r,n)}this.m_positions[l].a=S,this.m_positions[u].a=b}return m>-.024},t.prototype.SolveTOIPositionConstraints=function(e,i){for(var o=t.SolveTOIPositionConstraints_s_xfA,s=t.SolveTOIPositionConstraints_s_xfB,r=t.SolveTOIPositionConstraints_s_psm,n=t.SolveTOIPositionConstraints_s_rA,m=t.SolveTOIPositionConstraints_s_rB,_=t.SolveTOIPositionConstraints_s_P,h=0,l=0;l<this.m_count;++l){var u=this.m_positionConstraints[l],c=u.indexA,p=u.indexB,f=u.localCenterA,d=u.localCenterB,y=u.pointCount,v=0,x=0;c!==e&&c!==i||(v=u.invMassA,x=u.invIA);var B=0,S=0;p!==e&&p!==i||(B=u.invMassB,S=u.invIB);for(var A=this.m_positions[c].c,b=this.m_positions[c].a,C=this.m_positions[p].c,V=this.m_positions[p].a,g=0;g<y;++g){o.q.SetAngle(b),s.q.SetAngle(V),N.SubVV(A,Z.MulRV(o.q,f,N.s_t0),o.p),N.SubVV(C,Z.MulRV(s.q,d,N.s_t0),s.p),r.Initialize(u,o,s,g);var w=r.normal,P=r.point,G=r.separation;N.SubVV(P,A,n),N.SubVV(P,C,m),h=M(h,G);var D=I(.75*(G+a),-.2,0),F=N.CrossVV(n,w),T=N.CrossVV(m,w),L=v+B+x*F*F+S*T*T,R=L>0?-D/L:0;N.MulSV(R,w,_),A.SelfMulSub(v,_),b-=x*N.CrossVV(n,_),C.SelfMulAdd(B,_),V+=S*N.CrossVV(m,_)}this.m_positions[c].a=b,this.m_positions[p].a=V}return h>=-.012},t.InitializeVelocityConstraints_s_xfA=new W,t.InitializeVelocityConstraints_s_xfB=new W,t.InitializeVelocityConstraints_s_worldManifold=new Lt,t.WarmStart_s_P=new N,t.SolveVelocityConstraints_s_dv=new N,t.SolveVelocityConstraints_s_dv1=new N,t.SolveVelocityConstraints_s_dv2=new N,t.SolveVelocityConstraints_s_P=new N,t.SolveVelocityConstraints_s_a=new N,t.SolveVelocityConstraints_s_b=new N,t.SolveVelocityConstraints_s_x=new N,t.SolveVelocityConstraints_s_d=new N,t.SolveVelocityConstraints_s_P1=new N,t.SolveVelocityConstraints_s_P2=new N,t.SolveVelocityConstraints_s_P1P2=new N,t.SolvePositionConstraints_s_xfA=new W,t.SolvePositionConstraints_s_xfB=new W,t.SolvePositionConstraints_s_psm=new To,t.SolvePositionConstraints_s_rA=new N,t.SolvePositionConstraints_s_rB=new N,t.SolvePositionConstraints_s_P=new N,t.SolveTOIPositionConstraints_s_xfA=new W,t.SolveTOIPositionConstraints_s_xfB=new W,t.SolveTOIPositionConstraints_s_psm=new To,t.SolveTOIPositionConstraints_s_rA=new N,t.SolveTOIPositionConstraints_s_rB=new N,t.SolveTOIPositionConstraints_s_P=new N,t}(),Ro=function(){function e(){this.m_allocator=null,this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=go.MakeArray(1024),this.m_velocities=wo.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}return e.prototype.Initialize=function(t,e,i,o,s){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=o,this.m_listener=s,this.m_positions.length<t)for(var r=P(2*this.m_positions.length,t);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new go;if(this.m_velocities.length<t)for(r=P(2*this.m_velocities.length,t);this.m_velocities.length<r;)this.m_velocities[this.m_velocities.length]=new wo},e.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},e.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},e.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},e.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},e.prototype.Solve=function(o,s,r,n){for(var a=e.s_timer.Reset(),m=s.dt,_=0;_<this.m_bodyCount;++_){var h=this.m_bodies[_];this.m_positions[_].c.Copy(h.m_sweep.c);var l=h.m_sweep.a,p=this.m_velocities[_].v.Copy(h.m_linearVelocity),f=h.m_angularVelocity;h.m_sweep.c0.Copy(h.m_sweep.c),h.m_sweep.a0=h.m_sweep.a,h.m_type===t.b2BodyType.b2_dynamicBody&&(p.x+=m*(h.m_gravityScale*r.x+h.m_invMass*h.m_force.x),p.y+=m*(h.m_gravityScale*r.y+h.m_invMass*h.m_force.y),f+=m*h.m_invI*h.m_torque,p.SelfMul(1/(1+m*h.m_linearDamping)),f*=1/(1+m*h.m_angularDamping)),this.m_positions[_].a=l,this.m_velocities[_].w=f}a.Reset();var d=e.s_solverData;d.step.Copy(s),d.positions=this.m_positions,d.velocities=this.m_velocities;var y=e.s_contactSolverDef;y.step.Copy(s),y.contacts=this.m_contacts,y.count=this.m_contactCount,y.positions=this.m_positions,y.velocities=this.m_velocities,y.allocator=this.m_allocator;var v=e.s_contactSolver.Initialize(y);for(v.InitializeVelocityConstraints(),s.warmStarting&&v.WarmStart(),_=0;_<this.m_jointCount;++_)this.m_joints[_].InitVelocityConstraints(d);for(o.solveInit=a.GetMilliseconds(),a.Reset(),_=0;_<s.velocityIterations;++_){for(var x=0;x<this.m_jointCount;++x)this.m_joints[x].SolveVelocityConstraints(d);v.SolveVelocityConstraints()}for(v.StoreImpulses(),o.solveVelocity=a.GetMilliseconds(),_=0;_<this.m_bodyCount;++_){var B=this.m_positions[_].c,S=(l=this.m_positions[_].a,p=this.m_velocities[_].v,f=this.m_velocities[_].w,N.MulSV(m,p,e.s_translation));if(N.DotVV(S,S)>4){var A=2/S.Length();p.SelfMul(A)}var b=m*f;b*b>c&&(f*=A=u/w(b)),B.x+=m*p.x,B.y+=m*p.y,l+=m*f,this.m_positions[_].a=l,this.m_velocities[_].w=f}a.Reset();var C=!1;for(_=0;_<s.positionIterations;++_){var V=v.SolvePositionConstraints(),g=!0;for(x=0;x<this.m_jointCount;++x){var P=this.m_joints[x].SolvePositionConstraints(d);g=g&&P}if(V&&g){C=!0;break}}for(_=0;_<this.m_bodyCount;++_){var I=this.m_bodies[_];I.m_sweep.c.Copy(this.m_positions[_].c),I.m_sweep.a=this.m_positions[_].a,I.m_linearVelocity.Copy(this.m_velocities[_].v),I.m_angularVelocity=this.m_velocities[_].w,I.SynchronizeTransform()}if(o.solvePosition=a.GetMilliseconds(),this.Report(v.m_velocityConstraints),n){var G=i;for(_=0;_<this.m_bodyCount;++_)(h=this.m_bodies[_]).GetType()!==t.b2BodyType.b2_staticBody&&(!h.m_autoSleepFlag||h.m_angularVelocity*h.m_angularVelocity>.0012184696791469947||N.DotVV(h.m_linearVelocity,h.m_linearVelocity)>1e-4?(h.m_sleepTime=0,G=0):(h.m_sleepTime+=m,G=M(G,h.m_sleepTime)));if(G>=.5&&C)for(_=0;_<this.m_bodyCount;++_)(h=this.m_bodies[_]).SetAwake(!1)}},e.prototype.SolveTOI=function(t,i,o){for(var s=0;s<this.m_bodyCount;++s){var r=this.m_bodies[s];this.m_positions[s].c.Copy(r.m_sweep.c),this.m_positions[s].a=r.m_sweep.a,this.m_velocities[s].v.Copy(r.m_linearVelocity),this.m_velocities[s].w=r.m_angularVelocity}var n=e.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.allocator=this.m_allocator,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;var a=e.s_contactSolver.Initialize(n);for(s=0;s<t.positionIterations&&!a.SolveTOIPositionConstraints(i,o);++s);for(this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,this.m_bodies[o].m_sweep.c0.Copy(this.m_positions[o].c),this.m_bodies[o].m_sweep.a0=this.m_positions[o].a,a.InitializeVelocityConstraints(),s=0;s<t.velocityIterations;++s)a.SolveVelocityConstraints();var m=t.dt;for(s=0;s<this.m_bodyCount;++s){var _=this.m_positions[s].c,h=this.m_positions[s].a,l=this.m_velocities[s].v,p=this.m_velocities[s].w,f=N.MulSV(m,l,e.s_translation);if(N.DotVV(f,f)>4){var d=2/f.Length();l.SelfMul(d)}var y=m*p;y*y>c&&(p*=d=u/w(y)),_.SelfMulAdd(m,l),h+=m*p,this.m_positions[s].a=h,this.m_velocities[s].w=p;var v=this.m_bodies[s];v.m_sweep.c.Copy(_),v.m_sweep.a=h,v.m_linearVelocity.Copy(l),v.m_angularVelocity=p,v.SynchronizeTransform()}this.Report(a.m_velocityConstraints)},e.prototype.Report=function(t){if(null!==this.m_listener)for(var i=0;i<this.m_contactCount;++i){var o=this.m_contacts[i];if(o){var s=t[i],r=e.s_impulse;r.count=s.pointCount;for(var n=0;n<s.pointCount;++n)r.normalImpulses[n]=s.points[n].normalImpulse,r.tangentImpulses[n]=s.points[n].tangentImpulse;this.m_listener.PostSolve(o,r)}}},e.s_timer=new K,e.s_solverData=new Mo,e.s_contactSolverDef=new Fo,e.s_contactSolver=new Lo,e.s_translation=new N,e.s_impulse=new xo,e}();(so=t.b2ParticleFlag||(t.b2ParticleFlag={}))[so.b2_waterParticle=0]="b2_waterParticle",so[so.b2_zombieParticle=2]="b2_zombieParticle",so[so.b2_wallParticle=4]="b2_wallParticle",so[so.b2_springParticle=8]="b2_springParticle",so[so.b2_elasticParticle=16]="b2_elasticParticle",so[so.b2_viscousParticle=32]="b2_viscousParticle",so[so.b2_powderParticle=64]="b2_powderParticle",so[so.b2_tensileParticle=128]="b2_tensileParticle",so[so.b2_colorMixingParticle=256]="b2_colorMixingParticle",so[so.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",so[so.b2_barrierParticle=1024]="b2_barrierParticle",so[so.b2_staticPressureParticle=2048]="b2_staticPressureParticle",so[so.b2_reactiveParticle=4096]="b2_reactiveParticle",so[so.b2_repulsiveParticle=8192]="b2_repulsiveParticle",so[so.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",so[so.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",so[so.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",so[so.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var ko=function(){this.flags=0,this.position=new N,this.velocity=new N,this.color=new Q(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function qo(t,e,i){return I(Math.ceil(Math.sqrt(t/(.01*e))*i),1,8)}var zo,Eo=function(){function t(){this.m_index=p}return t.prototype.GetIndex=function(){return this.m_index},t.prototype.SetIndex=function(t){this.m_index=t},t}();(zo=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[zo.b2_solidParticleGroup=1]="b2_solidParticleGroup",zo[zo.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",zo[zo.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",zo[zo.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",zo[zo.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",zo[zo.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Jo=function(){this.flags=0,this.groupFlags=0,this.position=new N,this.angle=0,this.linearVelocity=new N,this.angularVelocity=0,this.color=new Q,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},No=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new N,this.m_linearVelocity=new N,this.m_angularVelocity=0,this.m_transform=new W,this.m_userData=null,this.m_system=t}return e.prototype.GetNext=function(){return this.m_next},e.prototype.GetParticleSystem=function(){return this.m_system},e.prototype.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},e.prototype.GetBufferIndex=function(){return this.m_firstIndex},e.prototype.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},e.prototype.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},e.prototype.GetGroupFlags=function(){return this.m_groupFlags},e.prototype.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},e.prototype.GetMass=function(){return this.UpdateStatistics(),this.m_mass},e.prototype.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},e.prototype.GetCenter=function(){return this.UpdateStatistics(),this.m_center},e.prototype.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},e.prototype.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},e.prototype.GetTransform=function(){return this.m_transform},e.prototype.GetPosition=function(){return this.m_transform.p},e.prototype.GetAngle=function(){return this.m_transform.q.GetAngle()},e.prototype.GetLinearVelocityFromWorldPoint=function(t,i){var o=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),N.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,N.SubVV(t,this.m_center,o),i)},e.prototype.GetUserData=function(){return this.m_userData},e.prototype.SetUserData=function(t){this.m_userData=t},e.prototype.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},e.prototype.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},e.prototype.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},e.prototype.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new N,e=new N;if(this.m_timestamp!==this.m_system.m_timestamp){var i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[o]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[o]);if(this.m_mass>0){var s=1/this.m_mass;this.m_center.SelfMul(s),this.m_linearVelocity.SelfMul(s)}for(this.m_inertia=0,this.m_angularVelocity=0,o=this.m_firstIndex;o<this.m_lastIndex;o++)N.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),N.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=i*N.DotVV(t,t),this.m_angularVelocity+=i*N.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e.GetLinearVelocityFromWorldPoint_s_t0=new N,e}(),jo=function(){function t(t){this.m_front=0,this.m_back=0,this.m_capacity=0,this.m_buffer=A(t,(function(t){return null})),this.m_capacity=t}return t.prototype.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0,this.m_back>=this.m_capacity&&(this.m_capacity>0?(this.m_buffer.concat(A(this.m_capacity,(function(t){return null}))),this.m_capacity*=2):(this.m_buffer.concat(A(1,(function(t){return null}))),this.m_capacity=1))}this.m_buffer[this.m_back]=t,this.m_back++},t.prototype.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},t.prototype.Empty=function(){return this.m_front===this.m_back},t.prototype.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},t}(),Oo=function(){function t(e){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=A(e,(function(e){return new t.Generator})),this.m_generatorCapacity=e}return t.prototype.AddGenerator=function(t,e,i){var o=this.m_generatorBuffer[this.m_generatorCount++];o.center.Copy(t),o.tag=e,o.necessary=i},t.prototype.Generate=function(e,o){for(var s=1/e,r=new N(+i,+i),n=new N(-i,-i),a=0,m=0;m<this.m_generatorCount;m++)(c=this.m_generatorBuffer[m]).necessary&&(N.MinV(r,c.center,r),N.MaxV(n,c.center,n),++a);if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=o,r.y-=o,n.x+=o,n.y+=o,this.m_countX=1+Math.floor(s*(n.x-r.x)),this.m_countY=1+Math.floor(s*(n.y-r.y)),this.m_diagram=[];var _=new jo(4*this.m_countX*this.m_countY);for(m=0;m<this.m_generatorCount;m++){(c=this.m_generatorBuffer[m]).center.SelfSub(r).SelfMul(s);var h=Math.floor(c.center.x),l=Math.floor(c.center.y);h>=0&&l>=0&&h<this.m_countX&&l<this.m_countY&&_.Push(new t.Task(h,l,h+l*this.m_countX,c))}for(;!_.Empty();){h=(p=_.Front()).m_x,l=p.m_y;var u=p.m_i,c=p.m_generator;_.Pop(),this.m_diagram[u]||(this.m_diagram[u]=c,h>0&&_.Push(new t.Task(h-1,l,u-1,c)),l>0&&_.Push(new t.Task(h,l-1,u-this.m_countX,c)),h<this.m_countX-1&&_.Push(new t.Task(h+1,l,u+1,c)),l<this.m_countY-1&&_.Push(new t.Task(h,l+1,u+this.m_countX,c)))}for(l=0;l<this.m_countY;l++)for(h=0;h<this.m_countX-1;h++)u=h+l*this.m_countX,(f=this.m_diagram[u])!==(d=this.m_diagram[u+1])&&(_.Push(new t.Task(h,l,u,d)),_.Push(new t.Task(h+1,l,u+1,f)));for(l=0;l<this.m_countY-1;l++)for(h=0;h<this.m_countX;h++)u=h+l*this.m_countX,(f=this.m_diagram[u])!==(d=this.m_diagram[u+this.m_countX])&&(_.Push(new t.Task(h,l,u,d)),_.Push(new t.Task(h,l+1,u+this.m_countX,f)));for(;!_.Empty();){var p,f,d;if(h=(p=_.Front()).m_x,l=p.m_y,u=p.m_i,m=p.m_generator,_.Pop(),(f=this.m_diagram[u])!==(d=m)){var y=f.center.x-h,v=f.center.y-l,x=d.center.x-h,B=d.center.y-l;y*y+v*v>x*x+B*B&&(this.m_diagram[u]=d,h>0&&_.Push(new t.Task(h-1,l,u-1,d)),l>0&&_.Push(new t.Task(h,l-1,u-this.m_countX,d)),h<this.m_countX-1&&_.Push(new t.Task(h+1,l,u+1,d)),l<this.m_countY-1&&_.Push(new t.Task(h,l+1,u+this.m_countX,d)))}}},t.prototype.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var i=0;i<this.m_countX-1;i++){var o=i+e*this.m_countX,s=this.m_diagram[o],r=this.m_diagram[o+1],n=this.m_diagram[o+this.m_countX],a=this.m_diagram[o+1+this.m_countX];r!==n&&(s!==r&&s!==n&&(s.necessary||r.necessary||n.necessary)&&t(s.tag,r.tag,n.tag),a!==r&&a!==n&&(s.necessary||r.necessary||n.necessary)&&t(r.tag,a.tag,n.tag))}},t}();function Xo(t,e,i){var o=t[e];t[e]=t[i],t[i]=o}function Uo(t,e){return t<e}function Zo(t,e,i,o){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===o&&(o=Uo);for(var s=e,r=[],n=0;;){for(;s+1<i;i++){var a=t[s+Math.floor(Math.random()*(i-s))];r[n++]=i;for(var m=s-1;;){for(;o(t[++m],a););for(;o(a,t[--i]););if(m>=i)break;Xo(t,m,i)}}if(0===n)break;s=i,i=r[--n]}return t}function Wo(t,e,i,o){return void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===o&&(o=Uo),Zo(t,e,i,o)}function Ho(t,e,i){void 0===i&&(i=t.length);for(var o=0,s=0;s<i;++s)e(t[s])||(s!==o?Xo(t,o++,s):++o);return o}function Qo(t,e,i,o,s){void 0===s&&(s=Uo);for(var r=i-e;r>0;){var n=Math.floor(r/2),a=e+n;s(t[a],o)?(e=++a,r-=n+1):r=n}return e}function Yo(t,e,i,o,s){void 0===s&&(s=Uo);for(var r=i-e;r>0;){var n=Math.floor(r/2),a=e+n;s(o,t[a])?r=n:(e=++a,r-=n+1)}return e}function Ko(t,e,i,o){for(var s=i;e!==s;)Xo(t,e++,s++),s===o?s=i:e===i&&(i=s)}!function(t){var e=function(){this.center=new N,this.tag=0,this.necessary=!1};t.Generator=e;var i=function(t,e,i,o){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=o};t.Task=i}(Oo||(Oo={}));var $o=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}return t.prototype.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},t.prototype.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},t.prototype.Grow=function(){var t=this.capacity?2*this.capacity:y;this.Reserve(t)},t.prototype.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},t.prototype.Shorten=function(t){},t.prototype.Data=function(){return this.data},t.prototype.GetCount=function(){return this.count},t.prototype.SetCount=function(t){this.count=t},t.prototype.GetCapacity=function(){return this.capacity},t.prototype.RemoveIf=function(t){this.count=Ho(this.data,t,this.count)},t.prototype.Unique=function(t){this.count=function(t,e,i,o){if(e===i)return i;for(var s=e;++e!==i;)o(t[s],t[e])||Xo(t,++s,e);return++s}(this.data,0,this.count,t)},t}(),ts=function(t){function e(e){var i=t.call(this)||this;return i.m_system=e,i}return pi(e,t),e.prototype.ShouldQueryParticleSystem=function(t){return!1},e.prototype.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),i=0;i<e;i++)for(var o=t.GetAABB(i),s=this.m_system.GetInsideBoundsEnumerator(o),r=void 0;(r=s.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,r);return!0},e.prototype.ReportParticle=function(t,e){return!1},e.prototype.ReportFixtureAndParticle=function(t,e,i){},e}(So),es=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new N,this.flags=0}return t.prototype.SetIndices=function(t,e){this.indexA=t,this.indexB=e},t.prototype.SetWeight=function(t){this.weight=t},t.prototype.SetNormal=function(t){this.normal.Copy(t)},t.prototype.SetFlags=function(t){this.flags=t},t.prototype.GetIndexA=function(){return this.indexA},t.prototype.GetIndexB=function(){return this.indexB},t.prototype.GetWeight=function(){return this.weight},t.prototype.GetNormal=function(){return this.normal},t.prototype.GetFlags=function(){return this.flags},t.prototype.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},t.prototype.IsNotEqual=function(t){return!this.IsEqual(t)},t.prototype.ApproximatelyEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&w(this.weight-t.weight)<.01&&N.DistanceSquaredVV(this.normal,t.normal)<1e-4},t}(),is=function(){this.index=0,this.weight=0,this.normal=new N,this.mass=0},os=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},ss=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new N(0,0),this.pb=new N(0,0),this.pc=new N(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},rs=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}return t.prototype.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},t.prototype.Clone=function(){return(new t).Copy(this)},t}();t.b2ParticleSystem=function(){function o(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new o.UserOverridableBuffer,this.m_flagsBuffer=new o.UserOverridableBuffer,this.m_positionBuffer=new o.UserOverridableBuffer,this.m_velocityBuffer=new o.UserOverridableBuffer,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new o.UserOverridableBuffer,this.m_groupBuffer=[],this.m_userDataBuffer=new o.UserOverridableBuffer,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new o.UserOverridableBuffer,this.m_bodyContactCountBuffer=new o.UserOverridableBuffer,this.m_consecutiveContactStepsBuffer=new o.UserOverridableBuffer,this.m_stuckParticleBuffer=new $o((function(){return 0})),this.m_proxyBuffer=new $o((function(){return new o.Proxy})),this.m_contactBuffer=new $o((function(){return new es})),this.m_bodyContactBuffer=new $o((function(){return new is})),this.m_pairBuffer=new $o((function(){return new os})),this.m_triadBuffer=new $o((function(){return new ss})),this.m_expirationTimeBuffer=new o.UserOverridableBuffer,this.m_indexByExpirationTimeBuffer=new o.UserOverridableBuffer,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new rs,this.m_prev=null,this.m_next=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}return o.computeTag=function(t,e){return(e+o.yOffset>>>0<<o.yShift)+(o.xScale*t+o.xOffset>>>0)>>>0},o.computeRelativeTag=function(t,e,i){return t+(i<<o.yShift)+(e<<o.xShift)>>>0},o.prototype.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},o.prototype.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var i=this.m_count?2*this.m_count:y;this.ReallocateInternalAllocatedBuffers(i)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return p;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var o=this.m_count++;if(!this.m_flagsBuffer.data)throw new Error;if(this.m_flagsBuffer.data[o]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[o]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[o]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[o]=0),!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;this.m_positionBuffer.data[o]=(this.m_positionBuffer.data[o]||new N).Copy(e(t.position,N.ZERO)),this.m_velocityBuffer.data[o]=(this.m_velocityBuffer.data[o]||new N).Copy(e(t.velocity,N.ZERO)),this.m_weightBuffer[o]=0,this.m_forceBuffer[o]=(this.m_forceBuffer[o]||new N).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[o]=0),this.m_depthBuffer&&(this.m_depthBuffer[o]=0);var s=(new Q).Copy(e(t.color,Q.ZERO));!this.m_colorBuffer.data&&s.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[o]=(this.m_colorBuffer.data[o]||new Q).Copy(s)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[o]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[o]=null);var r=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],n=e(t.lifetime,0),a=n>0;if(this.m_expirationTimeBuffer.data||a){if(this.SetParticleLifetime(o,a?n:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),!this.m_indexByExpirationTimeBuffer.data)throw new Error;this.m_indexByExpirationTimeBuffer.data[o]=o}r.index=o;var m=e(t.group,null);return this.m_groupBuffer[o]=m,m&&(m.m_firstIndex<m.m_lastIndex?(this.RotateBuffer(m.m_firstIndex,m.m_lastIndex,o),m.m_lastIndex=o+1):(m.m_firstIndex=o,m.m_lastIndex=o+1)),this.SetParticleFlags(o,e(t.flags,0)),o},o.prototype.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Eo).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},o.prototype.DestroyParticle=function(e,i){if(void 0===i&&(i=!1),!this.m_flagsBuffer.data)throw new Error;var o=t.b2ParticleFlag.b2_zombieParticle;i&&(o|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|o)},o.prototype.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.GetParticleCount();if(!this.m_indexByExpirationTimeBuffer.data)throw new Error;if(!this.m_expirationTimeBuffer.data)throw new Error;var o=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],s=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[o]>0?o:s,e)},o.prototype.DestroyParticlesInShape=function(t,e,i){void 0===i&&(i=!1);var s=o.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var r=new o.DestroyParticlesInShapeCallback(this,t,e,i),n=s;return t.ComputeAABB(n,e,0),this.m_world.QueryAABB(r,n),r.Destroyed()},o.prototype.CreateParticleGroup=function(t){var i=o.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var s=i;s.SetPositionAngle(e(t.position,N.ZERO),e(t.angle,0));var r=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,s),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,e(t.shapeCount,t.shapes.length),t,s),t.positionData)for(var n=e(t.particleCount,t.positionData.length),a=0;a<n;a++){var m=t.positionData[a];this.CreateParticleForGroup(t,s,m)}var _=this.m_count,h=new No(this);for(h.m_firstIndex=r,h.m_lastIndex=_,h.m_strength=e(t.strength,1),h.m_userData=t.userData,h.m_transform.Copy(s),h.m_prev=null,h.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=h),this.m_groupList=h,++this.m_groupCount,a=r;a<_;a++)this.m_groupBuffer[a]=h;this.SetGroupFlags(h,e(t.groupFlags,0));var l=new o.ConnectionFilter;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(r,_,l),t.group&&(this.JoinParticleGroups(t.group,h),h=t.group),h},o.prototype.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var i=new o.JoinParticleGroupsFilter(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(var s=e.m_firstIndex;s<e.m_lastIndex;s++)this.m_groupBuffer[s]=t;var r=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,r),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},o.prototype.SplitParticleGroup=function(t){this.UpdateContacts(!0);var e=A(t.GetParticleCount(),(function(t){return new o.ParticleListNode}));o.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);var i=o.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)},o.prototype.GetParticleGroupList=function(){return this.m_groupList},o.prototype.GetParticleGroupCount=function(){return this.m_groupCount},o.prototype.GetParticleCount=function(){return this.m_count},o.prototype.GetMaxParticleCount=function(){return this.m_def.maxCount},o.prototype.SetMaxParticleCount=function(t){this.m_def.maxCount=t},o.prototype.GetAllParticleFlags=function(){return this.m_allParticleFlags},o.prototype.GetAllGroupFlags=function(){return this.m_allGroupFlags},o.prototype.SetPaused=function(t){this.m_paused=t},o.prototype.GetPaused=function(){return this.m_paused},o.prototype.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},o.prototype.GetDensity=function(){return this.m_def.density},o.prototype.SetGravityScale=function(t){this.m_def.gravityScale=t},o.prototype.GetGravityScale=function(){return this.m_def.gravityScale},o.prototype.SetDamping=function(t){this.m_def.dampingStrength=t},o.prototype.GetDamping=function(){return this.m_def.dampingStrength},o.prototype.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},o.prototype.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},o.prototype.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},o.prototype.GetRadius=function(){return this.m_particleDiameter/2},o.prototype.GetPositionBuffer=function(){if(!this.m_positionBuffer.data)throw new Error;return this.m_positionBuffer.data},o.prototype.GetVelocityBuffer=function(){if(!this.m_velocityBuffer.data)throw new Error;return this.m_velocityBuffer.data},o.prototype.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},o.prototype.GetGroupBuffer=function(){return this.m_groupBuffer},o.prototype.GetWeightBuffer=function(){return this.m_weightBuffer},o.prototype.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},o.prototype.GetFlagsBuffer=function(){if(!this.m_flagsBuffer.data)throw new Error;return this.m_flagsBuffer.data},o.prototype.SetParticleFlags=function(e,i){if(!this.m_flagsBuffer.data)throw new Error;this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i},o.prototype.GetParticleFlags=function(t){if(!this.m_flagsBuffer.data)throw new Error;return this.m_flagsBuffer.data[t]},o.prototype.SetFlagsBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_flagsBuffer,t,e)},o.prototype.SetPositionBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_positionBuffer,t,e)},o.prototype.SetVelocityBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_velocityBuffer,t,e)},o.prototype.SetColorBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_colorBuffer,t,e)},o.prototype.SetUserDataBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_userDataBuffer,t,e)},o.prototype.GetContacts=function(){return this.m_contactBuffer.data},o.prototype.GetContactCount=function(){return this.m_contactBuffer.count},o.prototype.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},o.prototype.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},o.prototype.GetPairs=function(){return this.m_pairBuffer.data},o.prototype.GetPairCount=function(){return this.m_pairBuffer.count},o.prototype.GetTriads=function(){return this.m_triadBuffer.data},o.prototype.GetTriadCount=function(){return this.m_triadBuffer.count},o.prototype.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},o.prototype.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},o.prototype.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},o.prototype.ComputeCollisionEnergy=function(){if(!this.m_velocityBuffer.data)throw new Error;for(var t=o.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data,i=0,s=0;s<this.m_contactBuffer.count;s++){var r=this.m_contactBuffer.data[s],n=r.indexA,a=r.indexB,m=r.normal,_=N.SubVV(e[a],e[n],t),h=N.DotVV(_,m);h<0&&(i+=h*h)}return.5*this.GetParticleMass()*i},o.prototype.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},o.prototype.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},o.prototype.SetParticleLifetime=function(t,e){var i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i)for(var o=this.GetParticleCount(),s=0;s<o;++s)this.m_indexByExpirationTimeBuffer.data[s]=s;var r=e/this.m_def.lifetimeGranularity,n=r>0?this.GetQuantizedTimeElapsed()+r:r;n!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=n,this.m_expirationTimeBufferRequiresSorting=!0)},o.prototype.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},o.prototype.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},o.prototype.GetDestructionByAge=function(){return this.m_def.destroyByAge},o.prototype.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},o.prototype.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},o.prototype.GetIndexByExpirationTimeBuffer=function(){if(this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),!this.m_indexByExpirationTimeBuffer.data)throw new Error;return this.m_indexByExpirationTimeBuffer.data},o.prototype.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},o.prototype.ApplyLinearImpulse=function(t,e,i){if(!this.m_velocityBuffer.data)throw new Error;for(var o=this.m_velocityBuffer.data,s=(e-t)*this.GetParticleMass(),r=(new N).Copy(i).SelfMul(1/s),n=t;n<e;n++)o[n].SelfAdd(r)},o.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},o.prototype.ParticleApplyForce=function(t,e){if(!this.m_flagsBuffer.data)throw new Error;o.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))},o.prototype.ApplyForce=function(t,e,i){var s=(new N).Copy(i).SelfMul(1/(e-t));if(o.IsSignificantForce(s)){this.PrepareForceBuffer();for(var r=t;r<e;r++)this.m_forceBuffer[r].SelfAdd(s)}},o.prototype.GetNext=function(){return this.m_next},o.prototype.QueryAABB=function(t,e){if(0!==this.m_proxyBuffer.count){var i=this.m_proxyBuffer.count,s=Qo(this.m_proxyBuffer.data,0,i,o.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),o.Proxy.CompareProxyTag),r=Yo(this.m_proxyBuffer.data,s,i,o.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),o.Proxy.CompareTagProxy);if(!this.m_positionBuffer.data)throw new Error;for(var n=this.m_positionBuffer.data,a=s;a<r;++a){var m=this.m_proxyBuffer.data[a].index,_=n[m];if(e.lowerBound.x<_.x&&_.x<e.upperBound.x&&e.lowerBound.y<_.y&&_.y<e.upperBound.y&&!t.ReportParticle(this,m))break}}},o.prototype.QueryShapeAABB=function(t,e,i,s){void 0===s&&(s=0);var r=o.QueryShapeAABB_s_aabb;e.ComputeAABB(r,i,s),this.QueryAABB(t,r)},o.prototype.QueryPointAABB=function(t,e,i){void 0===i&&(i=a);var s=o.QueryPointAABB_s_aabb;s.lowerBound.Set(e.x-i,e.y-i),s.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,s)},o.prototype.RayCast=function(t,e,i){var s=o.RayCast_s_aabb,r=o.RayCast_s_p,n=o.RayCast_s_v,a=o.RayCast_s_n,m=o.RayCast_s_point;if(0!==this.m_proxyBuffer.count){if(!this.m_positionBuffer.data)throw new Error;var _=this.m_positionBuffer.data,h=s;N.MinV(e,i,h.lowerBound),N.MaxV(e,i,h.upperBound);for(var l,u=1,c=N.SubVV(i,e,n),p=N.DotVV(c,c),f=this.GetInsideBoundsEnumerator(h);(l=f.GetNext())>=0;){var d=N.SubVV(e,_[l],r),y=N.DotVV(d,c),v=y*y-p*(N.DotVV(d,d)-this.m_squaredDiameter);if(v>=0){var x=L(v),B=(-y-x)/p;if(B>u)continue;if(B<0&&((B=(-y+x)/p)<0||B>u))continue;var S=N.AddVMulSV(d,B,c,a);S.Normalize();var A=t.ReportParticle(this,l,N.AddVMulSV(e,B,c,m),S,B);if((u=M(u,A))<=0)break}}}},o.prototype.ComputeAABB=function(t){var e=this.GetParticleCount();if(t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i,!this.m_positionBuffer.data)throw new Error;for(var o=this.m_positionBuffer.data,s=0;s<e;s++){var r=o[s];N.MinV(t.lowerBound,r,t.lowerBound),N.MaxV(t.upperBound,r,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},o.prototype.FreeBuffer=function(t,e){null!==t&&(t.length=0)},o.prototype.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},o.prototype.ReallocateBuffer3=function(t,e,i){if(i<=e)throw new Error;var o=t?t.slice():[];return o.length=i,o},o.prototype.ReallocateBuffer5=function(t,e,i,o,s){if(o<=i)throw new Error;if(e&&!(o<=e))throw new Error;return s&&!t||e||(t=this.ReallocateBuffer3(t,i,o)),t},o.prototype.ReallocateBuffer4=function(t,e,i,o){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,o)},o.prototype.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(y),(t=[]).length=this.m_internalAllocatedCapacity),t},o.prototype.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},o.prototype.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},o.prototype.CreateParticleForGroup=function(t,i,o){var s=new ko;s.flags=e(t.flags,0),W.MulXV(i,o,s.position),N.AddVV(e(t.linearVelocity,N.ZERO),N.CrossSV(e(t.angularVelocity,0),N.SubVV(s.position,e(t.position,N.ZERO),N.s_t0),N.s_t0),s.velocity),s.color.Copy(e(t.color,Q.ZERO)),s.lifetime=e(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)},o.prototype.CreateParticlesStrokeShapeForGroup=function(i,s,r){var n=o.CreateParticlesStrokeShapeForGroup_s_edge,a=o.CreateParticlesStrokeShapeForGroup_s_d,m=o.CreateParticlesStrokeShapeForGroup_s_p,_=e(s.stride,0);0===_&&(_=this.GetParticleStride());for(var h=0,l=i.GetChildCount(),u=0;u<l;u++){var c=null;i.GetType()===t.b2ShapeType.e_edgeShape?c=i:(c=n,i.GetChildEdge(c,u));for(var p=N.SubVV(c.m_vertex2,c.m_vertex1,a),f=p.Length();h<f;){var d=N.AddVMulSV(c.m_vertex1,h/f,p,m);this.CreateParticleForGroup(s,r,d),h+=_}h-=f}},o.prototype.CreateParticlesFillShapeForGroup=function(t,i,s){var r=o.CreateParticlesFillShapeForGroup_s_aabb,n=o.CreateParticlesFillShapeForGroup_s_p,a=e(i.stride,0);0===a&&(a=this.GetParticleStride());var m=W.IDENTITY,_=r;t.ComputeAABB(_,m,0);for(var h=Math.floor(_.lowerBound.y/a)*a;h<_.upperBound.y;h+=a)for(var l=Math.floor(_.lowerBound.x/a)*a;l<_.upperBound.x;l+=a){var u=n.Set(l,h);t.TestPoint(m,u)&&this.CreateParticleForGroup(i,s,u)}},o.prototype.CreateParticlesWithShapeForGroup=function(e,i,o){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,o);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,o)}},o.prototype.CreateParticlesWithShapesForGroup=function(t,e,i,s){var r=new o.CompositeShape(t,e);this.CreateParticlesFillShapeForGroup(r,i,s)},o.prototype.CloneParticle=function(t,e){var i=new ko;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;var o=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){var s=this.m_handleIndexBuffer.data[t];s&&s.SetIndex(o),this.m_handleIndexBuffer.data[o]=s,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[o]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[o]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[o]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[o].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[o]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[o]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[o]=this.m_expirationTimeBuffer.data[t]),o},o.prototype.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)},o.prototype.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},o.ParticleCanBeConnected=function(e,i){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},o.prototype.UpdatePairsAndTriads=function(e,i,s){var r=o.UpdatePairsAndTriads_s_dab,n=o.UpdatePairsAndTriads_s_dbc,a=o.UpdatePairsAndTriads_s_dca;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var m=this.m_positionBuffer.data,_=0,h=e;h<i;h++)_|=this.m_flagsBuffer.data[h];if(_&o.k_pairFlags)for(var l=0;l<this.m_contactBuffer.count;l++){var u=this.m_contactBuffer.data[l],c=u.indexA,p=u.indexB,f=this.m_flagsBuffer.data[c],d=this.m_flagsBuffer.data[p],y=this.m_groupBuffer[c],v=this.m_groupBuffer[p];if(c>=e&&c<i&&p>=e&&p<i&&!((f|d)&t.b2ParticleFlag.b2_zombieParticle)&&(f|d)&o.k_pairFlags&&(s.IsNecessary(c)||s.IsNecessary(p))&&o.ParticleCanBeConnected(f,y)&&o.ParticleCanBeConnected(d,v)&&s.ShouldCreatePair(c,p)){var x=this.m_pairBuffer.data[this.m_pairBuffer.Append()];x.indexA=c,x.indexB=p,x.flags=u.flags,x.strength=M(y?y.m_strength:1,v?v.m_strength:1),x.distance=N.DistanceVV(m[c],m[p])}Wo(this.m_pairBuffer.data,0,this.m_pairBuffer.count,o.ComparePairIndices),this.m_pairBuffer.Unique(o.MatchPairIndices)}if(_&o.k_triadFlags){var B=new Oo(i-e);for(h=e;h<i;h++){var S=this.m_flagsBuffer.data[h],A=this.m_groupBuffer[h];S&t.b2ParticleFlag.b2_zombieParticle||!o.ParticleCanBeConnected(S,A)||B.AddGenerator(m[h],h,s.IsNecessary(h))}var b=this.GetParticleStride();B.Generate(b/2,2*b);var C=this;B.GetNodes((function(t,e,i){if(!C.m_flagsBuffer.data)throw new Error;var _=C.m_flagsBuffer.data[t],h=C.m_flagsBuffer.data[e],l=C.m_flagsBuffer.data[i];if((_|h|l)&o.k_triadFlags&&s.ShouldCreateTriad(t,e,i)){var u=m[t],c=m[e],p=m[i],f=N.SubVV(u,c,r),d=N.SubVV(c,p,n),y=N.SubVV(p,u,a),v=4*C.m_squaredDiameter;if(N.DotVV(f,f)>v||N.DotVV(d,d)>v||N.DotVV(y,y)>v)return;var x=C.m_groupBuffer[t],B=C.m_groupBuffer[e],S=C.m_groupBuffer[i],A=C.m_triadBuffer.data[C.m_triadBuffer.Append()];A.indexA=t,A.indexB=e,A.indexC=i,A.flags=_|h|l,A.strength=M(M(x?x.m_strength:1,B?B.m_strength:1),S?S.m_strength:1);var b=(u.x+c.x+p.x)/3,V=(u.y+c.y+p.y)/3;A.pa.x=u.x-b,A.pa.y=u.y-V,A.pb.x=c.x-b,A.pb.y=c.y-V,A.pc.x=p.x-b,A.pc.y=p.y-V,A.ka=-N.DotVV(y,f),A.kb=-N.DotVV(f,d),A.kc=-N.DotVV(d,y),A.s=N.CrossVV(u,c)+N.CrossVV(c,p)+N.CrossVV(p,u)}})),Wo(this.m_triadBuffer.data,0,this.m_triadBuffer.count,o.CompareTriadIndices),this.m_triadBuffer.Unique(o.MatchTriadIndices)}},o.prototype.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new o.ReactiveFilter(this.m_flagsBuffer);if(this.UpdatePairsAndTriads(0,this.m_count,e),!this.m_flagsBuffer.data)throw new Error;for(var i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},o.ComparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB},o.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},o.CompareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!==i)return i<0;var o=t.indexB-e.indexB;return 0!==o?o<0:t.indexC<e.indexC},o.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},o.InitializeParticleLists=function(t,e){for(var i=t.GetBufferIndex(),o=t.GetParticleCount(),s=0;s<o;s++){var r=e[s];r.list=r,r.next=null,r.count=1,r.index=s+i}},o.prototype.MergeParticleListsInContact=function(t,e){for(var i=t.GetBufferIndex(),s=0;s<this.m_contactBuffer.count;s++){var r=this.m_contactBuffer.data[s],n=r.indexA,a=r.indexB;if(t.ContainsParticle(n)&&t.ContainsParticle(a)){var m=e[n-i].list,_=e[a-i].list;if(m!==_){if(m.count<_.count){var h=m;m=_,_=h}o.MergeParticleLists(m,_)}}}},o.MergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var o=i.next;if(!o){i.next=t.next;break}i=o}t.next=e,t.count+=e.count,e.count=0},o.FindLongestParticleList=function(t,e){for(var i=t.GetParticleCount(),o=e[0],s=0;s<i;s++){var r=e[s];o.count<r.count&&(o=r)}return o},o.prototype.MergeZombieParticleListNodes=function(e,i,s){if(!this.m_flagsBuffer.data)throw new Error;for(var r=e.GetParticleCount(),n=0;n<r;n++){var a=i[n];a!==s&&this.m_flagsBuffer.data[a.index]&t.b2ParticleFlag.b2_zombieParticle&&o.MergeParticleListAndNode(s,a)}},o.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},o.prototype.CreateParticleGroupsFromParticleList=function(e,i,o){if(!this.m_flagsBuffer.data)throw new Error;var s=e.GetParticleCount(),r=new Jo;r.groupFlags=e.GetGroupFlags(),r.userData=e.GetUserData();for(var n=0;n<s;n++){var a=i[n];if(a.count&&a!==o)for(var m=this.CreateParticleGroup(r),_=a;_;_=_.next){var h=_.index,l=this.CloneParticle(h,m);this.m_flagsBuffer.data[h]|=t.b2ParticleFlag.b2_zombieParticle,_.index=l}}},o.prototype.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.GetBufferIndex(),o=0;o<this.m_pairBuffer.count;o++){var s=this.m_pairBuffer.data[o],r=s.indexA,n=s.indexB;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(n)&&(s.indexB=e[n-i].index)}for(o=0;o<this.m_triadBuffer.count;o++){var a=this.m_triadBuffer.data[o],m=(r=a.indexA,n=a.indexB,a.indexC);t.ContainsParticle(r)&&(a.indexA=e[r-i].index),t.ContainsParticle(n)&&(a.indexB=e[n-i].index),t.ContainsParticle(m)&&(a.indexC=e[m-i].index)}},o.prototype.ComputeDepth=function(){for(var e=[],o=0,s=0;s<this.m_contactBuffer.count;s++){var r=(v=this.m_contactBuffer.data[s]).indexA,n=v.indexB,a=this.m_groupBuffer[r],m=this.m_groupBuffer[n];a&&a===m&&a.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[o++]=v)}for(var _=[],h=0,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){_[h++]=l,this.SetGroupFlags(l,l.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var u=l.m_firstIndex;u<l.m_lastIndex;u++)this.m_accumulationBuffer[u]=0}for(s=0;s<o;s++){r=(v=e[s]).indexA,n=v.indexB;var c=v.weight;this.m_accumulationBuffer[r]+=c,this.m_accumulationBuffer[n]+=c}for(u=0;u<h;u++)for(var p=(l=_[u]).m_firstIndex;p<l.m_lastIndex;p++)c=this.m_accumulationBuffer[p],this.m_depthBuffer[p]=c<.8?0:i;for(var f=L(this.m_count)>>0,d=0;d<f;d++){var y=!1;for(s=0;s<o;s++){r=(v=e[s]).indexA,n=v.indexB;var v,x=1-v.weight,B=this.m_depthBuffer[r],S=this.m_depthBuffer[n],A=S+x,b=B+x;B>A&&(this.m_depthBuffer[r]=A,y=!0),S>b&&(this.m_depthBuffer[n]=b,y=!0)}if(!y)break}for(u=0;u<h;u++)for(var C=(l=_[u]).m_firstIndex;C<l.m_lastIndex;C++)this.m_depthBuffer[C]<i?this.m_depthBuffer[C]*=this.m_particleDiameter:this.m_depthBuffer[C]=0},o.prototype.GetInsideBoundsEnumerator=function(t){var e=o.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=o.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),s=this.m_proxyBuffer.count,r=Qo(this.m_proxyBuffer.data,0,s,e,o.Proxy.CompareProxyTag),n=Yo(this.m_proxyBuffer.data,0,s,i,o.Proxy.CompareTagProxy);return new o.InsideBoundsEnumerator(this,e,i,r,n)},o.prototype.UpdateAllParticleFlags=function(){if(!this.m_flagsBuffer.data)throw new Error;this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},o.prototype.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},o.prototype.AddContact=function(t,e,i){if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;var s=o.AddContact_s_d,r=this.m_positionBuffer.data,n=N.SubVV(r[e],r[t],s),a=N.DotVV(n,n);if(a<this.m_squaredDiameter){var m=F(a);isFinite(m)||(m=198177537e11);var _=this.m_contactBuffer.data[this.m_contactBuffer.Append()];_.indexA=t,_.indexB=e,_.flags=this.m_flagsBuffer.data[t]|this.m_flagsBuffer.data[e],_.weight=1-a*m*this.m_inverseDiameter,N.MulSV(m,n,_.normal)}},o.prototype.FindContacts_Reference=function(t){var e=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var i=0,s=0;i<e;i++){for(var r=o.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),n=i+1;n<e&&!(r<this.m_proxyBuffer.data[n].tag);n++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[n].index,this.m_contactBuffer);for(var a=o.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);s<e&&!(a<=this.m_proxyBuffer.data[s].tag);s++);var m=o.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1);for(n=s;n<e&&!(m<this.m_proxyBuffer.data[n].tag);n++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[n].index,this.m_contactBuffer)}},o.prototype.FindContacts=function(t){this.FindContacts_Reference(t)},o.prototype.UpdateProxies_Reference=function(t){if(!this.m_positionBuffer.data)throw new Error;for(var e=this.m_positionBuffer.data,i=this.m_inverseDiameter,s=0;s<this.m_proxyBuffer.count;++s){var r=this.m_proxyBuffer.data[s],n=e[r.index];r.tag=o.computeTag(i*n.x,i*n.y)}},o.prototype.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},o.prototype.SortProxies=function(t){Zo(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,o.Proxy.CompareProxyProxy)},o.prototype.FilterContacts=function(e){var i=this.GetParticleContactFilter();if(null!==i){var o=this;this.m_contactBuffer.RemoveIf((function(e){return 0!=(e.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!i.ShouldCollideParticleParticle(o,e.indexA,e.indexB)}))}},o.prototype.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},o.prototype.NotifyContactListenerPostContact=function(t){var e=this.GetParticleContactListener();if(null!==e){for(var i=0;i<this.m_contactBuffer.count;++i){var o=this.m_contactBuffer.data[i];e.BeginContactParticleParticle(this,o)}throw new Error}},o.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},o.prototype.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var e=new o.b2ParticlePairSet;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(o.b2ParticleContactIsZombie)},o.prototype.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},o.prototype.NotifyBodyContactListenerPostContact=function(t){var e=this.GetFixtureContactListener();if(null!==e){for(var i=0;i<this.m_bodyContactBuffer.count;i++){var o=this.m_bodyContactBuffer.data[i];e.BeginContactFixtureParticle(this,o)}throw new Error}},o.prototype.UpdateBodyContacts=function(){var t=o.UpdateBodyContacts_s_aabb,e=new o.FixtureParticleSet;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){if(!this.m_bodyContactCountBuffer.data)throw new Error;if(!this.m_lastBodyContactStepBuffer.data)throw new Error;if(!this.m_consecutiveContactStepsBuffer.data)throw new Error;for(var i=this.GetParticleCount(),s=0;s<i;s++)this.m_bodyContactCountBuffer.data[s]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[s]+1&&(this.m_consecutiveContactStepsBuffer.data[s]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var r=t;this.ComputeAABB(r);var n=new o.UpdateBodyContactsCallback(this,this.GetFixtureContactFilter());this.m_world.QueryAABB(n,r),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)},o.prototype.Solve=function(e){var i=o.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(e),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<e.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var s=i.Copy(e);if(s.dt/=e.particleIterations,s.inv_dt*=e.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(s),this.SolvePressure(s),this.SolveDamping(s),this.m_allParticleFlags&o.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(s),this.LimitVelocity(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(s),this.SolveCollision(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall(),!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var r=0;r<this.m_count;r++)this.m_positionBuffer.data[r].SelfMulAdd(s.dt,this.m_velocityBuffer.data[r])}},o.prototype.SolveCollision=function(t){var e=o.SolveCollision_s_aabb;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;var s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=e;n.lowerBound.x=+i,n.lowerBound.y=+i,n.upperBound.x=-i,n.upperBound.y=-i;for(var a=0;a<this.m_count;a++){var m=r[a],_=s[a],h=_.x+t.dt*m.x,l=_.y+t.dt*m.y;n.lowerBound.x=M(n.lowerBound.x,M(_.x,h)),n.lowerBound.y=M(n.lowerBound.y,M(_.y,l)),n.upperBound.x=P(n.upperBound.x,P(_.x,h)),n.upperBound.y=P(n.upperBound.y,P(_.y,l))}var u=new o.SolveCollisionCallback(this,t);this.m_world.QueryAABB(u,n)},o.prototype.LimitVelocity=function(t){if(!this.m_velocityBuffer.data)throw new Error;for(var e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t),o=0;o<this.m_count;o++){var s=e[o],r=N.DotVV(s,s);r>i&&s.SelfMul(L(i/r))}},o.prototype.SolveGravity=function(t){if(!this.m_velocityBuffer.data)throw new Error;for(var e=o.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,s=N.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e),r=0;r<this.m_count;r++)i[r].SelfAdd(s)},o.prototype.SolveBarrier=function(e){var i=o.SolveBarrier_s_aabb,s=o.SolveBarrier_s_va,r=o.SolveBarrier_s_vb,n=o.SolveBarrier_s_pba,a=o.SolveBarrier_s_vba,m=o.SolveBarrier_s_vc,_=o.SolveBarrier_s_pca,h=o.SolveBarrier_s_vca,l=o.SolveBarrier_s_qba,u=o.SolveBarrier_s_qca,c=o.SolveBarrier_s_dv,p=o.SolveBarrier_s_f;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var f=this.m_positionBuffer.data,d=this.m_velocityBuffer.data,y=0;y<this.m_count;y++)0!=(this.m_flagsBuffer.data[y]&o.k_barrierWallFlags)&&d[y].SetZero();for(var v=2.5*e.dt,x=this.GetParticleMass(),B=0;B<this.m_pairBuffer.count;B++){var S=this.m_pairBuffer.data[B];if(S.flags&t.b2ParticleFlag.b2_barrierParticle){var A=S.indexA,b=S.indexB,C=f[A],V=f[b],g=i;N.MinV(C,V,g.lowerBound),N.MaxV(C,V,g.upperBound);for(var w=this.m_groupBuffer[A],M=this.m_groupBuffer[b],P=this.GetLinearVelocity(w,A,C,s),I=this.GetLinearVelocity(M,b,V,r),G=N.SubVV(V,C,n),D=N.SubVV(I,P,a),F=this.GetInsideBoundsEnumerator(g),T=void 0;(T=F.GetNext())>=0;){var R=f[T],k=this.m_groupBuffer[T];if(w!==k&&M!==k){var q=this.GetLinearVelocity(k,T,R,m),z=N.SubVV(R,C,_),E=N.SubVV(q,P,h),J=N.CrossVV(D,E),j=N.CrossVV(G,E)-N.CrossVV(z,D),O=N.CrossVV(G,z),X=void 0,U=void 0,Z=l,W=u;if(0===J){if(0===j)continue;if(!((U=-O/j)>=0&&U<v))continue;if(N.AddVMulSV(G,U,D,Z),N.AddVMulSV(z,U,E,W),!((X=N.DotVV(Z,W)/N.DotVV(Z,Z))>=0&&X<=1))continue}else{var H=j*j-4*O*J;if(H<0)continue;var Q=L(H),Y=(-j-Q)/(2*J),K=(-j+Q)/(2*J);if(Y>K){var $=Y;Y=K,K=$}if(U=Y,N.AddVMulSV(G,U,D,Z),N.AddVMulSV(z,U,E,W),X=N.DotVV(Z,W)/N.DotVV(Z,Z),!(U>=0&&U<v&&X>=0&&X<=1)){if(!((U=K)>=0&&U<v))continue;if(N.AddVMulSV(G,U,D,Z),N.AddVMulSV(z,U,E,W),!((X=N.DotVV(Z,W)/N.DotVV(Z,Z))>=0&&X<=1))continue}}var tt=c;tt.x=P.x+X*D.x-q.x,tt.y=P.y+X*D.y-q.y;var et=N.MulSV(x,tt,p);if(k&&this.IsRigidGroup(k)){var it=k.GetMass(),ot=k.GetInertia();it>0&&k.m_linearVelocity.SelfMulAdd(1/it,et),ot>0&&(k.m_angularVelocity+=N.CrossVV(N.SubVV(R,k.GetCenter(),N.s_t0),et)/ot)}else d[T].SelfAdd(tt);this.ParticleApplyForce(T,et.SelfMul(-e.inv_dt))}}}}},o.prototype.SolveStaticPressure=function(e){if(!this.m_flagsBuffer.data)throw new Error;this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var i=this.GetCriticalPressure(e),o=this.m_def.staticPressureStrength*i,s=d*i,r=this.m_def.staticPressureRelaxation,n=0;n<this.m_def.staticPressureIterations;n++){for(var a=0;a<this.m_count;a++)this.m_accumulationBuffer[a]=0;for(var m=0;m<this.m_contactBuffer.count;m++){var _=this.m_contactBuffer.data[m];if(_.flags&t.b2ParticleFlag.b2_staticPressureParticle){var h=_.indexA,l=_.indexB,u=_.weight;this.m_accumulationBuffer[h]+=u*this.m_staticPressureBuffer[l],this.m_accumulationBuffer[l]+=u*this.m_staticPressureBuffer[h]}}for(a=0;a<this.m_count;a++)if(u=this.m_weightBuffer[a],this.m_flagsBuffer.data[a]&t.b2ParticleFlag.b2_staticPressureParticle){var c=(this.m_accumulationBuffer[a]+o*(u-1))/(u+r);this.m_staticPressureBuffer[a]=I(c,0,s)}else this.m_staticPressureBuffer[a]=0}},o.prototype.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(t=0;t<this.m_bodyContactBuffer.count;t++){var e=(o=this.m_bodyContactBuffer.data[t]).index,i=o.weight;this.m_weightBuffer[e]+=i}for(t=0;t<this.m_contactBuffer.count;t++){e=(o=this.m_contactBuffer.data[t]).indexA;var o,s=o.indexB;i=o.weight,this.m_weightBuffer[e]+=i,this.m_weightBuffer[s]+=i}},o.prototype.SolvePressure=function(e){var i=o.SolvePressure_s_f;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=this.GetCriticalPressure(e),a=this.m_def.pressureStrength*n,m=d*n,_=0;_<this.m_count;_++){var h=this.m_weightBuffer[_],l=a*P(0,h-1);this.m_accumulationBuffer[_]=M(l,m)}if(this.m_allParticleFlags&o.k_noPressureFlags)for(_=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&o.k_noPressureFlags&&(this.m_accumulationBuffer[_]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(_=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var u=e.dt/(this.m_def.density*this.m_particleDiameter),c=this.GetParticleInvMass(),p=0;p<this.m_bodyContactBuffer.count;p++){var f=(A=this.m_bodyContactBuffer.data[p]).index,y=A.body,v=(h=A.weight,A.mass),x=A.normal,B=s[f],S=(l=this.m_accumulationBuffer[f]+a*h,N.MulSV(u*h*v*l,x,i));r[f].SelfMulSub(c,S),y.ApplyLinearImpulse(S,B,!0)}for(p=0;p<this.m_contactBuffer.count;p++){var A;f=(A=this.m_contactBuffer.data[p]).indexA,y=A.indexB,h=A.weight,x=A.normal,l=this.m_accumulationBuffer[f]+this.m_accumulationBuffer[y],S=N.MulSV(u*h*l,x,i),r[f].SelfSub(S),r[y].SelfAdd(S)}},o.prototype.SolveDamping=function(t){var e=o.SolveDamping_s_v,i=o.SolveDamping_s_f;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=this.m_def.dampingStrength,a=1/this.GetCriticalVelocity(t),m=this.GetParticleInvMass(),_=0;_<this.m_bodyContactBuffer.count;_++){var h=(x=this.m_bodyContactBuffer.data[_]).index,l=x.body,u=x.weight,c=x.mass,p=x.normal,f=s[h],d=N.SubVV(l.GetLinearVelocityFromWorldPoint(f,N.s_t0),r[h],e);if((B=N.DotVV(d,p))<0){var y=P(n*u,M(-a*B,.5)),v=N.MulSV(y*c*B,p,i);r[h].SelfMulAdd(m,v),l.ApplyLinearImpulse(v.SelfNeg(),f,!0)}}for(_=0;_<this.m_contactBuffer.count;_++){var x,B;h=(x=this.m_contactBuffer.data[_]).indexA,l=x.indexB,u=x.weight,p=x.normal,d=N.SubVV(r[l],r[h],e),(B=N.DotVV(d,p))<0&&(y=P(n*u,M(-a*B,.5)),v=N.MulSV(y*B,p,i),r[h].SelfAdd(v),r[l].SelfSub(v))}},o.prototype.SolveRigidDamping=function(){var t=o.SolveRigidDamping_s_t0,e=o.SolveRigidDamping_s_t1,i=o.SolveRigidDamping_s_p,s=o.SolveRigidDamping_s_v,r=[0],n=[0],a=[0],m=[0],_=[0],h=[0];if(!this.m_positionBuffer.data)throw new Error;for(var l=this.m_positionBuffer.data,u=this.m_def.dampingStrength,c=0;c<this.m_bodyContactBuffer.count;c++){var p=(S=this.m_bodyContactBuffer.data[c]).index;if((b=this.m_groupBuffer[p])&&this.IsRigidGroup(b)){var f=S.body,d=S.normal,y=S.weight,v=l[p],x=N.SubVV(f.GetLinearVelocityFromWorldPoint(v,t),b.GetLinearVelocityFromWorldPoint(v,e),s);if((A=N.DotVV(x,d))<0){this.InitDampingParameterWithRigidGroupOrParticle(r,n,a,!0,b,p,v,d),this.InitDampingParameter(m,_,h,f.GetMass(),f.GetInertia()-f.GetMass()*f.GetLocalCenter().LengthSquared(),f.GetWorldCenter(),v,d);var B=u*M(y,1)*this.ComputeDampingImpulse(r[0],n[0],a[0],m[0],_[0],h[0],A);this.ApplyDamping(r[0],n[0],a[0],!0,b,p,B,d),f.ApplyLinearImpulse(N.MulSV(-B,d,N.s_t0),v,!0)}}}for(c=0;c<this.m_contactBuffer.count;c++){p=(S=this.m_contactBuffer.data[c]).indexA,f=S.indexB,d=S.normal,y=S.weight;var S,A,b=this.m_groupBuffer[p],C=this.m_groupBuffer[f],V=this.IsRigidGroup(b),g=this.IsRigidGroup(C);if(b!==C&&(V||g))v=N.MidVV(l[p],l[f],i),x=N.SubVV(this.GetLinearVelocity(C,f,v,t),this.GetLinearVelocity(b,p,v,e),s),(A=N.DotVV(x,d))<0&&(this.InitDampingParameterWithRigidGroupOrParticle(r,n,a,V,b,p,v,d),this.InitDampingParameterWithRigidGroupOrParticle(m,_,h,g,C,f,v,d),B=u*y*this.ComputeDampingImpulse(r[0],n[0],a[0],m[0],_[0],h[0],A),this.ApplyDamping(r[0],n[0],a[0],V,b,p,B,d),this.ApplyDamping(m[0],_[0],h[0],g,C,f,-B,d))}},o.prototype.SolveExtraDamping=function(){var t=o.SolveExtraDamping_s_v,e=o.SolveExtraDamping_s_f;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var i=this.m_velocityBuffer.data,s=this.m_positionBuffer.data,r=this.GetParticleInvMass(),n=0;n<this.m_bodyContactBuffer.count;n++){var a=this.m_bodyContactBuffer.data[n],m=a.index;if(this.m_flagsBuffer.data[m]&o.k_extraDampingFlags){var _=a.body,h=a.mass,l=a.normal,u=s[m],c=N.SubVV(_.GetLinearVelocityFromWorldPoint(u,N.s_t0),i[m],t),p=N.DotVV(c,l);if(p<0){var f=N.MulSV(.5*h*p,l,e);i[m].SelfMulAdd(r,f),_.ApplyLinearImpulse(f.SelfNeg(),u,!0)}}}},o.prototype.SolveWall=function(){if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var e=this.m_velocityBuffer.data,i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()},o.prototype.SolveRigid=function(e){var i=o.SolveRigid_s_position,s=o.SolveRigid_s_rotation,r=o.SolveRigid_s_transform,n=o.SolveRigid_s_velocityTransform;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var a=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){_.UpdateStatistics();var h=s;h.SetAngle(e.dt*_.m_angularVelocity);var l=N.AddVV(_.m_center,N.SubVV(N.MulSV(e.dt,_.m_linearVelocity,N.s_t0),Z.MulRV(h,_.m_center,N.s_t1),N.s_t0),i),u=r;u.SetPositionRotation(l,h),W.MulXX(u,_.m_transform,_.m_transform);var c=n;c.p.x=e.inv_dt*u.p.x,c.p.y=e.inv_dt*u.p.y,c.q.s=e.inv_dt*u.q.s,c.q.c=e.inv_dt*(u.q.c-1);for(var p=_.m_firstIndex;p<_.m_lastIndex;p++)W.MulXV(c,a[p],m[p])}},o.prototype.SolveElastic=function(e){var i=o.SolveElastic_s_pa,s=o.SolveElastic_s_pb,r=o.SolveElastic_s_pc,n=o.SolveElastic_s_r,a=o.SolveElastic_s_t0;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var m=this.m_positionBuffer.data,_=this.m_velocityBuffer.data,h=e.inv_dt*this.m_def.elasticStrength,l=0;l<this.m_triadBuffer.count;l++){var u=this.m_triadBuffer.data[l];if(u.flags&t.b2ParticleFlag.b2_elasticParticle){var c=u.indexA,p=u.indexB,f=u.indexC,d=u.pa,y=u.pb,v=u.pc,x=i.Copy(m[c]),B=s.Copy(m[p]),S=r.Copy(m[f]),A=_[c],b=_[p],C=_[f];x.SelfMulAdd(e.dt,A),B.SelfMulAdd(e.dt,b),S.SelfMulAdd(e.dt,C);var V=(x.x+B.x+S.x)/3,g=(x.y+B.y+S.y)/3;x.x-=V,x.y-=g,B.x-=V,B.y-=g,S.x-=V,S.y-=g;var w=n;w.s=N.CrossVV(d,x)+N.CrossVV(y,B)+N.CrossVV(v,S),w.c=N.DotVV(d,x)+N.DotVV(y,B)+N.DotVV(v,S);var M=F(w.s*w.s+w.c*w.c);isFinite(M)||(M=198177537e11),w.s*=M,w.c*=M;var P=h*u.strength;Z.MulRV(w,d,a),N.SubVV(a,x,a),N.MulSV(P,a,a),A.SelfAdd(a),Z.MulRV(w,y,a),N.SubVV(a,B,a),N.MulSV(P,a,a),b.SelfAdd(a),Z.MulRV(w,v,a),N.SubVV(a,S,a),N.MulSV(P,a,a),C.SelfAdd(a)}}},o.prototype.SolveSpring=function(e){var i=o.SolveSpring_s_pa,s=o.SolveSpring_s_pb,r=o.SolveSpring_s_d,n=o.SolveSpring_s_f;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var a=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,_=e.inv_dt*this.m_def.springStrength,h=0;h<this.m_pairBuffer.count;h++){var l=this.m_pairBuffer.data[h];if(l.flags&t.b2ParticleFlag.b2_springParticle){var u=l.indexA,c=l.indexB,p=i.Copy(a[u]),f=s.Copy(a[c]),d=m[u],y=m[c];p.SelfMulAdd(e.dt,d),f.SelfMulAdd(e.dt,y);var v=N.SubVV(f,p,r),x=l.distance,B=v.Length(),S=_*l.strength,A=N.MulSV(S*(x-B)/B,v,n);d.SelfSub(A),y.SelfAdd(A)}}},o.prototype.SolveTensile=function(e){var i=o.SolveTensile_s_weightedNormal,s=o.SolveTensile_s_s,r=o.SolveTensile_s_f;if(!this.m_velocityBuffer.data)throw new Error;for(var n=this.m_velocityBuffer.data,a=0;a<this.m_count;a++)this.m_accumulation2Buffer[a]=new N,this.m_accumulation2Buffer[a].SetZero();for(var m=0;m<this.m_contactBuffer.count;m++)if((v=this.m_contactBuffer.data[m]).flags&t.b2ParticleFlag.b2_tensileParticle){var _=v.indexA,h=v.indexB,l=v.weight,u=v.normal,c=N.MulSV((1-l)*l,u,i);this.m_accumulation2Buffer[_].SelfSub(c),this.m_accumulation2Buffer[h].SelfAdd(c)}var p=this.GetCriticalVelocity(e),f=this.m_def.surfaceTensionPressureStrength*p,d=this.m_def.surfaceTensionNormalStrength*p,y=.5*p;for(m=0;m<this.m_contactBuffer.count;m++){var v;if((v=this.m_contactBuffer.data[m]).flags&t.b2ParticleFlag.b2_tensileParticle){_=v.indexA,h=v.indexB,l=v.weight,u=v.normal;var x=this.m_weightBuffer[_]+this.m_weightBuffer[h],B=N.SubVV(this.m_accumulation2Buffer[h],this.m_accumulation2Buffer[_],s),S=M(f*(x-2)+d*N.DotVV(B,u),y)*l,A=N.MulSV(S,u,r);n[_].SelfSub(A),n[h].SelfAdd(A)}}},o.prototype.SolveViscous=function(){var e=o.SolveViscous_s_v,i=o.SolveViscous_s_f;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=this.m_def.viscousStrength,a=this.GetParticleInvMass(),m=0;m<this.m_bodyContactBuffer.count;m++){var _=(d=this.m_bodyContactBuffer.data[m]).index;if(this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_viscousParticle){var h=d.body,l=d.weight,u=d.mass,c=s[_],p=N.SubVV(h.GetLinearVelocityFromWorldPoint(c,N.s_t0),r[_],e),f=N.MulSV(n*u*l,p,i);r[_].SelfMulAdd(a,f),h.ApplyLinearImpulse(f.SelfNeg(),c,!0)}}for(m=0;m<this.m_contactBuffer.count;m++){var d;(d=this.m_contactBuffer.data[m]).flags&t.b2ParticleFlag.b2_viscousParticle&&(_=d.indexA,h=d.indexB,l=d.weight,p=N.SubVV(r[h],r[_],e),f=N.MulSV(n*l,p,i),r[_].SelfAdd(f),r[h].SelfSub(f))}},o.prototype.SolveRepulsive=function(e){var i=o.SolveRepulsive_s_f;if(!this.m_velocityBuffer.data)throw new Error;for(var s=this.m_velocityBuffer.data,r=this.m_def.repulsiveStrength*this.GetCriticalVelocity(e),n=0;n<this.m_contactBuffer.count;n++){var a=this.m_contactBuffer.data[n];if(a.flags&t.b2ParticleFlag.b2_repulsiveParticle){var m=a.indexA,_=a.indexB;if(this.m_groupBuffer[m]!==this.m_groupBuffer[_]){var h=a.weight,l=a.normal,u=N.MulSV(r*h,l,i);s[m].SelfSub(u),s[_].SelfAdd(u)}}}},o.prototype.SolvePowder=function(e){var i=o.SolvePowder_s_f;if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=this.m_def.powderStrength*this.GetCriticalVelocity(e),a=.25,m=this.GetParticleInvMass(),_=0;_<this.m_bodyContactBuffer.count;_++){var h=(d=this.m_bodyContactBuffer.data[_]).index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_powderParticle&&(y=d.weight)>a){var l=d.body,u=d.mass,c=s[h],p=d.normal,f=N.MulSV(n*u*(y-a),p,i);r[h].SelfMulSub(m,f),l.ApplyLinearImpulse(f,c,!0)}}for(_=0;_<this.m_contactBuffer.count;_++){var d,y;(d=this.m_contactBuffer.data[_]).flags&t.b2ParticleFlag.b2_powderParticle&&(y=d.weight)>a&&(h=d.indexA,l=d.indexB,p=d.normal,f=N.MulSV(n*(y-a),p,i),r[h].SelfSub(f),r[l].SelfAdd(f))}},o.prototype.SolveSolid=function(t){var e=o.SolveSolid_s_f;if(!this.m_velocityBuffer.data)throw new Error;var i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var s=t.inv_dt*this.m_def.ejectionStrength,r=0;r<this.m_contactBuffer.count;r++){var n=this.m_contactBuffer.data[r],a=n.indexA,m=n.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[m]){var _=n.weight,h=n.normal,l=this.m_depthBuffer[a]+this.m_depthBuffer[m],u=N.MulSV(s*l*_,h,e);i[a].SelfSub(u),i[m].SelfAdd(u)}}},o.prototype.SolveForce=function(t){if(!this.m_velocityBuffer.data)throw new Error;for(var e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass(),o=0;o<this.m_count;o++)e[o].SelfMulAdd(i,this.m_forceBuffer[o]);this.m_hasForce=!1},o.prototype.SolveColorMixing=function(){if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_colorBuffer.data)throw new Error;var e=.5*this.m_def.colorMixingStrength;if(e)for(var i=0;i<this.m_contactBuffer.count;i++){var o=this.m_contactBuffer.data[i],s=o.indexA,r=o.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_colorMixingParticle){var n=this.m_colorBuffer.data[s],a=this.m_colorBuffer.data[r];Q.MixColors(n,a,e)}}},o.prototype.SolveZombie=function(){if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;for(var e=0,i=[],o=0;o<this.m_count;o++)i[o]=p;var s=0;for(o=0;o<this.m_count;o++){var r=this.m_flagsBuffer.data[o];if(r&t.b2ParticleFlag.b2_zombieParticle){var n=this.m_world.m_destructionListener;r&t.b2ParticleFlag.b2_destructionListenerParticle&&n&&n.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data&&(a=this.m_handleIndexBuffer.data[o])&&(a.SetIndex(p),this.m_handleIndexBuffer.data[o]=null),i[o]=p}else{var a;if(i[o]=e,o!==e)this.m_handleIndexBuffer.data&&((a=this.m_handleIndexBuffer.data[o])&&a.SetIndex(e),this.m_handleIndexBuffer.data[e]=a),this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o]);e++,s|=r}}for(var m=function(t){return t.index<0},_=function(t){return t.indexA<0||t.indexB<0},h=function(t){return t.index<0},l=function(t){return t.indexA<0||t.indexB<0},u=function(t){return t.indexA<0||t.indexB<0||t.indexC<0},c=0;c<this.m_proxyBuffer.count;c++){var f=this.m_proxyBuffer.data[c];f.index=i[f.index]}for(this.m_proxyBuffer.RemoveIf(m),c=0;c<this.m_contactBuffer.count;c++)(d=this.m_contactBuffer.data[c]).indexA=i[d.indexA],d.indexB=i[d.indexB];for(this.m_contactBuffer.RemoveIf(_),c=0;c<this.m_bodyContactBuffer.count;c++){var d;(d=this.m_bodyContactBuffer.data[c]).index=i[d.index]}for(this.m_bodyContactBuffer.RemoveIf(h),c=0;c<this.m_pairBuffer.count;c++){var y=this.m_pairBuffer.data[c];y.indexA=i[y.indexA],y.indexB=i[y.indexB]}for(this.m_pairBuffer.RemoveIf(l),c=0;c<this.m_triadBuffer.count;c++){var v=this.m_triadBuffer.data[c];v.indexA=i[v.indexA],v.indexB=i[v.indexB],v.indexC=i[v.indexC]}if(this.m_triadBuffer.RemoveIf(u),this.m_indexByExpirationTimeBuffer.data)for(var x=0,B=0;B<this.m_count;B++){var S=i[this.m_indexByExpirationTimeBuffer.data[B]];S!==p&&(this.m_indexByExpirationTimeBuffer.data[x++]=S)}for(var A=this.m_groupList;A;A=A.GetNext()){var b=e,C=0,V=!1;for(o=A.m_firstIndex;o<A.m_lastIndex;o++){var g=i[o];g>=0?(b=M(b,g),C=P(C,g+1)):V=!0}b<C?(A.m_firstIndex=b,A.m_lastIndex=C,V&&A.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(A,A.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(A.m_firstIndex=0,A.m_lastIndex=0,A.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(A,A.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}for(this.m_count=e,this.m_allParticleFlags=s,this.m_needsUpdateAllParticleFlags=!1,A=this.m_groupList;A;){var w=A.GetNext();A.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(A),A=w}},o.prototype.SolveLifetimes=function(t){if(!this.m_expirationTimeBuffer.data)throw new Error;if(!this.m_indexByExpirationTimeBuffer.data)throw new Error;this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,o=this.m_indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Zo(o,0,s,(function(t,e){var o=i[t],s=i[e],r=o<=0;return r===s<=0?o>s:r})),this.m_expirationTimeBufferRequiresSorting=!1);for(var r=s-1;r>=0;--r){var n=o[r],a=i[n];if(e<a||a<=0)break;this.DestroyParticle(n)}},o.prototype.RotateBuffer=function(t,e,i){if(t!==e&&e!==i){if(!this.m_flagsBuffer.data)throw new Error;if(!this.m_positionBuffer.data)throw new Error;if(!this.m_velocityBuffer.data)throw new Error;if(Ko(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Ko(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Ko(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Ko(this.m_consecutiveContactStepsBuffer.data,t,e,i),Ko(this.m_positionBuffer.data,t,e,i),Ko(this.m_velocityBuffer.data,t,e,i),Ko(this.m_groupBuffer,t,e,i),this.m_hasForce&&Ko(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Ko(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Ko(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Ko(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Ko(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Ko(this.m_handleIndexBuffer.data,t,e,i);for(var o=t;o<i;++o){var s=this.m_handleIndexBuffer.data[o];s&&s.SetIndex(c(s.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Ko(this.m_expirationTimeBuffer.data,t,e,i);var r=this.GetParticleCount();if(!this.m_indexByExpirationTimeBuffer.data)throw new Error;var n=this.m_indexByExpirationTimeBuffer.data;for(o=0;o<r;++o)n[o]=c(n[o])}for(var a=0;a<this.m_proxyBuffer.count;a++){var m=this.m_proxyBuffer.data[a];m.index=c(m.index)}for(a=0;a<this.m_contactBuffer.count;a++)(_=this.m_contactBuffer.data[a]).indexA=c(_.indexA),_.indexB=c(_.indexB);for(a=0;a<this.m_bodyContactBuffer.count;a++){var _;(_=this.m_bodyContactBuffer.data[a]).index=c(_.index)}for(a=0;a<this.m_pairBuffer.count;a++){var h=this.m_pairBuffer.data[a];h.indexA=c(h.indexA),h.indexB=c(h.indexB)}for(a=0;a<this.m_triadBuffer.count;a++){var l=this.m_triadBuffer.data[a];l.indexA=c(l.indexA),l.indexB=c(l.indexB),l.indexC=c(l.indexC)}for(var u=this.m_groupList;u;u=u.GetNext())u.m_firstIndex=c(u.m_firstIndex),u.m_lastIndex=c(u.m_lastIndex-1)+1}function c(o){return o<t?o:o<e?o+i-e:o<i?o+t-e:o}},o.prototype.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},o.prototype.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},o.prototype.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},o.prototype.GetParticleStride=function(){return f*this.m_particleDiameter},o.prototype.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},o.prototype.GetParticleInvMass=function(){var t=1.3333333333333333*this.m_inverseDiameter;return this.m_inverseDensity*t*t},o.prototype.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},o.prototype.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},o.prototype.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},o.prototype.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},o.prototype.SetUserOverridableBuffer=function(t,e,i){t.data=e,t.userSuppliedCapacity=i},o.prototype.SetGroupFlags=function(e,i){var o=e.m_groupFlags;(o^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),o&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i},o.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},o.prototype.RemoveSpuriousBodyContacts=function(){Zo(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,o.BodyContactCompare);var t=o.RemoveSpuriousBodyContacts_s_n,e=o.RemoveSpuriousBodyContacts_s_pos,i=o.RemoveSpuriousBodyContacts_s_normal,s=this,r=-1,n=0;this.m_bodyContactBuffer.count=Ho(this.m_bodyContactBuffer.data,(function(o){if(o.index!==r&&(n=0,r=o.index),n++>3)return!0;var m=t.Copy(o.normal);if(m.SelfMul(s.m_particleDiameter*(1-o.weight)),!s.m_positionBuffer.data)throw new Error;var _=N.AddVV(s.m_positionBuffer.data[o.index],m,e);if(!o.fixture.TestPoint(_)){for(var h=o.fixture.GetShape().GetChildCount(),l=0;l<h;l++){var u=i;if(o.fixture.ComputeDistance(_,u,l)<a)return!1}return!0}return!1}),this.m_bodyContactBuffer.count)},o.prototype.DetectStuckParticle=function(t){if(!(this.m_stuckThreshold<=0)){if(!this.m_bodyContactCountBuffer.data)throw new Error;if(!this.m_consecutiveContactStepsBuffer.data)throw new Error;if(!this.m_lastBodyContactStepBuffer.data)throw new Error;++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp}},o.prototype.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==p},o.prototype.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},o.prototype.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},o.prototype.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},o.prototype.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},o.prototype.IsRigidGroup=function(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},o.prototype.GetLinearVelocity=function(t,e,i,o){if(t&&this.IsRigidGroup(t))return t.GetLinearVelocityFromWorldPoint(i,o);if(!this.m_velocityBuffer.data)throw new Error;return o.Copy(this.m_velocityBuffer.data[e])},o.prototype.InitDampingParameter=function(t,e,i,o,s,r,n,a){t[0]=o>0?1/o:0,e[0]=s>0?1/s:0,i[0]=N.CrossVV(N.SubVV(n,r,N.s_t0),a)},o.prototype.InitDampingParameterWithRigidGroupOrParticle=function(e,i,o,s,r,n,a,m){if(r&&s)this.InitDampingParameter(e,i,o,r.GetMass(),r.GetInertia(),r.GetCenter(),a,m);else{if(!this.m_flagsBuffer.data)throw new Error;var _=this.m_flagsBuffer.data[n];this.InitDampingParameter(e,i,o,_&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,m)}},o.prototype.ComputeDampingImpulse=function(t,e,i,o,s,r,n){var a=t+e*i*i+o+s*r*r;return a>0?n/a:0},o.prototype.ApplyDamping=function(t,e,i,o,s,r,n,a){if(s&&o)s.m_linearVelocity.SelfMulAdd(n*t,a),s.m_angularVelocity+=n*i*e;else{if(!this.m_velocityBuffer.data)throw new Error;this.m_velocityBuffer.data[r].SelfMulAdd(n*t,a)}},o.xTruncBits=12,o.yTruncBits=12,o.tagBits=32,o.yOffset=1<<o.yTruncBits-1,o.yShift=o.tagBits-o.yTruncBits,o.xShift=o.tagBits-o.yTruncBits-o.xTruncBits,o.xScale=1<<o.xShift,o.xOffset=o.xScale*(1<<o.xTruncBits-1),o.yMask=(1<<o.yTruncBits)-1<<o.yShift,o.xMask=~o.yMask,o.DestroyParticlesInShape_s_aabb=new zt,o.CreateParticleGroup_s_transform=new W,o.ComputeCollisionEnergy_s_v=new N,o.QueryShapeAABB_s_aabb=new zt,o.QueryPointAABB_s_aabb=new zt,o.RayCast_s_aabb=new zt,o.RayCast_s_p=new N,o.RayCast_s_v=new N,o.RayCast_s_n=new N,o.RayCast_s_point=new N,o.k_pairFlags=t.b2ParticleFlag.b2_springParticle,o.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,o.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,o.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,o.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,o.CreateParticlesStrokeShapeForGroup_s_edge=new vi,o.CreateParticlesStrokeShapeForGroup_s_d=new N,o.CreateParticlesStrokeShapeForGroup_s_p=new N,o.CreateParticlesFillShapeForGroup_s_aabb=new zt,o.CreateParticlesFillShapeForGroup_s_p=new N,o.UpdatePairsAndTriads_s_dab=new N,o.UpdatePairsAndTriads_s_dbc=new N,o.UpdatePairsAndTriads_s_dca=new N,o.AddContact_s_d=new N,o.UpdateBodyContacts_s_aabb=new zt,o.Solve_s_subStep=new Vo,o.SolveCollision_s_aabb=new zt,o.SolveGravity_s_gravity=new N,o.SolveBarrier_s_aabb=new zt,o.SolveBarrier_s_va=new N,o.SolveBarrier_s_vb=new N,o.SolveBarrier_s_pba=new N,o.SolveBarrier_s_vba=new N,o.SolveBarrier_s_vc=new N,o.SolveBarrier_s_pca=new N,o.SolveBarrier_s_vca=new N,o.SolveBarrier_s_qba=new N,o.SolveBarrier_s_qca=new N,o.SolveBarrier_s_dv=new N,o.SolveBarrier_s_f=new N,o.SolvePressure_s_f=new N,o.SolveDamping_s_v=new N,o.SolveDamping_s_f=new N,o.SolveRigidDamping_s_t0=new N,o.SolveRigidDamping_s_t1=new N,o.SolveRigidDamping_s_p=new N,o.SolveRigidDamping_s_v=new N,o.SolveExtraDamping_s_v=new N,o.SolveExtraDamping_s_f=new N,o.SolveRigid_s_position=new N,o.SolveRigid_s_rotation=new Z,o.SolveRigid_s_transform=new W,o.SolveRigid_s_velocityTransform=new W,o.SolveElastic_s_pa=new N,o.SolveElastic_s_pb=new N,o.SolveElastic_s_pc=new N,o.SolveElastic_s_r=new Z,o.SolveElastic_s_t0=new N,o.SolveSpring_s_pa=new N,o.SolveSpring_s_pb=new N,o.SolveSpring_s_d=new N,o.SolveSpring_s_f=new N,o.SolveTensile_s_weightedNormal=new N,o.SolveTensile_s_s=new N,o.SolveTensile_s_f=new N,o.SolveViscous_s_v=new N,o.SolveViscous_s_f=new N,o.SolveRepulsive_s_f=new N,o.SolvePowder_s_f=new N,o.SolveSolid_s_f=new N,o.RemoveSpuriousBodyContacts_s_n=new N,o.RemoveSpuriousBodyContacts_s_pos=new N,o.RemoveSpuriousBodyContacts_s_normal=new N,o}(),function(e){var o=function(){this.data=null,this.userSuppliedCapacity=0};e.UserOverridableBuffer=o;var s=function(){function t(){this.index=p,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}();e.Proxy=s;var r=function(){function t(t,i,o,s,r){this.m_system=t,this.m_xLower=(i&e.xMask)>>>0,this.m_xUpper=(o&e.xMask)>>>0,this.m_yLower=(i&e.yMask)>>>0,this.m_yUpper=(o&e.yMask)>>>0,this.m_first=s,this.m_last=r}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&e.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return p},t}();e.InsideBoundsEnumerator=r;var n=function(){this.next=null,this.count=0,this.index=0};e.ParticleListNode=n;var m=function(){function t(){}return t.prototype.Allocate=function(t,e){return e},t.prototype.Clear=function(){},t.prototype.GetCount=function(){return 0},t.prototype.Invalidate=function(t){},t.prototype.GetValidBuffer=function(){return[]},t.prototype.GetBuffer=function(){return[]},t.prototype.SetCount=function(t){},t}();e.FixedSetAllocator=m;var _=function(t,e){this.second=p,this.first=t,this.second=e};e.FixtureParticle=_;var h=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return pi(e,t),e.prototype.Initialize=function(t,e){},e.prototype.Find=function(t){return p},e}(e.FixedSetAllocator);e.FixtureParticleSet=h;var l=function(t,e){this.first=p,this.second=p,this.first=t,this.second=e};e.ParticlePair=l;var u=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return pi(e,t),e.prototype.Initialize=function(t,e){},e.prototype.Find=function(t){return p},e}(e.FixedSetAllocator);e.b2ParticlePairSet=u;var c=function(){function t(){}return t.prototype.IsNecessary=function(t){return!0},t.prototype.ShouldCreatePair=function(t,e){return!0},t.prototype.ShouldCreateTriad=function(t,e,i){return!0},t}();e.ConnectionFilter=c;var f=function(t){function e(e,i,o,s){var r=t.call(this)||this;return r.m_callDestructionListener=!1,r.m_destroyed=0,r.m_system=e,r.m_shape=i,r.m_xf=o,r.m_callDestructionListener=s,r.m_destroyed=0,r}return pi(e,t),e.prototype.ReportFixture=function(t){return!1},e.prototype.ReportParticle=function(t,e){if(t!==this.m_system)return!1;if(!this.m_system.m_positionBuffer.data)throw new Error;return this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0},e.prototype.Destroyed=function(){return this.m_destroyed},e}(So);e.DestroyParticlesInShapeCallback=f;var d=function(t){function e(e){var i=t.call(this)||this;return i.m_threshold=0,i.m_threshold=e,i}return pi(e,t),e.prototype.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},e.prototype.ShouldCreateTriad=function(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)},e}(e.ConnectionFilter);e.JoinParticleGroupsFilter=d;var y=function(e){function o(i,o){void 0===o&&(o=i.length);var s=e.call(this,t.b2ShapeType.e_unknown,0)||this;return s.m_shapeCount=0,s.m_shapes=i,s.m_shapeCount=o,s}return pi(o,e),o.prototype.Clone=function(){throw new Error},o.prototype.GetChildCount=function(){return 1},o.prototype.TestPoint=function(t,e){for(var i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1},o.prototype.ComputeDistance=function(t,e,i,o){return 0},o.prototype.RayCast=function(t,e,i,o){return!1},o.prototype.ComputeAABB=function(t,e,o){var s=new zt;t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var r=0;r<this.m_shapeCount;r++)for(var n=this.m_shapes[r].GetChildCount(),a=0;a<n;a++){var m=s;this.m_shapes[r].ComputeAABB(m,e,a),t.Combine1(m)}},o.prototype.ComputeMass=function(t,e){},o.prototype.SetupDistanceProxy=function(t,e){},o.prototype.ComputeSubmergedArea=function(t,e,i,o){return 0},o.prototype.Dump=function(t){},o}(ui);e.CompositeShape=y;var v=function(e){function i(t){var i=e.call(this)||this;return i.m_flagsBuffer=t,i}return pi(i,e),i.prototype.IsNecessary=function(e){if(!this.m_flagsBuffer.data)throw new Error;return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},i}(e.ConnectionFilter);e.ReactiveFilter=v;var x=function(i){function o(t,e){var o=i.call(this,t)||this;return o.m_contactFilter=e,o}return pi(o,i),o.prototype.ShouldCollideFixtureParticle=function(e,i,o){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[o]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,o)},o.prototype.ReportFixtureAndParticle=function(i,o,s){var r=e.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_n,n=e.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_rp;if(!this.m_system.m_flagsBuffer.data)throw new Error;if(!this.m_system.m_positionBuffer.data)throw new Error;var a=this.m_system.m_positionBuffer.data[s],m=r,_=i.ComputeDistance(a,m,o);if(_<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(i,this.m_system,s)){var h=i.GetBody(),l=h.GetWorldCenter(),u=h.GetMass(),c=h.GetInertia()-u*h.GetLocalCenter().LengthSquared(),p=u>0?1/u:0,f=c>0?1/c:0,d=this.m_system.m_flagsBuffer.data[s]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),y=N.SubVV(a,l,n),v=N.CrossVV(y,m),x=d+p+f*v*v,B=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];B.index=s,B.body=h,B.fixture=i,B.weight=1-_*this.m_system.m_inverseDiameter,B.normal.Copy(m.SelfNeg()),B.mass=x>0?1/x:0,this.m_system.DetectStuckParticle(s)}},o.ReportFixtureAndParticle_s_n=new N,o.ReportFixtureAndParticle_s_rp=new N,o}(ts);e.UpdateBodyContactsCallback=x;var B=function(i){function o(t,e){var o=i.call(this,t)||this;return o.m_step=e,o}return pi(o,i),o.prototype.ReportFixtureAndParticle=function(i,o,s){var r=e.SolveCollisionCallback.ReportFixtureAndParticle_s_p1,n=e.SolveCollisionCallback.ReportFixtureAndParticle_s_output,m=e.SolveCollisionCallback.ReportFixtureAndParticle_s_input,_=e.SolveCollisionCallback.ReportFixtureAndParticle_s_p,h=e.SolveCollisionCallback.ReportFixtureAndParticle_s_v,l=e.SolveCollisionCallback.ReportFixtureAndParticle_s_f,u=i.GetBody();if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var c=this.m_system.m_positionBuffer.data[s],p=this.m_system.m_velocityBuffer.data[s],f=n,d=m;if(0===this.m_system.m_iterationIndex){var y=W.MulTXV(u.m_xf0,c,r);i.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(y.SelfSub(u.GetLocalCenter()),Z.MulRV(u.m_xf0.q,y,y),Z.MulTRV(u.m_xf.q,y,y),y.SelfAdd(u.GetLocalCenter())),W.MulXV(u.m_xf,y,d.p1)}else d.p1.Copy(c);if(N.AddVMulSV(c,this.m_step.dt,p,d.p2),d.maxFraction=1,i.RayCast(f,d,o)){var v=f.normal,x=_;x.x=(1-f.fraction)*d.p1.x+f.fraction*d.p2.x+a*v.x,x.y=(1-f.fraction)*d.p1.y+f.fraction*d.p2.y+a*v.y;var B=h;B.x=this.m_step.inv_dt*(x.x-c.x),B.y=this.m_step.inv_dt*(x.y-c.y),this.m_system.m_velocityBuffer.data[s].Copy(B);var S=l;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.x-B.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.y-B.y),this.m_system.ParticleApplyForce(s,S)}},o.prototype.ReportParticle=function(t,e){return!1},o.ReportFixtureAndParticle_s_p1=new N,o.ReportFixtureAndParticle_s_output=new qt,o.ReportFixtureAndParticle_s_input=new kt,o.ReportFixtureAndParticle_s_p=new N,o.ReportFixtureAndParticle_s_v=new N,o.ReportFixtureAndParticle_s_f=new N,o}(ts);e.SolveCollisionCallback=B}(t.b2ParticleSystem||(t.b2ParticleSystem={}));var ns=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new bo,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new N,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Co,this.m_island=new Ro,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}return e.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},e.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},e.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},e.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},e.prototype.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new wi(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},e.prototype.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var o=t.m_controllerList;o;){var s=o;o=o.nextController,s.controller.RemoveBody(t)}for(var r=t.m_contactList;r;){var n=r;r=r.next,this.m_contactManager.Destroy(n.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var m=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(m),m.DestroyProxies(),m.Destroy(),t.m_fixtureList=a,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e,i){switch(e.type){case t.b2JointType.e_distanceJoint:return new Fi(e);case t.b2JointType.e_mouseJoint:return new ji(e);case t.b2JointType.e_prismaticJoint:return new Xi(e);case t.b2JointType.e_revoluteJoint:return new Hi(e);case t.b2JointType.e_pulleyJoint:return new Zi(e);case t.b2JointType.e_gearJoint:return new zi(e);case t.b2JointType.e_wheelJoint:return new eo(e);case t.b2JointType.e_weldJoint:return new $i(e);case t.b2JointType.e_frictionJoint:return new ki(e);case t.b2JointType.e_ropeJoint:return new Yi(e);case t.b2JointType.e_motorJoint:return new Ji(e);case t.b2JointType.e_areaJoint:return new Li(e)}throw new Error},e._Joint_Destroy=function(t,e){},e.prototype.CreateJoint=function(t){if(this.IsLocked())throw new Error;var i=e._Joint_Create(t,null);i.m_prev=null,i.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=i),this.m_jointList=i,++this.m_jointCount,i.m_edgeA.prev=null,i.m_edgeA.next=i.m_bodyA.m_jointList,i.m_bodyA.m_jointList&&(i.m_bodyA.m_jointList.prev=i.m_edgeA),i.m_bodyA.m_jointList=i.m_edgeA,i.m_edgeB.prev=null,i.m_edgeB.next=i.m_bodyB.m_jointList,i.m_bodyB.m_jointList&&(i.m_bodyB.m_jointList.prev=i.m_edgeB),i.m_bodyB.m_jointList=i.m_edgeB;var o=t.bodyA,s=t.bodyB;if(!t.collideConnected)for(var r=s.GetContactList();r;)r.other===o&&r.contact.FlagForFiltering(),r=r.next;return i},e.prototype.DestroyJoint=function(t){if(this.IsLocked())throw new Error;var i=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var o=t.m_bodyA,s=t.m_bodyB;if(o.SetAwake(!0),s.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===o.m_jointList&&(o.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===s.m_jointList&&(s.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,e._Joint_Destroy(t,null),--this.m_jointCount,!i)for(var r=s.GetContactList();r;)r.other===o&&r.contact.FlagForFiltering(),r=r.next},e.prototype.CreateParticleSystem=function(e){if(this.IsLocked())throw new Error;var i=new t.b2ParticleSystem(e,this);return i.m_prev=null,i.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=i),this.m_particleSystemList=i,i},e.prototype.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},e.prototype.CalculateReasonableParticleIterations=function(t){return null===this.m_particleSystemList?1:qo(this.m_gravity.Length(),function(t){for(var e=i,o=t.GetParticleSystemList();null!==o;o=o.m_next)e=M(e,o.GetRadius());return e}(this),t)},e.prototype.Step=function(t,i,o,s){void 0===s&&(s=this.CalculateReasonableParticleIterations(t));var r=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var n=e.Step_s_step;n.dt=t,n.velocityIterations=i,n.positionIterations=o,n.particleIterations=s,n.inv_dt=t>0?1/t:0,n.dtRatio=this.m_inv_dt0*t,n.warmStarting=this.m_warmStarting;var a=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=a.GetMilliseconds(),this.m_stepComplete&&n.dt>0){for(var m=e.Step_s_timer.Reset(),_=this.m_particleSystemList;_;_=_.m_next)_.Solve(n);this.Solve(n),this.m_profile.solve=m.GetMilliseconds()}if(this.m_continuousPhysics&&n.dt>0){var h=e.Step_s_timer.Reset();this.SolveTOI(n),this.m_profile.solveTOI=h.GetMilliseconds()}n.dt>0&&(this.m_inv_dt0=n.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=r.GetMilliseconds()},e.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},e.prototype.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var i=t.GetRadius(),o=t.GetPositionBuffer();if(t.m_colorBuffer.data){var s=t.GetColorBuffer();this.m_debugDraw.DrawParticles(o,i,s,e)}else this.m_debugDraw.DrawParticles(o,i,null,e)}}},e.prototype.DrawDebugData=function(){if(null!==this.m_debugDraw){var i=this.m_debugDraw.GetFlags(),o=e.DrawDebugData_s_color.SetRGB(0,0,0);if(i&t.b2DrawFlags.e_shapeBit)for(var s=this.m_bodyList;s;s=s.m_next){var r=s.m_xf;this.m_debugDraw.PushTransform(r);for(var n=s.GetFixtureList();n;n=n.m_next)s.IsActive()?s.GetType()===t.b2BodyType.b2_staticBody?(o.SetRGB(.5,.9,.5),this.DrawShape(n,o)):s.GetType()===t.b2BodyType.b2_kinematicBody?(o.SetRGB(.5,.5,.9),this.DrawShape(n,o)):s.IsAwake()?(o.SetRGB(.9,.7,.7),this.DrawShape(n,o)):(o.SetRGB(.6,.6,.6),this.DrawShape(n,o)):(o.SetRGB(.5,.5,.3),this.DrawShape(n,o));this.m_debugDraw.PopTransform(r)}if(i&t.b2DrawFlags.e_particleBit)for(var a=this.m_particleSystemList;a;a=a.m_next)this.DrawParticleSystem(a);if(i&t.b2DrawFlags.e_jointBit)for(var m=this.m_jointList;m;m=m.m_next)this.DrawJoint(m);if(i&t.b2DrawFlags.e_aabbBit){o.SetRGB(.9,.3,.9);var _=e.DrawDebugData_s_vs;for(s=this.m_bodyList;s;s=s.m_next)if(s.IsActive())for(n=s.GetFixtureList();n;n=n.m_next)for(var h=0;h<n.m_proxyCount;++h){var l=n.m_proxies[h].treeNode.aabb;_[0].Set(l.lowerBound.x,l.lowerBound.y),_[1].Set(l.upperBound.x,l.lowerBound.y),_[2].Set(l.upperBound.x,l.upperBound.y),_[3].Set(l.lowerBound.x,l.upperBound.y),this.m_debugDraw.DrawPolygon(_,4,o)}}if(i&t.b2DrawFlags.e_centerOfMassBit)for(s=this.m_bodyList;s;s=s.m_next)(r=e.DrawDebugData_s_xf).q.Copy(s.m_xf.q),r.p.Copy(s.GetWorldCenter()),this.m_debugDraw.DrawTransform(r);if(i&t.b2DrawFlags.e_controllerBit)for(var u=this.m_controllerList;u;u=u.m_next)u.Draw(this.m_debugDraw)}},e.prototype.QueryAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var o=e.userData.fixture;return t?t.ReportFixture(o):!i||i(o)})),t instanceof So)for(var o=this.m_particleSystemList;o;o=o.m_next)t.ShouldQueryParticleSystem(o)&&o.QueryAABB(t,e)},e.prototype.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(null,t,(function(t){return e.push(t),!0})),e},e.prototype.QueryPointAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var o=e.userData.fixture;return t?t.ReportFixture(o):!i||i(o)})),t instanceof So)for(var o=this.m_particleSystemList;o;o=o.m_next)t.ShouldQueryParticleSystem(o)&&o.QueryPointAABB(t,e)},e.prototype.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(null,t,(function(t){return e.push(t),!0})),e},e.prototype.QueryFixtureShape=function(t,i,o,s,r){var n=e.QueryFixtureShape_s_aabb;if(i.ComputeAABB(n,s,o),this.m_contactManager.m_broadPhase.Query(n,(function(e){var n=e.userData,a=n.fixture;if(Xt(i,o,a.GetShape(),n.childIndex,s,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(r)return r(a)}return!0})),t instanceof So)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.QueryAABB(t,n)},e.prototype.QueryAllFixtureShape=function(t,e,i,o){return void 0===o&&(o=[]),this.QueryFixtureShape(null,t,e,i,(function(t){return o.push(t),!0})),o},e.prototype.QueryFixturePoint=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(o){var s=o.userData.fixture;if(s.TestPoint(e)){if(t)return t.ReportFixture(s);if(i)return i(s)}return!0})),t)for(var o=this.m_particleSystemList;o;o=o.m_next)t.ShouldQueryParticleSystem(o)&&o.QueryPointAABB(t,e)},e.prototype.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(null,t,(function(t){return e.push(t),!0})),e},e.prototype.RayCast=function(t,i,o,s){var r=e.RayCast_s_input;if(r.maxFraction=1,r.p1.Copy(i),r.p2.Copy(o),this.m_contactManager.m_broadPhase.RayCast(r,(function(r,n){var a=n.userData,m=a.fixture,_=a.childIndex,h=e.RayCast_s_output;if(m.RayCast(h,r,_)){var l=h.fraction,u=e.RayCast_s_point;if(u.Set((1-l)*i.x+l*o.x,(1-l)*i.y+l*o.y),t)return t.ReportFixture(m,u,h.normal,l);if(s)return s(m,u,h.normal,l)}return r.maxFraction})),t)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.RayCast(t,i,o)},e.prototype.RayCastOne=function(t,e){var i=null,o=1;return this.RayCast(null,t,e,(function(t,e,s,r){return r<o&&(o=r,i=t),o})),i},e.prototype.RayCastAll=function(t,e,i){return void 0===i&&(i=[]),this.RayCast(null,t,e,(function(t,e,o,s){return i.push(t),1})),i},e.prototype.GetBodyList=function(){return this.m_bodyList},e.prototype.GetJointList=function(){return this.m_jointList},e.prototype.GetParticleSystemList=function(){return this.m_particleSystemList},e.prototype.GetContactList=function(){return this.m_contactManager.m_contactList},e.prototype.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},e.prototype.GetAllowSleeping=function(){return this.m_allowSleep},e.prototype.SetWarmStarting=function(t){this.m_warmStarting=t},e.prototype.GetWarmStarting=function(){return this.m_warmStarting},e.prototype.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},e.prototype.GetContinuousPhysics=function(){return this.m_continuousPhysics},e.prototype.SetSubStepping=function(t){this.m_subStepping=t},e.prototype.GetSubStepping=function(){return this.m_subStepping},e.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},e.prototype.GetBodyCount=function(){return this.m_bodyCount},e.prototype.GetJointCount=function(){return this.m_jointCount},e.prototype.GetContactCount=function(){return this.m_contactManager.m_contactCount},e.prototype.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},e.prototype.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},e.prototype.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},e.prototype.SetGravity=function(t,e){if(void 0===e&&(e=!0),!N.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)},e.prototype.GetGravity=function(){return this.m_gravity},e.prototype.IsLocked=function(){return this.m_locked},e.prototype.SetAutoClearForces=function(t){this.m_clearForces=t},e.prototype.GetAutoClearForces=function(){return this.m_clearForces},e.prototype.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var i=this.m_jointList;i;i=i.m_next)i.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},e.prototype.GetContactManager=function(){return this.m_contactManager},e.prototype.GetProfile=function(){return this.m_profile},e.prototype.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var i=0,o=this.m_bodyList;o;o=o.m_next)o.m_islandIndex=i,o.Dump(e),++i;i=0;for(var s=this.m_jointList;s;s=s.m_next)s.m_index=i,++i;for(s=this.m_jointList;s;s=s.m_next)s.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),s.Dump(e),e("}\n"));for(s=this.m_jointList;s;s=s.m_next)s.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),s.Dump(e),e("}\n"))}},e.prototype.DrawJoint=function(i){if(null!==this.m_debugDraw){var o=i.GetBodyA(),s=i.GetBodyB(),r=o.m_xf,n=s.m_xf,a=r.p,m=n.p,_=i.GetAnchorA(e.DrawJoint_s_p1),h=i.GetAnchorB(e.DrawJoint_s_p2),l=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(i.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(_,h,l);break;case t.b2JointType.e_pulleyJoint:var u=i,c=u.GetGroundAnchorA(),p=u.GetGroundAnchorB();this.m_debugDraw.DrawSegment(c,_,l),this.m_debugDraw.DrawSegment(p,h,l),this.m_debugDraw.DrawSegment(c,p,l);break;case t.b2JointType.e_mouseJoint:var f=e.DrawJoint_s_c;f.Set(0,1,0),this.m_debugDraw.DrawPoint(_,4,f),this.m_debugDraw.DrawPoint(h,4,f),f.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(_,h,f);break;default:this.m_debugDraw.DrawSegment(a,_,l),this.m_debugDraw.DrawSegment(_,h,l),this.m_debugDraw.DrawSegment(m,h,l)}}},e.prototype.DrawShape=function(i,o){if(null!==this.m_debugDraw){var s=i.GetShape();switch(s.m_type){case t.b2ShapeType.e_circleShape:var r=s,n=r.m_p,a=r.m_radius,m=N.UNITX;this.m_debugDraw.DrawSolidCircle(n,a,m,o);break;case t.b2ShapeType.e_edgeShape:var _=s,h=_.m_vertex1,l=_.m_vertex2;this.m_debugDraw.DrawSegment(h,l,o);break;case t.b2ShapeType.e_chainShape:var u=s,c=u.m_count,p=u.m_vertices,f=e.DrawShape_s_ghostColor.SetRGBA(.75*o.r,.75*o.g,.75*o.b,o.a);if(h=p[0],this.m_debugDraw.DrawPoint(h,4,o),u.m_hasPrevVertex){var d=u.m_prevVertex;this.m_debugDraw.DrawSegment(d,h,f),this.m_debugDraw.DrawCircle(d,.1,f)}for(var y=1;y<c;++y)l=p[y],this.m_debugDraw.DrawSegment(h,l,o),this.m_debugDraw.DrawPoint(l,4,o),h=l;if(u.m_hasNextVertex){var v=u.m_nextVertex;this.m_debugDraw.DrawSegment(v,h,f),this.m_debugDraw.DrawCircle(v,.1,f)}break;case t.b2ShapeType.e_polygonShape:var x=s,B=x.m_count;p=x.m_vertices,this.m_debugDraw.DrawSolidPolygon(p,B,o)}}},e.prototype.Solve=function(e){for(var i=this.m_bodyList;i;i=i.m_next)i.m_xf0.Copy(i.m_xf);for(var o=this.m_controllerList;o;o=o.m_next)o.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var s=this.m_island;for(s.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener),i=this.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1;for(var r=this.m_contactManager.m_contactList;r;r=r.m_next)r.m_islandFlag=!1;for(var n=this.m_jointList;n;n=n.m_next)n.m_islandFlag=!1;for(var a=this.s_stack,m=this.m_bodyList;m;m=m.m_next)if(!m.m_islandFlag&&m.IsAwake()&&m.IsActive()&&m.GetType()!==t.b2BodyType.b2_staticBody){s.Clear();var _=0;for(a[_++]=m,m.m_islandFlag=!0;_>0;){if(!(i=a[--_]))throw new Error;if(s.AddBody(i),i.m_awakeFlag=!0,i.GetType()!==t.b2BodyType.b2_staticBody){for(var h=i.m_contactList;h;h=h.next){var l=h.contact;if(!l.m_islandFlag&&l.IsEnabled()&&l.IsTouching()){var u=l.m_fixtureA.m_isSensor,c=l.m_fixtureB.m_isSensor;if(!u&&!c){if(s.AddContact(l),l.m_islandFlag=!0,!(f=h.other))throw new Error;f.m_islandFlag||(a[_++]=f,f.m_islandFlag=!0)}}}for(var p=i.m_jointList;p;p=p.next){var f;p.joint.m_islandFlag||(f=p.other).IsActive()&&(s.AddJoint(p.joint),p.joint.m_islandFlag=!0,f.m_islandFlag||(a[_++]=f,f.m_islandFlag=!0))}}}var d=new Co;s.Solve(d,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=d.solveInit,this.m_profile.solveVelocity+=d.solveVelocity,this.m_profile.solvePosition+=d.solvePosition;for(var y=0;y<s.m_bodyCount;++y)(i=s.m_bodies[y]).GetType()===t.b2BodyType.b2_staticBody&&(i.m_islandFlag=!1)}for(y=0;y<a.length&&a[y];++y)a[y]=null;var v=new K;for(i=this.m_bodyList;i;i=i.m_next)i.m_islandFlag&&i.GetType()!==t.b2BodyType.b2_staticBody&&i.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=v.GetMilliseconds()},e.prototype.SolveTOI=function(i){var o=this.m_island;if(o.Initialize(64,32,0,null,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var s=this.m_bodyList;s;s=s.m_next)s.m_islandFlag=!1,s.m_sweep.alpha0=0;for(var r=this.m_contactManager.m_contactList;r;r=r.m_next)r.m_toiFlag=!1,r.m_islandFlag=!1,r.m_toiCount=0,r.m_toi=1}for(;;){var n=null,a=1;for(r=this.m_contactManager.m_contactList;r;r=r.m_next)if(r.IsEnabled()&&!(r.m_toiCount>8)){var m=1;if(r.m_toiFlag)m=r.m_toi;else{var _=r.GetFixtureA(),h=r.GetFixtureB();if(_.IsSensor()||h.IsSensor())continue;var l=_.GetBody(),u=h.GetBody(),c=l.m_type,p=u.m_type,f=l.IsAwake()&&c!==t.b2BodyType.b2_staticBody,d=u.IsAwake()&&p!==t.b2BodyType.b2_staticBody;if(!f&&!d)continue;var y=l.IsBullet()||c!==t.b2BodyType.b2_dynamicBody,v=u.IsBullet()||p!==t.b2BodyType.b2_dynamicBody;if(!y&&!v)continue;var x=l.m_sweep.alpha0;l.m_sweep.alpha0<u.m_sweep.alpha0?(x=u.m_sweep.alpha0,l.m_sweep.Advance(x)):u.m_sweep.alpha0<l.m_sweep.alpha0&&(x=l.m_sweep.alpha0,u.m_sweep.Advance(x));var B=r.GetChildIndexA(),S=r.GetChildIndexB(),A=e.SolveTOI_s_toi_input;A.proxyA.SetShape(_.GetShape(),B),A.proxyB.SetShape(h.GetShape(),S),A.sweepA.Copy(l.m_sweep),A.sweepB.Copy(u.m_sweep),A.tMax=1;var b=e.SolveTOI_s_toi_output;xe(b,A);var C=b.t;m=b.state===t.b2TOIOutputState.e_touching?M(x+(1-x)*C,1):1,r.m_toi=m,r.m_toiFlag=!0}m<a&&(n=r,a=m)}if(null===n||.9999<a){this.m_stepComplete=!0;break}var V=n.GetFixtureA(),g=n.GetFixtureB(),w=V.GetBody(),P=g.GetBody(),I=e.SolveTOI_s_backup1.Copy(w.m_sweep),G=e.SolveTOI_s_backup2.Copy(P.m_sweep);if(w.Advance(a),P.Advance(a),n.Update(this.m_contactManager.m_contactListener),n.m_toiFlag=!1,++n.m_toiCount,n.IsEnabled()&&n.IsTouching()){w.SetAwake(!0),P.SetAwake(!0),o.Clear(),o.AddBody(w),o.AddBody(P),o.AddContact(n),w.m_islandFlag=!0,P.m_islandFlag=!0,n.m_islandFlag=!0;for(var D=0;D<2;++D)if((E=0===D?w:P).m_type===t.b2BodyType.b2_dynamicBody)for(var F=E.m_contactList;F&&o.m_bodyCount!==o.m_bodyCapacity&&o.m_contactCount!==o.m_contactCapacity;F=F.next){var T=F.contact;if(!T.m_islandFlag){var L=F.other;if(L.m_type!==t.b2BodyType.b2_dynamicBody||E.IsBullet()||L.IsBullet()){var R=T.m_fixtureA.m_isSensor,k=T.m_fixtureB.m_isSensor;if(!R&&!k){var q=e.SolveTOI_s_backup.Copy(L.m_sweep);L.m_islandFlag||L.Advance(a),T.Update(this.m_contactManager.m_contactListener),T.IsEnabled()&&T.IsTouching()?(T.m_islandFlag=!0,o.AddContact(T),L.m_islandFlag||(L.m_islandFlag=!0,L.m_type!==t.b2BodyType.b2_staticBody&&L.SetAwake(!0),o.AddBody(L))):(L.m_sweep.Copy(q),L.SynchronizeTransform())}}}}var z=e.SolveTOI_s_subStep;for(z.dt=(1-a)*i.dt,z.inv_dt=1/z.dt,z.dtRatio=1,z.positionIterations=20,z.velocityIterations=i.velocityIterations,z.particleIterations=i.particleIterations,z.warmStarting=!1,o.SolveTOI(z,w.m_islandIndex,P.m_islandIndex),D=0;D<o.m_bodyCount;++D){var E;if((E=o.m_bodies[D]).m_islandFlag=!1,E.m_type===t.b2BodyType.b2_dynamicBody)for(E.SynchronizeFixtures(),F=E.m_contactList;F;F=F.next)F.contact.m_toiFlag=!1,F.contact.m_islandFlag=!1}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else n.SetEnabled(!1),w.m_sweep.Copy(I),P.m_sweep.Copy(G),w.SynchronizeTransform(),P.SynchronizeTransform()}},e.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},e.prototype.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e.Step_s_step=new Vo,e.Step_s_stepTimer=new K,e.Step_s_timer=new K,e.DrawDebugData_s_color=new Q(0,0,0),e.DrawDebugData_s_vs=N.MakeArray(4),e.DrawDebugData_s_xf=new W,e.QueryFixtureShape_s_aabb=new zt,e.RayCast_s_input=new kt,e.RayCast_s_output=new qt,e.RayCast_s_point=new N,e.DrawJoint_s_p1=new N,e.DrawJoint_s_p2=new N,e.DrawJoint_s_color=new Q(.5,.8,.8),e.DrawJoint_s_c=new Q,e.DrawShape_s_ghostColor=new Q,e.SolveTOI_s_subStep=new Vo,e.SolveTOI_s_backup=new H,e.SolveTOI_s_backup1=new H,e.SolveTOI_s_backup2=new H,e.SolveTOI_s_toi_input=new ne,e.SolveTOI_s_toi_output=new me,e}(),as=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},ms=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}return t.prototype.GetNext=function(){return this.m_next},t.prototype.GetPrev=function(){return this.m_prev},t.prototype.GetBodyList=function(){return this.m_bodyList},t.prototype.AddBody=function(t){var e=new as(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},t.prototype.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},t.prototype.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),_s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.normal=new N(0,1),e.offset=0,e.density=0,e.velocity=new N(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new N(0,0),e}return pi(e,t),e.prototype.Step=function(t){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;if(i.IsAwake()){for(var s=new N,r=new N,n=0,a=0,m=i.GetFixtureList();m;m=m.m_next){var _=new N,h=m.GetShape().ComputeSubmergedArea(this.normal,this.offset,i.GetTransform(),_);n+=h,s.x+=h*_.x,s.y+=h*_.y;var l=0;a+=h*(l=this.useDensity?m.GetDensity():1),r.x+=h*_.x*l,r.y+=h*_.y*l}if(s.x/=n,s.y/=n,r.x/=a,r.y/=a,!(n<o)){var u=this.gravity.Clone().SelfNeg();u.SelfMul(this.density*n),i.ApplyForce(u,r);var c=i.GetLinearVelocityFromWorldPoint(s,new N);c.SelfSub(this.velocity),c.SelfMul(-this.linearDrag*n),i.ApplyForce(c,s),i.ApplyTorque(-i.GetInertia()/i.GetMass()*n*i.GetAngularVelocity()*this.angularDrag)}}}}},e.prototype.Draw=function(t){var e=100,i=new N,o=new N;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,o.x=this.normal.x*this.offset-this.normal.y*e,o.y=this.normal.y*this.offset+this.normal.x*e;var s=new Q(0,0,.8);t.DrawSegment(i,o,s)},e}(ms),hs=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.A=new N(0,0),e}return pi(e,t),e.prototype.Step=function(t){for(var i=N.MulSV(t.dt,this.A,e.Step_s_dtA),o=this.m_bodyList;o;o=o.nextBody){var s=o.body;s.IsAwake()&&s.SetLinearVelocity(N.AddVV(s.GetLinearVelocity(),i,N.s_t0))}},e.prototype.Draw=function(t){},e.Step_s_dtA=new N,e}(ms),ls=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.F=new N(0,0),e}return pi(e,t),e.prototype.Step=function(t){for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},e.prototype.Draw=function(t){},e}(ms),us=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.G=1,e.invSqr=!0,e}return pi(e,t),e.prototype.Step=function(t){if(this.invSqr)for(var i=this.m_bodyList;i;i=i.nextBody)for(var s=(_=i.body).GetWorldCenter(),r=_.GetMass(),n=this.m_bodyList;n&&n!==i;n=n.nextBody){var a=(h=n.body).GetWorldCenter(),m=h.GetMass();(c=(l=a.x-s.x)*l+(u=a.y-s.y)*u)<o||((p=e.Step_s_f.Set(l,u)).SelfMul(this.G/c/L(c)*r*m),_.IsAwake()&&_.ApplyForce(p,s),h.IsAwake()&&h.ApplyForce(p.SelfMul(-1),a))}else for(i=this.m_bodyList;i;i=i.nextBody){var _;for(s=(_=i.body).GetWorldCenter(),r=_.GetMass(),n=this.m_bodyList;n&&n!==i;n=n.nextBody){var h,l,u,c,p;a=(h=n.body).GetWorldCenter(),m=h.GetMass(),(c=(l=a.x-s.x)*l+(u=a.y-s.y)*u)<o||((p=e.Step_s_f.Set(l,u)).SelfMul(this.G/c*r*m),_.IsAwake()&&_.ApplyForce(p,s),h.IsAwake()&&h.ApplyForce(p.SelfMul(-1),a))}}},e.prototype.Draw=function(t){},e.Step_s_f=new N,e}(ms),cs=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.T=new X,e.maxTimestep=0,e}return pi(e,t),e.prototype.Step=function(t){var i=t.dt;if(!(i<=o)){i>this.maxTimestep&&this.maxTimestep>0&&(i=this.maxTimestep);for(var s=this.m_bodyList;s;s=s.nextBody){var r=s.body;if(r.IsAwake()){var n=r.GetWorldVector(X.MulMV(this.T,r.GetLocalVector(r.GetLinearVelocity(),N.s_t0),N.s_t1),e.Step_s_damping);r.SetLinearVelocity(N.AddVV(r.GetLinearVelocity(),N.MulSV(i,n,N.s_t0),N.s_t1))}}}},e.prototype.Draw=function(t){},e.prototype.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/P(t,e):0},e.Step_s_damping=new N,e}(ms),ps=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new N(0,0),this.damping=.1,this.k2=.9,this.k3=.1},fs=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new N,this.m_damping=0,this.m_k2=1,this.m_k3=.1}return t.prototype.GetVertexCount=function(){return this.m_count},t.prototype.GetVertices=function(){return this.m_ps},t.prototype.Initialize=function(t){this.m_count=t.count,this.m_ps=N.MakeArray(this.m_count),this.m_p0s=N.MakeArray(this.m_count),this.m_vs=N.MakeArray(this.m_count),this.m_ims=b(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var i=t.masses[e];this.m_ims[e]=i>0?1/i:0}var o=this.m_count-1,s=this.m_count-2;for(this.m_Ls=b(o),this.m_as=b(s),e=0;e<o;++e){var r=this.m_ps[e],n=this.m_ps[e+1];this.m_Ls[e]=N.DistanceVV(r,n)}for(e=0;e<s;++e){r=this.m_ps[e],n=this.m_ps[e+1];var a=this.m_ps[e+2],m=N.SubVV(n,r,N.s_t0),_=N.SubVV(a,n,N.s_t1),h=N.CrossVV(m,_),l=N.DotVV(m,_);this.m_as[e]=J(h,l)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},t.prototype.Step=function(t,e){if(0!==t){for(var i=Math.exp(-t*this.m_damping),o=0;o<this.m_count;++o)this.m_p0s[o].Copy(this.m_ps[o]),this.m_ims[o]>0&&this.m_vs[o].SelfMulAdd(t,this.m_gravity),this.m_vs[o].SelfMul(i),this.m_ps[o].SelfMulAdd(t,this.m_vs[o]);for(o=0;o<e;++o)this.SolveC2(),this.SolveC3(),this.SolveC2();var s=1/t;for(o=0;o<this.m_count;++o)N.MulSV(s,N.SubVV(this.m_ps[o],this.m_p0s[o],N.s_t0),this.m_vs[o])}},t.prototype.SolveC2=function(){for(var e=this.m_count-1,i=0;i<e;++i){var o=this.m_ps[i],s=this.m_ps[i+1],r=N.SubVV(s,o,t.s_d),n=r.Normalize(),a=this.m_ims[i],m=this.m_ims[i+1];if(a+m!==0){var _=a/(a+m),h=m/(a+m);o.SelfMulSub(this.m_k2*_*(this.m_Ls[i]-n),r),s.SelfMulAdd(this.m_k2*h*(this.m_Ls[i]-n),r)}}},t.prototype.SetAngle=function(t){for(var e=this.m_count-2,i=0;i<e;++i)this.m_as[i]=t},t.prototype.SolveC3=function(){for(var e=this.m_count-2,i=0;i<e;++i){var o=this.m_ps[i],s=this.m_ps[i+1],n=this.m_ps[i+2],a=this.m_ims[i],m=this.m_ims[i+1],_=this.m_ims[i+2],h=N.SubVV(s,o,t.s_d1),l=N.SubVV(n,s,t.s_d2),u=h.LengthSquared(),c=l.LengthSquared();if(u*c!=0){var p=N.CrossVV(h,l),f=N.DotVV(h,l),d=J(p,f),y=N.MulSV(-1/u,h.SelfSkew(),t.s_Jd1),v=N.MulSV(1/c,l.SelfSkew(),t.s_Jd2),x=N.NegV(y,t.s_J1),B=N.SubVV(y,v,t.s_J2),S=v,A=a*N.DotVV(x,x)+m*N.DotVV(B,B)+_*N.DotVV(S,S);if(0!==A){A=1/A;for(var b=d-this.m_as[i];b>r;)b=(d-=2*r)-this.m_as[i];for(;b<-r;)b=(d+=2*r)-this.m_as[i];var C=-this.m_k3*A*b;o.SelfMulAdd(a*C,x),s.SelfMulAdd(m*C,B),n.SelfMulAdd(_*C,S)}}}},t.prototype.Draw=function(t){for(var e=new Q(.4,.5,.7),i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)},t.s_d=new N,t.s_d1=new N,t.s_d2=new N,t.s_Jd1=new N,t.s_Jd2=new N,t.s_J1=new N,t.s_J2=new N,t}();t.b2Assert=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(!t)throw new(Error.bind.apply(Error,[void 0].concat(e)))},t.b2Maybe=e,t.b2_maxFloat=i,t.b2_epsilon=o,t.b2_epsilon_sq=s,t.b2_pi=r,t.b2_maxManifoldPoints=2,t.b2_maxPolygonVertices=8,t.b2_aabbExtension=n,t.b2_aabbMultiplier=2,t.b2_linearSlop=a,t.b2_angularSlop=m,t.b2_polygonRadius=_,t.b2_maxSubSteps=8,t.b2_maxTOIContacts=32,t.b2_velocityThreshold=1,t.b2_maxLinearCorrection=h,t.b2_maxAngularCorrection=l,t.b2_maxTranslation=2,t.b2_maxTranslationSquared=4,t.b2_maxRotation=u,t.b2_maxRotationSquared=c,t.b2_baumgarte=.2,t.b2_toiBaumgarte=.75,t.b2_invalidParticleIndex=p,t.b2_maxParticleIndex=2147483647,t.b2_particleStride=f,t.b2_minParticleWeight=1,t.b2_maxParticlePressure=d,t.b2_maxParticleForce=.5,t.b2_maxTriadDistance=2,t.b2_maxTriadDistanceSquared=4,t.b2_minParticleSystemBufferCapacity=y,t.b2_barrierCollisionTime=2.5,t.b2_timeToSleep=.5,t.b2_linearSleepTolerance=v,t.b2_angularSleepTolerance=x,t.b2Alloc=function(t){return null},t.b2Free=function(t){},t.b2Log=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]},t.b2Version=B,t.b2_version=S,t.b2_branch="master",t.b2_commit="fbf51801d80fc389d43dc46524520e89043b6faf",t.b2ParseInt=function(t){return parseInt(t,10)},t.b2ParseUInt=function(t){return Math.abs(parseInt(t,10))},t.b2MakeArray=A,t.b2MakeNullArray=function(t){for(var e=[],i=0;i<t;++i)e.push(null);return e},t.b2MakeNumberArray=b,t.b2_pi_over_180=C,t.b2_180_over_pi=V,t.b2_two_pi=g,t.b2Abs=w,t.b2Min=M,t.b2Max=P,t.b2Clamp=I,t.b2Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},t.b2IsValid=G,t.b2Sq=D,t.b2InvSqrt=F,t.b2Sqrt=L,t.b2Pow=R,t.b2DegToRad=function(t){return t*C},t.b2RadToDeg=function(t){return t*V},t.b2Cos=k,t.b2Sin=q,t.b2Acos=z,t.b2Asin=E,t.b2Atan2=J,t.b2NextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,1+(t|=t>>16&65535)},t.b2IsPowerOfTwo=function(t){return t>0&&0==(t&t-1)},t.b2Random=function(){return 2*Math.random()-1},t.b2RandomRange=function(t,e){return(e-t)*Math.random()+t},t.b2Vec2=N,t.b2Vec2_zero=j,t.b2Vec3=O,t.b2Mat22=X,t.b2Mat33=U,t.b2Rot=Z,t.b2Transform=W,t.b2Sweep=H,t.b2Color=Q,t.b2Draw=Y,t.b2Timer=K,t.b2Counter=$,t.b2GrowableStack=tt,t.b2BlockAllocator=et,t.b2StackAllocator=it,t.b2ContactFeature=It,t.b2ContactID=Gt,t.b2ManifoldPoint=Dt,t.b2Manifold=Tt,t.b2WorldManifold=Lt,t.b2GetPointStates=function(e,i,o,s){var r;for(r=0;r<o.pointCount;++r){var n=o.points[r].id.key;e[r]=t.b2PointState.b2_removeState;for(var a=0,m=s.pointCount;a<m;++a)if(s.points[a].id.key===n){e[r]=t.b2PointState.b2_persistState;break}}for(;r<2;++r)e[r]=t.b2PointState.b2_nullState;for(r=0;r<s.pointCount;++r)for(n=s.points[r].id.key,i[r]=t.b2PointState.b2_addState,a=0,m=o.pointCount;a<m;++a)if(o.points[a].id.key===n){i[r]=t.b2PointState.b2_persistState;break}for(;r<2;++r)i[r]=t.b2PointState.b2_nullState},t.b2ClipVertex=Rt,t.b2RayCastInput=kt,t.b2RayCastOutput=qt,t.b2AABB=zt,t.b2TestOverlapAABB=Et,t.b2ClipSegmentToLine=Jt,t.b2TestOverlapShape=Xt,t.b2DistanceProxy=ot,t.b2SimplexCache=st,t.b2DistanceInput=rt,t.b2DistanceOutput=nt,t.b2ShapeCastInput=at,t.b2ShapeCastOutput=mt,t.b2_gjk_reset=function(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0},t.b2SimplexVertex=_t,t.b2Simplex=ht,t.b2Distance=xt,t.b2ShapeCast=function(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var i=e.proxyA,o=e.proxyB,s=P(i.m_radius,_)+P(o.m_radius,_),r=e.transformA,n=e.transformB,a=e.translationB,m=St.Set(0,0),h=0,l=At;l.m_count=0;for(var u=l.m_vertices,c=i.GetSupport(Z.MulTRV(r.q,N.NegV(a,N.s_t1),N.s_t0)),p=W.MulXV(r,i.GetVertex(c),bt),f=o.GetSupport(Z.MulTRV(n.q,a,N.s_t0)),d=W.MulXV(n,o.GetVertex(f),Ct),y=N.SubVV(p,d,Vt),v=P(_,s-_),x=0;x<20&&w(y.Length()-v)>.004;){t.iterations+=1,c=i.GetSupport(Z.MulTRV(r.q,N.NegV(y,N.s_t1),N.s_t0)),p=W.MulXV(r,i.GetVertex(c),bt),f=o.GetSupport(Z.MulTRV(n.q,y,N.s_t0)),d=W.MulXV(n,o.GetVertex(f),Ct);var B=N.SubVV(p,d,gt);y.Normalize();var S=N.DotVV(y,B),A=N.DotVV(y,a);if(S-v>h*A){if(A<=0)return!1;if((h=(S-v)/A)>1)return!1;m.Copy(y).SelfNeg(),l.m_count=0}var b=u[l.m_count];switch(b.indexA=f,b.wA.Copy(d).SelfMulAdd(h,a),b.indexB=c,b.wB.Copy(p),b.w.Copy(b.wB).SelfSub(b.wA),b.a=1,l.m_count+=1,l.m_count){case 1:break;case 2:l.Solve2();break;case 3:l.Solve3()}if(3===l.m_count)return!1;l.GetClosestPoint(y),++x}var C=wt,V=Mt;return l.GetWitnessPoints(C,V),y.LengthSquared()>0&&(m.Copy(y).SelfNeg(),m.Normalize()),t.normal.Copy(m),t.lambda=h,t.iterations=x,!0},t.b2Pair=Ht,t.b2BroadPhase=Qt,t.b2PairLessThan=Yt,t.b2TreeNode=Zt,t.b2DynamicTree=Wt,t.b2_toi_reset=function(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0},t.b2TOIInput=ne,t.b2TOIOutput=me,t.b2SeparationFunction=_e,t.b2TimeOfImpact=xe,t.b2CollideCircles=Ae,t.b2CollidePolygonAndCircle=ge,t.b2CollidePolygons=He,t.b2CollideEdgeAndCircle=si,t.b2CollideEdgeAndPolygon=_i,t.b2MassData=li,t.b2Shape=ui,t.b2CircleShape=di,t.b2PolygonShape=yi,t.b2EdgeShape=vi,t.b2ChainShape=xi,t.b2Filter=Bi,t.b2FixtureDef=Si,t.b2FixtureProxy=Ai,t.b2Fixture=bi,t.b2BodyDef=gi,t.b2Body=wi,t.b2World=ns,t.b2DestructionListener=yo,t.b2ContactFilter=vo,t.b2ContactImpulse=xo,t.b2ContactListener=Bo,t.b2QueryCallback=So,t.b2RayCastCallback=Ao,t.b2Island=Ro,t.b2Profile=Co,t.b2TimeStep=Vo,t.b2Position=go,t.b2Velocity=wo,t.b2SolverData=Mo,t.b2ContactManager=bo,t.b2MixFriction=io,t.b2MixRestitution=oo,t.b2ContactEdge=ro,t.b2Contact=no,t.b2ContactRegister=po,t.b2ContactFactory=fo,t.g_blockSolve=Po,t.b2VelocityConstraintPoint=Io,t.b2ContactVelocityConstraint=Go,t.b2ContactPositionConstraint=Do,t.b2ContactSolverDef=Fo,t.b2PositionSolverManifold=To,t.b2ContactSolver=Lo,t.b2CircleContact=ao,t.b2PolygonContact=mo,t.b2PolygonAndCircleContact=_o,t.b2EdgeAndCircleContact=ho,t.b2EdgeAndPolygonContact=lo,t.b2ChainAndCircleContact=uo,t.b2ChainAndPolygonContact=co,t.b2Jacobian=Mi,t.b2JointEdge=Pi,t.b2JointDef=Ii,t.b2Joint=Gi,t.b2AreaJointDef=Ti,t.b2AreaJoint=Li,t.b2DistanceJointDef=Di,t.b2DistanceJoint=Fi,t.b2FrictionJointDef=Ri,t.b2FrictionJoint=ki,t.b2GearJointDef=qi,t.b2GearJoint=zi,t.b2MotorJointDef=Ei,t.b2MotorJoint=Ji,t.b2MouseJointDef=Ni,t.b2MouseJoint=ji,t.b2PrismaticJointDef=Oi,t.b2PrismaticJoint=Xi,t.b2_minPulleyLength=2,t.b2PulleyJointDef=Ui,t.b2PulleyJoint=Zi,t.b2RevoluteJointDef=Wi,t.b2RevoluteJoint=Hi,t.b2RopeJointDef=Qi,t.b2RopeJoint=Yi,t.b2WeldJointDef=Ki,t.b2WeldJoint=$i,t.b2WheelJointDef=to,t.b2WheelJoint=eo,t.b2ControllerEdge=as,t.b2Controller=ms,t.b2BuoyancyController=_s,t.b2ConstantAccelController=hs,t.b2ConstantForceController=ls,t.b2GravityController=us,t.b2TensorDampingController=cs,t.b2ParticleDef=ko,t.b2CalculateParticleIterations=qo,t.b2ParticleHandle=Eo,t.b2ParticleGroupDef=Jo,t.b2ParticleGroup=No,t.b2GrowableBuffer=$o,t.b2FixtureParticleQueryCallback=ts,t.b2ParticleContact=es,t.b2ParticleBodyContact=is,t.b2ParticlePair=os,t.b2ParticleTriad=ss,t.b2ParticleSystemDef=rs,t.b2RopeDef=ps,t.b2Rope=fs}(),t("default",s.exports)}));t("__cjsMetaURL",e.meta.url)}}}));

System.register("chunks:///_virtual/audioManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./storageManager.ts","./lodash.ts","./resourcesUtils.ts"],(function(o){"use strict";var s,i,t,u,e,n,a,r,d,c,h,l;return{setters:[function(o){s=o.defineProperty,i=o.createClass},function(o){t=o.cclegacy,u=o._decorator,e=o.Node,n=o.director,a=o.game,r=o.AudioSource,d=o.AudioClip},function(o){c=o.StorageManager},function(o){h=o.Lodash},function(o){l=o.ResourceUtil}],execute:function(){var p,f,m;t._RF.push({},"2998b0ZhKlBf7zSWKyyU4Zs","audioManager",void 0);var S=u.ccclass;u.property,o("AudioManager",S("AudioManager")((m=f=function(){function o(){s(this,"musicVolume",.8),s(this,"soundVolume",1),s(this,"audios",{}),s(this,"arrSound",[]),s(this,"dictWeaponSoundIndex",{}),s(this,"_persistRootNode",null),s(this,"_audioSources",[])}var t=o.prototype;return t.init=function(){this._persistRootNode||(this._persistRootNode=new e("audio"),n.getScene().addChild(this._persistRootNode),a.addPersistRootNode(this._persistRootNode),this.musicVolume=this.getAudioSetting(!0)?.8:0,this.soundVolume=this.getAudioSetting(!1)?1:0)},t._getAudioSource=function(o){for(var s,i=0;i<this._audioSources.length;++i){var t=this._audioSources[i];if(!t.playing){s=t;break}}return s||(s=this._persistRootNode.addComponent(r),this._audioSources.push(s)),s.node.off(r.EventType.ENDED),s.clip=o,s.currentTime=0,s},t.getAudioSetting=function(o){var s;return!(s=o?c.instance.getGlobalData("music"):c.instance.getGlobalData("sound"))||"true"===s},t.playMusic=function(o,s){var i=this,t="audio/music/"+o;l.loadRes(t,d,(function(t,u){var e=i._getAudioSource(u),n={source:e,isMusic:!0};i.audios[o]=n,e.volume=i.musicVolume,e.loop=s,e.play()}))},t.playSound=function(o,s){var i=this;if(void 0===s&&(s=!1),this.soundVolume){l.loadRes("audio/sound/"+o,d,(function(t,u){var e=i._getAudioSource(u),n={source:e,isMusic:!1};i.arrSound.push(n),s&&(i.audios[o]=n),e.volume=i.soundVolume,e.loop=s,e.play(),e.node.on(r.EventType.ENDED,(function(){h.remove(i.arrSound,(function(o){return o.source===n.source}))}))}))}},t.stop=function(o){this.audios.hasOwnProperty(o)&&this.audios[o].source.stop()},t.stopAll=function(){for(var o in this.audios){if(this.audios.hasOwnProperty(o))this.audios[o].source.stop()}},t.getMusicVolume=function(){return this.musicVolume},t.setMusic=function(o){for(var s in this.musicVolume=o,this.audios){if(this.audios.hasOwnProperty(s)&&this.audios[s].isMusic)this.audios[s].source.volume=this.musicVolume}},t.pauseAll=function(){for(var o in console.log("pause all music!!!"),this.audios){if(this.audios.hasOwnProperty(o))this.audios[o].source.pause()}},t.resumeAll=function(){for(var o in this.audios){if(this.audios.hasOwnProperty(o))this.audios[o].source.play()}},t.openMusic=function(){this.setMusic(.8),c.instance.setGlobalData("music","true")},t.closeMusic=function(){this.setMusic(0),c.instance.setGlobalData("music","false")},t.openSound=function(){this.setSound(1),c.instance.setGlobalData("sound","true")},t.closeSound=function(){this.setSound(0),c.instance.setGlobalData("sound","false")},t.setSound=function(o){for(var s in this.soundVolume=o,this.audios){if(this.audios.hasOwnProperty(s)&&!this.audios[s].isMusic)this.audios[s].source.volume=this.soundVolume}for(var i=0;i<this.arrSound.length;i++){this.arrSound[i].source.volume=this.soundVolume}},t.stopSingleSound=function(o){this.audios.hasOwnProperty(o)&&!this.audios[o].isMusic&&this.audios[o].source.stop()},t.playWeaponSound=function(o){this.dictWeaponSoundIndex[o]?this.dictWeaponSoundIndex[o]=1===this.dictWeaponSoundIndex[o]?2:1:this.dictWeaponSoundIndex[o]=1,this.playSound(o+"_"+this.dictWeaponSoundIndex[o])},i(o,null,[{key:"instance",get:function(){return this._instance||(this._instance=new o),this._instance}}]),o}(),s(f,"_instance",void 0),p=m))||p);t._RF.pop()}}}));

System.register("chunks:///_virtual/fighter.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./effect.ts","./constants.ts","./resourcesUtils.ts","./audioManager.ts","./fighterRigidBody.ts","./poolManager.ts","./fighterModel.ts","./gameLogic.ts"],(function(t){"use strict";var i,e,s,a,n,o,h,r,_,d,g,f,c,l,u,T,m,p,S,E;return{setters:[function(t){i=t.applyDecoratedDescriptor,e=t.inheritsLoose,s=t.initializerDefineProperty,a=t.assertThisInitialized,n=t.defineProperty,o=t.createClass},function(t){h=t.cclegacy,r=t._decorator,_=t.Node,d=t.Vec3,g=t.Tween,f=t.Component},function(t){c=t.Effect},function(t){l=t.default},function(t){u=t.ResourceUtil},function(t){T=t.AudioManager},function(t){m=t.FighterRigidBody},function(t){p=t.PoolManager},function(t){S=t.FighterModel},function(t){E=t.GameLogic}],execute:function(){var y,P,A,I,D,M,v;h._RF.push({},"2b7cfvgZ+tNAYxPyQw8LueM","fighter",void 0);var w=r.ccclass,R=r.property;t("Fighter",(y=w("Fighter"),P=R(_),A=R(_),y((M=i((D=function(t){function i(){for(var i,e=arguments.length,o=new Array(e),h=0;h<e;h++)o[h]=arguments[h];return i=t.call.apply(t,[this].concat(o))||this,s(a(i),"ndModelParent",M,a(i)),s(a(i),"ndShadow",v,a(i)),n(a(i),"fighterInfo",void 0),n(a(i),"identity",0),n(a(i),"rigidBody",null),n(a(i),"fightType",0),n(a(i),"team",0),n(a(i),"isDead",!1),n(a(i),"hpMax",0),n(a(i),"cellPos",0),n(a(i),"target",null),n(a(i),"_moveStartCostTime",0),n(a(i),"_manager",null),n(a(i),"_attackRange",.8),n(a(i),"_hp",0),n(a(i),"_damage",0),n(a(i),"_coolTime",0),n(a(i),"_currentStatus",-1),n(a(i),"_attackAniTime",0),n(a(i),"_moveTime",0),n(a(i),"_moveSpeed",0),n(a(i),"_isWaitingDamage",!1),n(a(i),"_tweenDead",null),n(a(i),"_isAttacking",!1),n(a(i),"_fightStartTargetPos",new d),n(a(i),"_nodeModel",null),n(a(i),"_fighterModel",null),n(a(i),"_isPlayingChairEffect",!1),n(a(i),"_timeScale",1),n(a(i),"_curPos",new d),n(a(i),"_outPos",new d),n(a(i),"_deadPos",new d),n(a(i),"_oriEuler",new d),n(a(i),"_nowPos",new d),n(a(i),"_targetPos",new d),n(a(i),"_forward",new d),n(a(i),"_direction",new d),n(a(i),"_startOffset",new d),i}e(i,t);var h=i.prototype;return h.start=function(){this._enterStatus(l.FIGHTER_STATUS.IDLE)},h.onDisable=function(){this._tweenDead&&(this._tweenDead.stop(),this._tweenDead=null)},h.init=function(t,i,e,s,a,n,o){var h=this;this.rigidBody=this.getComponent(m),this.rigidBody.initBody(a,.3),this.rigidBody.setWorldPosition(s),this.rigidBody.enableSync=!0,this.timeScale=1,this.isDead=!1,this.target=null,this.cellPos=o,this.identity=t,this.fighterInfo=e,this.fightType=e.type,this.team=i,this.ndShadow.active=!0,this._fightStartTargetPos=null,this._currentStatus=-1,this._attackAniTime=0,this._coolTime=0,this._isWaitingDamage=!1,this._isAttacking=!1,this._isPlayingChairEffect=!1,this._manager=n,this._enterStatus(l.FIGHTER_STATUS.IDLE);var r=270;switch(this.team){case 2:r=270;break;case 3:r=180;break;case 4:r=0}this._oriEuler.set(0,r,0),this.node.eulerAngles=this._oriEuler,u.getFighterModel(this.fighterInfo.type,(function(t,i){t?console.error("get fighter model failed!: ",t):(h._nodeModel=p.instance.getNode(i,h.ndModelParent),h._fighterModel=h._nodeModel.getComponent(S),h._fighterModel.show(h),h._fighterModel.setEffectListener(h._triggerEffect,h))}));var _=this.fighterInfo.scale;if(this.node.setScale(_,_,_),this.rigidBody.updateRadius(.3*_),this._hp=this.fighterInfo.hp,this.hpMax=this._hp,this._damage=this.fighterInfo.attack,this._moveSpeed=this.fighterInfo.speed,this.fightType===l.FIGHTER_TYPE.CLOSE||this.fightType===l.FIGHTER_TYPE.OX||this.fightType===l.FIGHTER_TYPE.BAT){this._moveSpeed=Math.floor(1.2*this._moveSpeed-Math.random()*this._moveSpeed*.2*2)}this._attackRange=this.fighterInfo.range/100},h.resetFighterState=function(){this._tweenDead&&(this._tweenDead.stop(),this._tweenDead=null),this.recycle()},h._enterStatus=function(t){if(this._currentStatus!==t&&(!this.isDead||t===l.FIGHTER_STATUS.DEAD))switch(this._currentStatus=t,t){case l.FIGHTER_STATUS.IDLE:this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.IDLE);break;case l.FIGHTER_STATUS.FIND:this._findEnemy();break;case l.FIGHTER_STATUS.DEAD:this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.DIED,!0);break;case l.FIGHTER_STATUS.CHARGE:this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.RUN,!0)}},h._findEnemy=function(){if(!this._manager.isGameOver){var t=this._manager.getNearestEnemy(this);t&&t.isValid?(this.target=t.getComponent(i),this._enterStatus(l.FIGHTER_STATUS.MOVE)):(this._enterStatus(l.FIGHTER_STATUS.IDLE),this._manager.checkWin(this.team),this._manager.isGameOver||this.scheduleOnce(this._findEnemy,3))}},h._playAttackEffect=function(){var t=this,i=null;this.fightType===l.FIGHTER_TYPE.OX||this.fightType===l.FIGHTER_TYPE.BAT?i="attckRing01":this.fightType===l.FIGHTER_TYPE.CLOSE&&(i="attck01"),i&&u.getEffectPrefab(i,(function(i,e){if(!i){var s=p.instance.getNode(e,t.node),a=s.getComponent(c);a.play(),a.setEndListener((function(){p.instance.putNode(s)}))}}))},h._attack=function(){var t=this;this._coolTime>0?this._enterStatus(l.FIGHTER_STATUS.IDLE):(this._enterStatus(l.FIGHTER_STATUS.ATTACK),this._coolTime=this.fighterInfo.attackSpeed/1e3,this._playAttackEffect(),E.vibrateShort(),T.instance.playWeaponSound(this.fightType.toString()),this._isWaitingDamage=!0,this._attackAniTime=0,this._fighterModel?(this._fighterModel.playAttack(),this._fighterModel.showHandWeapon(),this._isAttacking=!0,this._fighterModel.onceAniFinished((function(){t._isAttacking=!1,t._enterStatus(l.FIGHTER_STATUS.IDLE)}),this)):(this._isAttacking=!1,this._enterStatus(l.FIGHTER_STATUS.IDLE)))},h.onDamage=function(t,i){this._hp-=t,this._hp<=0&&(this._hp=0,this._onDead(i))},h._onDead=function(t){var i=this;this._enterStatus(l.FIGHTER_STATUS.DEAD),this.ndShadow.active=!1,this.isDead=!0,this.rigidBody.destroyBody(),this._tweenDead&&(this._tweenDead.stop(),this._tweenDead=null);var e=this.node.forward;d.multiplyScalar(this._outPos,e,1),d.add(this._outPos,this._outPos,this.node.position),this._deadPos.set(this._outPos),this._deadPos.y=-2,this._tweenDead=new g(this.node).to(.2,{position:this._outPos}).delay(.8).by(1,{position:this._deadPos}).union().call((function(){i.recycle()})).start(),this._manager.onSomeoneDead(this)},h.fightStart=function(t,i){this.rigidBody.enableSync=!0,this._damage=Math.floor(this.fighterInfo.attack*t),this._fightStartTargetPos=i,this._startOffset.set(this._fightStartTargetPos),this._moveStartCostTime=this._startOffset.subtract(this.node.position).length()/(this._moveSpeed/166.6),this._enterStatus(l.FIGHTER_STATUS.CHARGE)},h._triggerEffect=function(){var t=this;if(this._isWaitingDamage&&(this._isWaitingDamage=!1,this.target&&!this.target.isDead))if(this.fightType===l.FIGHTER_TYPE.ARCHER||this.fightType===l.FIGHTER_TYPE.AXE||this.fightType===l.FIGHTER_TYPE.BOMBER){var i=this.target.node.worldPosition;this._fighterModel.throwWeapon((function(e){t.fightType===l.FIGHTER_TYPE.ARCHER?t._manager.effectGroup.playBombEffect(i):e._isPlayingChairEffect||(e._isPlayingChairEffect=!0,t._manager.effectGroup.playChairEffect(i,(function(){e._isPlayingChairEffect=!1})));var s=t.fighterInfo.damageRange/100;s>0?t._manager.getEnemyAroundRange(t.team,e.node.position,s).forEach((function(i){i.onDamage(t._damage,t.identity)})):e&&!e.isDead&&e.onDamage(t._damage,t.identity);t._fighterModel.showHandWeapon()}))}else{var e=this.fighterInfo.damageRange/100;if(e>0)this._manager.getEnemyAroundRange(this.team,this.target.node.position,e).forEach((function(i){i.onDamage(t._damage,t.identity)}));else this.target&&!this.target.isDead&&this.target.onDamage(this._damage,this.identity)}},h.showWin=function(){this.isDead||this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.WIN)},h.recycle=function(){this.node.parent&&(this.rigidBody.destroyBody(),p.instance.putNode(this._nodeModel),this._nodeModel=null,this._fighterModel=null,p.instance.putNode(this.node))},h.update=function(t){if(!this.isDead&&!this._manager.isGamePause)if(t*=this.timeScale,this.target){if(this.target.isDead)return this.target=null,void this._enterStatus(l.FIGHTER_STATUS.FIND);this._targetPos.set(this.target.node.position);var e=this._targetPos.subtract(this.node.position);e.length()-this.target.radius-this.radius<=this._attackRange?(this._direction.set(e),this._direction.normalize().negative(),this._forward.set(this._direction),this.node.forward=this._forward,this._moveTime=0,this._coolTime<=0?this._attack():this._coolTime-=t):this._isAttacking?(this._attackAniTime+=t,this._attackAniTime>2&&(this._isAttacking=!1)):(this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.RUN,!0),this._direction.set(e),this._direction.x+=Math.floor(.2*Math.random())-.1,this._direction.z+=Math.floor(.2*Math.random())-.1,this._direction.normalize(),this._forward.set(this._direction),this._forward.negative(),this.node.forward=this._forward,this._direction=this._direction.multiplyScalar(this._moveSpeed/1e4),this._curPos.set(this.node.position),this._curPos.add(this._direction),this.rigidBody.setWorldPosition(this._curPos),this._moveTime+=t,this._moveTime>.1&&this._findEnemy())}else if(this._fightStartTargetPos){this._targetPos.set(this._fightStartTargetPos);var s=this._targetPos.subtract(this.node.position);if(this._moveStartCostTime-=t,this._moveStartCostTime<=0)this._fightStartTargetPos=null,this._enterStatus(l.FIGHTER_STATUS.FIND);else if(this._fighterModel&&this._fighterModel.playAni(l.ANI_TYPE.RUN,!0),this._direction.set(s),this._direction.x+=Math.floor(.2*Math.random())-.1,this._direction.z+=Math.floor(.2*Math.random())-.1,this._direction.normalize(),this._forward.set(this._direction),this._forward.negative(),this.node.forward=this._forward,this._direction=this._direction.multiplyScalar(this._moveSpeed*t/166.6),this._nowPos.set(this.node.worldPosition),this._nowPos.add(this._direction),this.rigidBody.setWorldPosition(this._nowPos),this._moveTime+=t,this._moveTime>.1){if(!this._manager.isGameOver){var a=this._manager.getNearestEnemy(this);if(a){var n,o=null===(n=a.getComponent(i))||void 0===n?void 0:n.radius;a.tmpMinDis-o-this.radius<=this._attackRange&&(this._fightStartTargetPos=null,this.target=a.getComponent(i),this._attack())}}this._moveTime=0}}},o(i,[{key:"timeScale",get:function(){return this._timeScale},set:function(t){this._timeScale=t,this._fighterModel&&this._fighterModel.updateAniSpeed()}},{key:"radius",get:function(){return.3*this.fighterInfo.scale}}]),i}(f)).prototype,"ndModelParent",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v=i(D.prototype,"ndShadow",[A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=D))||I));h._RF.pop()}}}));

System.register("chunks:///_virtual/lodash.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(r){"use strict";var n,t,e;return{setters:[function(r){n=r.defineProperty},function(r){t=r.cclegacy,e=r._decorator}],execute:function(){var u,i,o;t._RF.push({},"36051rP1H1GZqMi/EupE1cf","lodash",void 0);var f=e.ccclass;r("Lodash",f("Lodash")((o=i=function(){function r(){}return r.find=function(n,t){var e;if(Array.isArray(n)||(n=r._toArray(n)),(e=n.filter(t)).length)return e[0]},r.forEach=function(n,t){Array.isArray(n)?n.forEach(t):r._toArrayKey(n).forEach((function(r,e,u){var i=r.key,o=r.value;t(o,i,n)}))},r.cloneDeep=function(n){if(null===n||"object"!=typeof n)return n;var t={};for(var e in n.constructor===Array&&(t=[]),n)n.hasOwnProperty(e)&&(t[e]=r.cloneDeep(n[e]));return t},r.map=function(n,t){Array.isArray(n)||(n=r._toArray(n));var e=[];return n.forEach((function(r,n,u){e.push(t(r,n,u))})),e},r._toArrayKey=function(r){var n=[];for(var t in r)r.hasOwnProperty(t)&&n.push({key:t,value:r[t]});return n},r._toArray=function(r){var n=[];for(var t in r)r.hasOwnProperty(t)&&n.push(r[t]);return n},r.filter=function(n,t){return Array.isArray(n)||(n=r._toArray(n)),n.filter(t)},r.isEqual=function(n,t){if(!(n instanceof Object)||!(t instanceof Object))return n===t;if(Object.keys(n).length!==Object.keys(t).length)return!1;for(var e in n){var u=n[e]instanceof Object,i=t[e]instanceof Object;if(u&&i)return r.isEqual(n[e],t[e]);if(n[e]!==t[e])return!1}return!0},r.pullAllWith=function(r,n,t){return n.forEach((function(n){r.filter((function(r){return t(r,n)})).forEach((function(n){var t=r.indexOf(n);-1!==r.indexOf(n)&&r.splice(t,1)}))})),r},r.now=function(){return Date.now()},r.pullAll=function(r,n){return n.forEach((function(n){var t=r.indexOf(n);-1!==r.indexOf(n)&&r.splice(t,1)})),r},r.forEachRight=function(n,t){Array.isArray(n)||(n=r._toArray(n));for(var e=n.length-1;e>=0;e--){if(!t(n[e]))break}},r.startsWith=function(r,n,t){return(r=r.substr(t)).startsWith(n)},r.endsWith=function(r,n,t){return(r=r.substr(t)).endsWith(n)},r.remove=function(n,t){var e=[],u=[];return n.forEach((function(r,n){t(r)&&(e.push(r),u.push(n))})),r._basePullAt(n,u),e},r._basePullAt=function(r,n){for(var t,e=r?n.length:0,u=e-1;e--;){var i=n[e];e!==u&&i===t||(t=i,Array.prototype.splice.call(r,i,1))}return r},r.findIndex=function(r,n,t){var e;if(r=r.slice(t),"function"==typeof n){for(e=0;e<r.length;e++)if(n(r[e]))return e}else if(Array.isArray(n))for(e=0;e<r.length;e++){var u=n[0],i=!0;if(n.length>1&&(i=n[1]),r[e][u]===i)return e}else for(e=0;e<r.length;e++)if(r[e]===n)return e;return-1},r.concat=function(){var r=arguments.length;if(!r)return[];for(var n=arguments[0],t=1;t<r;)n=n.concat(arguments[t]),t++;return n},r.isNumber=function(r){return"number"==typeof r},r.indexOf=function(r,n,t){return(r=r.slice(t)).indexOf(n)},r.join=function(r,n){if(null===r)return"";var t="";return r.forEach((function(r){t+=r+n})),t.substr(0,t.length-1)},r.split=function(r,n,t){return r.split(n,t)},r.max=function(r){if(r&&r.length){for(var n,t=0;t<r.length;t++)0===t?n=r[0]:n<r[t]&&(n=r[t]);return n}},r.drop=function(r,n){return(null===r?0:r.length)?r.slice(n):[]},r.flattenDeep=function(n){return n.reduce((function(n,t){return n.concat(Array.isArray(t)?r.flattenDeep(t):t)}),[])},r.uniq=function(r){var n=[];return r.forEach((function(r){-1===n.indexOf(r)&&n.push(r)})),n},r.isNaN=function(n){return r.isNumber(n)&&n!==+n},r.chunk=function(r,n){if(!(null===r?0:r.length)||n<1)return[];for(var t=[];r.length>n;)t.push(r.slice(0,n)),r=r.slice(n);return t.push(r),t},r.toFinite=function(r){var n=1/0;return r?(r=Number(r))===n||r===-1/0?17976931348623157e292*(r<0?-1:1):r==r?r:0:0===r?r:0},r.isObject=function(r){var n=typeof r;return null!==r&&("object"===n||"function"===n)},r.isLength=function(n){return"number"==typeof n&&n>-1&&n%1==0&&n<=r.MAX_SAFE_INTEGER},r._isArrayLike=function(n){return null!==n&&r.isLength(n.length)},r.maxBy=function(r,n){if(r&&r.length){for(var t,e,u=0;u<r.length;u++)0===u?(t=n(r[0]),e=r[0]):t<r[u]&&(t=r[u],e=r[u]);return e}},r.minBy=function(r,n){if(r&&r.length){for(var t,e,u=0;u<r.length;u++)0===u?(t=n(r[0]),e=r[0]):t>r[u]&&(t=n(r[u]),e=r[u]);return e}},r.sumBy=function(r,n){var t=0;for(var e in r)t+=n(r[e]);return t},r.countBy=function(r,n){var t={};for(var e in r){var u=n(e);t.hasOwnProperty(u)?t[u]+=1:t[u]=1}return t},r}(),n(i,"MAX_SAFE_INTEGER",9007199254740991),u=o))||u);t._RF.pop()}}}));

System.register("chunks:///_virtual/follow.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./gameLogic.ts","./fighter.ts"],(function(t){"use strict";var e,i,o,r,n,s,a,h,l,_,g,u,c,w,f;return{setters:[function(t){e=t.applyDecoratedDescriptor,i=t.inheritsLoose,o=t.initializerDefineProperty,r=t.assertThisInitialized,n=t.defineProperty},function(t){s=t.cclegacy,a=t._decorator,h=t.CameraComponent,l=t.CCInteger,_=t.Vec3,g=t.Tween,u=t.lerp,c=t.Component},function(t){w=t.GameLogic},function(t){f=t.Fighter}],execute:function(){var p,v,m,d,P,F,H;s._RF.push({},"370a07OJxxNpL08V023XKXC","follow",void 0);var y=a.ccclass,T=a.property;t("Follow",(p=y("Follow"),v=T(h),m=T({type:l}),p((F=e((P=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return e=t.call.apply(t,[this].concat(s))||this,o(r(e),"camera",F,r(e)),o(r(e),"originFov",H,r(e)),n(r(e),"_manager",null),n(r(e),"_posTween",new _),n(r(e),"_rotateTween",new _),n(r(e),"_tweenMove",null),n(r(e),"_tweenRotate",null),n(r(e),"_tweenHeight",null),n(r(e),"_orthoHeight",{value:0}),n(r(e),"_originPosAfterStart",new _(-16,22,16)),n(r(e),"_isStartFollow",!1),n(r(e),"_adjustCoolTime",3),n(r(e),"_targetHeight",-1),n(r(e),"_nextPos",new _),n(r(e),"_targetPos",null),e}i(e,t);var s=e.prototype;return s.onLoad=function(){w.mainCamera=this.camera},s.start=function(){},s.initCamera=function(t){this.node.setWorldPosition(-27.6,21,0),this.node.setWorldRotationFromEuler(-60,-90,0),this._targetPos=null,this._isStartFollow=!1,this.camera.orthoHeight=10,this.camera.fov=this.originFov,this._tweenMove&&(this._tweenMove.stop(),this._tweenMove=null),this._tweenRotate&&(this._tweenRotate.stop(),this._tweenRotate=null),this._tweenHeight&&(this._tweenHeight.stop(),this._tweenHeight=null),t&&(this.node.setWorldPosition(this._originPosAfterStart),this.node.setWorldRotationFromEuler(-45,-45,0))},s.startGame=function(t){var e=this;this._manager=t,this.node.getWorldPosition(this._posTween),this._rotateTween.set(this.node.eulerAngles),this._orthoHeight.value=this.camera.orthoHeight,this._tweenMove=new g(this._posTween).to(1,{x:this._originPosAfterStart.x,y:this._originPosAfterStart.y,z:this._originPosAfterStart.z}).call((function(){e._tweenMove=null,e._targetPos=null,e._isStartFollow=!0,e._adjustCoolTime=3})).start(),this._tweenRotate=new g(this._rotateTween).to(1,{x:-45,y:-45,z:0}).call((function(){e._tweenRotate=null})).start()},s.update=function(t){if(this._tweenMove)this.node.setWorldPosition(this._posTween),this.node.setWorldRotationFromEuler(this._rotateTween.x,this._rotateTween.y,this._rotateTween.z),this.camera.orthoHeight=this._orthoHeight.value;else if(this._isStartFollow)if(this._manager.isGameOver)this._isStartFollow=!1;else if(this._adjustCoolTime-=t,this._adjustCoolTime<0){this._adjustCoolTime=.5;var e=999999,i=-999999,o=999999,r=-999999;for(var n in this._manager.dictFighter){var s=this._manager.dictFighter[n];for(var a in s){var h=s[a].position.x,l=s[a].position.z;e>h&&(e=h),i<h&&(i=h),o>l&&(o=l),r<l&&(r=l)}}var g=i-e,c=r-o;this._targetPos=new _(this._originPosAfterStart.x+g/2+e,this._originPosAfterStart.y,this._originPosAfterStart.z+c/2+o);var w=Math.sqrt(g*g+c*c);this._targetHeight=Math.round(4*w),this._targetHeight=this._targetHeight<this.originFov-10?this.originFov-10:this._targetHeight}else if(this._targetPos){var p=0;for(var v in this._manager.dictFighter){var m=this._manager.dictFighter[v];for(var d in m){m[d].getComponent(f).isDead||(p+=1)}}if(p>0&&(_.lerp(this._nextPos,this.node.position,this._targetPos,1*t),this.node.position=this._nextPos,this._targetHeight>0)){var P=u(this.camera.fov,this._targetHeight,1*t);this.camera.fov=P}}},e}(c)).prototype,"camera",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=e(P.prototype,"originFov",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),d=P))||d));s._RF.pop()}}}));

System.register("chunks:///_virtual/util.ts",["cc"],(function(e){"use strict";var r,t;return{setters:[function(e){r=e.cclegacy,t=e._decorator}],execute:function(){var n;r._RF.push({},"3a324AuObpAT6A94z1mbb0r","util",void 0);var o=t.ccclass;e("Util",o("Util")(n=function(){function e(){}return e.clone=function(e){if(null===e||"object"!=typeof e)return e;var r={};for(var t in e.constructor===Array&&(r=[]),e)e.hasOwnProperty(t)&&(r[t]=this.clone(e[t]));return r},e.objectToArray=function(e){var r=[];for(var t in e)e.hasOwnProperty(t)&&r.push(e[t]);return r},e.arrayToObject=function(e,r){var t={};for(var n in e)e.hasOwnProperty(n)&&e[n][r]&&(t[e[n][r]]=e[n]);return t},e.getWeightRandIndex=function(e,r){for(var t=Math.floor(Math.random()*r),n=0,o=0;o<e.length&&!(t<(n+=e[o]));o++);return o},e.getRandomNFromM=function(e,r){for(var t=[],n=0,o=0;o<r&&!(o>=e+1);){n=this.getRandomInt(0,e);for(var a=0,i=0;i<o;i++)if(t[i]===n){a=1;break}0===a&&(t[o]=n,o++)}return t},e.getRandomInt=function(e,r){var t=Math.random()*(r-e+1)+e;return Math.floor(t)},e.getStringLength=function(e){for(var r=e,t=0,n=0,o=r.length;n<o;n++){t+=r.charCodeAt(n)<=255?1:2}return Math.ceil(t/2)},e.isEmptyObject=function(e){var r=!0;if(e&&e.constructor===Object){for(var t in e)if(e.hasOwnProperty(t)){r=!1;break}}else r=!1;return r},e.isNewDay=function(e){var r=new Date(e),t=new Date,n=r.getYear(),o=r.getMonth(),a=r.getDate(),i=t.getYear(),f=t.getMonth(),u=t.getDate();return i>n||(f>o||u>a)},e.getPropertyCount=function(e){var r,t=0;for(r in e)e.hasOwnProperty(r)&&t++;return t},e.difference=function(e,r){var t=[];if(e.constructor!==Array||r.constructor!==Array)return t;for(var n=e.length,o=0;o<n;o++)-1===r.indexOf(e[o])&&t.push(e[o]);return t},e._stringToArray=function(e){var r,t="\\ufe0e\\ufe0f",n="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",o=RegExp("[\\u200d\\ud800-\\udfff"+n+t+"]"),a="\\ud83c[\\udffb-\\udfff]",i="[\\ufe0e\\ufe0f]?",f="["+n+"]",u="(?:"+f+"|"+a+")"+"?",h="[\\ud800-\\udfff]",c="[^\\ud800-\\udfff]",g="(?:\\ud83c[\\udde6-\\uddff]){2}",d="[\\ud800-\\udbff][\\udc00-\\udfff]",l=i+u+("(?:\\u200d(?:"+[c,g,d].join("|")+")"+i+u+")*"),s="(?:"+[c+f+"?",f,g,d,h].join("|")+")",v=RegExp(a+"(?="+a+")|"+s+l,"g");return r=e,o.test(r)?function(e){return e.match(v)||[]}(e):function(e){return e.split("")}(e)},e.simulationUUID=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e.trim=function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},e.isNowValid=function(e,r){var t=new Date(e),n=new Date(r),o=!1;if(t.getDate()+""!="NaN"&&n.getDate()+""!="NaN"){var a=new Date;o=a<n&&a>t}return o},e.getDeltaDays=function(e,r){e=new Date(e),r=new Date(r);var t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),a=r.getFullYear(),i=r.getMonth()+1,f=r.getDate();e=new Date(t+"/"+n+"/"+o+" GMT+0800").getTime();var u=(r=new Date(a+"/"+i+"/"+f+" GMT+0800").getTime())-e;return Math.floor(u/864e5)},e.getMin=function(e){var r=null;if(e.constructor===Array)for(var t=e.length,n=0;n<t;n++)r=0===n?Number(e[0]):r>Number(e[n])?Number(e[n]):r;return r},e.formatTwoDigits=function(e){return(Array(2).join(0)+e).slice(-2)},e.formatDate=function(e,r){var t={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(var n in/(y+)/.test(r)&&(r=r.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+n+")").test(r)&&(r=r.replace(RegExp.$1,1===RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return r},e.getDay=function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},e.formatName=function(e,r){r=r||6;var t=this._stringToArray(e),n="";if(t.length>r){for(var o=0;o<r;o++)n+=t[o];n+="..."}else n=e;return n},e.formatMoney=function(e){for(var r=["","K","M","G","T","P","E","Z","Y","B","N","D"],t="",n=0;n<r.length;n++){if(!(e>=1e4)){t=Math.floor(e)+r[n];break}e/=1e3}return""===t&&(t=Math.floor(e)+"U"),t},e.formatValue=function(e){for(var r=[],t="",n=0;n<26;n++)r.push(String.fromCharCode(97+n));for(var o=0;o<r.length;o++){if(!(e>=1e4)){t=Math.floor(e)+r[o];break}e/=1e3}return t},e.formatTimeForSecond=function(e,r){void 0===r&&(r=!1);var t="",n=e%60,o=Math.floor(e/60);o=o<0?0:o;var a=Math.floor(o/60),i=o%60;return a>0?(t+=a>9?a.toString():"0"+a,t+=":"):t+="00:",t+=i>9?i.toString():"0"+i,r||(t+=":",t+=n>9?n.toString():"0"+n),t},e.formatTimeForMillisecond=function(e){var r=Math.floor(e/1e3%60),t=Math.floor(e/1e3/60%60);return{hour:Math.floor(e/1e3/60/60),minute:t,second:r}},e.rand=function(e){for(var r=this.clone(e),t=r.length-1;t>=0;t--){var n=Math.floor(Math.random()*(t+1)),o=r[n];r[n]=r[t],r[t]=o}return r},e.getOffsetMimutes=function(e,r){var t=r-e;return Math.floor(t%36e5/6e4)},e.formatNumToFixed=function(e,r){return void 0===r&&(r=0),Number(e.toFixed(r))},e.lerp=function(e,r,t){void 0===t&&(t=.25);var n=r;return e>r?n=r+(e-r)*t:e<r&&(n=r-(r-e)*t),n},e.decrypt=function(e){var r=6;e.length%2==0&&(r=7);for(var t="",n=0;n<e.length-r;n+=2)t+=e[n+1],t+=e[n];return t+=e.slice(e.length-r+1),t=this._base64Decode(t)},e.encrypt=function(e){var r=this._base64encode(e),t=6;r.length%2==0&&(t=7);for(var n="",o=0;o<(r.length-t+1)/2;o++)n+=r[2*o+1],n+=r[2*o];return n+=r.slice(r.length-t+1)},e._base64encode=function(e){var r,t,n,o,a,i,f,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h="",c=0;for(e=this._utf8Encode(e);c<e.length;)o=(r=e.charCodeAt(c++))>>2,a=(3&r)<<4|(t=e.charCodeAt(c++))>>4,i=(15&t)<<2|(n=e.charCodeAt(c++))>>6,f=63&n,isNaN(t)?i=f=64:isNaN(n)&&(f=64),h=h+u.charAt(o)+u.charAt(a)+u.charAt(i)+u.charAt(f);return h},e._utf8Encode=function(e){e=e.replace(/\r\n/g,"\n");for(var r="",t=0;t<e.length;t++){var n=e.charCodeAt(t);n<128?r+=String.fromCharCode(n):n>127&&n<2048?(r+=String.fromCharCode(n>>6|192),r+=String.fromCharCode(63&n|128)):(r+=String.fromCharCode(n>>12|224),r+=String.fromCharCode(n>>6&63|128),r+=String.fromCharCode(63&n|128))}return r},e._utf8Decode=function(e){for(var r="",t=0,n=0,o=0,a=0;t<e.length;)(n=e.charCodeAt(t))<128?(r+=String.fromCharCode(n),t++):n>191&&n<224?(o=e.charCodeAt(t+1),r+=String.fromCharCode((31&n)<<6|63&o),t+=2):(o=e.charCodeAt(t+1),a=e.charCodeAt(t+2),r+=String.fromCharCode((15&n)<<12|(63&o)<<6|63&a),t+=3);return r},e._base64Decode=function(e){var r,t,n,o,a,i,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="",h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<e.length;)r=f.indexOf(e.charAt(h++))<<2|(o=f.indexOf(e.charAt(h++)))>>4,t=(15&o)<<4|(a=f.indexOf(e.charAt(h++)))>>2,n=(3&a)<<6|(i=f.indexOf(e.charAt(h++))),u+=String.fromCharCode(r),64!=a&&(u+=String.fromCharCode(t)),64!=i&&(u+=String.fromCharCode(n));return u=this._utf8Decode(u)},e.checkIsLowPhone=function(){if(window.wx){var e=-1,r=window.wx.getSystemInfoSync();if(r.system.indexOf("iOS")>=0){for(var t=r.model,n=["iPhone1,1","iPhone1,2","iPhone2,1","iPhone3,1","iPhone3,3","iPhone4,1","iPhone5,1","iPhone5,2","iPhone5,3","iPhone5,4","iPhone6,1","iPhone6,2"],o=["iPhone6,2","iPhone7,1","iPhone7,2","iPhone8,1","iPhone8,2","iPhone8,4"],a=["iPhone9,1","iPhone9,2","iPhone9,3","iPhone9,4","iPhone10,1","iPhone10,2","iPhone10,3","iPhone10,4","iPhone10,5","iPhone10,6"],i=["iPhone11,2","iPhone11,4","iPhone11,6","iPhone11,8","iPhone12,1","iPhone12,3","iPhone12,5","iPhone12,8"],f=0;f<n.length;f++)t.indexOf(n[f])>=0&&(e=5);for(var u=0;u<o.length;u++)t.indexOf(o[u])>=0&&(e=10);for(var h=0;h<a.length;h++)t.indexOf(a[h])>=0&&(e=20);for(var c=0;c<i.length;c++)t.indexOf(i[c])>=0&&(e=30)}else e=r.benchmarkLevel;return e<22}return!1},e}())||n);r._RF.pop()}}}));

System.register("chunks:///_virtual/uiManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./resourcesUtils.ts"],(function(i){"use strict";var t,a,e,n,o,r,s;return{setters:[function(i){t=i.defineProperty,a=i.createClass},function(i){e=i.cclegacy,n=i._decorator,o=i.isValid,r=i.find},function(i){s=i.ResourceUtil}],execute:function(){var p,c,h;e._RF.push({},"3a40fDP+PNOpbJ7L2QTa8FM","uiManager",void 0);var l=n.ccclass;i("UIManager",l("UIManager")((h=c=function(){function i(){t(this,"_dictSharedPanel",{}),t(this,"_dictLoading",{}),t(this,"_arrPopupDialog",[])}var e=i.prototype;return e.isDialogVisible=function(i){if(!this._dictSharedPanel.hasOwnProperty(i))return!1;var t=this._dictSharedPanel[i];return o(t)&&t.active&&t.parent},e.showDialog=function(i,t,a){var e=this;if(!this._dictLoading[i]){var n=i.lastIndexOf("/"),p=i.slice(n+1);if(t||(t=[]),this._dictSharedPanel.hasOwnProperty(i)){var c=this._dictSharedPanel[i];if(o(c)){c.parent=r("Canvas"),c.active=!0;var h=c.getComponent(p),l=c.getComponent(p.charAt(0).toUpperCase()+p.slice(1));if(h&&h.show)h.show.apply(h,t),a&&a(h);else{if(!l||!l.show)throw"查找不到脚本文件"+p;l.show.apply(l,t),a&&a(l)}return}}this._dictLoading[i]=!0,s.createUI(i,(function(n,o){var r=!1;if(e._dictLoading[i]||(r=!0),e._dictLoading[i]=!1,n)console.error(n);else{e._dictSharedPanel[i]=o;var s=o.getComponent(p),c=o.getComponent(p.charAt(0).toUpperCase()+p.slice(1));if(s&&s.show)s.show.apply(s,t),a&&a(s);else{if(!c||!c.show)throw"查找不到脚本文件"+p;c.show.apply(c,t),a&&a(c)}r&&e.hideDialog(i)}}))}},e.hideDialog=function(i,t){if(this._dictSharedPanel.hasOwnProperty(i)){var a=this._dictSharedPanel[i];if(a&&o(a)){var e=a.getComponent("animationUI");e?e.close((function(){a.parent=null,t&&"function"==typeof t&&t()})):(a.parent=null,t&&"function"==typeof t&&t())}else t&&"function"==typeof t&&t()}this._dictLoading[i]=!1},e.pushToPopupSeq=function(i,t,a){var e={panelPath:i,scriptName:t,param:a,isShow:!1};this._arrPopupDialog.push(e),this._checkPopupSeq()},e.insertToPopupSeq=function(i,t,a){var e={panelPath:t,param:a,isShow:!1};this._arrPopupDialog.splice(i,0,e)},e.shiftFromPopupSeq=function(i){var t=this;this.hideDialog(i,(function(){t._arrPopupDialog[0]&&t._arrPopupDialog[0].panelPath===i&&(t._arrPopupDialog.shift(),t._checkPopupSeq())}))},e._checkPopupSeq=function(){if(this._arrPopupDialog.length>0){var i=this._arrPopupDialog[0];i.isShow||(this.showDialog(i.panelPath,i.param),this._arrPopupDialog[0].isShow=!0)}},a(i,null,[{key:"instance",get:function(){return this._instance||(this._instance=new i),this._instance}}]),i}(),t(c,"_instance",void 0),p=h))||p);e._RF.pop()}}}));

System.register("chunks:///_virtual/levelTips.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./localConfig.ts","./playerData.ts"],(function(e){"use strict";var t,i,r,n,a,l,o,s,c,u,p,f,h,g,y,d;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,r=e.initializerDefineProperty,n=e.assertThisInitialized,a=e.defineProperty},function(e){l=e.cclegacy,o=e._decorator,s=e.Node,c=e.SpriteComponent,u=e.SpriteFrame,p=e.Vec2,f=e.view,h=e.Component},function(e){g=e.default},function(e){y=e.localConfig},function(e){d=e.PlayerData}],execute:function(){var _,v,E,P,b,F,S,w,T,L,m,I,D;l._RF.push({},"3efdc/ULLlPR4Y6D44J8Kcl","levelTips",void 0);var x=o.ccclass,z=o.property;e("levelTips",(_=x("levelTips"),v=z([s]),E=z(s),P=z(c),b=z(u),F=z(u),_((T=t((w=function(e){function t(){for(var t,i=arguments.length,l=new Array(i),o=0;o<i;o++)l[o]=arguments[o];return t=e.call.apply(e,[this].concat(l))||this,r(n(t),"aryStar",T,n(t)),r(n(t),"ndFlag",L,n(t)),r(n(t),"spFlag",m,n(t)),r(n(t),"sfUpgrade",I,n(t)),r(n(t),"sfExchange",D,n(t)),a(n(t),"_fighterId",null),a(n(t),"_type",null),a(n(t),"_newPos",new p),t}i(t,e);var l=t.prototype;return l.start=function(){},l.onDisable=function(){this._fighterId=null,this._type=null},l.show=function(e,t,i){if(this._newPos.set(e.x/f.getScaleX(),e.y/f.getScaleY()+120),this.node.setWorldPosition(this._newPos.x,this._newPos.y,0),void 0!==t&&void 0!==i&&(this._fighterId!==t||this._type!==i)){this._fighterId=t,this._type=i;var r=y.instance.queryByID("fighter",t.toString()).level;if(i===g.LEVEL_TIPS_TYPE.UPGRADE)d.instance.getFighterNextId(t)>0?r+=1:i=g.LEVEL_TIPS_TYPE.EXCHANGE;this.ndFlag.active=!1,i===g.LEVEL_TIPS_TYPE.UPGRADE?(this.ndFlag.active=!0,this.spFlag.spriteFrame=this.sfUpgrade):i===g.LEVEL_TIPS_TYPE.EXCHANGE&&(this.ndFlag.active=!0,this.spFlag.spriteFrame=this.sfExchange);var n=r%5;n=0!==n?n:5;for(var a=0;a<n;a++)this.aryStar[a].active=!0;for(var l=n;l<this.aryStar.length;l++)this.aryStar[l].active=!1}},t}(h)).prototype,"aryStar",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),L=t(w.prototype,"ndFlag",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m=t(w.prototype,"spFlag",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=t(w.prototype,"sfUpgrade",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=t(w.prototype,"sfExchange",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=w))||S));l._RF.pop()}}}));

System.register("chunks:///_virtual/migrate-canvas.ts",["cc"],(function(){"use strict";var n,e,t,i,r,o,a;return{setters:[function(c){n=c.cclegacy,e=c.director,t=c.Director,i=c.Canvas,r=c.Camera,o=c.game,a=c.Node}],execute:function(){n._RF.push({},"3f141c+VKdCPZwiDv5aHGNP","migrate-canvas",void 0);var c=1048575;function l(n,e){for(var t=0,i=n.children.length;t<i;t++)n.children[t].layer=e,l(n.children[t],e)}e.on(t.EVENT_AFTER_SCENE_LAUNCH,(function(){var n,t,a,s=null===(n=e.getScene())||void 0===n?void 0:n.children,v=null===(t=e.getScene())||void 0===t?void 0:t.getComponentsInChildren(i);if(!(v.length<=1)){v=v.filter((function(n){return!!n.cameraComponent}));var m=null===(a=e.getScene())||void 0===a?void 0:a.getComponentsInChildren(r),u=0;m.forEach((function(n){return u|=n.visibility&c}));for(var p=[],f=0,d=s.length;f<d;f++){var C=s[f];if(o.isPersistRootNode(C)){var h=C.getComponentsInChildren(i);0!==h.length&&p.push.apply(p,h.filter((function(n){return!!n.cameraComponent})))}}p.forEach((function(n){if(v.find((function(e){return e!==n&&e.cameraComponent.visibility&n.cameraComponent.visibility&c}))){var e=~u,t=e&~(e-1);n.cameraComponent.visibility=t|4293918720&n.cameraComponent.visibility,l(n.node,t),u|=e}}))}}));var s=a.prototype.setParent;function v(n){var e=0,t=n.getComponent(i);return t&&t.cameraComponent?e=t.cameraComponent.visibility&t.node.layer?t.node.layer:t.cameraComponent.visibility&~(t.cameraComponent.visibility-1):(n.parent&&(e=v(n.parent)),e)}a.prototype.setParent=function(n,e){if(s.call(this,n,e),n){var t=v(this);t&&(this.layer=t,l(this,t))}},n._RF.pop()}}}));

System.register("chunks:///_virtual/storageManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./util.ts"],(function(t){"use strict";var a,s,e,n,i,o,r,c;return{setters:[function(t){a=t.defineProperty,s=t.createClass},function(t){e=t.cclegacy,n=t._decorator,i=t.sys,o=t.log},function(t){r=t.default},function(t){c=t.Util}],execute:function(){var h,u,_;e._RF.push({},"494bcBC32dJ4rWdXXlHIJfm","storageManager",void 0);var f=n.ccclass;n.property,t("StorageManager",f("StorageManager")((_=u=function(){function t(){a(this,"_jsonData",{}),a(this,"_path",null),a(this,"KEY_CONFIG",r.GAME_NAME),a(this,"_markSave",!1),a(this,"_saveTimer",-1)}var e=t.prototype;return e.start=function(){var t,a=this;(this._jsonData={userId:""},this._path=this._getConfigPath(),i.isNative)?t=jsb.fileUtils.getValueMapFromFile(this._path)[this.KEY_CONFIG]:t=i.localStorage.getItem(this.KEY_CONFIG);if(t&&t.length){t.startsWith("@")&&(t=t.substring(1),t=c.decrypt(t));try{var s=JSON.parse(t);this._jsonData=s}catch(t){}}this._saveTimer=setInterval((function(){a.scheduleSave()}),5e3)},e.setConfigDataWithoutSave=function(t,a){var s=this._jsonData.userId;this._jsonData[s]?this._jsonData[s][t]=a:console.error("no account can not save")},e.setConfigData=function(t,a){this.setConfigDataWithoutSave(t,a),this._markSave=!0},e.getConfigData=function(t){var a=this._jsonData.userId;if(this._jsonData[a]){var s=this._jsonData[a][t];return s||""}return o("no account can not load"),""},e.setGlobalData=function(t,a){this._jsonData[t]=a,this.save()},e.getGlobalData=function(t){return this._jsonData[t]},e.setUserId=function(t){this._jsonData.userId=t,this._jsonData[t]||(this._jsonData[t]={}),this.save()},e.getUserId=function(){return this._jsonData.userId},e.scheduleSave=function(){this._markSave&&this.save()},e.markModified=function(){this._markSave=!0},e.save=function(){var t=JSON.stringify(this._jsonData),a="@"+c.encrypt(t);if(this._markSave=!1,i.isNative){var s={};s[this.KEY_CONFIG]=a,jsb.fileUtils.writeToFile(s,this._path)}else{i.localStorage.setItem(this.KEY_CONFIG,a)}},e._getConfigPath=function(){var t=i.platform,a="";return t===i.OS.WINDOWS?a="src/conf":t===i.OS.LINUX?a="./conf":i.isNative?(a=jsb.fileUtils.getWritablePath(),a+="conf"):a="src/conf",a},s(t,null,[{key:"instance",get:function(){return this._instance||(this._instance=new t,this._instance.start()),this._instance}}]),t}(),a(u,"_instance",void 0),h=_))||h);e._RF.pop()}}}));

System.register("chunks:///_virtual/guide.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./clientEvent.ts","./guideManager.ts"],(function(t){"use strict";var e,n,i,s,o,h,a,r,u,_,d,c,l,g,v,f,T,p,E,y,C,w;return{setters:[function(t){e=t.applyDecoratedDescriptor,n=t.inheritsLoose,i=t.initializerDefineProperty,s=t.assertThisInitialized,o=t.defineProperty},function(t){h=t.cclegacy,a=t._decorator,r=t.Node,u=t.SpriteFrame,_=t.Color,d=t.Vec3,c=t.UITransformComponent,l=t.view,g=t.tween,v=t.Tween,f=t.SpriteComponent,T=t.find,p=t.rect,E=t.EventTouch,y=t.Component},function(t){C=t.ClientEvent},function(t){w=t.GuideManager}],execute:function(){var F,m,H,P,b,S,B,R,A,k,I,O,N,G,U;h._RF.push({},"4b80akLVCFPoZuB6xAOeZbU","guide",void 0);var W=a.ccclass,D=a.property;t("guide",(F=W("guide"),m=D(r),H=D(r),P=D(r),b=D(r),S=D(u),B=D(u),F((k=e((A=function(t){function e(){for(var e,n=arguments.length,h=new Array(n),a=0;a<n;a++)h[a]=arguments[a];return e=t.call.apply(t,[this].concat(h))||this,i(s(e),"ndBackground",k,s(e)),i(s(e),"ndMask",I,s(e)),i(s(e),"ndHand",O,s(e)),i(s(e),"ndFrame",N,s(e)),i(s(e),"sfForce",G,s(e)),i(s(e),"sfUnForce",U,s(e)),o(s(e),"_subGuideInfo",null),o(s(e),"_ndTarget",null),o(s(e),"_targetContent",null),o(s(e),"_refreshPosTimer",null),o(s(e),"_spHand",null),o(s(e),"_ndRecvEvent",null),o(s(e),"_curWaitEvent",null),o(s(e),"_curWaitResetEvent",null),o(s(e),"_isForce",!0),o(s(e),"_isSkipByAnyWhere",!1),o(s(e),"_isHideBlack",!1),o(s(e),"_isTouchStart",!1),o(s(e),"_isDragStart",!1),o(s(e),"_isTouch",!1),o(s(e),"_isShowAni",!1),o(s(e),"_isPlayingAni",!1),o(s(e),"_tweenFrame",null),o(s(e),"_tweenHand",null),o(s(e),"_tweenDrag",null),o(s(e),"_tweenFade",null),o(s(e),"_colorHand",new _(255,255,255,255)),o(s(e),"_oldPos",new d),o(s(e),"_endPos",new d),o(s(e),"_dragScale1",new d(1,1,1)),o(s(e),"_dragScale2",new d(1.2,1.2,1.2)),o(s(e),"_handPos1",new d),o(s(e),"_handPos2",new d),o(s(e),"_touchPos1",new d),o(s(e),"_touchPos2",new d),e}n(e,t);var h=e.prototype;return h.start=function(){this._enableIntercept(!0),this._enableBgBlock(!0)},h._enableIntercept=function(t){t?(this.ndFrame.on(r.EventType.TOUCH_START,this._onTouchStart,this),this.ndFrame.on(r.EventType.TOUCH_END,this._onTouchEnd,this),this.ndFrame.on(r.EventType.TOUCH_CANCEL,this._onTouchCancel,this)):(this.ndFrame.off(r.EventType.TOUCH_START,this._onTouchStart,this),this.ndFrame.off(r.EventType.TOUCH_END,this._onTouchEnd,this),this.ndFrame.off(r.EventType.TOUCH_CANCEL,this._onTouchCancel,this))},h._enableBgBlock=function(t){t?(this.node.on(r.EventType.TOUCH_START,this._onBgTouchStart,this),this.node.on(r.EventType.TOUCH_MOVE,this._onBgTouchMove,this),this.node.on(r.EventType.TOUCH_END,this._onBgTouchEnd,this),this.node.on(r.EventType.TOUCH_CANCEL,this._onBgTouchCancel,this)):(this.node.off(r.EventType.TOUCH_START,this._onBgTouchStart,this),this.node.off(r.EventType.TOUCH_MOVE,this._onBgTouchMove,this),this.node.off(r.EventType.TOUCH_END,this._onBgTouchEnd,this),this.node.off(r.EventType.TOUCH_CANCEL,this._onBgTouchCancel,this))},h.show=function(t,e){if(void 0===e&&(e=!0),this._subGuideInfo=t,this._ndTarget=null,this._targetContent=null,this._oldPos=null,this._isTouch=!1,this._ndRecvEvent=null,this._isShowAni=e,t.getNodeFun){var n=t.getNodeFun.nodeFun;this._ndTarget=n.apply(t.getNodeFun.nodeOwner,t.getNodeFun.nodeParam)}else if(t.getPosFun){var i=t.getPosFun.posFun;this._targetContent=i.apply(t.getPosFun.posOwner,t.getPosFun.posParam)}this._ndTarget||this._targetContent||t.isShowTextOnly?(this._isForce=!0,t.hasOwnProperty("isForce")&&(this._isForce=t.isForce),this._isHideBlack=!1,t.hasOwnProperty("isHideBlack")&&(this._isHideBlack=t.isHideBlack),this._isSkipByAnyWhere=!1,t.hasOwnProperty("isSkipByAnyWhere")&&(this._isSkipByAnyWhere=t.isSkipByAnyWhere),(this._ndTarget||this._targetContent)&&this._updatePosByTargetNode(),this._regFinishEvent(),this._regResetEvent()):w.instance.pauseSubGuide()},h._regFinishEvent=function(){this._curWaitEvent&&(C.off(this._curWaitEvent,this._onFinishEventTrigger,this),this._curWaitEvent=null),this._subGuideInfo.finishConditionEvent&&(this._curWaitEvent=this._subGuideInfo.finishConditionEvent,C.on(this._curWaitEvent,this._onFinishEventTrigger,this))},h._regResetEvent=function(){this._curWaitResetEvent&&(C.off(this._curWaitResetEvent,this._onResetEventTrigger,this),this._curWaitResetEvent=null),this._subGuideInfo.resetConditionEvent&&(this._curWaitResetEvent=this._subGuideInfo.resetConditionEvent,C.on(this._curWaitResetEvent,this._onResetEventTrigger,this))},h._onFinishEventTrigger=function(){this._guideFinish(),C.off(this._curWaitEvent,this._onFinishEventTrigger,this),this._curWaitEvent=null},h._onResetEventTrigger=function(){C.off(this._curWaitResetEvent,this._onResetEventTrigger,this),this._curWaitEvent=null,this.show(this._subGuideInfo,!1)},h._updatePosByTargetNode=function(){var t=null,e=0,n=0;if(this._ndTarget){var i,s=this._ndTarget.getComponent(c);this._touchPos1.set(0,0,0);var o=s.convertToWorldSpaceAR(this._touchPos1);if(this._oldPos&&o.equals(this._oldPos))return;this._oldPos.set(o);var h=.5-s.anchorPoint.x,a=.5-s.anchorPoint.y;o.x+=h*s.width,o.y+=a*s.height,t=null===(i=this.node.getComponent(c))||void 0===i?void 0:i.convertToNodeSpaceAR(o),e=s.contentSize.width+4,this._subGuideInfo.offsetWidth&&(e+=Number(this._subGuideInfo.offsetWidth)),n=s.contentSize.height+4,this._subGuideInfo.offsetHeight&&(n+=Number(this._subGuideInfo.offsetHeight)),this._subGuideInfo.offsetX&&(t.x+=Number(this._subGuideInfo.offsetX)),this._subGuideInfo.offsetY&&(t.y+=Number(this._subGuideInfo.offsetY))}else if(this._targetContent){if(this._oldPos&&this._targetContent.pos&&this._targetContent.pos.equals(this._oldPos))return;this._oldPos=this._targetContent.pos,t=this._targetContent.pos,e=this._targetContent.width,n=this._targetContent.height}this._setMaskRegion(t,e,n),this._showHand(),this._setForce(this._isForce),this._isHideBlack&&this._setForce(!1)},h._setMaskRegion=function(t,e,n){var i=this;0!==e&&0!==n?(this.ndMask.active=!0,this.ndFrame.active=!0):(this.ndMask.active=!1,this.ndFrame.active=!1),this.ndMask.setPosition(t),this.ndFrame.setPosition(t),this._tweenFrame&&(this._tweenFrame.stop(),this._tweenFrame=null);var s=this.ndMask.getComponent(c),o=this.ndFrame.getComponent(c);if(this._isShowAni){var h=l.getViewportRect();s.setContentSize(2*h.width,2*h.height),o.setContentSize(2*h.width,2*h.height),this._isPlayingAni=!0,g(s).to(.5,{width:e,height:n}).call((function(){i._isPlayingAni=!1})).start(),this._tweenFrame=new v(o).to(.5,{width:e,height:n}).delay(1).call((function(){i.ndBackground.active=!1,i.ndFrame.getComponent(f).spriteFrame=i.sfUnForce,i._tweenFrame=null})).union().start()}else s.setContentSize(e,n),o.setContentSize(e,n);this.ndBackground.setPosition(-t.x,-t.y,0),this.ndBackground.active=!0},h._showCombineHand=function(){var t=this;if(this.ndHand.active=!0,this.ndHand.getComponent(f).color=this._colorHand,this._targetContent){var e=this._targetContent.pos;e.x-=110,this._endPos.set(e.x+220,e.y),this._targetContent.dragStart&&(e=this._targetContent.dragStart,this._endPos=this._targetContent.dragEnd);var n=this._endPos.clone().subtract(e).length()/300;this.ndHand.position=e,this.ndHand.setScale(1.2,1.2,1.2),this._spHand=this.ndHand.getComponent(f),this._tweenDrag=new v(this.ndHand).delay(.2).to(.2,{scale:this._dragScale1}).delay(.2).to(n,{position:this._endPos}).delay(.2).to(.2,{scale:this._dragScale2}).call((function(){t._tweenFade&&(t._tweenFade.stop(),t._tweenFade=null),t._tweenFade=new v(t._spHand.color).to(.2,{a:0}).start()})).delay(.4).call((function(){t.ndHand.position=e,t._spHand.color=_.WHITE})).union().repeatForever().start()}else this.ndHand.active=!1},h._showHand=function(){if(this._tweenHand&&(this._tweenHand.stop(),this._tweenHand=null),this._tweenDrag&&(this._tweenDrag.stop(),this._tweenDrag=null),this._tweenFade&&(this._tweenFade.stop(),this._tweenFade=null),this._subGuideInfo.combineGuide)this._showCombineHand();else if(!this._subGuideInfo.isIntroduction||this._subGuideInfo.isShowHandOnTips||this._subGuideInfo.isShowHandOnFrame){this.ndHand.active=!0,this.ndHand.getComponent(f).color=this._colorHand;var t=new d;this.ndFrame&&(t=this.ndFrame.getPosition());var e=l.getViewportRect(),n=this.ndHand.getComponent(c).contentSize;t.x>e.width/2-n.width&&(t.x=e.width/2-n.width),t.y<-(e.height/2-n.height)&&(t.y=-(e.height/2-n.height)),this.ndHand.setPosition(t),this._handPos1.set(t.x+20,t.y-20,0),this._handPos2.set(t.x,t.y,0),this._tweenHand=new v(this.ndHand).to(.5,{position:this._handPos1}).to(.5,{position:this._handPos2}).union().repeatForever().start()}else this.ndHand.active=!1},h._setForce=function(t){this.ndMask.active=t;var e=t?this.sfForce:this.sfUnForce;this.ndFrame.getComponent(f).spriteFrame=e},h._onBgTouchStart=function(t){if(!this._isPlayingAni)return this._isTouchStart=!1,this._isDragStart=!1,this._checkIsTouchNode(t,this._targetContent)?(this._isTouchStart=!0,void(this._subGuideInfo.getPosFun&&this._subGuideInfo.getPosFun.posRecvEventNodePath?(this._ndRecvEvent=T(this._subGuideInfo.getPosFun.posRecvEventNodePath),this._simTouchByEvent(r.EventType.TOUCH_START,t,this._ndRecvEvent)):this._ndRecvEvent=null)):void 0},h._onBgTouchMove=function(t){this._isPlayingAni||(this._isTouchStart&&(this._subGuideInfo.combineGuide||this._checkIsTouchNode(t,this._targetContent))?this._ndRecvEvent&&this._simTouchByEvent(r.EventType.TOUCH_MOVE,t,this._ndRecvEvent):this._isDragStart||this._isForce&&(t.propagationStopped=!0))},h._onBgTouchCancel=function(t){this._isPlayingAni||(this._isTouchStart||this._isDragStart?this._ndRecvEvent&&this._simTouchByEvent(r.EventType.TOUCH_CANCEL,t,this._ndRecvEvent):this._isForce&&(t.propagationStopped=!0))},h._onBgTouchEnd=function(t){this._isPlayingAni||(this._isTouchStart?this._ndRecvEvent&&this._simTouchByEvent(r.EventType.TOUCH_END,t,this._ndRecvEvent):this._isDragStart||this._isForce&&(this._isHideBlack&&this._isSkipByAnyWhere&&this._guideFinish(),t.propagationStopped=!0))},h._guideFinish=function(){this._refreshPosTimer&&(clearInterval(this._refreshPosTimer),this._refreshPosTimer=null),w.instance.finishBigGuide()},h._checkIsTouchNode=function(t,e){var n;if(!e)return!1;var i=t.getUILocation();this._touchPos2.set(e.pos.x,e.pos.y,0);var s=null===(n=this.node.getComponent(c))||void 0===n?void 0:n.convertToWorldSpaceAR(this._touchPos2);return!!p(s.x-e.width/2,s.y-e.height/2,e.width,e.height).contains(i)},h._onTouchStart=function(t){this._isPlayingAni||(console.log("shadows touchStart"),this._isTouch||this._ndTarget&&this._simTouchByEvent(r.EventType.TOUCH_START,t,this._ndTarget))},h._onTouchEnd=function(t){this._isPlayingAni||(console.log("shadows touchEnd"),this._isTouch||(this._isTouch=!0,this._ndTarget&&(this._simTouchByEvent(r.EventType.TOUCH_END,t,this._ndTarget),this._guideFinish())))},h._onTouchCancel=function(t){this._isPlayingAni||(console.log("shadows touchCancel"),this._ndTarget&&this._simTouchByEvent(r.EventType.TOUCH_CANCEL,t,this._ndTarget))},h._simTouchByEvent=function(t,e,n){"function"!=typeof e.getTouches&&console.error("oldEvent.getTouches is not a function!type("+typeof e.getTouches+")");var i=new E(e.getTouches(),e.bubbles,t);i.touch=e.touch,i.simulate=!0,n?n.dispatchEvent(i):i.eventManager.dispatchEvent(i)},e}(y)).prototype,"ndBackground",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=e(A.prototype,"ndMask",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O=e(A.prototype,"ndHand",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=e(A.prototype,"ndFrame",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G=e(A.prototype,"sfForce",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U=e(A.prototype,"sfUnForce",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R=A))||R));h._RF.pop()}}}));

System.register("chunks:///_virtual/clientEvent.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(e){"use strict";var r,n,t;return{setters:[function(e){r=e.defineProperty},function(e){n=e.cclegacy,t=e._decorator}],execute:function(){var a,l,c;n._RF.push({},"504f0VEo7JPI7YcwXi7DtgE","clientEvent",void 0);var i=t.ccclass;t.property,e("ClientEvent",i("ClientEvent")((c=l=function(){function e(){}return e.on=function(r,n,t){var a={handler:n,target:t},l=e._handlers[r];l||(l=[],e._handlers[r]=l);for(var c=0;c<l.length;c++)if(!l[c])return l[c]=a,c;return l.push(a),l.length},e.off=function(r,n,t){var a=e._handlers[r];if(a)for(var l=0;l<a.length;l++){var c=a[l];if(c.handler===n&&(!t||t===c.target)){a.splice(l,1);break}}},e.dispatchEvent=function(r){for(var n=arguments.length,t=new Array(n>1?n-1:0),a=1;a<n;a++)t[a-1]=arguments[a];var l,c=e._handlers[r],i=[];for(l=1;l<arguments.length;l++)i.push(arguments[l]);if(c)for(l=0;l<c.length;l++){var o=c[l];o.handler&&o.handler.apply(o.target,i)}},e}(),r(l,"_handlers",{}),a=c))||a);n._RF.pop()}}}));

System.register("chunks:///_virtual/guideManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./playerData.ts","./clientEvent.ts","./uiManager.ts","./fighterManager.ts"],(function(i){"use strict";var e,t,n,u,s,r,a,d,h,o;return{setters:[function(i){e=i.defineProperty,t=i.createClass},function(i){n=i.cclegacy,u=i._decorator,s=i.find},function(i){r=i.default},function(i){a=i.PlayerData},function(i){d=i.ClientEvent},function(i){h=i.UIManager},function(i){o=i.FighterManager}],execute:function(){var c,_,G;n._RF.push({},"506a9nYRztOcbBiWjnuXag/","guideManager",void 0);var f=u.ccclass;u.property,i("GuideManager",f("GuideManager")((G=_=function(){function i(){e(this,"_isStart",!1),e(this,"_currentWaitEvent",""),e(this,"_isGuiding",!1),e(this,"_isPlaying",!1),e(this,"_currentSubGuideInfo",null),e(this,"_finishGuideObj",{}),e(this,"_aryGuideSteps",[]),e(this,"_currentSubGuideIndex",0),e(this,"_currentBigGuideInfo",null),e(this,"_callBackFunc",null)}var n=i.prototype;return n._init=function(){this._currentWaitEvent="",this._isGuiding=!1,this._isPlaying=!1,this._currentSubGuideInfo=null,this._finishGuideObj={}},n.startGuide=function(){this._isStart=!0,this._loadGuideStep(),this._loadFinishGuide(),this._enterBigGuide()},n._loadGuideStep=function(){this._aryGuideSteps=[{id:r.GUIDE_STEP.START,guideVersion:1,title:"开始引导",guideLs:[{title:"延时-为避免没有引导",type:r.GUIDE_TYPE.DELAY,param:[100]}]},{id:r.GUIDE_STEP.BUY,guideVersion:1,title:"引导-购买",guideLs:[{title:"延时-为避免没有引导",type:r.GUIDE_TYPE.DELAY,param:[50]}]},{id:r.GUIDE_STEP.COMBINE_ONE,guideVersion:1,title:"引导-合成-1",guideLs:[{title:"等待进入主场景",type:r.GUIDE_TYPE.WAIT_EVENT,param:["onHomeShow"]},{title:"延时-为避免没有引导",type:r.GUIDE_TYPE.DELAY,param:[100]},{title:"引导合成",type:r.GUIDE_TYPE.GUIDE,offsetWidth:40,offsetHeight:40,getPosFun:{posFun:this.execFun,posOwner:this,posParam:["getCombineContent"],posRecvEventNodePath:"Canvas/homeUI"},combineGuide:!0,finishConditionEvent:"combineSucceed",resetConditionEvent:"swapSucceed"}]},{id:r.GUIDE_STEP.COMBINE_TWO,guideVersion:1,title:"引导-合成-2",guideLs:[{title:"通知显示指向开始游戏的手指",type:r.GUIDE_TYPE.TRIGGER_EVENT,param:["showStartGameHandForGuide"]}]},{id:r.GUIDE_STEP.BUY_CELL,guideVersion:1,title:"引导-购买格子",guideLs:[{title:"等待没有格子的时候",type:r.GUIDE_TYPE.WAIT_EVENT,param:["noEnoughPos"]},{title:"通知显示购买格子按钮",type:r.GUIDE_TYPE.TRIGGER_EVENT,param:["showBuyCellForGuide"]},{title:"延时-为避免没有引导",type:r.GUIDE_TYPE.DELAY,param:[100]},{title:"引导购买格子",type:r.GUIDE_TYPE.GUIDE,offsetWidth:40,offsetHeight:40,getNodeFun:{nodeFun:this.execFun,nodeOwner:this,nodeParam:["getBuyCellButton"]}}]}]},n._loadFinishGuide=function(){var i=this,e=a.instance.getFinishGuide();e.length>0&&e.forEach((function(e){i._finishGuideObj[e]=!0}),this);for(var t=0;t<this._aryGuideSteps.length;t++){var n=this._aryGuideSteps[t].id;this._aryGuideSteps[t].isFinish=this._finishGuideObj.hasOwnProperty(n)&&this._finishGuideObj[n]}},n._enterBigGuide=function(){if(this._isStart)return this._isGuiding?this._checkGuide():this._findNewBigGuide(),null!==this._currentSubGuideInfo},n._findNewBigGuide=function(){for(var i=0;i<this._aryGuideSteps.length;i++){var e=this._aryGuideSteps[i];if(!e.isFinish)return!!this._isConditionFinish(e.guideLs[0])&&(this._playSubGuide(i),!0)}return!1},n._checkGuide=function(){return!!this._isGuiding&&(this._isConditionFinish(this._currentSubGuideInfo)?this._isPlaying||this._continueSubGuide():this._isPlaying&&this.pauseSubGuide(),!0)},n.hasFinishGuide=function(i){return!!this._finishGuideObj[i]},n._isConditionFinish=function(i){return!i.hasOwnProperty("condition")||i.condition.apply(i.conditionOwner,i.conditionParam)},n._isNeedSkipBigGuide=function(){return!(!this._currentBigGuideInfo||!this._currentBigGuideInfo.hasOwnProperty("skipGuide"))&&this._currentBigGuideInfo.skipGuide.fun.apply(this._currentBigGuideInfo.skipGuide.owner,this._currentBigGuideInfo.skipGuide.param)},n.pauseSubGuide=function(){this._isPlaying=!1,this._currentSubGuideInfo.type===r.GUIDE_TYPE.GUIDE&&this._hideGuidePanel(),this._currentSubGuideInfo.isSkipAfterPause&&this.finishBigGuide()},n._continueSubGuide=function(){this._isPlaying=!0,this._doPlaySubGuide(this._currentSubGuideInfo)},n._isNeedPassSubGuide=function(){return!(!this._currentSubGuideInfo||!this._currentSubGuideInfo.hasOwnProperty("passCondition"))&&this._currentSubGuideInfo.passCondition.apply(this._currentSubGuideInfo.passConditionOwner,this._currentSubGuideInfo.passConditionParam)},n._playSubGuide=function(i){this._currentSubGuideIndex=0,this._currentBigGuideInfo=this._aryGuideSteps[i],console.log("### start guide: ",this._currentBigGuideInfo.id),this._currentSubGuideInfo=this._currentBigGuideInfo.guideLs[this._currentSubGuideIndex],this._isNeedSkipBigGuide()?this.finishBigGuide(!0):this._doPlaySubGuide(this._currentBigGuideInfo.guideLs[this._currentSubGuideIndex])},n.finishBigGuide=function(i){if(void 0===i&&(i=!1),this._currentSubGuideInfo){switch(this._currentSubGuideInfo.type){case r.GUIDE_TYPE.GUIDE:this._hideGuidePanel()}if(this._currentSubGuideInfo.hasOwnProperty("afterFun"))this._currentSubGuideInfo.afterFun.apply(this._currentSubGuideInfo.afterOwner,this._currentSubGuideInfo.afterParam);if((this._currentSubGuideInfo.hasOwnProperty("guideOver")||this._currentSubGuideIndex>=this._currentBigGuideInfo.guideLs.length-1||i)&&!this._currentBigGuideInfo.isFinish){this._currentBigGuideInfo.isFinish=!0;var e=this._currentBigGuideInfo.id;this._finishGuideObj[e]=!0,a.instance.finishGuide(e)}this._currentSubGuideIndex>=this._currentBigGuideInfo.guideLs.length-1||i?(this._isGuiding=!1,this._isPlaying=!1,this._currentBigGuideInfo=null,this._currentSubGuideIndex=null,this._currentSubGuideInfo=null,this._findNewBigGuide()):(this._currentSubGuideIndex++,this._currentSubGuideInfo=this._currentBigGuideInfo.guideLs[this._currentSubGuideIndex],this._doPlaySubGuide(this._currentSubGuideInfo))}},n._doPlaySubGuide=function(i){var e=this;if(this._currentSubGuideInfo=i,this._isGuiding=!0,this._isNeedPassSubGuide())return this.finishBigGuide(),!0;if(this._isConditionFinish(this._currentSubGuideInfo)){if(i.hasOwnProperty("beforeFun"))i.beforeFun.apply(i.beforeOwner,i.beforeParam);switch(this._isPlaying=!1,i.type){case r.GUIDE_TYPE.TRIGGER_EVENT:this._isPlaying=!0,d.dispatchEvent(i.param[0],i.param[1]),this.finishBigGuide();break;case r.GUIDE_TYPE.SPACE:this.finishBigGuide();break;case r.GUIDE_TYPE.GUIDE:this._isPlaying=!0,this._showGuidePanel(i);break;case r.GUIDE_TYPE.WAIT_EVENT:this._isPlaying=!0,this._callBackFunc&&(d.off(this._currentWaitEvent,this._callBackFunc,this),this._callBackFunc=null,this._currentWaitEvent=""),this._callBackFunc=function(){d.off(i.param[0],e._callBackFunc,e),e._currentSubGuideInfo&&e._currentSubGuideInfo.type===r.GUIDE_TYPE.WAIT_EVENT&&e._currentSubGuideInfo.param[0]===i.param[0]&&(e._callBackFunc=null,e._currentWaitEvent="",e.finishBigGuide())},this._currentWaitEvent=i.param[0],d.on(i.param[0],this._callBackFunc,this);break;case r.GUIDE_TYPE.DELAY:setTimeout((function(){e.finishBigGuide()}),i.param[0])}}else this._isPlaying=!1},n._showGuidePanel=function(i){h.instance.showDialog("guide/guide",[i])},n._hideGuidePanel=function(){h.instance.hideDialog("guide/guide")},n.execFun=function(i,e){switch(i){case"getStartButton":return s("homeUI/start/btnStart",this.ndCanvas);case"getBuyButton":return s("homeUI/menu/buy",this.ndCanvas);case"isFightStart":return!h.instance.isDialogVisible("home/homeUI");case"getCombineContent":var t=s("game/fighters");return(null==t?void 0:t.getComponent(o)).getCombineContentForGuide();case"getBuyCellButton":return s("homeUI/menu/buyCell",this.ndCanvas)}},n.isPlayingBuyGuide=function(){return this._isPlaying&&this._currentBigGuideInfo.id===r.GUIDE_STEP.BUY},t(i,[{key:"ndCanvas",get:function(){return s("Canvas")}}],[{key:"instance",get:function(){return this._instance||(this._instance=new i,this._instance._init()),this._instance}}]),i}(),e(_,"_instance",void 0),c=G))||c);n._RF.pop()}}}));

System.register("chunks:///_virtual/coinTipsManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./poolManager.ts","./gameLogic.ts"],(function(e){"use strict";var n,t,o,i,r,s,a,c,p,l,u,f,h,g;return{setters:[function(e){n=e.applyDecoratedDescriptor,t=e.inheritsLoose,o=e.initializerDefineProperty,i=e.assertThisInitialized,r=e.defineProperty},function(e){s=e.cclegacy,a=e._decorator,c=e.Prefab,p=e.Vec3,l=e.LabelComponent,u=e.Tween,f=e.Component},function(e){h=e.PoolManager},function(e){g=e.GameLogic}],execute:function(){var d,v,y,_,w;s._RF.push({},"566572pKjZKGozWyhy0Ko0W","coinTipsManager",void 0);var M=a.ccclass,m=a.property;e("coinTipsManager",(d=M("coinTipsManager"),v=m(c),d((w=n((_=function(e){function n(){for(var n,t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n=e.call.apply(e,[this].concat(s))||this,o(i(n),"pfCoinTips",w,i(n)),r(i(n),"_uiPos",new p),r(i(n),"_scale1",new p(1.2,1.2,1.2)),r(i(n),"_scale2",new p(1,1,1)),r(i(n),"_pos1",new p(0,100,0)),n}t(n,e);var s=n.prototype;return s.start=function(){},s.dropCoin=function(e,n){var t=h.instance.getNode(this.pfCoinTips,this.node);g.mainCamera.convertToUINode(n,this.node,this._uiPos),t.setPosition(this._uiPos);var o=t.getChildByName("num");o&&(o.getComponent(l).string=e.toString()),t.setScale(0,0,0),t.tweenMove=new u(t).to(.3,{scale:this._scale1}).to(.1,{scale:this._scale2}).by(.6,{position:this._pos1}).union().call((function(){t.tweenMove=null,h.instance.putNode(t)})).start()},s.recycle=function(){var e=[];this.node.children.forEach((function(n){e.push(n)})),e.forEach((function(e){e.tweenMove&&(e.tweenMove.stop(),e.tweenMove=null),h.instance.putNode(e)}))},n}(f)).prototype,"pfCoinTips",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y=_))||y));s._RF.pop()}}}));

System.register("chunks:///_virtual/playerData.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./storageManager.ts","./localConfig.ts"],(function(e){"use strict";var t,i,n,a,o,r,s;return{setters:[function(e){t=e.defineProperty,i=e.createClass},function(e){n=e.cclegacy,a=e._decorator},function(e){o=e.default},function(e){r=e.StorageManager},function(e){s=e.localConfig}],execute:function(){var l,h,f;n._RF.push({},"58adfsYmadHl65bvnduo9tU","playerData",void 0);var u=a.ccclass;a.property,e("PlayerData",u("PlayerData")((f=h=function(){function e(){t(this,"serverTime",0),t(this,"localTime",0),t(this,"userId",""),t(this,"playerInfo",null),t(this,"isNewBee",!1),t(this,"dataVersion",""),t(this,"settings",{}),t(this,"formation",{}),t(this,"isLoadFinished",!1),t(this,"waitingUnlock",-1),t(this,"waitingBuy",-1),t(this,"isLastFightWin",!0)}var n=e.prototype;return n.loadGlobalCache=function(){var e=r.instance.getUserId();e&&(this.userId=e)},n.loadFromCache=function(){this.playerInfo=this.loadDataByKey(o.LOCAL_CACHE.PLAYER),this.settings=this.loadDataByKey(o.LOCAL_CACHE.SETTINGS),this.formation=this.loadDataByKey(o.LOCAL_CACHE.FORMATION)},n.loadDataByKey=function(e){var t={},i=r.instance.getConfigData(e);if(i)try{t=JSON.parse(i)}catch(e){t={}}return t},n.createPlayerInfo=function(e){if(this.playerInfo={gold:100,level:1,createDate:new Date,buyTimes:0,buyCellTimes:0,unlock:[o.BASE_FIGHTER],onlineReward:0,finishGuides:[],hasUsedFireBall:!1},this.isNewBee=!0,e)for(var t in e)this.playerInfo[t]=e[t];this.createDefaultFormation(),this.saveAll()},n.createDefaultFormation=function(){this.formation={1:101,2:101,3:101}},n.updatePlayerInfo=function(e,t){var i=!1;this.playerInfo.hasOwnProperty(e)&&("number"==typeof t?(i=!0,this.playerInfo[e]+=t,this.playerInfo[e]<0&&(this.playerInfo[e]=0)):"boolean"!=typeof t&&"string"!=typeof t||(i=!0,this.playerInfo[e]=t)),i&&this.savePlayerInfoToLocalCache()},n.savePlayerInfoToLocalCache=function(){r.instance.setConfigData(o.LOCAL_CACHE.PLAYER,JSON.stringify(this.playerInfo))},n.saveFormationToLocalCache=function(){r.instance.setConfigData(o.LOCAL_CACHE.FORMATION,JSON.stringify(this.formation))},n.saveAll=function(){r.instance.setConfigDataWithoutSave(o.LOCAL_CACHE.PLAYER,JSON.stringify(this.playerInfo)),r.instance.setConfigDataWithoutSave(o.LOCAL_CACHE.SETTINGS,JSON.stringify(this.settings)),r.instance.setConfigDataWithoutSave(o.LOCAL_CACHE.FORMATION,JSON.stringify(this.formation)),r.instance.setConfigData(o.LOCAL_CACHE.DATA_VERSION,this.dataVersion)},n.getFinishGuide=function(){return this.playerInfo.hasOwnProperty("finishGuides")?this.playerInfo.finishGuides:[]},n.finishGuide=function(e){this.playerInfo.finishGuides||(this.playerInfo.finishGuides=[]),-1===this.playerInfo.finishGuides.indexOf(e)&&(this.playerInfo.finishGuides.push(e),this.savePlayerInfoToLocalCache())},n.syncServerTime=function(e){this.serverTime=e,this.localTime=Date.now()},n.getCurrentTime=function(){var e=Date.now()-this.localTime;return this.serverTime+e},n.clear=function(){this.playerInfo=null,this.settings={},this.formation={},this.saveAll()},n.generateRandomAccount=function(){this.userId=""+Date.now()+10,r.instance.setUserId(this.userId)},n.getFormationFight=function(){return this._getFormationFight(this.formation)},n._getFormationFight=function(e){var t=0;for(var i in e){var n=e[i];if(n>0){var a=s.instance.queryByID("fighter",n);t+=a.num*a.fight}}return t},n.getCurLevelEnemyFight=function(){return this._getFormationFight(this.getCurLevelEnemy())},n.getCurLevelEnemy=function(){var e=s.instance.queryByID("level",this.playerInfo.level.toString()).formation.split("_"),t={};return e.forEach((function(e){var i=e.split("#"),n=i[0],a=i[1];t[a]=n})),t},n.passLevel=function(){var e=s.instance.queryByID("level",this.playerInfo.level.toString()).unlock;e&&-1===this.playerInfo.unlock.indexOf(e)&&(this.playerInfo.unlock.push(e),this.savePlayerInfoToLocalCache(),this.waitingUnlock=e,this.waitingBuy=e),this.playerInfo.level++,this.playerInfo.level>o.MAX_LEVEL&&(this.playerInfo.level=o.MAX_LEVEL),this.savePlayerInfoToLocalCache()},n._getBuyTimes=function(){var e=0;return this.playerInfo.buyTimes&&(e=this.playerInfo.buyTimes),e},n.addBuyTimes=function(){this.playerInfo.buyTimes?this.playerInfo.buyTimes++:this.playerInfo.buyTimes=1,this.savePlayerInfoToLocalCache()},n.getBuyFighterPrice=function(){var e=this._getBuyTimes();return e<13?30+10*e:160+Math.round(30*Math.pow(1.07,e-13))},n.getBuyCellPrice=function(){return Math.floor(100*Math.pow(1.2,this.getBuyCellTimes()))},n.getBuyCellTimes=function(){var e=0;return this.playerInfo.buyCellTimes&&(e=this.playerInfo.buyCellTimes),e},n.addBuyCellTimes=function(){this.playerInfo.buyCellTimes?this.playerInfo.buyCellTimes++:this.playerInfo.buyCellTimes=1,this.savePlayerInfoToLocalCache()},n.getEmptyPos=function(){for(var e in this.formation)if(0===this.formation[e])return Number(e);return-1},n.getUnlockFighters=function(){return this.playerInfo.unlock?this.playerInfo.unlock:[o.BASE_FIGHTER]},n.getRandomBuyFighter=function(){if(this.waitingBuy>0){var e=this.waitingBuy;return this.waitingBuy=-1,e}var t=this.getUnlockFighters();return t[Math.floor(Math.random()*t.length)]},n.addFighter=function(e,t){if(0!==this.formation[e])return!1;this.formation[e]=Number(t),this.saveFormationToLocalCache()},n.getFighterIdByCellPos=function(e){return this.formation[e]},n.addCell=function(){var e=Object.keys(this.formation).length,t=o.UNLOCK_CELL_SEQ[e];return e>=o.UNLOCK_CELL_SEQ.length&&(t=e),this.formation[t]=0,this.saveFormationToLocalCache(),t},n.swapCell=function(e,t){var i=this.formation[e];this.formation[e]=this.formation[t],this.formation[t]=i,this.saveFormationToLocalCache()},n.getFighterNextId=function(e){var t=s.instance.queryByID("fighter",e.toString()),i=s.instance.queryOneByCondition("fighter",{level:t.level+1,type:t.type});return i?Number(i.ID):-1},n.combineCell=function(e,t,i){this.formation[e]=0,this.formation[t]=i,this.saveFormationToLocalCache()},n.updateOnlineReward=function(t){void 0===t&&(t=1e3),this.playerInfo.onlineReward||(this.playerInfo.onlineReward=0),this.playerInfo.onlineReward+=o.ONLINE.PROFIT_PER_SECOND*e.instance.getBuyFighterPrice()*t/1e3,this.playerInfo.onlineReward=Number(this.playerInfo.onlineReward.toFixed(2)),this.savePlayerInfoToLocalCache()},n.getOnlineReward=function(){return this.playerInfo.onlineReward||(this.playerInfo.onlineReward=0),Math.floor(this.playerInfo.onlineReward)},n.reduceOnlineReward=function(e){this.playerInfo.onlineReward||(this.playerInfo.onlineReward=0),this.playerInfo.onlineReward-=e,this.playerInfo.onlineReward=Number(this.playerInfo.onlineReward.toFixed(2)),this.savePlayerInfoToLocalCache()},n.markUseFireBall=function(){this.playerInfo.hasUsedFireBall=!0,this.savePlayerInfoToLocalCache()},i(e,[{key:"gold",get:function(){return this.playerInfo.gold}}],[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}(),t(h,"_instance",void 0),l=f))||l);n._RF.pop()}}}));

System.register("chunks:///_virtual/constants.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(E){"use strict";var _,A,I;return{setters:[function(E){_=E.defineProperty},function(E){A=E.cclegacy,I=E._decorator}],execute:function(){var T,e,R;A._RF.push({},"5cda5HMDj9GC4JUS9Jf1t/v","constants",void 0);var L=I.ccclass;I.property,E("default",L((R=e=function(){},_(e,"PANEL_GROUP",{UI_ROOT:0,GAME_ROOT:1}),_(e,"PANEL_HIERARCHY",{BASE:1,MARQUEE:5e3,MODAL:1e4,POPUP:15e3,TIPS:2e4}),_(e,"FIGHTER_TYPE",{CLOSE:1,OX:2,BAT:3,AXE:4,ARCHER:5,BOMBER:6}),_(e,"FIGHTER_MODEL",{1:"axe",2:"altman",3:"soldier",4:"javelin",5:"catapult",6:"clown"}),_(e,"LOCAL_CACHE",{PLAYER:"player",SETTINGS:"settings",DATA_VERSION:"dataVersion",ACCOUNT:"account",FORMATION:"formation"}),_(e,"GAME_NAME",void 0),_(e,"MAX_LEVEL",50),_(e,"BASE_FIGHTER",101),_(e,"UNLOCK_CELL_SEQ",[1,2,3,7,6,8,12,11,13,17,16,18,15,19,10,14,5,9,0,4,22,21,23,20,24,27,26,28,25,29,32,31,33,30,34,37,36,38,35,39,42,41,43,40,44,47,46,48,45,49]),_(e,"COLLIDER_GROUP",{PLANE:1}),_(e,"CELL_FIGHTER_SPACING",.3),_(e,"PLAYER_TEAM",1),_(e,"ENEMY_TEAM",2),_(e,"ONLINE",{MAX_TIME:1800,PROFIT_PER_SECOND:.01,TIME_PER_CIRCLE:10}),_(e,"FIRE_BALL_DISTANCE",2.5),_(e,"FIRE_BALL_DAMAGE_PERCENT",.5),_(e,"FIRE_BALL_COOL_TIME",10),_(e,"PTM_RATIO",.1),_(e,"GUIDE_STEP",{START:100,BUY:200,COMBINE_ONE:300,COMBINE_TWO:400,BUY_CELL:500,LAST_GUIDE:700}),_(e,"GUIDE_TYPE",{SPACE:0,GUIDE_ANI:1,TRIGGER_EVENT:2,WAIT_EVENT:3,GUIDE:4,DELAY:5}),_(e,"AUDIO_SOUND",{BACKGROUND:"background",BUY_CELL:"buyCell",BUY_FIGHTER:"buyFighter",COMBINE:"combine",FIGHT_START:"fightStart",WIN:"win",FAIL:"fail",FIRE_BALL:"fireBall",RAMPAGE:"rampage"}),_(e,"EVENT_NAME",{BUY_CELL:"buyCell",BUY_FIGHTER:"buyFighter",COMBINE_SUCCEED:"combineSucceed",DROP_COIN:"dropCoin",FIGHT_START:"fightStart",FIGHT_RESET:"fightReset",GAME_INIT:"gameInit",GAME_OVER:"gameOver",HOME_UI_TOUCH:"homeUITouch",HIDE_ALL_SIMILAR:"hideAllSimilar",UPDATE_GOLD:"updateGold",UPDATE_LEVEL:"updateLevel",USE_FIRE_BALL:"useFireBall",UPDATE_FORMATION:"updateFormation",UPDATE_ONLINE_REWARD:"updateOnlineReward",REC_ONLINE_REWARD:"recOnlineReward",SHOW_SPRINT:"showSprint",SHOW_LEVEL_TIPS:"showLevelTips"}),_(e,"ANI_TYPE",{IDLE:"idle",RUN:"run",ATTACK:"attack",WIN:"win",DIED:"died"}),_(e,"FIGHTER_STATUS",{IDLE:0,CHARGE:1,FIND:2,MOVE:3,ATTACK:4,WIN:5,DEAD:6}),_(e,"LEVEL_TIPS_TYPE",{NONE:0,UPGRADE:1,EXCHANGE:2}),T=R))||T);A._RF.pop()}}}));

System.register("chunks:///_virtual/resourcesUtils.ts",["cc","./constants.ts"],(function(e){"use strict";var n,t,o,r,i,a,s,f,l,u,c;return{setters:[function(e){n=e.cclegacy,t=e._decorator,o=e.resources,r=e.error,i=e.Prefab,a=e.SpriteFrame,s=e.Texture2D,f=e.instantiate,l=e.find,u=e.isValid},function(e){c=e.default}],execute:function(){var d;n._RF.push({},"70839MN671LJosdxppBRfP9","resourcesUtils",void 0);var p=t.ccclass;e("ResourceUtil",p("ResourceUtil")(d=function(){function e(){}return e.loadRes=function(e,n,t){void 0===t&&(t=function(){}),o.load(e,(function(e,n){if(e)return r(e.message||e),void t(e,n);t&&t(null,n)}))},e.loadEffectRes=function(e){var n=this;return new Promise((function(t,o){n.loadRes("prefab/effect/"+e,i,(function(n,r){if(n)return console.error("effect load failed",e),void(o&&o());t&&t(r)}))}))},e.loadModelRes=function(e){var n=this;return new Promise((function(t,o){n.loadRes("prefab/model/"+e,i,(function(n,r){if(n)return console.error("model load failed",e),void(o&&o());t&&t(r)}))}))},e.loadModelResArr=function(e,n,t,r){var a=n.map((function(n){return e+"/"+n}));o.load(a,i,t,r)},e.loadSpriteFrameRes=function(e){var n=this;return new Promise((function(t,o){n.loadRes(e,a,(function(n,r){if(n)return console.error("spriteFrame load failed!",e,n),void(o&&o());var i=new s;i.image=r;var f=new a;f.texture=i,t&&t(f)}))}))},e.getMap=function(e,n){var t="map";t+=e>=100?e:e>=10?"0"+e:"00"+e,this.loadRes("map/config/"+t,null,(function(e,t){if(e)n(e,t);else{var o="";if(t._file){window.LZString&&(o=window.LZString.decompressFromEncodedURIComponent(t._file));var r=JSON.parse(o);n(null,r)}else if(t.text){window.LZString&&(o=window.LZString.decompressFromEncodedURIComponent(t.text));var i=JSON.parse(o);n(null,i)}else t.json?n(null,t.json):n("failed")}}))},e.getMapObj=function(e,n,t,r){for(var a=[],s=0;s<n.length;s++)a.push("map/"+e+"/"+n[s]);o.load(a,i,t,r)},e.getUIPrefabRes=function(e,n){this.loadRes("prefab/ui/"+e,i,n)},e.createUI=function(e,n,t){this.getUIPrefabRes(e,(function(e,o){if(!e){var r=f(o);r.setPosition(0,0,0),t||(t=l("Canvas")),t.addChild(r),n&&n(null,r)}}))},e.getJsonData=function(e,n){this.loadRes("datas/"+e,null,(function(e,t){e?r(e.message||e):t.json?n(e,t.json):n("failed!!!")}))},e.getTextData=function(e,n){this.loadRes("datas/"+e,null,(function(e,t){if(e)r(e.message||e);else{var o=t.text;n(e,o)}}))},e.setSpriteFrame=function(e,n,t){this.loadRes(e+"/spriteFrame",a,(function(o,r){if(o)return console.error("set sprite frame failed! err:",e,o),void t(o);n&&u(n)&&(n.spriteFrame=r,t(null))}))},e.getEffectPrefab=function(e,n){this.loadRes("prefab/effect/"+e,i,n)},e.getFighterModel=function(e,n){var t=c.FIGHTER_MODEL[e];c.FIGHTER_TYPE.CLOSE,this.loadRes("prefab/model/man/"+t,i,n)},e.getWeapon=function(e,n){this.loadRes("prefab/model/weapon/"+e,i,n)},e.getCard=function(e,n){this.loadRes("texture/card/"+e+"/spriteFrame",a,n)},e}())||d);n._RF.pop()}}}));

System.register("chunks:///_virtual/effectGroup.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./effect.ts","./resourcesUtils.ts","./poolManager.ts"],(function(e){"use strict";var t,n,o,r,f,i,c,s;return{setters:[function(e){t=e.inheritsLoose},function(e){n=e.cclegacy,o=e._decorator,r=e.instantiate,f=e.Component},function(e){i=e.Effect},function(e){c=e.ResourceUtil},function(e){s=e.PoolManager}],execute:function(){var a;n._RF.push({},"73cdczYX6hMJ412pF6gNDHc","effectGroup",void 0);var l=o.ccclass;o.property,e("effectGroup",l("effectGroup")(a=function(e){function n(){return e.apply(this,arguments)||this}t(n,e);var o=n.prototype;return o.start=function(){},o.playChairEffect=function(e,t){var n=this;c.getEffectPrefab("hit01",(function(o,r){if(o)console.error("get effect failed:",o);else{var f=s.instance.getNode(r,n.node);e.y=.1,f.setWorldPosition(e);var c=f.getComponent(i);c.play(),c.setEndListener((function(){s.instance.putNode(f),t&&t()}))}}))},o.playBombEffect=function(e,t){var n=this;void 0===t&&(t=1),c.getEffectPrefab("hitBoom01",(function(o,r){if(o)console.error("get effect failed:",o);else{var f=s.instance.getNode(r,n.node);f.setScale(t,t,t),f.setWorldPosition(e);var c=f.getComponent(i);c.play(),c.setEndListener((function(){s.instance.putNode(f)}))}}))},o.playFireBallEffect=function(e,t){var n=this;c.getEffectPrefab("fireBall01",(function(o,f){if(o)console.error("get effect failed:",o);else{var c=r(f);c.parent=n.node,c.setWorldPosition(e);var s=c.getComponent(i);s.play(),s.setEndListener((function(){n.playBombEffect(e,2),c.destroy(),t&&t()}))}}))},o.playWinEffect=function(e,t){var n=this;c.getEffectPrefab("win01",(function(o,f){if(o)console.error("get effect failed:",o);else{var c=r(f);c.parent=n.node,c.setWorldPosition(e);var s=c.getComponent(i);s.play(),s.setEndListener((function(){c.destroy(),t&&t()}))}}))},n}(f))||a);n._RF.pop()}}}));

System.register("chunks:///_virtual/homeUIOnline.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./uiManager.ts","./homeUI.ts"],(function(n){"use strict";var e,t,i,o,r,a,l,c,u,s,f,p,h,d;return{setters:[function(n){e=n.applyDecoratedDescriptor,t=n.inheritsLoose,i=n.initializerDefineProperty,o=n.assertThisInitialized},function(n){r=n.cclegacy,a=n._decorator,l=n.LabelComponent,c=n.Component},function(n){u=n.default},function(n){s=n.PlayerData},function(n){f=n.ClientEvent},function(n){p=n.GameLogic},function(n){h=n.UIManager},function(n){d=n.homeUI}],execute:function(){var m,g,E,_,b,y,R;r._RF.push({},"7a1fce/Wg5GypPr8/dwMSEv","homeUIOnline",void 0);var w=a.ccclass,D=a.property;n("homeUIOnline",(m=w("homeUIOnline"),g=D(l),E=D(d),m((y=e((b=function(n){function e(){for(var e,t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return e=n.call.apply(n,[this].concat(r))||this,i(o(e),"lbGold",y,o(e)),i(o(e),"home",R,o(e)),e}t(e,n);var r=e.prototype;return r.start=function(){p.startOnlineReward(),this._updateReward()},r.onEnable=function(){f.on(u.EVENT_NAME.UPDATE_ONLINE_REWARD,this._updateReward,this)},r.onDisable=function(){f.off(u.EVENT_NAME.UPDATE_ONLINE_REWARD,this._updateReward,this)},r._updateReward=function(){this.lbGold.string=s.instance.getOnlineReward().toString()},r.onBtnOnlineClick=function(){h.instance.showDialog("home/online",[function(){}]),this.home.hideHand()},e}(c)).prototype,"lbGold",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R=e(b.prototype,"home",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_=b))||_));r._RF.pop()}}}));

System.register("chunks:///_virtual/missile.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./poolManager.ts"],(function(t){"use strict";var i,e,s,o,n,r,a,l,h,u,c,p,T,d;return{setters:[function(t){i=t.applyDecoratedDescriptor,e=t.inheritsLoose,s=t.initializerDefineProperty,o=t.assertThisInitialized,n=t.defineProperty},function(t){r=t.cclegacy,a=t._decorator,l=t.Prefab,h=t.ModelComponent,u=t.CCBoolean,c=t.Vec3,p=t.ParticleSystemComponent,T=t.Component},function(t){d=t.PoolManager}],execute:function(){var f,m,g,b,P,y,C,x,M;r._RF.push({},"7c879aXXNBJ+qXcgTMqr9RD","missile",void 0);var _=a.ccclass,S=a.property;t("Missile",(f=_("Missile"),m=S(l),g=S(h),b=S(u),f((C=i((y=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return i=t.call.apply(t,[this].concat(r))||this,s(o(i),"pfTrail",C,o(i)),s(o(i),"model",x,o(i)),s(o(i),"isAutoRotate",M,o(i)),n(o(i),"totalTime",-1),n(o(i),"currentTime",0),n(o(i),"maxHeight",0),n(o(i),"posOffset",new c),n(o(i),"posStart",new c),n(o(i),"endCb",null),n(o(i),"attackTarget",null),n(o(i),"ndTrail",null),n(o(i),"rotateCoolTime",0),n(o(i),"_targetPos",new c),n(o(i),"_nextTargetPos",new c),i}e(i,t);var r=i.prototype;return r.onLoad=function(){},r.start=function(){},r.reset=function(){this.endCb=null,this.totalTime=0,this.currentTime=0,this.posStart=null,this.posOffset=null,this.maxHeight=0,this.node.setScale(1,1,1),this.ndTrail&&(d.instance.putNode(this.ndTrail),this.ndTrail=null)},r.throwMissile=function(t,i,e,s){if(this.node.setScale(.5,.5,.5),this.rotateCoolTime=0,this.posStart.set(this.node.worldPosition),this.posOffset.set(t).subtract(this.node.worldPosition),this.totalTime=this.posOffset.length()/i,this.currentTime=0,this.maxHeight=5*this.totalTime,this.endCb=s,this.attackTarget=e,this.pfTrail){this.ndTrail&&(d.instance.putNode(this.ndTrail),this.ndTrail=null),this.ndTrail=d.instance.getNode(this.pfTrail,this.node);var o=this.ndTrail.getComponent(p);null==o||o.clear(),null==o||o.stop(),null==o||o.play()}},r._onFlyOver=function(){this.endCb&&this.endCb(this.attackTarget),this.endCb=null,this.attackTarget=null,this.ndTrail&&(d.instance.putNode(this.ndTrail),this.ndTrail=null),d.instance.putNode(this.node)},r.update=function(t){if(!(this.totalTime<=0)&&this.currentTime<this.totalTime){this.currentTime+=t,this.currentTime>this.totalTime&&(this.currentTime=this.totalTime);var i=Number((this.currentTime/this.totalTime).toFixed(2)),e=this.maxHeight*Math.cos(i*Math.PI-Math.PI/2);this._targetPos.set(this.posStart.x+this.posOffset.x*i,this.posStart.y+e,this.posStart.z+this.posOffset.z*i),this.node.setWorldPosition(this._targetPos),this.isAutoRotate&&(this.rotateCoolTime-=t,this.rotateCoolTime<0&&(this.rotateCoolTime=.1,(i=Number(((this.currentTime+.1)/this.totalTime).toFixed(2)))<1&&(e=this.maxHeight*Math.cos(i*Math.PI-Math.PI/2),this._nextTargetPos.set(this.posStart.x+this.posOffset.x*i,this.posStart.y+e,this.posStart.z+this.posOffset.z*i),this.node.forward=this._nextTargetPos.subtract(this._targetPos).normalize().negative()))),i>=1&&this._onFlyOver()}},i}(T)).prototype,"pfTrail",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=i(y.prototype,"model",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=i(y.prototype,"isAutoRotate",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P=y))||P));r._RF.pop()}}}));

System.register("chunks:///_virtual/poolManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(t){"use strict";var e,o,n,i,r,a;return{setters:[function(t){e=t.defineProperty,o=t.createClass},function(t){n=t.cclegacy,i=t._decorator,r=t.instantiate,a=t.NodePool}],execute:function(){var c,s,l;n._RF.push({},"862ecnB9sBDI4zgJRDhcqo/","poolManager",void 0);var u=i.ccclass;i.property,t("PoolManager",u("PoolManager")((l=s=function(){function t(){e(this,"_dictPool",{}),e(this,"_dictPrefab",{})}var n=t.prototype;return n.getNode=function(t,e){var o=t.name;t.position||(o=t.data.name),this._dictPrefab[o]=t;var n=null;if(this._dictPool.hasOwnProperty(o)){var i=this._dictPool[o];n=i.size()>0?i.get():r(t)}else{var c=new a;this._dictPool[o]=c,n=r(t)}return n.parent=e,n.active=!0,n},n.putNode=function(t){if(t){var e=t.name,o=null;this._dictPool.hasOwnProperty(e)?o=this._dictPool[e]:(o=new a,this._dictPool[e]=o),o.put(t)}},n.clearPool=function(t){this._dictPool.hasOwnProperty(t)&&this._dictPool[t].clear()},o(t,null,[{key:"instance",get:function(){return this._instance||(this._instance=new t),this._instance}}]),t}(),e(s,"_instance",void 0),c=l))||c);n._RF.pop()}}}));

System.register("chunks:///_virtual/main.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./audioManager.ts","./localConfig.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./uiManager.ts","./guideManager.ts"],(function(n){"use strict";var t,a,e,i,o,c,s,r,u,l,f,d,g;return{setters:[function(n){t=n.inheritsLoose},function(n){a=n.cclegacy,e=n._decorator,i=n.game,o=n.Component},function(n){c=n.default},function(n){s=n.AudioManager},function(n){r=n.localConfig},function(n){u=n.PlayerData},function(n){l=n.ClientEvent},function(n){f=n.GameLogic},function(n){d=n.UIManager},function(n){g=n.GuideManager}],execute:function(){var m;a._RF.push({},"99bd4jijD9FIrCsDcDx5t14","main",void 0);var p=e.ccclass;e.property,n("main",p("main")(m=function(n){function a(){return n.apply(this,arguments)||this}t(a,n);var e=a.prototype;return e.onLoad=function(){var n=this;i.frameRate=60,u.instance.loadGlobalCache(),u.instance.userId||(u.instance.generateRandomAccount(),u.instance.createPlayerInfo()),u.instance.loadFromCache(),r.instance.loadConfig((function(){n._loadFinish()})),g.instance.startGuide(),s.instance.init(),window.wx&&window.wx.getSystemInfo({success:function(n){"android"===n.platform&&(f.isEnableVibrate=!1)}})},e._loadFinish=function(){u.instance.isLoadFinished=!0,l.dispatchEvent(c.EVENT_NAME.GAME_INIT),1!==u.instance.playerInfo.level&&d.instance.showDialog("home/homeUI")},a}(o))||m);a._RF.pop()}}}));

System.register("chunks:///_virtual/fighterRigidBody.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts"],(function(t){"use strict";var i,o,e,s,n,r,d;return{setters:[function(t){i=t.inheritsLoose,o=t.defineProperty,e=t.assertThisInitialized},function(t){s=t.cclegacy,n=t._decorator,r=t.Component},function(t){d=t.default}],execute:function(){var y;s._RF.push({},"a39e5LlIuJHx5/8zxw8bss8","fighterRigidBody",void 0);var u=n.ccclass;n.property,t("FighterRigidBody",u("FighterRigidBody")(y=function(t){function s(){for(var i,s=arguments.length,n=new Array(s),r=0;r<s;r++)n[r]=arguments[r];return i=t.call.apply(t,[this].concat(n))||this,o(e(i),"enableSync",!0),o(e(i),"_bodyDef",null),o(e(i),"_fixture",null),o(e(i),"_world",null),o(e(i),"_b2Body",null),i}i(s,t);var n=s.prototype;return n.start=function(){},n.onDestroy=function(){this.destroyBody()},n.initBody=function(t,i){void 0===i&&(i=1);var o=new box2d.b2BodyDef;if(!this._b2Body){this._world=t,o.type=box2d.b2BodyType.b2_dynamicBody,o.allowSleep=!1,o.fixedRotation=!0,this._bodyDef=o,this._b2Body=t.CreateBody(this._bodyDef);var e=new box2d.b2CircleShape(i/d.PTM_RATIO),s=new box2d.b2FixtureDef;s.shape=e,this._b2Body&&(this._fixture=this._b2Body.CreateFixture(s,0))}},n.updateRadius=function(t){this._fixture&&(this._fixture.GetShape().m_radius=t/d.PTM_RATIO)},n.setWorldPosition=function(t){var i={x:t.x/d.PTM_RATIO,y:t.z/d.PTM_RATIO};this._b2Body&&this._b2Body.SetPosition(i),this.node.setPosition(t)},n._getWorldPosition=function(){var t={x:0,y:0};if(this._b2Body){var i=this._b2Body.GetPosition();t.x=i.x*d.PTM_RATIO,t.y=i.y*d.PTM_RATIO}return t},n.release=function(){this._b2Body&&(this._fixture&&this._b2Body.DestroyFixture(this._fixture),this._world.DestroyBody(this._b2Body),this._b2Body=null)},n.destroyBody=function(){this._b2Body&&(this._fixture&&this._b2Body.DestroyFixture(this._fixture),this._world.DestroyBody(this._b2Body),this._b2Body=null)},n.update=function(t){if(this._b2Body&&this.enableSync){var i=this._getWorldPosition(),o=this.node.position;i.x===o.x&&i.y===o.z||this.node.setPosition(i.x,0,i.y)}},s}(r))||y);s._RF.pop()}}}));

System.register("chunks:///_virtual/time.ts",["./_rollupPluginModLoBabelHelpers.js","cc"],(function(e){"use strict";var t,a,r;return{setters:[function(e){t=e.defineProperty},function(e){a=e.cclegacy,r=e._decorator}],execute:function(){var n,g,o;a._RF.push({},"b0452+NhVtOLrMdEmycPIRW","time",void 0);var u=r.ccclass;e("default",u((o=g=function(){function e(){}return e.formatDate=function(e,t){var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(var r in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(""+e.getFullYear()).substr(4-RegExp.$1.length))),a)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?a[r]:("00"+a[r]).substr((""+a[r]).length)));return t},e.getDaysBySeconds=function(t){return Math.floor(t/e.SECONDS_PER_DAY)},e.getSecondsFromDays=function(t){return t*e.SECONDS_PER_DAY},e.getDateInfo=function(e){return new Date(e)},e.getTimeStamp=function(e){return e?(new Date).getTime():Math.floor((new Date).getTime()/1e3)},e.convertToDate=function(e,t){return e=Number(e),e=Math.floor(e),t||(e*=1e3),new Date(e)},e.formatDayToEnglish=function(e){var t;switch(e.getMonth()){case 0:t="January";break;case 1:t=" February";break;case 2:t="March";break;case 3:t="April";break;case 4:t="May";break;case 5:t="June";break;case 6:t="July";break;case 7:t="August";break;case 8:t="September";break;case 9:t="October";break;case 10:t="November";break;case 11:t="December"}var a="";return a+=(1===e.getDate()||11===e.getDate()||21===e.getDate()||31===e.getDate()?e.getDate()+"st":2===e.getDate()||22===e.getDate()?e.getDate()+"nd":3===e.getDate()||23===e.getDate()?e.getDate()+"rd":e.getDate()+"th")+" ",a+=t+",",a+=""+e.getFullYear()},e.getWeekOfYear=function(e){void 0===e&&(e=new Date);var t=e,a=new Date(e.getFullYear(),0,1),r=Math.round((t.getTime()-a.getTime())/864e5);return Math.ceil((r+(a.getDay()+1-1))/7)},e.getInervalSecond=function(e,t){var a=t.getTime()-e.getTime();return parseInt((a/1e3).toString())},e.getInervalHour=function(e,t){var a=t.getTime()-e.getTime();return a<0?0:Math.floor(a/1e3/3600)},e.getInervalDay=function(e,t){var a=t.getTime()-e.getTime();return Math.floor(a/864e5)},e.isToday=function(e,t){var a=new Date(e*(t?1:1e3)),r=new Date;return a.getDate()===r.getDate()&&a.getMonth()===r.getMonth()&&a.getFullYear()===r.getFullYear()},e.isNowValid=function(e,t){var a=new Date(e),r=new Date(t),n=!1;if(""+a.getDate()!="NaN"&&""+r.getDate()!="NaN"){var g=new Date;n=g<r&&g>a}return n},e.isNewDay=function(e){var t=new Date(e),a=new Date,r=t.getFullYear(),n=t.getMonth(),g=t.getDate(),o=a.getFullYear(),u=a.getMonth(),c=a.getDate();return o>r||(u>n||c>g)},e}(),t(g,"SECONDS_PER_DAY",86400),n=o))||n);a._RF.pop()}}}));

System.register("chunks:///_virtual/online.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./uiManager.ts"],(function(t){"use strict";var n,e,i,o,l,r,a,c,s,u,d,h,f,b;return{setters:[function(t){n=t.applyDecoratedDescriptor,e=t.inheritsLoose,i=t.initializerDefineProperty,o=t.assertThisInitialized,l=t.defineProperty},function(t){r=t.cclegacy,a=t._decorator,c=t.LabelComponent,s=t.Component},function(t){u=t.default},function(t){d=t.PlayerData},function(t){h=t.ClientEvent},function(t){f=t.GameLogic},function(t){b=t.UIManager}],execute:function(){var g,p,_,E,y,D,v;r._RF.push({},"b5dcabaLrtBSbigNdBuOujQ","online",void 0);var N=a.ccclass,m=a.property;t("online",(g=N("online"),p=m(c),_=m(c),g((D=n((y=function(t){function n(){for(var n,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return n=t.call.apply(t,[this].concat(r))||this,i(o(n),"lbGold",D,o(n)),i(o(n),"lbGoldDouble",v,o(n)),l(o(n),"_gold",0),l(o(n),"_callback",null),n}e(n,t);var r=n.prototype;return r.start=function(){},r.show=function(t){this._callback=t,this._gold=d.instance.getOnlineReward(),this.lbGold.string=this._gold.toString(),this.lbGoldDouble.string=(3*this._gold).toString()},r.onBtnNormalClick=function(){this.reward(!1)},r.onBtnDoubleClick=function(){this.reward(!0)},r.reward=function(t){f.addGold(t?3*this._gold:this._gold),d.instance.reduceOnlineReward(this._gold),h.dispatchEvent(u.EVENT_NAME.UPDATE_ONLINE_REWARD),h.dispatchEvent(u.EVENT_NAME.REC_ONLINE_REWARD),this._close()},r.onBtnCloseClick=function(){this._close()},r._close=function(){b.instance.hideDialog("home/online"),this._callback&&this._callback()},n}(s)).prototype,"lbGold",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v=n(y.prototype,"lbGoldDouble",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=y))||E));r._RF.pop()}}}));

System.register("chunks:///_virtual/gameLogic.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./playerData.ts","./clientEvent.ts"],(function(e){"use strict";var n,t,a,i,r,c,o;return{setters:[function(e){n=e.defineProperty},function(e){t=e.cclegacy,a=e._decorator,i=e.Vec3},function(e){r=e.default},function(e){c=e.PlayerData},function(e){o=e.ClientEvent}],execute:function(){var E,u,s;t._RF.push({},"becffCU1LxPYLkR8xenXIn2","gameLogic",void 0);var _=a.ccclass;a.property,e("GameLogic",_("GameLogic")((s=u=function(){function e(){}return e.startOnlineReward=function(){this.onlineInterval=setInterval((function(){c.instance.updateOnlineReward(1e3),o.dispatchEvent(r.EVENT_NAME.UPDATE_ONLINE_REWARD)}),1e3)},e.addGold=function(e){c.instance.updatePlayerInfo("gold",e),o.dispatchEvent(r.EVENT_NAME.UPDATE_GOLD)},e.getFighterPosByNum=function(e,n){switch(n){case 1:return[e];case 2:var t=e.clone();return t.z-=r.CELL_FIGHTER_SPACING,e.z+=r.CELL_FIGHTER_SPACING,[t,e];case 4:return[new i(e.x-r.CELL_FIGHTER_SPACING,e.y,e.z-r.CELL_FIGHTER_SPACING),new i(e.x+r.CELL_FIGHTER_SPACING,e.y,e.z-r.CELL_FIGHTER_SPACING),new i(e.x-r.CELL_FIGHTER_SPACING,e.y,e.z+r.CELL_FIGHTER_SPACING),new i(e.x+r.CELL_FIGHTER_SPACING,e.y,e.z+r.CELL_FIGHTER_SPACING)];default:return[e]}},e.vibrateShort=function(){e.isEnableVibrate&&window.wx&&window.wx.vibrateShort()},e}(),n(u,"mainCamera",null),n(u,"isDebugMode",!1),n(u,"onlineInterval",-1),n(u,"isEnableVibrate",!0),E=s))||E);t._RF.pop()}}}));

System.register("chunks:///_virtual/fighterModel.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./resourcesUtils.ts","./poolManager.ts","./missile.ts"],(function(n){"use strict";var t,e,i,o,r,a,s,l,c,p,h,u,d,f,_,g,w,W,y,b;return{setters:[function(n){t=n.applyDecoratedDescriptor,e=n.inheritsLoose,i=n.initializerDefineProperty,o=n.assertThisInitialized,r=n.defineProperty},function(n){a=n.cclegacy,s=n._decorator,l=n.SkinningModelComponent,c=n.Material,p=n.Node,h=n.SkeletalAnimationComponent,u=n.Prefab,d=n.Color,f=n.Vec3,_=n.AnimationComponent,g=n.Component},function(n){w=n.default},function(n){W=n.ResourceUtil},function(n){y=n.PoolManager},function(n){b=n.Missile}],execute:function(){var m,v,A,C,E,M,P,N,R,H,I,z,S,T,F;a._RF.push({},"c579cKjCENEtJ2iUfc3EvYK","fighterModel",void 0);var D=s.ccclass,L=s.property;n("FighterModel",(m=D("FighterModel"),v=L(l),A=L([c]),C=L(p),E=L(p),M=L(h),P=L(u),m((H=t((R=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),s=0;s<e;s++)a[s]=arguments[s];return t=n.call.apply(n,[this].concat(a))||this,i(o(t),"model",H,o(t)),i(o(t),"aryMaterial",I,o(t)),i(o(t),"ndRightHand",z,o(t)),i(o(t),"ndHead",S,o(t)),i(o(t),"ani",T,o(t)),i(o(t),"pfWeapon",F,o(t)),r(o(t),"_cb",null),r(o(t),"_target",null),r(o(t),"_ndWeapon",null),r(o(t),"_ndCrown",null),r(o(t),"_currentAni",""),r(o(t),"_fighter",null),r(o(t),"_colorWhiteCrown",new d(255,255,255)),r(o(t),"_colorGoldCrown",new d(255,248,40)),r(o(t),"_weaponPos",new f),r(o(t),"_weaponEuler",new f),t}e(t,n);var a=t.prototype;return a.start=function(){},a.show=function(n){var t=this;this._fighter=n;var e=0;if(e=n.team===w.PLAYER_TEAM?1===n.fighterInfo.color?2:1:0,this.model.material=this.aryMaterial[e],this._ndWeapon&&(y.instance.putNode(this._ndWeapon),this._ndWeapon=null),this._ndCrown&&(y.instance.putNode(this._ndCrown),this._ndCrown=null),this.pfWeapon){this._ndWeapon=y.instance.getNode(this.pfWeapon,this.ndRightHand),this._weaponPos.set(this.pfWeapon.data.position),this._weaponEuler.set(this.pfWeapon.data.eulerAngles),this._ndWeapon.position=this._weaponPos,this._ndWeapon.eulerAngles=this._weaponEuler,this._ndWeapon.active=!0;var i=this._ndWeapon.getComponent(b);i&&i.reset()}if(n.fighterInfo.crown){var o="crown/crownWhite";2===this._fighter.fighterInfo.crown&&(o="crown/crownGold"),W.loadModelRes(o).then((function(n){t._ndCrown=y.instance.getNode(n,t.ndHead)}))}this.updateAniSpeed(),this.ani.play(w.ANI_TYPE.IDLE)},a.setEffectListener=function(n,t){this._cb=n,this._target=t},a.triggerEffect=function(){this._cb&&this._cb.apply(this._target)},a.onceAniFinished=function(n,t){this.ani.once(_.EventType.FINISHED,(function(){n()}),t)},a.playAttack=function(){this.playAni(w.ANI_TYPE.ATTACK)},a.playAni=function(n,t){void 0===t&&(t=!1),t&&this._currentAni===n||(this._currentAni=n,this.ani.play(n))},a.showHandWeapon=function(){this._ndWeapon&&!this._ndWeapon.active&&(this._ndWeapon.active=!0)},a.throwWeapon=function(n){var t=y.instance.getNode(this.pfWeapon,this._fighter.node.parent);t.setWorldPosition(this._ndWeapon.worldPosition),t.setWorldRotation(this._ndWeapon.worldRotation);var e=this._fighter.target.node.worldPosition;t.getComponent(b).throwMissile(e,10*this._fighter.timeScale,this._fighter.target,n),this._ndWeapon.active=!1},a.updateAniSpeed=function(){var n=this;this.ani.clips.forEach((function(t){t.speed=n._fighter.timeScale}))},t}(g)).prototype,"model",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=t(R.prototype,"aryMaterial",[A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z=t(R.prototype,"ndRightHand",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=t(R.prototype,"ndHead",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=t(R.prototype,"ani",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F=t(R.prototype,"pfWeapon",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=R))||N));a._RF.pop()}}}));

System.register("chunks:///_virtual/formationCell.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./effect.ts","./constants.ts","./resourcesUtils.ts","./poolManager.ts","./localConfig.ts","./gameLogic.ts"],(function(t){"use strict";var i,e,n,o,r,s,a,l,c,h,u,f,d,p,m,_,g,y,P;return{setters:[function(t){i=t.applyDecoratedDescriptor,e=t.inheritsLoose,n=t.initializerDefineProperty,o=t.assertThisInitialized,r=t.defineProperty,s=t.createClass},function(t){a=t.cclegacy,l=t._decorator,c=t.Node,h=t.Vec3,u=t.ParticleSystemComponent,f=t.AnimationComponent,d=t.Component},function(t){p=t.Effect},function(t){m=t.default},function(t){_=t.ResourceUtil},function(t){g=t.PoolManager},function(t){y=t.localConfig},function(t){P=t.GameLogic}],execute:function(){var S,v,C,I,w,b,E;a._RF.push({},"cce35Ufa5pF5Z1E3wSTHXi0","formationCell",void 0);var F=l.ccclass,N=l.property;t("FormationCell",(S=F("FormationCell"),v=N(c),C=N(c),S((b=i((w=function(t){function i(){for(var i,e=arguments.length,s=new Array(e),a=0;a<e;a++)s[a]=arguments[a];return i=t.call.apply(t,[this].concat(s))||this,n(o(i),"ndCell",b,o(i)),n(o(i),"ndSelect",E,o(i)),r(o(i),"pos",0),r(o(i),"fighterId",0),r(o(i),"aryIdentity",[]),r(o(i),"_ndSimilar",null),r(o(i),"_team",0),r(o(i),"_manager",null),r(o(i),"_isShowSimilar",!1),r(o(i),"_select",!1),r(o(i),"_similarPos",new h(0,.1,0)),r(o(i),"_sprintPos",new h(0,.1,0)),r(o(i),"_combinePos",new h(0,.1,0)),r(o(i),"_cellPos1",new h),r(o(i),"_cellPos2",new h),i}e(i,t);var a=i.prototype;return a.start=function(){},a.init=function(t,i,e,n){this.pos=t,this._team=i,this.fighterId=Number(e),this._manager=n,this.showSimilar(!1),this.ndCell.active=i===m.PLAYER_TEAM;var o=10*(1===i?-1:1)+Math.floor(t/5)*(1===i?-1.5:1.5),r=t%5*1.5-3;this.node.setWorldPosition(o,0,r),e&&this.updateFighter(e)},a.recycle=function(){this.fighterId=0,this.aryIdentity=[],g.instance.putNode(this.node)},a.updateFighter=function(t){var i=this;if(this.aryIdentity.length>0&&(this.aryIdentity.forEach((function(t){i._manager.removeFighter(t)})),this.aryIdentity=[]),this.fighterId=t,!(this.fighterId<=0)){var e=y.instance.queryByID("fighter",t.toString()),n=e.num;this._cellPos1.set(this.node.worldPosition),P.getFighterPosByNum(this._cellPos1,n).forEach((function(t){var n=i._manager.addFighter(i._team,t,e,i.pos);i.aryIdentity.push(n)}))}},a.checkIsHit=function(t){this._cellPos2.set(this.node.worldPosition);return this._cellPos2.x-.75<=t.x&&this._cellPos2.x+.75>=t.x&&this._cellPos2.z-.75<=t.z&&this._cellPos2.z+.75>=t.z},a.showSimilar=function(t){var i=this;if(this._isShowSimilar=t,this._isShowSimilar)this._ndSimilar||_.getEffectPrefab("upLoop01",(function(t,e){if(i.node.activeInHierarchy&&i._isShowSimilar&&!i._ndSimilar){i._ndSimilar=g.instance.getNode(e,i.node),i._similarPos.set(0,.1,0),i._ndSimilar.position=i._similarPos;var n=i._ndSimilar.getComponentInChildren(u);null==n||n.play()}}));else if(this._ndSimilar){var e=this._ndSimilar.getComponentInChildren(u);null==e||e.clear(),null==e||e.stop(),g.instance.putNode(this._ndSimilar),this._ndSimilar=null}},a.showCombineSucceed=function(){var t=this;_.getEffectPrefab("upClick",(function(i,e){if(t.node.activeInHierarchy){var n=g.instance.getNode(e,t.node);t._combinePos.set(0,.1,0),n.position=t._combinePos;var o=n.getComponentInChildren(u);o.clear(),o.play();var r=n.getComponent(f);r.play(),r.once("finished",(function(){g.instance.putNode(n)}))}}))},a.showSprint=function(){var t=this;_.getEffectPrefab("goBallistic01",(function(i,e){if(!i&&t.node.activeInHierarchy){var n=g.instance.getNode(e,t.node);t._sprintPos.set(0,.1,0),n.position=t._sprintPos;var o=n.getComponent(p);o.play(),o.setEndListener((function(){g.instance.putNode(n)}))}}))},s(i,[{key:"select",get:function(){return this._select},set:function(t){this._select=t,this.ndSelect.active=t}}]),i}(d)).prototype,"ndCell",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=i(w.prototype,"ndSelect",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=w))||I));a._RF.pop()}}}));

System.register("chunks:///_virtual/homeUI.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./resourcesUtils.ts","./audioManager.ts","./poolManager.ts","./localConfig.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./uiManager.ts","./levelTips.ts","./guideManager.ts"],(function(t){"use strict";var n,e,i,o,l,a,r,s,u,c,h,d,p,_,f,y,E,b,g,T,v,B,w,m,C,P,S,I,N,U;return{setters:[function(t){n=t.applyDecoratedDescriptor,e=t.inheritsLoose,i=t.initializerDefineProperty,o=t.assertThisInitialized,l=t.defineProperty,a=t.createClass},function(t){r=t.cclegacy,s=t._decorator,u=t.Node,c=t.SpriteFrame,h=t.LabelComponent,d=t.ButtonComponent,p=t.Vec3,_=t.Tween,f=t.SpriteComponent,y=t.UITransformComponent,E=t.Color,b=t.tween,g=t.Component},function(t){T=t.default},function(t){v=t.ResourceUtil},function(t){B=t.AudioManager},function(t){w=t.PoolManager},function(t){m=t.localConfig},function(t){C=t.PlayerData},function(t){P=t.ClientEvent},function(t){S=t.GameLogic},function(t){I=t.UIManager},function(t){N=t.levelTips},function(t){U=t.GuideManager}],execute:function(){var L,A,z,H,M,F,O,D,R,k,G,V,W,x,Y,q,j,J,K,Q,X,Z,$,tt,nt,et,it,ot,lt,at,rt,st,ut,ct,ht,dt,pt,_t,ft,yt,Et,bt,gt,Tt,vt,Bt,wt,mt,Ct,Pt,St,It,Nt,Ut,Lt,At,zt;r._RF.push({},"d243dEWQWtBn4ffJoq2cTso","homeUI",void 0);var Ht=s.ccclass,Mt=s.property;t("homeUI",(L=Ht("homeUI"),A=Mt(u),z=Mt(u),H=Mt(c),M=Mt(c),F=Mt(c),O=Mt(u),D=Mt(h),R=Mt(h),k=Mt(h),G=Mt(h),V=Mt(d),W=Mt(u),x=Mt(u),Y=Mt(u),q=Mt(h),j=Mt(u),J=Mt(d),K=Mt(u),Q=Mt(u),X=Mt(h),Z=Mt(u),$=Mt(u),tt=Mt(u),nt=Mt(u),et=Mt(h),it=Mt(h),ot=Mt(u),L((rt=n((at=function(t){function n(){for(var n,e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];return n=t.call.apply(t,[this].concat(a))||this,i(o(n),"ndIndicator",rt,o(n)),i(o(n),"ndFight",st,o(n)),i(o(n),"sfCrazy",ut,o(n)),i(o(n),"sfGood",ct,o(n)),i(o(n),"sfNormal",ht,o(n)),i(o(n),"ndTips",dt,o(n)),i(o(n),"lbGold",pt,o(n)),i(o(n),"lbSelf",_t,o(n)),i(o(n),"lbEnemy",ft,o(n)),i(o(n),"lbLevel",yt,o(n)),i(o(n),"btnBuy",Et,o(n)),i(o(n),"ndBuyByMoney",bt,o(n)),i(o(n),"ndBuyCellByMoney",gt,o(n)),i(o(n),"ndBuy",Tt,o(n)),i(o(n),"lbPrice",vt,o(n)),i(o(n),"ndBuyCellUpgrade",Bt,o(n)),i(o(n),"btnBuyCell",wt,o(n)),i(o(n),"ndBuyCell",mt,o(n)),i(o(n),"ndOnline",Ct,o(n)),i(o(n),"lbPriceCell",Pt,o(n)),i(o(n),"ndBlock",St,o(n)),i(o(n),"ndHand",It,o(n)),i(o(n),"ndBtnStart",Nt,o(n)),i(o(n),"ndUnlock",Ut,o(n)),i(o(n),"lbUnlockLevel",Lt,o(n)),i(o(n),"lbUnlockName",At,o(n)),i(o(n),"ndFightTipsParent",zt,o(n)),l(o(n),"_rotateSpeed",170),l(o(n),"_isRotating",!0),l(o(n),"_oriIndicatorEuler",new p),l(o(n),"_curIndicatorEuler",new p),l(o(n),"_ndLevelTips",null),l(o(n),"_tweenBtnStart",null),l(o(n),"_tweenTips",null),l(o(n),"_tweenHand",null),l(o(n),"_btnStartScale1",new p(1.3,1.3,1.3)),l(o(n),"_btnStartScale2",new p(1,1,1)),l(o(n),"_tipPos",new p(0,60,0)),l(o(n),"_handPos1",new p),l(o(n),"_handPos2",new p),l(o(n),"_handWorPos",new p),l(o(n),"_fightTipScale",new p(0,50,0)),l(o(n),"_fightTipPos",new p(.5,.5,0)),l(o(n),"_outPutPos",new p),l(o(n),"_isShowLevelTips",!1),n}e(n,t);var r=n.prototype;return r.onLoad=function(){},r.start=function(){B.instance.playMusic(T.AUDIO_SOUND.BACKGROUND,!0)},r.onEnable=function(){P.on(T.EVENT_NAME.UPDATE_GOLD,this._updateGold,this),P.on(T.EVENT_NAME.UPDATE_FORMATION,this._updateFormation,this),P.on(T.EVENT_NAME.UPDATE_LEVEL,this._updateLevel,this),P.on(T.EVENT_NAME.SHOW_LEVEL_TIPS,this._showLevelTips,this),P.on(T.EVENT_NAME.REC_ONLINE_REWARD,this._updateFormation,this),P.on(T.EVENT_NAME.BUY_FIGHTER,this._buyFighter,this),this.node.on(u.EventType.TOUCH_START,this._onTouchEvent,this),this.node.on(u.EventType.TOUCH_MOVE,this._onTouchEvent,this),this.node.on(u.EventType.TOUCH_END,this._onTouchEvent,this),this.node.on(u.EventType.TOUCH_CANCEL,this._onTouchEvent,this)},r.onDisable=function(){P.off(T.EVENT_NAME.UPDATE_GOLD,this._updateGold,this),P.off(T.EVENT_NAME.UPDATE_FORMATION,this._updateFormation,this),P.off(T.EVENT_NAME.UPDATE_LEVEL,this._updateLevel,this),P.off(T.EVENT_NAME.SHOW_LEVEL_TIPS,this._showLevelTips,this),P.off(T.EVENT_NAME.REC_ONLINE_REWARD,this._updateFormation,this),P.off(T.EVENT_NAME.BUY_FIGHTER,this._buyFighter,this),this.node.off(u.EventType.TOUCH_START,this._onTouchEvent,this),this.node.off(u.EventType.TOUCH_MOVE,this._onTouchEvent,this),this.node.off(u.EventType.TOUCH_END,this._onTouchEvent,this),this.node.off(u.EventType.TOUCH_CANCEL,this._onTouchEvent,this)},r._stopBtnStartAni=function(){this._tweenBtnStart&&(this._tweenBtnStart.stop(),this._tweenBtnStart=null)},r.show=function(){this._stopBtnStartAni(),C.instance.playerInfo.level>=3&&(this._tweenBtnStart=new _(this.ndBtnStart).to(.3,{scale:this._btnStartScale1}).to(.3,{scale:this._btnStartScale2}).union().repeatForever().start()),this._isRotating=!0,this.ndTips.active=!1,this.ndBlock.active=!1,this._updateGold(),this._updateLevel(),this._updateFormation(),-1!==C.instance.waitingUnlock&&(I.instance.showDialog("home/unlock",[C.instance.waitingUnlock,function(){}]),C.instance.waitingUnlock=-1),C.instance.playerInfo.level<3&&this._resetIndicatorForGuide(),C.instance.isLastFightWin||this._showFailGuide(),this.ndOnline.active=C.instance.playerInfo.level>=4,C.instance.playerInfo.level>=4||U.instance.hasFinishGuide(T.GUIDE_STEP.BUY_CELL)?this.ndBuyCell.active=!0:this.ndBuyCell.active=!1;var t=this.getNextUnlock();if(t){var n=t.unlock,e=m.instance.queryByID("fighter",n.toString());e&&(this.lbUnlockLevel.string="第"+t.level+"关解锁",this.lbUnlockName.string=e.name,this.ndUnlock.active=!0)}else this.ndUnlock.active=!1},r._showFailGuide=function(){this.btnBuy.interactable?(this._handWorPos.set(this.ndBuy.worldPosition),this._showHand(this._handWorPos)):this.btnBuyCell.interactable?(this._handWorPos.set(this.ndBuyCell.worldPosition),this._showHand(this._handWorPos)):(this._handWorPos.set(this.ndOnline.worldPosition),this._showHand(this._handWorPos))},r._updateGold=function(){this.lbGold.string=C.instance.playerInfo.gold.toString()},r.updateBuyBtn=function(){var t=C.instance.getBuyFighterPrice();this.lbPrice.string=t.toString(),this.ndBuyByMoney.active=!0;var n=-1!==C.instance.getEmptyPos();t<=C.instance.gold&&n?this.buyBtnEnable=!0:(n||(this.lbPrice.string="格子不足"),this.buyBtnEnable=!1)},r.updateBuyCellBtn=function(){var t=C.instance.getBuyCellPrice();this.lbPriceCell.string=t.toString(),this.ndBuyCellUpgrade.active=!1,this.ndBuyCellByMoney.active=!0,t<=C.instance.gold?(this.buyCellBtnEnable=!0,-1===C.instance.getEmptyPos()&&(this.ndBuyCellUpgrade.active=!0)):(this.buyCellBtnEnable=!1,-1===C.instance.getEmptyPos()&&(this.ndBuyCellUpgrade.active=!0))},r._updateFormation=function(){this.lbSelf.string=C.instance.getFormationFight().toString(),this.updateBuyBtn(),this.updateBuyCellBtn()},r._updateLevel=function(){this.lbLevel.string="第 "+C.instance.playerInfo.level+" 关",this.lbEnemy.string=C.instance.getCurLevelEnemyFight().toString()},r._showStart=function(t){var n=this,e=1,i=this.sfNormal;Math.abs(t.z)<=5?(e=1.5,i=this.sfCrazy,P.dispatchEvent(T.EVENT_NAME.SHOW_SPRINT),B.instance.playSound(T.AUDIO_SOUND.RAMPAGE)):Math.abs(t.z)<=35?(e=1.2,i=this.sfGood):(e=1,i=this.sfNormal),this.ndTips.getComponent(f).spriteFrame=i,this.ndTips.setPosition(0,-40,0),this._tweenTips&&(this._tweenTips.stop(),this._tweenTips=null),this.ndTips.active=!0,this._tweenTips=new _(this.ndTips).to(1,{position:this._tipPos}).call((function(){n._tweenTips=null,I.instance.hideDialog("home/homeUI"),P.dispatchEvent(T.EVENT_NAME.FIGHT_START,e)})).start(),B.instance.playSound(T.AUDIO_SOUND.FIGHT_START)},r.onBtnFightClick=function(){if(!this.ndTips.active){this._stopBtnStartAni(),P.dispatchEvent(T.EVENT_NAME.HIDE_ALL_SIMILAR);var t=this.ndIndicator.eulerAngles;this._isRotating=!1,this.ndBlock.active=!0,this._showStart(t),this.hideHand()}},r._showBuy=function(t){var n=C.instance.getRandomBuyFighter();I.instance.showDialog("home/buyFighter",[n,t,function(){}])},r.onBtnBuyClick=function(){var t=C.instance.getEmptyPos();if(-1!==t){var n=C.instance.getBuyFighterPrice();n<=C.instance.gold&&(S.addGold(-n),this._showBuy(t)),this.hideHand()}},r._addCell=function(){C.instance.addBuyCellTimes();var t=C.instance.addCell();P.dispatchEvent(T.EVENT_NAME.BUY_CELL,t),B.instance.playSound(T.AUDIO_SOUND.BUY_CELL),this.updateBuyCellBtn(),this.updateBuyBtn()},r.onBtnBuyCellClick=function(){var t=C.instance.getBuyCellPrice();t<=C.instance.gold&&(S.addGold(-t),this._addCell()),this.hideHand()},r._onTouchEvent=function(t){P.dispatchEvent(T.EVENT_NAME.HOME_UI_TOUCH,t.type,t.getLocation())},r._showLevelTips=function(t,n,e,i){var o,l=this;(this._isShowLevelTips=t,t)?this._ndLevelTips?(this._ndLevelTips.active=!0,null===(o=this._ndLevelTips.getComponent(N))||void 0===o||o.show(n,e,i)):v.getUIPrefabRes("home/levelTips",(function(t,o){var a;l._isShowLevelTips&&(l._ndLevelTips||(l._ndLevelTips=w.instance.getNode(o,l.node)),l._ndLevelTips.active=!0,null===(a=l._ndLevelTips.getComponent(N))||void 0===a||a.show(n,e,i))})):this._ndLevelTips&&(this._ndLevelTips.active=!1)},r._resetIndicatorForGuide=function(){this._oriIndicatorEuler.set(0,0,0),this.ndIndicator.eulerAngles=this._oriIndicatorEuler,this._isRotating=!1},r._showHand=function(t){var n,e;this._tweenHand&&(this._tweenHand.stop(),this._tweenHand=null),this.ndHand.active=!0,null===(n=this.ndHand.parent)||void 0===n||null===(e=n.getComponent(y))||void 0===e||e.convertToNodeSpaceAR(t,this._outPutPos),this.ndHand.setPosition(this._outPutPos),this._handPos1.set(this._outPutPos.x+20,this._outPutPos.y-20,0),this._handPos2.set(this._outPutPos.x,this._outPutPos.y,0),this._tweenHand=new _(this.ndHand).to(.5,{position:this._handPos1}).to(.5,{position:this._handPos2}).union().repeatForever().start()},r.hideHand=function(){this._tweenHand&&(this._tweenHand.stop(),this._tweenHand=null),this.ndHand.active=!1},r.getNextUnlock=function(){for(var t=C.instance.playerInfo.level,n=m.instance.getTableArr("level"),e=t-1;e<n.length;e++)if(n[e].unlock)return{level:e+1,unlock:n[e].unlock};return null},r._buyFighter=function(t,n){var e=this,i=m.instance.queryByID("fighter",n.toString());v.getUIPrefabRes("home/fightTips",(function(t,n){if(!t){var o=w.instance.getNode(n,e.ndFightTipsParent);o.setPosition(0,0,0),o.setScale(1,1,1),o.getChildByName("title").getComponent(h).color=E.WHITE;var l=o.getChildByName("value").getComponent(h);l.color=E.GREEN,l.string="+"+i.fight,e._fightTipPos.set(0,50,0),e._fightTipScale.set(.5,.5,0),b(o).by(.5,{position:e._fightTipPos}).delay(.3).to(.2,{scale:e._fightTipScale}).union().call((function(){w.instance.putNode(o)})).start()}}))},r.update=function(t){this._isRotating&&(this._curIndicatorEuler.set(this.ndIndicator.eulerAngles),this._curIndicatorEuler.z=this._curIndicatorEuler.z%360,this._curIndicatorEuler.z+=this._rotateSpeed*t,this._curIndicatorEuler.z=Math.round(this._curIndicatorEuler.z),(this._curIndicatorEuler.z<=-70||this._curIndicatorEuler.z>=290)&&this._rotateSpeed<0?(this._rotateSpeed=-this._rotateSpeed,this._curIndicatorEuler.z=-70):(this._curIndicatorEuler.z>=70||this._curIndicatorEuler.z<=-290)&&this._rotateSpeed>0&&(this._rotateSpeed=-this._rotateSpeed,this._curIndicatorEuler.z=70),this.ndIndicator.eulerAngles=this._curIndicatorEuler)},a(n,[{key:"buyBtnEnable",set:function(t){this.btnBuy.interactable=t,this.ndBuy.getComponentsInChildren(f).forEach((function(n){n.grayscale=!t}))}},{key:"buyCellBtnEnable",set:function(t){this.btnBuyCell.interactable=t,this.ndBuyCell.getComponentsInChildren(f).forEach((function(n){n.grayscale=!t}))}}]),n}(g)).prototype,"ndIndicator",[A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st=n(at.prototype,"ndFight",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ut=n(at.prototype,"sfCrazy",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ct=n(at.prototype,"sfGood",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ht=n(at.prototype,"sfNormal",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dt=n(at.prototype,"ndTips",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pt=n(at.prototype,"lbGold",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_t=n(at.prototype,"lbSelf",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ft=n(at.prototype,"lbEnemy",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yt=n(at.prototype,"lbLevel",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Et=n(at.prototype,"btnBuy",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bt=n(at.prototype,"ndBuyByMoney",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gt=n(at.prototype,"ndBuyCellByMoney",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tt=n(at.prototype,"ndBuy",[Y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vt=n(at.prototype,"lbPrice",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bt=n(at.prototype,"ndBuyCellUpgrade",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wt=n(at.prototype,"btnBuyCell",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mt=n(at.prototype,"ndBuyCell",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ct=n(at.prototype,"ndOnline",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pt=n(at.prototype,"lbPriceCell",[X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),St=n(at.prototype,"ndBlock",[Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),It=n(at.prototype,"ndHand",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nt=n(at.prototype,"ndBtnStart",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ut=n(at.prototype,"ndUnlock",[nt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lt=n(at.prototype,"lbUnlockLevel",[et],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),At=n(at.prototype,"lbUnlockName",[it],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zt=n(at.prototype,"ndFightTipsParent",[ot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt=at))||lt));r._RF.pop()}}}));

System.register("chunks:///_virtual/localConfig.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./csvManager.ts","./resourcesUtils.ts"],(function(n){"use strict";var t,e,r,a,i,c,o;return{setters:[function(n){t=n.defineProperty,e=n.createClass},function(n){r=n.cclegacy,a=n._decorator,i=n.resources},function(n){c=n.CSVManager},function(n){o=n.ResourceUtil}],execute:function(){var s,u,l;r._RF.push({},"d6367op4OtEuZ+Oj6Jlb6Ha","localConfig",void 0);var _=a.ccclass;a.property,n("localConfig",_("localConfig")((l=u=function(){function n(){t(this,"_csvManager",new c),t(this,"_callback",new Function),t(this,"_currentLoad",0),t(this,"_cntLoad",0)}var r=n.prototype;return r.loadConfig=function(n){this._callback=n,this._loadCSV()},r._loadCSV=function(){var n=this;i.loadDir("datas",(function(t,e){if(!t){var r=e.filter((function(n){return".md"!==n._native}));n._cntLoad=r.length,r.length?r.forEach((function(t,e,r){o.getTextData(t.name,(function(e,r){n._csvManager.addTable(t.name,r),n._tryToCallbackOnFinished()}))})):n._tryToCallbackOnFinished()}}))},r.queryOne=function(n,t,e){return this._csvManager.queryOne(n,t,e)},r.queryByID=function(n,t){return this._csvManager.queryByID(n,t)},r.getTable=function(n){return this._csvManager.getTable(n)},r.getTableArr=function(n){return this._csvManager.getTableArr(n)},r.queryAll=function(n,t,e){return this._csvManager.queryAll(n,t,e)},r.queryIn=function(n,t,e){return this._csvManager.queryIn(n,t,e)},r.queryByCondition=function(n,t){return this._csvManager.queryByCondition(n,t)},r.queryOneByCondition=function(n,t){return this._csvManager.queryOneByCondition(n,t)},r._tryToCallbackOnFinished=function(){this._callback&&(this._currentLoad++,this._currentLoad>=this._cntLoad&&this._callback())},e(n,null,[{key:"instance",get:function(){return this._instance||(this._instance=new n),this._instance}}]),n}(),t(u,"_instance",void 0),s=l))||s);r._RF.pop()}}}));

System.register("chunks:///_virtual/unlock.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./resourcesUtils.ts","./localConfig.ts","./uiManager.ts"],(function(n){"use strict";var t,e,i,r,o,a,l,c,s,u,p,f,b;return{setters:[function(n){t=n.applyDecoratedDescriptor,e=n.inheritsLoose,i=n.initializerDefineProperty,r=n.assertThisInitialized,o=n.defineProperty},function(n){a=n.cclegacy,l=n._decorator,c=n.SpriteComponent,s=n.LabelComponent,u=n.Component},function(n){p=n.ResourceUtil},function(n){f=n.localConfig},function(n){b=n.UIManager}],execute:function(){var h,d,g,y,m,C,k;a._RF.push({},"e4456ZRHldAlLMVAvwtLJNC","unlock",void 0);var v=l.ccclass,_=l.property;n("unlock",(h=v("unlock"),d=_(c),g=_(s),h((C=t((m=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),l=0;l<e;l++)a[l]=arguments[l];return t=n.call.apply(n,[this].concat(a))||this,i(r(t),"spCard",C,r(t)),i(r(t),"lbName",k,r(t)),o(r(t),"_callback",null),t}e(t,n);var a=t.prototype;return a.start=function(){},a.onDisable=function(){},a.show=function(n,t){var e=this;this._callback=t;var i=f.instance.queryByID("fighter",n.toString());p.getCard(i.type,(function(n,t){e.spCard.node.isValid&&(e.spCard.spriteFrame=t)})),this.lbName.string=i.name},a.onBtnOKClick=function(){b.instance.hideDialog("home/unlock"),this._callback&&this._callback()},t}(u)).prototype,"spCard",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k=t(m.prototype,"lbName",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y=m))||y));a._RF.pop()}}}));

System.register("chunks:///_virtual/fighterManager.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./util.ts","./audioManager.ts","./poolManager.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./fighter.ts","./follow.ts","./uiManager.ts","./formationCell.ts","./effectGroup.ts"],(function(t){"use strict";var e,i,r,n,o,s,a,h,l,c,_,g,f,d,u,E,m,p,v,C,y,T,I,P,S,F,N,A,M;return{setters:[function(t){e=t.applyDecoratedDescriptor,i=t.inheritsLoose,r=t.initializerDefineProperty,n=t.assertThisInitialized,o=t.defineProperty},function(t){s=t.cclegacy,a=t._decorator,h=t.Prefab,l=t.BoxColliderComponent,c=t.Vec3,_=t.geometry,g=t.Vec2,f=t.view,d=t.PhysicsSystem,u=t.Node,E=t.find,m=t.Component},function(t){p=t.default},function(t){v=t.Util},function(t){C=t.AudioManager},function(t){y=t.PoolManager},function(t){T=t.PlayerData},function(t){I=t.ClientEvent},function(t){P=t.GameLogic},function(t){S=t.Fighter},function(t){F=t.Follow},function(t){N=t.UIManager},function(t){A=t.FormationCell},function(t){M=t.effectGroup}],execute:function(){var R,L,w,O,b,G,V,U,B,D,H,k,W;s._RF.push({},"e96a6rSHBtP4J0IlW8tGaAa","fighterManager",void 0);var Y=a.ccclass,x=a.property;t("FighterManager",(R=Y("FighterManager"),L=x(h),w=x(h),O=x(M),b=x(F),G=x(l),R((B=e((U=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return e=t.call.apply(t,[this].concat(s))||this,r(n(e),"pfFighter",B,n(e)),r(n(e),"pfFormationCell",D,n(e)),r(n(e),"effectGroup",H,n(e)),r(n(e),"cameraFollow",k,n(e)),r(n(e),"planeCollider",W,n(e)),o(n(e),"isGameStart",!1),o(n(e),"isGameOver",!1),o(n(e),"isGamePause",!1),o(n(e),"dictFighter",{}),o(n(e),"_identity",1),o(n(e),"_world",void 0),o(n(e),"_dictCell",{}),o(n(e),"_aryCell",[]),o(n(e),"_currentSelect",-1),o(n(e),"_currentMoveTarget",-1),o(n(e),"_arySelectFighterIdentity",[]),o(n(e),"_preTime",0),o(n(e),"_curTime",0),o(n(e),"_timeScale",1),o(n(e),"_isInit",!1),o(n(e),"_endPos",new c),o(n(e),"_startPos",new c),o(n(e),"_outPos",new c),o(n(e),"_tempPos",new c),o(n(e),"_ballPos",new c),o(n(e),"_outRay1",new _.Ray),o(n(e),"_curTouchPos",new g),e}i(e,t);var s=e.prototype;return s.onEnable=function(){I.on(p.EVENT_NAME.FIGHT_START,this._fightStart,this),I.on(p.EVENT_NAME.FIGHT_RESET,this._fightReset,this),I.on(p.EVENT_NAME.GAME_INIT,this._gameInit,this),I.on(p.EVENT_NAME.BUY_FIGHTER,this._buyFighter,this),I.on(p.EVENT_NAME.BUY_CELL,this._buyCell,this),I.on(p.EVENT_NAME.HOME_UI_TOUCH,this._homeUITouch,this),I.on(p.EVENT_NAME.USE_FIRE_BALL,this._useFireBall,this),I.on(p.EVENT_NAME.SHOW_SPRINT,this._showSprint,this),I.on(p.EVENT_NAME.HIDE_ALL_SIMILAR,this._hideAllSimilar,this)},s.onDisable=function(){I.off(p.EVENT_NAME.FIGHT_START,this._fightStart,this),I.off(p.EVENT_NAME.FIGHT_RESET,this._fightReset,this),I.off(p.EVENT_NAME.GAME_INIT,this._gameInit,this),I.off(p.EVENT_NAME.BUY_FIGHTER,this._buyFighter,this),I.off(p.EVENT_NAME.BUY_CELL,this._buyCell,this),I.off(p.EVENT_NAME.HOME_UI_TOUCH,this._homeUITouch,this),I.off(p.EVENT_NAME.USE_FIRE_BALL,this._useFireBall,this),I.off(p.EVENT_NAME.SHOW_SPRINT,this._showSprint,this),I.off(p.EVENT_NAME.HIDE_ALL_SIMILAR,this._hideAllSimilar,this)},s.start=function(){this.planeCollider.setGroup(p.COLLIDER_GROUP.PLANE),T.instance.isLoadFinished&&this._gameInit()},s._gameInit=function(){this._isInit||(this._isInit=!0,this._initWorld(),this._fightReset(),1===T.instance.playerInfo.level&&this._fightStart(1.5))},s._initWorld=function(){var t=box2d.b2Vec2.ZERO,e=new box2d.b2World(t);this._world=e},s._fightReset=function(){for(var t in this.isGameStart=!1,this.isGamePause=!1,this.isGameOver=!1,this._preTime=0,this._curTime=0,this._timeScale=1,this.cameraFollow.initCamera(1===T.instance.playerInfo.level),this.dictFighter){var e=this.dictFighter[t];for(var i in e){e[i].getComponent(S).resetFighterState()}}this._aryCell.forEach((function(t){t.getComponent(A).recycle()})),this._aryCell=[],this.node.destroyAllChildren(),this.dictFighter={},this._dictCell={},this.initFighters(),this._checkSimilar()},s.initFighters=function(){var t=this,e={};if(P.isDebugMode)e={1:[301,302,603,0,105,0,102,103,0,101,401,402,0,403,201,0,202,203,0,204,601,602,0,303,0],2:[104,0,303,302,301,101,102,103,0,0,401,0,403,402,201,203,202,0,0,204,601,0,603,0,602]};else{for(var i=T.instance.formation,r=[],n=[],o=0;o<30;o++)r[o]=-1,n[o]=-1;for(var s in i)r[s]=i[s];var a=T.instance.getCurLevelEnemy();for(var h in a)n[h]=a[h];e={1:r,2:n}}this.dictFighter={};var l=function(i){e[i].forEach((function(e,r){-1!==e&&t._addCell(r,Number(i),e)}))};for(var c in e)l(c)},s.addFighter=function(t,e,i,r){var n=this._identity++,o=y.instance.getNode(this.pfFighter,this.node);return o.getComponent(S).init(n,t,i,e,this._world,this,r),t!==p.PLAYER_TEAM&&(o.active=!1),this.dictFighter.hasOwnProperty(t)||(this.dictFighter[t]={}),this.dictFighter[t][n]=o,o.fight=i.fight,n},s.removeFighter=function(t){var e=this.dictFighter[p.PLAYER_TEAM][t];e&&e.getComponent(S).recycle();delete this.dictFighter[p.PLAYER_TEAM][t]},s._fightStart=function(t){this.isGameStart=!0,this._preTime=0,this._curTime=0,this._timeScale=1,N.instance.showDialog("fight/fightUI",[this]),this.cameraFollow.startGame(this);var e=[-3,-1.5,0,1.5,3],i=[],r=[],n=0;for(var o in this.dictFighter){var s=this.dictFighter[o],a=1;for(var h in o===p.PLAYER_TEAM.toString()&&(a=t),s){var l=s[h];l.active=!0;var _=l.getComponent(S);if(o===p.PLAYER_TEAM.toString()){var g=_.cellPos%5,f=g;switch(g){case 0:f=1;break;case 4:f=3}var d=[e[f-1],e[f],e[f+1]],u=Math.floor(Math.random()*d.length),E=new c(0,0,d[u]);-1===i.indexOf(d[u])&&i.push(d[u]),_.fightStart(a,E)}else r.push(_)}for(;r.length>0;){var m=i[n];n++,n%=i.length;var v=Math.floor(Math.random()*r.length),C=r.splice(v,1)[0],y=new c(0,0,m);C.fightStart(a,y)}}},s._checkTimeScale=function(t){if(this.isGameStart&&!this.isGamePause&&!this.isGameOver){this._curTime+=t;var e=Math.floor(this._curTime);if(e!=this._preTime){this._preTime=e;var i=1+.5*Math.floor(e/10);if(i!==this._timeScale)for(var r in this._timeScale=i,console.log("提速:",this._timeScale,this._preTime),this.dictFighter){var n=this.dictFighter[r];for(var o in n){n[o].getComponent(S).timeScale=this._timeScale}}}}},s.getEnemyAroundRange=function(t,e,i){var r=1===t?2:1,n=[],o=this.dictFighter[r];for(var s in o){var a=o[s];if(a){var h=a.getComponent(S);if(h&&!h.isDead){var l=a.position.clone().subtract(e);l.x<=i&&l.z<=i&&l.x*l.x+l.z*l.z<=i*i&&n.push(h)}}}return n},s.getNearestEnemy=function(t){var e=999999,i=null,r=t.node.position;for(var n in this.dictFighter)if(t.team!==Number(n)){var o=this.dictFighter[n];for(var s in o){var a=o[s],h=a.position.clone().subtract(r);if(Math.abs(h.x)<e||Math.abs(h.y)<e){var l=h.length();l<e&&(e=l,(i=a).tmpMinDis=e)}}}return i},s.onSomeoneDead=function(t){var e=t.team;if(delete this.dictFighter[e][t.identity],1!==e){var i=t.fighterInfo.coin;i>0&&I.dispatchEvent(p.EVENT_NAME.DROP_COIN,i,t.node.worldPosition.clone())}else I.dispatchEvent(p.EVENT_NAME.DROP_COIN,-1,t.node.worldPosition.clone())},s.checkWin=function(t){if(!this.isGameOver){var e=!1,i=1===t?2:1;if(Object.keys(this.dictFighter[i]).length<=0){this.isGameOver=!0;var r=this.dictFighter[t];for(var n in r){r[n].getComponent(S).showWin()}e=1===t,I.dispatchEvent(p.EVENT_NAME.GAME_OVER,e)}if(e){var o=new _.Ray,s=f.getCanvasSize();P.mainCamera.screenPointToRay(s.width/2,s.height/2,o),d.instance.raycastClosest(o,p.COLLIDER_GROUP.PLANE,50,!1);var a=d.instance.raycastClosestResult.hitPoint;this.effectGroup.playWinEffect(a,(function(){})),C.instance.playSound(p.AUDIO_SOUND.WIN)}else C.instance.playSound(p.AUDIO_SOUND.FAIL)}},s.getFighterNum=function(t){void 0===t&&(t=!0);var e=0;if(t)e=Object.keys(this.dictFighter[p.PLAYER_TEAM]).length;else for(var i in this.dictFighter)"1"!==i&&(e+=Object.keys(this.dictFighter[i]).length);return e},s.getFighterFight=function(t){void 0===t&&(t=!0);var e=0;for(var i in this.dictFighter)if("1"===i&&t||"1"!==i&&!t){var r=this.dictFighter[i];for(var n in r)e+=r[n].fight}return e},s._buyFighter=function(t,e){this._dictCell[t]&&(this._dictCell[t].getComponent(A).updateFighter(T.instance.getFighterIdByCellPos(t)),this._checkSimilar())},s._buyCell=function(t){this._dictCell[t]||this._addCell(t,1,T.instance.getFighterIdByCellPos(t))},s._addCell=function(t,e,i){var r=y.instance.getNode(this.pfFormationCell,this.node);r.getComponent(A).init(t,Number(e),i,this),e===p.PLAYER_TEAM&&(this._dictCell[t]=r),this._aryCell.push(r)},s._homeUITouch=function(t,e){t===u.EventType.TOUCH_START?this._checkSelectCell(e):t===u.EventType.TOUCH_MOVE?this._checkNewCell(e):this._checkCellOperation(e)},s._checkSelectCell=function(t){if(P.mainCamera.screenPointToRay(t.x,t.y,this._outRay1),d.instance.raycastClosest(this._outRay1,p.COLLIDER_GROUP.PLANE,50,!1)){var e=d.instance.raycastClosestResult.hitPoint,i=this._getCellByPos(e);if(i&&i.aryIdentity.length>0){this._currentSelect=i.pos,this._arySelectFighterIdentity=v.clone(i.aryIdentity),this._currentMoveTarget=this._currentSelect,I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!0,t,i.fighterId,0);var r=i.fighterId;if(T.instance.getFighterNextId(r)>0)for(var n in this._hideAllSimilar(),this._dictCell)if(Number(n)!==i.pos){var o=this._dictCell[n].getComponent(A);o.fighterId===r&&o.showSimilar(!0)}this._checkNewCell(t)}}},s._getCellByPos=function(t){for(var e in this._dictCell){var i=this._dictCell[e].getComponent(A);if(i.checkIsHit(t))return i}return null},s._checkNewCell=function(t){if((this._curTouchPos.set(t),this._currentSelect>=0)&&(P.mainCamera.screenPointToRay(t.x,t.y,this._outRay1),d.instance.raycastClosest(this._outRay1,p.COLLIDER_GROUP.PLANE,50,!1))){for(var e=d.instance.raycastClosestResult.hitPoint,i=P.getFighterPosByNum(e,this._arySelectFighterIdentity.length),r=0;r<i.length;r++){var n=i[r],o=this.dictFighter[p.PLAYER_TEAM][this._arySelectFighterIdentity[r]];if(o)o.setPosition(n),o.getComponent(S).rigidBody.enableSync=!1}var s=this._getCellByPos(e);if(s&&s.pos!==this._currentMoveTarget){this._currentMoveTarget>=0&&(this._dictCell[this._currentMoveTarget].getComponent(A).select=!1,this._currentMoveTarget=-1),s.select=!0,this._currentMoveTarget=s.pos;var a=this._dictCell[this._currentSelect].getComponent(A);s.pos===a.pos||0===s.aryIdentity.length?I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!0,this._curTouchPos,a.fighterId,0):s.fighterId===a.fighterId?I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!0,this._curTouchPos,a.fighterId,1):I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!0,this._curTouchPos,a.fighterId,2)}else if(!s){if(-1!==this._currentMoveTarget){var h=this._dictCell[this._currentSelect].getComponent(A);I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!0,this._curTouchPos,h.fighterId,0)}this._currentMoveTarget>=0&&(this._dictCell[this._currentMoveTarget].getComponent(A).select=!1,this._currentMoveTarget=-1)}}},s._resetCellFighterPos=function(){var t=this;this._arySelectFighterIdentity.forEach((function(e){t.dictFighter[p.PLAYER_TEAM][e].getComponent(S).rigidBody.enableSync=!0}))},s._swapCell=function(t,e){var i=this,r=v.clone(e.aryIdentity),n=e.fighterId;if(e.aryIdentity=v.clone(t.aryIdentity),e.fighterId=t.fighterId,t.aryIdentity=r,t.fighterId=n,T.instance.swapCell(t.pos,e.pos),e.aryIdentity.length>0){this._tempPos.set(e.node.worldPosition);var o=P.getFighterPosByNum(this._tempPos,e.aryIdentity.length);e.aryIdentity.forEach((function(t,r){var n=i.dictFighter[p.PLAYER_TEAM][t].getComponent(S);n.cellPos=e.pos,n.rigidBody.setWorldPosition(o[r]),n.rigidBody.enableSync=!0}))}if(t.aryIdentity.length>0){this._tempPos.set(t.node.worldPosition);var s=P.getFighterPosByNum(this._tempPos,t.aryIdentity.length);t.aryIdentity.forEach((function(e,r){var n=i.dictFighter[p.PLAYER_TEAM][e].getComponent(S);n.cellPos=t.pos,n.rigidBody.setWorldPosition(s[r]),n.rigidBody.enableSync=!0}))}this._checkSimilar()},s._combineCell=function(t,e){var i=T.instance.getFighterNextId(t.fighterId);i>0?(T.instance.combineCell(t.pos,e.pos,i),e.updateFighter(i),t.updateFighter(0),e.showCombineSucceed(),C.instance.playSound(p.AUDIO_SOUND.COMBINE),I.dispatchEvent(p.EVENT_NAME.COMBINE_SUCCEED,e.pos,t.pos),I.dispatchEvent(p.EVENT_NAME.UPDATE_FORMATION),this._checkSimilar()):this._resetCellFighterPos()},s._checkCellOperation=function(t){if(this._currentSelect>=0){var e=this._dictCell[this._currentSelect].getComponent(A);if(P.mainCamera.screenPointToRay(t.x,t.y,this._outRay1),d.instance.raycastClosest(this._outRay1,p.COLLIDER_GROUP.PLANE,50,!1)){var i=d.instance.raycastClosestResult.hitPoint,r=this._getCellByPos(i);r?this._currentSelect===r.pos?this._resetCellFighterPos():0===r.aryIdentity.length?this._swapCell(e,r):r.fighterId===e.fighterId?this._combineCell(e,r):this._swapCell(e,r):this._resetCellFighterPos()}this._arySelectFighterIdentity=[],this._currentSelect=-1,this._currentMoveTarget>=0&&(this._dictCell[this._currentMoveTarget].getComponent(A).select=!1,this._currentMoveTarget=-1),this._checkSimilar()}I.dispatchEvent(p.EVENT_NAME.SHOW_LEVEL_TIPS,!1)},s._isCloseFighter=function(t){return t===p.FIGHTER_TYPE.CLOSE||t===p.FIGHTER_TYPE.BAT||t===p.FIGHTER_TYPE.OX},s._useFireBall=function(){var t=this,e=0,i=0,r=0,n=0,o=0,s=0;for(var a in this.dictFighter)if(a!==p.PLAYER_TEAM.toString()){var h=this.dictFighter[a];for(var l in h){var c=h[l],_=c.getComponent(S),g=c.position;this._isCloseFighter(_.fightType)?(e++,r+=g.x,n+=g.z):(i++,o+=g.x,s+=g.z)}}e>0?this._ballPos.set(r/e,0,n/e):i>0&&this._ballPos.set(o/i,0,s/i);var f=p.FIRE_BALL_DISTANCE*p.FIRE_BALL_DISTANCE;this.effectGroup.playFireBallEffect(this._ballPos,(function(){C.instance.playSound(p.AUDIO_SOUND.FIRE_BALL);var e=p.FIRE_BALL_DAMAGE_PERCENT;for(var i in T.instance.playerInfo.level<20&&(e=1),t.dictFighter)if(i!==p.PLAYER_TEAM.toString()){var r=t.dictFighter[i];for(var n in r){var o=r[n];if(o.worldPosition.clone().subtract(t._ballPos).lengthSqr()<f){var s=o.getComponent(S);s.onDamage(s.hpMax*e,-1)}}}}))},s.getCombineContentForGuide=function(){var t=this._dictCell[2],e=E("Canvas");P.mainCamera.convertToUINode(t.getWorldPosition(),e,this._outPos);var i=-1,r=-1,n=[this._dictCell[1],this._dictCell[2],this._dictCell[3]],o=[n[0].getComponent(A),n[1].getComponent(A),n[2].getComponent(A)];o[0].fighterId===o[1].fighterId?(i=0,r=1):o[0].fighterId===o[2].fighterId?(i=0,r=2):(i=1,r=2),P.mainCamera.convertToUINode(n[i].getWorldPosition(),e,this._startPos),P.mainCamera.convertToUINode(n[r].getWorldPosition(),e,this._endPos);var s=f.getViewportRect(),a=f.getDesignResolutionSize(),h=s.width/a.width,l=s.height/a.height,c=h>=l?h:l;return{pos:this._outPos,width:400*c,height:150*c,dragStart:this._startPos,dragEnd:this._endPos}},s._showSprint=function(){for(var t in this._dictCell){var e=this._dictCell[t].getComponent(A);e&&e.fighterId&&e.showSprint()}},s.pauseGame=function(){this.isGamePause=!0},s.resumeGame=function(){this.isGamePause=!1},s._hideAllSimilar=function(){for(var t in this._dictCell){this._dictCell[t].getComponent(A).showSimilar(!1)}},s._checkSimilar=function(){var t={},e=T.instance.formation;for(var i in e){var r=e[i];r>0&&(t.hasOwnProperty(r)?t[r].push(i):t[r]=[i])}for(var n in this._hideAllSimilar(),t){var o=t[n];if(o.length>1)for(var s=0;s<o.length;s++){var a=o[s];this._dictCell[a].getComponent(A).showSimilar(!0)}}},s.update=function(t){this.isGameStart&&(this._checkTimeScale(t),this._world&&this._world.Step(.034,6,2))},e}(m)).prototype,"pfFighter",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=e(U.prototype,"pfFormationCell",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=e(U.prototype,"effectGroup",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k=e(U.prototype,"cameraFollow",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W=e(U.prototype,"planeCollider",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V=U))||V));s._RF.pop()}}}));

System.register("chunks:///_virtual/buyFighter.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./resourcesUtils.ts","./audioManager.ts","./localConfig.ts","./playerData.ts","./clientEvent.ts","./uiManager.ts","./guideManager.ts"],(function(t){"use strict";var e,i,n,r,a,o,s,c,u,l,h,p,d,f,g,y,_;return{setters:[function(t){e=t.applyDecoratedDescriptor,i=t.inheritsLoose,n=t.initializerDefineProperty,r=t.assertThisInitialized,a=t.defineProperty},function(t){o=t.cclegacy,s=t._decorator,c=t.SpriteComponent,u=t.Component},function(t){l=t.default},function(t){h=t.ResourceUtil},function(t){p=t.AudioManager},function(t){d=t.localConfig},function(t){f=t.PlayerData},function(t){g=t.ClientEvent},function(t){y=t.UIManager},function(t){_=t.GuideManager}],execute:function(){var b,D,v,E,I;o._RF.push({},"ea7edIGRJBMJbx94wnYS2pg","buyFighter",void 0);var C=s.ccclass,F=s.property;t("buyFighter",(b=C("buyFighter"),D=F(c),b((I=e((E=function(t){function e(){for(var e,i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];return e=t.call.apply(t,[this].concat(o))||this,n(r(e),"spCardDouble",I,r(e)),a(r(e),"_fighterId",0),a(r(e),"_pos",0),a(r(e),"_callback",null),e}i(e,t);var o=e.prototype;return o.start=function(){},o.show=function(t,e,i){var n=this;if(this._fighterId=t,this._pos=e,this._callback=i,_.instance.isPlayingBuyGuide())this.onBtnNormalClick();else{var r=d.instance.queryByID("fighter",this._fighterId.toString());h.getCard(r.type,(function(t,e){n.spCardDouble.node.isValid&&(n.spCardDouble.spriteFrame=e)}))}},o.onBtnNormalClick=function(){y.instance.hideDialog("home/buyFighter"),f.instance.addFighter(this._pos,this._fighterId),g.dispatchEvent(l.EVENT_NAME.BUY_FIGHTER,this._pos,this._fighterId),p.instance.playSound(l.AUDIO_SOUND.BUY_FIGHTER),f.instance.addBuyTimes(),g.dispatchEvent(l.EVENT_NAME.UPDATE_FORMATION),this._callback&&this._callback()},e}(u)).prototype,"spCardDouble",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v=E))||v));o._RF.pop()}}}));

System.register("chunks:///_virtual/balance.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./localConfig.ts","./playerData.ts","./gameLogic.ts","./uiManager.ts"],(function(e){"use strict";var t,i,n,l,r,a,o,s,u,c,p,f,b,g,h,d,w,_;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,n=e.initializerDefineProperty,l=e.assertThisInitialized,r=e.defineProperty},function(e){a=e.cclegacy,o=e._decorator,s=e.SpriteComponent,u=e.Node,c=e.SpriteFrame,p=e.LabelComponent,f=e.Vec3,b=e.Tween,g=e.Component},function(e){h=e.localConfig},function(e){d=e.PlayerData},function(e){w=e.GameLogic},function(e){_=e.UIManager}],execute:function(){var y,v,m,R,F,z,B,L,T,C,W,D,H,G,I,E,S,P,A,M,k;a._RF.push({},"f01862LztJGL7i4nYXtwyX6","balance",void 0);var x=o.ccclass,N=o.property;e("balance",(y=x("balance"),v=N(s),m=N(s),R=N(u),F=N(c),z=N(c),B=N(c),L=N(c),T=N(p),C=N(p),y((H=t((D=function(e){function t(){for(var t,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return t=e.call.apply(e,[this].concat(a))||this,n(l(t),"spResultBg",H,l(t)),n(l(t),"spResultTitle",G,l(t)),n(l(t),"ndHalo",I,l(t)),n(l(t),"sfBgWin",E,l(t)),n(l(t),"sfBgFailed",S,l(t)),n(l(t),"sfTitleWin",P,l(t)),n(l(t),"sfTitleFailed",A,l(t)),n(l(t),"lbGold",M,l(t)),n(l(t),"lbLevel",k,l(t)),r(l(t),"_rewardCoin",0),r(l(t),"_isWin",!1),r(l(t),"_parent",null),r(l(t),"_tweenRotate",null),r(l(t),"_oriEuler",new f),r(l(t),"_targetEuler",new f(0,0,-360)),t}i(t,e);var a=t.prototype;return a.start=function(){},a.onDisable=function(){this._tweenRotate&&(this._tweenRotate.stop(),this._tweenRotate=null)},a.show=function(e,t,i){var n=this.sfBgWin,l=this.sfTitleWin;if(d.instance.isLastFightWin=e,e){this.ndHalo.active=!0,this._tweenRotate&&(this._tweenRotate.stop(),this._tweenRotate=null),this._oriEuler.set(0,0,0),this.ndHalo.eulerAngles=this._oriEuler,this._tweenRotate=new b(this.ndHalo).by(2,{eulerAngles:this._targetEuler}).repeatForever().start();var r=h.instance.queryByID("level",d.instance.playerInfo.level.toString());r&&r.gold&&(t+=r.gold)}else n=this.sfBgFailed,l=this.sfTitleFailed,this.ndHalo.active=!1;this.lbGold.string=t.toString(),this.spResultBg.spriteFrame=n,this.spResultTitle.spriteFrame=l,this.lbLevel.string="第 "+d.instance.playerInfo.level+" 关",this._rewardCoin=t,this._isWin=e,this._parent=i,d.instance.playerInfo.level<3&&this.reward(!1)},a.onBtnNextClick=function(){this.reward(!1)},a.reward=function(e){var t=e?3*this._rewardCoin:this._rewardCoin;w.addGold(t),this._isWin&&d.instance.passLevel(),_.instance.hideDialog("fight/balance"),this._parent.reset()},t}(g)).prototype,"spResultBg",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G=t(D.prototype,"spResultTitle",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=t(D.prototype,"ndHalo",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=t(D.prototype,"sfBgWin",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=t(D.prototype,"sfBgFailed",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P=t(D.prototype,"sfTitleWin",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=t(D.prototype,"sfTitleFailed",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=t(D.prototype,"lbGold",[T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k=t(D.prototype,"lbLevel",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W=D))||W));a._RF.pop()}}}));

System.register("chunks:///_virtual/fightUI.ts",["./_rollupPluginModLoBabelHelpers.js","cc","./constants.ts","./util.ts","./localConfig.ts","./playerData.ts","./clientEvent.ts","./uiManager.ts","./coinTipsManager.ts"],(function(i){"use strict";var t,e,n,l,o,r,s,a,u,c,h,p,f,b,g,_,d,m,T,v,y,E,S,w,C;return{setters:[function(i){t=i.applyDecoratedDescriptor,e=i.inheritsLoose,n=i.initializerDefineProperty,l=i.assertThisInitialized,o=i.defineProperty,r=i.createClass},function(i){s=i.cclegacy,a=i._decorator,u=i.LabelComponent,c=i.ProgressBarComponent,h=i.Node,p=i.ButtonComponent,f=i.SpriteComponent,b=i.SpriteFrame,g=i.Vec3,_=i.AnimationComponent,d=i.UITransformComponent,m=i.Component},function(i){T=i.default},function(i){v=i.Util},function(i){y=i.localConfig},function(i){E=i.PlayerData},function(i){S=i.ClientEvent},function(i){w=i.UIManager},function(i){C=i.coinTipsManager}],execute:function(){var F,B,k,N,z,I,U,M,D,H,V,R,A,O,P,G,L,x,j,q,W,X,Y,Z,J,K,Q,$,ii,ti,ei,ni,li,oi,ri;s._RF.push({},"fbbdcbBygFGwYyOX+6ZoIW3","fightUI",void 0);var si=a.ccclass,ai=a.property;i("fightUI",(F=si("fightUI"),B=ai(C),k=ai(u),N=ai(u),z=ai(u),I=ai(u),U=ai(c),M=ai(h),D=ai(h),H=ai(p),V=ai(f),R=ai(b),A=ai(b),O=ai(h),P=ai(u),G=ai(h),L=ai(h),F((q=t((j=function(i){function t(){for(var t,e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];return t=i.call.apply(i,[this].concat(r))||this,n(l(t),"coinTips",q,l(t)),n(l(t),"lbGold",W,l(t)),n(l(t),"lbSelf",X,l(t)),n(l(t),"lbEnemy",Y,l(t)),n(l(t),"lbLevel",Z,l(t)),n(l(t),"progressFighter",J,l(t)),n(l(t),"ndVS",K,l(t)),n(l(t),"ndTips",Q,l(t)),n(l(t),"btnSkillBtn",$,l(t)),n(l(t),"spSkillBtn",ii,l(t)),n(l(t),"sfSkillNormal",ti,l(t)),n(l(t),"sfSkillDisable",ei,l(t)),n(l(t),"ndCoolTime",ni,l(t)),n(l(t),"lbCoolTime",li,l(t)),n(l(t),"ndReset",oi,l(t)),n(l(t),"ndHand",ri,l(t)),o(l(t),"_coolTime",0),o(l(t),"_isUseFireBall",!1),o(l(t),"_currentTime",0),o(l(t),"_preTime",0),o(l(t),"_tweenHand",null),o(l(t),"_gold",0),o(l(t),"_factor",1),o(l(t),"_manager",null),o(l(t),"_vsPos",new g),t}e(t,i);var s=t.prototype;return s.start=function(){},s.onEnable=function(){S.on(T.EVENT_NAME.DROP_COIN,this._dropCoin,this),S.on(T.EVENT_NAME.GAME_OVER,this._gameOver,this)},s.onDisable=function(){S.off(T.EVENT_NAME.DROP_COIN,this._dropCoin,this),S.off(T.EVENT_NAME.GAME_OVER,this._gameOver,this)},s.show=function(i){var t;this._manager=i,this.lbLevel.string="第 "+E.instance.playerInfo.level+" 关",this.ndReset.active=E.instance.playerInfo.level>=3,this._updateFighterNum(),this._gold=0;var e=y.instance.queryByID("level",E.instance.playerInfo.level.toString());e&&e.coefficient?this._factor=e.coefficient:this._factor=1,this._updateGold(),this._coolTime=0,this.skillBtnEnable=!0,this._isUseFireBall=!1,this._currentTime=0,this._preTime=0,this.ndTips.active=!1,null===(t=this.ndTips.getComponent(_))||void 0===t||t.stop(),this.ndHand.active=!1,this._tweenHand&&(this._tweenHand.stop(),this._tweenHand=null)},s._updateFighterNum=function(){var i=this._manager.getFighterFight(!0);this.lbSelf.string=i.toString();var t=this._manager.getFighterFight(!1);this.lbEnemy.string=t.toString();var e=1*i/(i+t);this.progressFighter.progress=e,this._vsPos.set(this.ndVS.position);var n=this.progressFighter.node.getComponent(d);this._vsPos.x=n.contentSize.width*(e-.5),this.ndVS.position=this._vsPos},s._updateGold=function(){this.lbGold.string=this._gold.toString()},s._dropCoin=function(i,t){(i=this._factor*i)>0&&(this.coinTips.dropCoin(i,t),this._gold+=i,this._updateGold()),this._updateFighterNum()},s.onBtnResetClick=function(){this.reset()},s.reset=function(){this.coinTips.recycle(),S.dispatchEvent(T.EVENT_NAME.FIGHT_RESET),w.instance.hideDialog("fight/fightUI"),w.instance.showDialog("home/homeUI")},s._gameOver=function(i){var t=this;this.scheduleOnce((function(){w.instance.showDialog("fight/balance",[i,t._gold,t])}),2)},s._useFillBall=function(){this._isUseFireBall=!0,this.skillBtnEnable=!1,this._coolTime=10,S.dispatchEvent(T.EVENT_NAME.USE_FIRE_BALL)},s.onBtnSkillClick=function(){var i;(this._isUseFireBall=!0,this.ndTips.active)&&(this.ndTips.active=!1,null===(i=this.ndTips.getComponent(_))||void 0===i||i.stop());this.ndHand.active&&(this.ndHand.active=!1,this._tweenHand&&(this._tweenHand.stop(),this._tweenHand=null)),this._useFillBall(),E.instance.playerInfo.hasUsedFireBall||E.instance.markUseFireBall()},s.update=function(i){if(this._currentTime+=i,this._preTime===Math.floor(this._currentTime)||this._isUseFireBall||(this._preTime=Math.floor(this._currentTime)),this._coolTime>0&&this.ndCoolTime.active){this._coolTime-=i;var t=Math.round(this._coolTime);this.lbCoolTime.string=v.formatTimeForSecond(t),this._coolTime<=0&&(this._coolTime=0,this.skillBtnEnable=!0)}},r(t,[{key:"skillBtnEnable",set:function(i){this.btnSkillBtn.interactable=i,this.spSkillBtn.spriteFrame=i?this.sfSkillNormal:this.sfSkillDisable,this.ndCoolTime.active=!i}}]),t}(m)).prototype,"coinTips",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W=t(j.prototype,"lbGold",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X=t(j.prototype,"lbSelf",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y=t(j.prototype,"lbEnemy",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Z=t(j.prototype,"lbLevel",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J=t(j.prototype,"progressFighter",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K=t(j.prototype,"ndVS",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Q=t(j.prototype,"ndTips",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$=t(j.prototype,"btnSkillBtn",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ii=t(j.prototype,"spSkillBtn",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ti=t(j.prototype,"sfSkillNormal",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ei=t(j.prototype,"sfSkillDisable",[A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ni=t(j.prototype,"ndCoolTime",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),li=t(j.prototype,"lbCoolTime",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oi=t(j.prototype,"ndReset",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ri=t(j.prototype,"ndHand",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=j))||x));s._RF.pop()}}}));

System.register("chunks:///_virtual/main",["./effect.ts","./csvManager.ts","./constants.ts","./util.ts","./storageManager.ts","./lodash.ts","./resourcesUtils.ts","./audioManager.ts","./fighterRigidBody.ts","./poolManager.ts","./missile.ts","./fighterModel.ts","./localConfig.ts","./playerData.ts","./clientEvent.ts","./gameLogic.ts","./fighter.ts","./follow.ts","./uiManager.ts","./levelTips.ts","./migrate-canvas.ts","./formationCell.ts","./effectGroup.ts","./fighterManager.ts","./guideManager.ts","./guide.ts","./coinTipsManager.ts","./homeUI.ts","./homeUIOnline.ts","./main.ts","./time.ts","./online.ts","./unlock.ts","./buyFighter.ts","./balance.ts","./fightUI.ts","./box2d.mjs_cjs=&original=.js"],(function(){"use strict";return{setters:[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){}}}));

(function(r) {
  r('virtual:///prerequisite-imports/main', 'chunks:///_virtual/main'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});